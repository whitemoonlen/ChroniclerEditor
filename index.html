<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicler Editor</title>
    <style>
        /* 字體 */
        @import url("https://fontsapi.zeoseven.com/563/main/result.css");
        
        :root {
    --primary-color: #4E5E79;
    --secondary-color: #1a202c;
    --accent-color: #8b7355;
    --bg-color: #f7f5f3;
    --surface-color: #ffffff;
    --text-color: #2d3748;
    --text-muted: #718096;
    --border-color: #e2e8f0;
    --success-color: #48bb78;
    --warning-color: #ed8936;
    --danger-color: #f56565;
    --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-large: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --header-bg: #f1f5f9;      /* 頂部欄背景 - 比主要背景稍深一點 */
    --sidebar-bg: #f8fafc;     /* 側邊欄背景 - 比主要背景稍亮一點 */
    --main-content-bg: #fafbfc; /* 主要內容區域背景 - 更淺的灰白 */
    --content-bg: #ffffff;     /* 主要內容區背景 - 保持白色 */

    /* 預設配色備份 */
    --default-primary: #4E5E79;
    --default-secondary: #1a202c;
    --default-accent: #8b7355;
    --default-bg: #f7f5f3;
    --default-surface: #ffffff;
    --default-text: #2d3748;
    --default-text-muted: #718096;
    /* 新增預設界面色彩 */
    --default-header-bg: #f1f5f9;
    --default-sidebar-bg: #f8fafc;
    --default-content-bg: #ffffff;
    --default-main-content-bg: #fafbfc;

/* 護眼配色 - 黑白灰主調 (macOS 深色風格) */
--eyecare-primary: #404040;           /* 淡灰，作為主色與選中時的背景 */
--eyecare-secondary: #6e6e6e;         /* 中灰，用於 hover 或強調區塊 */
--eyecare-accent: #4b768b;            /* 白色，純淨對比點綴（例如 active 按鈕） */
--eyecare-bg: #7d7d7d;                /* 背景主體，近黑色但帶灰階 */
--eyecare-surface: #2a2a2a;           /* 卡片與面板區，略亮於背景以分層 */
--eyecare-text: #e0e0e0;              /* 主文字色，亮灰白 */
--eyecare-text-muted: #aaaaaa;        /* 輔助文字，柔灰 */
--eyecare-border: #525252;            /* 邊框顏色，深灰但不完全隱沒 */
--eyecare-header-bg: #000000;         /* 頂部區背景，與面板同調一致 */
--eyecare-sidebar-bg: #1f1f1f;        /* 側邊欄背景，更接近純黑 */
--eyecare-content-bg: #292929;        /* 內容區域背景，深灰與主背景做區隔 */
--eyecare-main-content-bg: #1a1a1a;   /* 整體最底背景，最深但仍非純黑 */

}


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Serif CJK JP", 'Georgia', 'Times New Roman', serif;
            font-weight: normal;
            background: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            line-height: 1.6;
        }


        .app-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: var(--bg-color);
}

.field-input.scrollable {
    max-height: 200px;
    overflow-y: auto;
    resize: vertical;
    min-height: 60px;
}

        /* 頂部主欄位 */
        .top-header {
    background: var(--header-bg);
    box-shadow: var(--shadow-light);
    z-index: 10;
    border-top: 4px solid var(--accent-color); /* 直接在頂部欄加上邊框 */
}

            .header-content {
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
   /* 語言選單樣式 */
.language-menu-container {
    position: relative;
    display: inline-block;
}

.language-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: var(--shadow-medium);
    z-index: 1001;
    min-width: 120px;
    margin-top: 4px;
}

.language-option {
    padding: 8px 16px;
    cursor: pointer;
    font-size: 0.85em;
    color: var(--text-color);
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--border-color);
}

.language-option:last-child {
    border-bottom: none;
}

.language-option:hover {
    background: var(--bg-color);
}

.language-option.active {
    background: var(--primary-color);
    color: white;
}
/* 下方容器 */
.bottom-container {
    display: flex;
    flex: 1;
    overflow: hidden;
}
        /* 側邊欄 */
        .sidebar {
    width: 280px;
    background: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    box-shadow: var(--shadow-light);
    
    /* 強制滾動條在左邊 */
    direction: rtl;
    
    /* 滾動條樣式 */
    scrollbar-width: thin;
    scrollbar-color: var(--accent-color) transparent;
}

.sidebar::-webkit-scrollbar {
    width: 3px !important;
}

.sidebar::-webkit-scrollbar-track {
    background: transparent !important;
}

.sidebar::-webkit-scrollbar-thumb {
    background: var(--accent-color) !important;
    border-radius: 1.5px !important;
    min-height: 20px !important;
    max-height: 40px !important;
    background-clip: padding-box !important;
    border: 2px solid transparent !important;
}

.sidebar::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color) !important;
}

.sidebar-section {
    border-bottom: 1px solid var(--border-color);
}

.sidebar-section:last-child {
    border-bottom: none;
}

.sidebar-section-header {
    padding: 16px 20px;
    background: transparent; /* 改為透明背景 */
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--border-color);
}

.sidebar-section-header:hover {
    background: var(--bg-color); /* hover時只是稍微變色 */
}

.sidebar-section-title {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--text-color); /* 改為正常文字色 */
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.sidebar-section-icon {
    font-size: 0.8em;
    color: var(--text-muted); /* 改為次要文字色 */
    transition: transform 0.2s ease;
}

.sidebar-section-content {
    padding: 16px;
    transition: all 0.3s ease;
    overflow: hidden;
    background: transparent; 
}

.sidebar-section-content.collapsed {
    max-height: 0;
    padding: 0 16px;
}

.sidebar-add-btn {
    width: 100%;
    margin-top: 12px;
    padding: 8px 16px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85em;
    transition: all 0.2s ease;
    background: var(--surface-color);
    color: var(--text-color);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.sidebar-add-btn:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-light);
}

        .character-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: transparent;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
    transition: all 0.2s ease;
    color: var(--text-color);
    margin-bottom: 2px;
}

/* 內容恢復正常方向 */
.sidebar > * {
    direction: ltr;
}

.character-header:hover {
    background: var(--bg-color);
}

.character-header.active {
    background: transparent;
    color: var(--accent-color); /* 選中時使用強調色文字 */
    font-weight: 600;
}
/* 三角符號樣式 - 左側 */
.character-header .expand-icon {
    font-size: 0.8em;
    color: var(--text-muted);
    transition: all 0.2s ease;
    transform: rotate(-90deg); /* 預設收合狀態 */
    margin-right: 8px;
}

.character-header.active .expand-icon {
    color: var(--accent-color);
    transform: rotate(0deg); /* 展開狀態 */
}
        .version-list {
    padding-left: 12px;
    margin-top: 4px;
    display: none;
}
/* 角色名稱和版本數量容器 */
.character-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex: 1;
}
.version-list.expanded {
    display: block;
}

.version-item {
    padding: 8px 16px;
    margin: 2px 0;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.2s ease;
    color: var(--text-muted);
}

.version-item:hover {
    background: var(--bg-color);
    color: var(--text-color);
}

.version-item.active {
    background: transparent;
    color: var(--accent-color); /* 只用強調色文字表示選中 */
    font-weight: 600;
}

 /* 角色名 */
.character-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    background: var(--content-bg);
    border-radius: 8px;
    margin-bottom: 24px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
}

.character-title-section {
    flex: 0 0 auto;
}

.character-main-title-fixed {
    font-size: 1.5em !important;
    font-weight: 700 !important;
    margin: 0 !important;
    padding: 8px 16px !important;
    border: 1px solid transparent !important;
    border-radius: 6px !important;
    background: transparent !important;
    color: var(--text-color) !important;
    transition: all 0.2s ease !important;
    min-width: 200px;
}

.character-main-title-fixed:focus {
    outline: none !important;
    border-color: var(--primary-color) !important;
    background: var(--bg-color) !important;
}

.character-main-title-fixed:hover {
    border-color: var(--border-color) !important;
}

.character-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}



        /* 主要內容區 - 英倫風格 */
        .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--main-content-bg);
}
        .header {
            display: none;
}

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .toggle-sidebar {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .toggle-sidebar:hover {
            background: var(--bg-color);
            color: var(--text-color);
        }

        .app-title-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }

        .app-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.02em;
        }

        .app-version {
            font-size: 0.75em;
            color: var(--text-muted);
            font-weight: 400;
        }

        .app-subtitle {
            font-size: 0.7em;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 2px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--main-content-bg);
        }

        .view-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--content-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            align-items: center;
            flex-wrap: wrap;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--content-bg);
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        /* 按鈕樣式 - 英倫風格 */
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85em;
            transition: all 0.2s ease;
            background: var(--surface-color);
            color: var(--text-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-light);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-color);
        }

        .btn-accent {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        /* 版本面板 - 文學編輯器風格 */
        .versions-container {
            display: grid;
            gap: 24px;
        }

        .versions-container.single-view {
            grid-template-columns: 1fr;
        }

        .versions-container.compare-view {
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        }

        .version-panel {
            background: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
        }

        .version-panel:hover {
            box-shadow: var(--shadow-medium);
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .version-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
            background: transparent;
            border: 1px solid transparent;
            padding: 6px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .version-title:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-color);
        }

        /* 為文字欄位添加自動調整高度功能： */

textarea.field-input {
    min-height: 120px;
    resize: vertical;
    overflow: hidden; /* 隱藏滾動條 */
    transition: height 0.2s ease; /* 平滑過渡效果 */
}

/* 文字欄位可以自動擴展 */
textarea.field-input.auto-resize {
    resize: none; /* 禁用手動調整 */
    overflow-y: hidden;
}
        
        .character-main-title {
    font-size: 1.4em !important;
    font-weight: 700 !important;
    margin: 0 !important;
    padding: 8px 12px !important;
    border: 1px solid transparent !important;
    border-radius: 6px !important;
    background: transparent !important;
    color: var(--text-color) !important;
    transition: all 0.2s ease !important;
}

.character-main-title:focus {
    outline: none !important;
    border-color: var(--primary-color) !important;
    background: var(--bg-color) !important;
}

.character-main-title:hover {
    border-color: var(--border-color) !important;
}


        /* 表單欄位 - 精緻設計 */
        .field-group {
            margin-bottom: 24px;
        }

        .field-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .field-stats {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-left: 12px;
            font-style: italic;
        }

        .field-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            font-family: "Noto Serif CJK JP", 'Georgia', serif;
            transition: all 0.2s ease;
            background: var(--surface-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(45, 55, 72, 0.1);
        }

        textarea.field-input {
            min-height: 120px;
            resize: vertical;
        }

        /* 頭像和基本資訊佈局 */
        .character-basic-info {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            align-items: flex-start;
        }

        .avatar-section {
            flex-shrink: 0;
        }

        .avatar-preview {
            width: auto;
            max-width: auto;
            height: 360px;
            aspect-ratio: 2/3;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            object-fit: cover;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8em;
            text-align: center;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        .avatar-upload-btn {
            width: 100%;
            margin-top: 12px;
            display: block;
        }

        .basic-info-fields {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-content: start;
}


        .file-input {
            display: none;
        }

        .file-label {
    padding: 8px 16px;
    background: var(--surface-color);
    color: var(--text-color);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
    font-size: 0.85em;
}

.file-label:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-light);
}

        /* 底部欄位區域 */
        .bottom-fields {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .bottom-fields .field-group {
            margin-bottom: 16px;
        }

        .bottom-fields .field-input {
            padding: 8px 12px;
            font-size: 0.85em;
        }

        .bottom-fields h4 {
            margin-bottom: 16px;
            color: var(--text-muted);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        /* 匯出區域 */
        .export-section {
            margin-top: 32px;
            padding: 24px;
            background: var(--content-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: var(--shadow-light);
        }

        .export-section h3 {
            margin-bottom: 16px;
            color: var(--text-color);
            font-size: 1.1em;
            font-weight: 600;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* 彈窗樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(45, 55, 72, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 5% auto;
            padding: 32px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 520px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-large);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            color: var(--danger-color);
            background: var(--bg-color);
        }

        .color-input-group {
            margin-bottom: 20px;
        }

        .color-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .color-input {
            width: 100%;
            height: 48px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .color-input:hover {
            border-color: var(--primary-color);
        }

        .color-preview {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            padding: 16px;
            background: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .color-preview-item {
            flex: 1;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: white;
            font-size: 0.8em;
        }

        .version-compare-controls {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .version-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .version-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .version-checkbox:hover {
            border-color: var(--primary-color);
        }

        .version-checkbox.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .version-checkbox input[type="checkbox"] {
            margin: 0;
        }

        /* 主題顏色選擇器 */
        .theme-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .theme-preset {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .theme-preset:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }

        .theme-preset.active {
            border-color: var(--primary-color);
            border-width: 3px;
        }

        /* 響應式設計 */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }
    
    .header-controls {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .bottom-container {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        max-height: 40vh;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
    }
    
    .versions-container.compare-view {
        grid-template-columns: 1fr;
    }

    .content-area {
        padding: 16px;
    }

        .character-header-bar {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }
    
    .character-title-section {
        text-align: center;
    }
    
    .character-controls {
        justify-content: center;
    }
}
}
/* 螢幕響應式 */
@media (max-width: 1024px) {
    .character-header-bar {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }
    
    .character-title-section {
        text-align: center;
    }
    
    .character-controls {
        justify-content: center;
    }
}
        /* 預設主題配色 */
        .theme-classic { background: linear-gradient(135deg, #4E5E79, #8b7355); }
        .theme-warm { background: linear-gradient(135deg, #744210, #d69e2e); }
        .theme-cool { background: linear-gradient(135deg, #2c5282, #3182ce); }
        .theme-forest { background: linear-gradient(135deg, #22543d, #38a169); }
        .theme-vintage { background: linear-gradient(135deg, #553c9a, #9f7aea); }
        .theme-minimal { background: linear-gradient(135deg, #4a5568, #718096); }
    </style>
</head>
<body>
    
    <div class="app-container">
    <div class="app-container">
    <!-- 頂部主欄位 -->
    <div class="top-header">
        <div class="header-content">
            <div class="header-left">
                <div class="app-title-container">
                    <div style="display: flex; align-items: baseline; gap: 12px;">
                        <h1 class="app-title">Chronicler Editor</h1>
                        <span class="app-version">v1.0.0 beta</span>
                    </div>
                    <div class="app-subtitle">本工具資料儲存在你的本機瀏覽器中，請定期備份以免資料丟失。</div>
                </div>
            </div>
            <div class="header-controls">
    <button class="btn btn-secondary" onclick="showColorPicker()">自訂顏色</button>
    <button class="btn btn-secondary" onclick="exportAllData()">匯出資料</button>
    <button class="btn btn-secondary" onclick="importAllData()">匯入資料</button>
    
    <!-- 語言選單 -->
    <div class="language-menu-container">
        <button class="btn btn-secondary" onclick="toggleLanguageMenu()" id="lang-toggle">
            <span id="lang-current">中文</span> ▼
        </button>
        <div class="language-menu" id="lang-menu" style="display: none;">
            <div class="language-option" onclick="selectLanguage('zh')">中文</div>
            <div class="language-option" onclick="selectLanguage('en')">English</div>
        </div>
    </div>
    
    <input type="file" id="importFile" accept=".json,.png" style="display: none;" onchange="handleImport(event)">
    <input type="file" id="importAllFile" accept=".json" style="display: none;" onchange="handleImportAll(event)">
</div>
        </div>
    </div>

    <!-- 下方內容區 -->
    <div class="bottom-container">
        <!-- 側邊欄 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
    <div class="sidebar-section-header" onclick="toggleSection('characters')">
        <span class="sidebar-section-title">角色列表</span>
        <span class="sidebar-section-icon" id="characters-icon">▼</span>
    </div>
    <div class="sidebar-section-content" id="characters-content">
        <div id="sidebarContent">
            <!-- 角色列表會在這裡生成 -->
        </div>
        <button class="btn btn-secondary sidebar-add-btn" onclick="addCharacter()">新增角色</button>
        <button class="btn btn-secondary sidebar-add-btn" onclick="importCharacter()">匯入角色</button>
    </div>
</div>

<!-- 世界書區塊 -->
<div class="sidebar-section">
    <div class="sidebar-section-header" onclick="toggleSection('worldbook')">
        <span class="sidebar-section-title">世界書</span>
        <span class="sidebar-section-icon" id="worldbook-icon">▼</span>
    </div>
    <div class="sidebar-section-content collapsed" id="worldbook-content">
        <div id="worldBookContent">
            <!-- 世界書列表會在這裡生成 -->
        </div>
        <button class="btn btn-secondary sidebar-add-btn" onclick="addWorldBook()">新增世界書</button>
        <button class="btn btn-secondary sidebar-add-btn" onclick="importWorldBook()">匯入世界書</button>
    </div>
</div>

<!-- 自定義欄位區塊 -->
<div class="sidebar-section">
    <div class="sidebar-section-header" onclick="toggleSection('custom')">
        <span class="sidebar-section-title">自定義欄位</span>
        <span class="sidebar-section-icon" id="custom-icon">▼</span>
    </div>
    <div class="sidebar-section-content" id="custom-content">
        <div id="customSectionContent">
            <!-- 自定義區塊列表會在這裡生成 -->
        </div>
        <button class="btn btn-secondary sidebar-add-btn" onclick="addCustomSection()">新增自定義欄位</button>
    </div>
</div>
        </div>

        <!-- 主要內容 -->
        <div class="main-content">
            <div class="content-area" id="contentArea">
                <!-- 內容會在這裡生成 -->
            </div>
        </div>
    </div>
</div>

    <script>

const translations = {
    zh: {
        // 界面文字
        appTitle: 'Chronicler Editor',
        appSubtitle: '本工具資料儲存在你的本機瀏覽器中，請定期備份以免資料丟失。',
        customColor: '自訂顏色',
        exportData: '匯出資料',
        importData: '匯入資料',
        importCharacter: '匯入角色',
        
        // 側邊欄
        characterList: '角色列表',
        worldBook: '世界書',
        addCharacter: '新增角色',
        comingSoon: '即將推出...',

        // 世界書
worldBook: '世界書',
addWorldBook: '新增世界書',
worldBookName: '世界書名稱',
worldBookDesc: '世界書描述',
addEntry: '新增條目',
entryName: '條目名稱',
keywords: '關鍵字',
secondaryKeys: '次要關鍵字',
entryContent: '條目內容',
entryComment: '條目註釋',
deleteEntry: '刪除條目',
keywordsPlaceholder: '關鍵字，用逗號分隔...',
secondaryKeysPlaceholder: '次要關鍵字，用逗號分隔...',
entryContentPlaceholder: '當觸發關鍵字時要插入的內容...',
entryCommentPlaceholder: '條目的註釋或說明...',
insertionOrder: '插入順序',
entryEnabled: '啟用條目',
selectiveMode: '選擇模式',
constantMode: '常駐模式',
deleteWorldBook: '刪除世界書',
copyWorldBook: '複製世界書',
exportWorldBook: '匯出世界書',
importWorldBook: '匯入世界書',


        // 自定義
customFields: '筆記本',
addCustomField: '新筆記',
customSection: '自定義區塊',
addField: '新增欄位',
fieldName: '欄位名稱',
fieldContent: '欄位內容',
deleteField: '刪除欄位',
customFieldPlaceholder: '輸入自定義內容...',
fieldNamePlaceholder: '欄位名稱...',
exportTXT: '匯出 TXT',
exportMarkdown: '匯出 Markdown',
copySection: '複製區塊組',
deleteSection: '刪除區塊',
sectionName: '區塊名稱',
        
        // 主要功能
        singleView: '單一檢視',
        compareView: '對比檢視',
        addVersion: '新增版本',
        characterName: '角色名稱',
        deleteCharacter: '刪除角色',
        copyCharacter: '複製角色組',
        unsavedChanges: '有尚未儲存的變更',
        saveChanged: '💾 已變更儲存',
        
        // 表單欄位
        creator: '創作者',
        charVersion: '角色版本',
        creatorNotes: '創作者備註',
        tags: '嵌入標籤',
        description: '角色描述',
        personality: '個性摘要',
        scenario: '場景設想',
        dialogue: '對話範例',
        firstMessage: '初始訊息',
        
        // 佔位符文字
        creatorPlaceholder: '創作者名稱（可選）...',
        versionPlaceholder: '版本號碼或描述（可選）...',
        notesPlaceholder: '創作備註或說明（可選）...',
        tagsPlaceholder: '標籤，用逗號分隔（可選）...',
        descPlaceholder: '描述角色的外貌、背景、設定等...',
        personalityPlaceholder: '角色的性格特徵、行為模式、說話方式等...',
        scenarioPlaceholder: '角色所處的情境、環境、當前狀況等...',
        dialoguePlaceholder: '{{user}}: 你好！\n{{char}}: 你好呀！很高興見到你～',
        firstMsgPlaceholder: '角色的第一句話或開場白...',
        
        // 按鈕
        save: '💾 儲存',
        copy: '📋 複製版本',
        delete: '刪除',
        selectImage: '選擇圖片',
        exportJSON: '匯出 JSON',
        exportPNG: '匯出 PNG',
        exportAll: '匯出所有版本',
        
        // 統計
        chars: '字',
        tokens: 'tokens',
        total: '總計',
        
        // 對話框
        customTheme: '自訂主題顏色',
        primaryColor: '主要顏色',
        secondaryColor: '次要顏色',
        accentColor: '強調顏色',
        bgColor: '背景顏色',
        surfaceColor: '按鈕與文字框顏色',
        textColor: '文字顏色',
        textMutedColor: '次要文字顏色',
        restoreDefault: '恢復預設',
        eyeCareMode: '護眼配色',
        borderColor: '邊框顏色',
        exportColorTheme: '匯出配色',
importColorTheme: '匯入配色',
        cancel: '取消',
        apply: '套用',
        headerBgColor: '頂部欄背景',
        sidebarBgColor: '側邊欄背景', 
        mainContentBgColor: '主要內容區背景',
        contentBgColor: '內容面板背景',
        
        // 提示訊息
        saved: '✓ 已儲存到瀏覽器',
        importSuccess: '角色匯入成功！',
        deleteConfirm: '確定要刪除角色「$1」嗎？\n\n⚠️ 刪除後無法復原，請確保已備份重要資料！',
        deleteVersionConfirm: '確定要刪除版本「$1」嗎？\n\n⚠️ 刪除後無法復原，請確保已備份重要資料！',
        needTwoVersions: '需要至少2個版本才能進行對比',
        keepOneCharacter: '至少需要保留一個角色',
        keepOneVersion: '至少需要保留一個版本',
        maxTwoVersions: '最多只能選擇2個版本',
        
        // 匯出相關
        selectVersion: '選擇要匯出的版本 (1-$1):',
        exportAllTitle: '匯出所有版本',
        exportAllDesc: '角色「$1」共有 $2 個版本，請選擇匯出格式：',
        jsonFormat: 'JSON 格式',
        jsonDesc: '純文字格式，適合匯入其他工具或備份',
        pngFormat: 'PNG 圖片格式',
        pngDesc: '包含圖片的角色卡，適合分享或在 SillyTavern 中使用',
        startExport: '開始匯出',
        exporting: '正在匯出 $1 個版本...',
        preparing: '準備中...',
        exportComplete: '✓ 已成功匯出 $1 個$2檔案！',
        noImage: '無圖片',
        versionStats: '$1字 / $2tokens',
        exportCharacter: '匯出角色卡',
        selectCharacter: '請選擇一個角色',

        // 對比檢視：
selectVersionsToCompare: '選擇要對比的版本',
selectTwoVersions: '選擇2個版本進行對比',
currentSelected: '目前已選',
startCompare: '開始對比',
needOneMore: '還需選擇1個版本'

    },
    
    en: {
        // Interface text
        appTitle: 'Chronicler Editor',
        appSubtitle: 'Data is stored locally in your browser. Please backup regularly to prevent data loss.',
        customColor: 'Custom Colors',
        exportData: 'Export Data',
        importData: 'Import Data',
        importCharacter: 'Import Character',
        
        // Sidebar
        characterList: 'Characters',
        worldBook: 'World Book',
        addCharacter: 'Add Character',
        comingSoon: 'Coming Soon...',
        
        // Main functions
        singleView: 'Single View',
        compareView: 'Compare View',
        addVersion: 'Add Version',
        characterName: 'Character Name',
        deleteCharacter: 'Delete Character',
        copyCharacter: 'Duplicate Character',
        unsavedChanges: 'Unsaved Changes',
        saveChanged: '💾 Changes Saved',
        
        // Form fields
        creator: 'Creator',
        charVersion: 'Character Version',
        creatorNotes: 'Creator Notes',
        tags: 'Tags',
        description: 'Description',
        personality: 'Personality',
        scenario: 'Scenario',
        dialogue: 'Example Dialogue',
        firstMessage: 'First Message',
        
        // Placeholders
        creatorPlaceholder: 'Creator name (optional)...',
        versionPlaceholder: 'Version number or description (optional)...',
        notesPlaceholder: 'Creator notes or description (optional)...',
        tagsPlaceholder: 'Tags, separated by commas (optional)...',
        descPlaceholder: 'Describe character appearance, background, settings...',
        personalityPlaceholder: 'Character traits, behavior patterns, speech style...',
        scenarioPlaceholder: 'Character situation, environment, current circumstances...',
        dialoguePlaceholder: '{{user}}: Hello!\\n{{char}}: Hi there! Nice to meet you~',
        firstMsgPlaceholder: 'Character\'s first message or greeting...',
        
        // Buttons
        save: '💾 Save',
        copy: '📋 Duplicate Version',
        delete: 'Delete',
        selectImage: 'Select Image',
        exportJSON: 'Export JSON',
        exportPNG: 'Export PNG',
        exportAll: 'Export All Versions',
        
        // Statistics
        chars: 'chars',
        tokens: 'tokens',
        total: 'Total',

       // Lorebook
worldBook: 'Lorebooks',
addWorldBook: 'Add Lorebook',
worldBookName: 'Lorebook Name',
worldBookDesc: 'Lorebook Description', 
addEntry: 'Add Entry',
entryName: 'Entry Name',
keywords: 'Keywords',
secondaryKeys: 'Secondary Keywords',
entryContent: 'Entry Content',
entryComment: 'Entry Comment',
deleteEntry: 'Delete Entry',
keywordsPlaceholder: 'Keywords, separated by commas...',
secondaryKeysPlaceholder: 'Secondary keywords, separated by commas...',
entryContentPlaceholder: 'Content to insert when keywords are triggered...',
entryCommentPlaceholder: 'Comment or description for this entry...',
insertionOrder: 'Insertion Order',
entryEnabled: 'Enable Entry',
selectiveMode: 'Selective Mode',
constantMode: 'Constant Mode',
deleteWorldBook: 'Delete Lorebook',
copyWorldBook: 'Duplicate Lorebook',
exportWorldBook: 'Export Lorebook',
importWorldBook: 'Import Lorebook',

        // 自定義
customFields: 'Notebook',
addCustomField: 'New Notebook',
customSection: 'Custom Section',
addField: 'Add Field',
fieldName: 'Field Name',
fieldContent: 'Field Content',
deleteField: 'Delete Field',
customFieldPlaceholder: 'Enter custom content...',
fieldNamePlaceholder: 'Field name...',
exportTXT: 'Export TXT',
exportMarkdown: 'Export Markdown',
copySection: 'Duplicate Section',
deleteSection: 'Delete Section',
sectionName: 'Section Name',
        
        // Dialogs
        customTheme: 'Custom Theme Colors',
        primaryColor: 'Primary Color',
        secondaryColor: 'Secondary Color',
        accentColor: 'Accent Color',
        bgColor: 'Background Color',
        surfaceColor: 'Button and Text Box Color',
        textColor: 'Text Color',
        textMutedColor: 'Muted Text Color',
        restoreDefault: 'Restore Default',
        eyeCareMode: 'Eye Care Colors',
        exportColorTheme: 'Export Colors',
        importColorTheme: 'Import Colors',
        borderColor: 'Border Color',
        cancel: 'Cancel',
        apply: 'Apply',
        headerBgColor: 'Header Background',
        sidebarBgColor: 'Sidebar Background',
        mainContentBgColor: 'Main Content Background', 
        contentBgColor: 'Content Panel Background',
        
        // Messages
        saved: '✓ Saved to browser',
        importSuccess: 'Character imported successfully!',
        deleteConfirm: 'Are you sure you want to delete character "$1"?\\n\\n⚠️ This cannot be undone. Please ensure you have backed up important data!',
        deleteVersionConfirm: 'Are you sure you want to delete version "$1"?\\n\\n⚠️ This cannot be undone. Please ensure you have backed up important data!',
        needTwoVersions: 'Need at least 2 versions to compare',
        keepOneCharacter: 'Must keep at least one character',
        keepOneVersion: 'Must keep at least one version',
        maxTwoVersions: 'Can only select up to 2 versions',
        
        // Compare View
        selectVersionsToCompare: 'Select Versions to Compare',
selectTwoVersions: 'Select 2 versions to compare',
currentSelected: 'Currently selected',
startCompare: 'Start Compare',
needOneMore: 'Need 1 more version',

        // Export related
        selectVersion: 'Select version to export (1-$1):',
        exportAllTitle: 'Export All Versions',
        exportAllDesc: 'Character "$1" has $2 versions. Please select export format:',
        jsonFormat: 'JSON Format',
        jsonDesc: 'Plain text format, suitable for importing to other tools or backup',
        pngFormat: 'PNG Image Format',
        pngDesc: 'Character card with images, suitable for sharing or use in SillyTavern',
        startExport: 'Start Export',
        exporting: 'Exporting $1 versions...',
        preparing: 'Preparing...',
        exportComplete: '✓ Successfully exported $1 $2 files!',
        noImage: 'No Image',
        versionStats: '$1chars / $2tokens',
        exportCharacter: 'Export Character Card',
        selectCharacter: 'Please select a character'
    }
};

let currentLang = localStorage.getItem('characterCreatorLang') || 'zh';

// 翻譯函數
function t(key, ...args) {
    let text = translations[currentLang][key] || key;
    // 處理參數替換 $1, $2 等
    args.forEach((arg, index) => {
        text = text.replace(`$${index + 1}`, arg);
    });
    return text;
}

function switchLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('characterCreatorLang', lang);
    renderAll(); // 這裡會觸發 updateSaveButtonStates()
}
        let characters = [];
        let currentCharacterId = null;
        let currentVersionId = null;
        let viewMode = 'single'; // 'single' 或 'compare'
        let sidebarCollapsed = false;
        let compareVersions = []; // 用於對比檢視的版本選擇
        let hasUnsavedChanges = false;
        let lastSavedData = null;
        let customSections = []; // 新增自定義區塊陣列
        let worldBooks = []; // 新增世界書陣列
        let currentMode = 'character'; // 新增模式狀態：'character'、'custom' 或 'worldbook'
        let currentWorldBookId = null; // 當前選中的世界書ID
        let currentWorldBookVersionId = null; // 當前選中的世界書版本ID
        let currentCustomSectionId = null; // 當前選中的自定義區塊ID
        let currentCustomVersionId = null; // 當前選中的自定義版本ID

        // 主題配色 - 英倫風低彩度配色
        const themes = {
            classic: { primary: '#4E5E79', secondary: '#1a202c', accent: '#8b7355', bg: '#f7f5f3' },
            warm: { primary: '#744210', secondary: '#553c9a', accent: '#d69e2e', bg: '#fefcf0' },
            cool: { primary: '#2c5282', secondary: '#2a4365', accent: '#3182ce', bg: '#f0f8ff' },
            forest: { primary: '#22543d', secondary: '#1a202c', accent: '#38a169', bg: '#f0fff4' },
            vintage: { primary: '#553c9a', secondary: '#44337a', accent: '#9f7aea', bg: '#faf5ff' },
            minimal: { primary: '#4a5568', secondary: '#2d3748', accent: '#718096', bg: '#f8f9fa' }
        };

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
function toggleSection(sectionName) {
    const content = document.getElementById(`${sectionName}-content`);
    const icon = document.getElementById(`${sectionName}-icon`);
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        icon.textContent = '▼';
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.classList.add('collapsed');
        icon.textContent = '▶';
        icon.style.transform = 'rotate(-90deg)';
    }
}

function autoResizeTextarea(textarea) {
    // 重置高度以獲得準確的 scrollHeight
    textarea.style.height = 'auto';
    
    // 計算所需高度，最小120px
    const minHeight = 120;
    const maxHeight = 500; // 設定最大高度避免過長
    let newHeight = Math.max(minHeight, textarea.scrollHeight);
    newHeight = Math.min(maxHeight, newHeight);
    
    // 設定新高度
    textarea.style.height = newHeight + 'px';
}

function initAutoResize() {
    // 為所有 textarea 添加自動調整功能
    const textareas = document.querySelectorAll('textarea.field-input');
    textareas.forEach(textarea => {
        // 添加 auto-resize class
        textarea.classList.add('auto-resize');
        
        // 初始調整大小
        autoResizeTextarea(textarea);
        
        // 監聽輸入事件
        textarea.addEventListener('input', function() {
            autoResizeTextarea(this);
        });
        
        // 監聽貼上事件
        textarea.addEventListener('paste', function() {
            // 稍微延遲以確保貼上的內容已經插入
            setTimeout(() => {
                autoResizeTextarea(this);
            }, 10);
        });
    });
}

        function countTokens(text) {
            if (!text) return 0;
            
            // 更精準的token計算，模擬GPT-4的BPE tokenizer
            // 預處理：移除多餘空白
            text = text.trim().replace(/\s+/g, ' ');
            
            let tokenCount = 0;
            let i = 0;
            
            while (i < text.length) {
                const char = text[i];
                
                // 中文字符（包括日文、韓文）- 通常是1 token
                if (/[\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(char)) {
                    tokenCount += 1;
                    i++;
                }
                // 英文單詞處理
                else if (/[a-zA-Z]/.test(char)) {
                    let wordStart = i;
                    while (i < text.length && /[a-zA-Z]/.test(text[i])) {
                        i++;
                    }
                    const word = text.slice(wordStart, i);
                    
                    // 英文單詞的token估算
                    if (word.length <= 3) {
                        tokenCount += 1;
                    } else if (word.length <= 6) {
                        tokenCount += 1.5;
                    } else if (word.length <= 10) {
                        tokenCount += 2;
                    } else {
                        tokenCount += Math.ceil(word.length / 4);
                    }
                }
                // 數字處理
                else if (/[0-9]/.test(char)) {
                    let numStart = i;
                    while (i < text.length && /[0-9.,]/.test(text[i])) {
                        i++;
                    }
                    const num = text.slice(numStart, i);
                    // 數字通常每2-4位是1個token
                    tokenCount += Math.ceil(num.replace(/[.,]/g, '').length / 3);
                }
                // 標點符號和特殊字符
                else if (/[^\s]/.test(char)) {
                    // 常見標點符號組合
                    if (i < text.length - 1) {
                        const twoChar = text.slice(i, i + 2);
                        if (['--', '...', '!!', '??', '::'].includes(twoChar)) {
                            tokenCount += 1;
                            i += 2;
                            continue;
                        }
                    }
                    
                    // 單個標點符號
                    if (/[.!?,:;()[\]{}"'`~@#$%^&*+=<>|\\/-]/.test(char)) {
                        tokenCount += 0.5;
                    } else {
                        tokenCount += 1;
                    }
                    i++;
                }
                // 空白字符
                else {
                    // 空格通常不單獨計算token，但會影響分詞
                    i++;
                }
            }
            
            // 加上一些特殊格式的額外token（如{{user}}, {{char}}等）
            const specialTokens = text.match(/\{\{(user|char|random|pick|roll)\}\}/g);
            if (specialTokens) {
                tokenCount += specialTokens.length * 0.5;
            }
            
            return Math.ceil(tokenCount);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebarCollapsed = !sidebarCollapsed;
            
            if (window.innerWidth <= 768) {
                // 手機版：使用 show/hide 類別
                sidebar.classList.toggle('show');
            } else {
                // 桌面版：使用 collapsed 類別來改變寬度
                sidebar.classList.toggle('collapsed', sidebarCollapsed);
            }
        }

        function changeTheme(themeName) {
            // 移除主題切換功能，只保留自訂顏色
        }

        function showColorPicker() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${t('customTheme')}</h3>
                <button class="close-modal" onclick="this.closest('.modal').remove()">×</button>
            </div>
            
            <div class="color-input-group">
                <label>${t('primaryColor')}</label>
                <input type="color" class="color-input" id="primary-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim()}">
            </div>
            
            <div class="color-input-group">
                <label>${t('secondaryColor')}</label>
                <input type="color" class="color-input" id="secondary-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim()}">
            </div>
            
            <div class="color-input-group">
                <label>${t('accentColor')}</label>
                <input type="color" class="color-input" id="accent-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('bgColor')}</label>
                <input type="color" class="color-input" id="bg-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim()}">
            </div>
            
            <div class="color-input-group">
                <label>${t('surfaceColor')}</label>
                <input type="color" class="color-input" id="surface-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--surface-color').trim()}">
            </div>
            
            <div class="color-input-group">
                <label>${t('textColor')}</label>
                <input type="color" class="color-input" id="text-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('textMutedColor')}</label>
                <input type="color" class="color-input" id="text-muted" value="${getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim()}">
            </div>
        <div class="color-input-group">
    <label>${t('borderColor')}</label>
    <input type="color" class="color-input" id="border-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()}">
</div>

            <div class="color-input-group">
                <label>${t('headerBgColor')}</label>
                <input type="color" class="color-input" id="header-bg" value="${getComputedStyle(document.documentElement).getPropertyValue('--header-bg').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('sidebarBgColor')}</label>
                <input type="color" class="color-input" id="sidebar-bg" value="${getComputedStyle(document.documentElement).getPropertyValue('--sidebar-bg').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('mainContentBgColor')}</label>
                <input type="color" class="color-input" id="main-content-bg" value="${getComputedStyle(document.documentElement).getPropertyValue('--main-content-bg').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('contentBgColor')}</label>
                <input type="color" class="color-input" id="content-bg" value="${getComputedStyle(document.documentElement).getPropertyValue('--content-bg').trim()}">
            </div>

            <div class="color-preview">
                <div class="color-preview-item" id="preview-primary">${currentLang === 'zh' ? '主要' : 'Primary'}</div>
                <div class="color-preview-item" id="preview-secondary">${currentLang === 'zh' ? '次要' : 'Secondary'}</div>
                <div class="color-preview-item" id="preview-accent">${currentLang === 'zh' ? '強調' : 'Accent'}</div>
                <div class="color-preview-item" id="preview-surface" style="color: var(--text-color);">${currentLang === 'zh' ? '介面' : 'Surface'}</div>
                <div class="color-preview-item" id="preview-text" style="background: var(--surface-color); color: white; border: 1px solid var(--border-color);">${currentLang === 'zh' ? '文字' : 'Text'}</div>
                <div class="color-preview-item" id="preview-text-muted" style="background: var(--surface-color); color: white; border: 1px solid var(--border-color);">${currentLang === 'zh' ? '次文字' : 'Muted'}</div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="applyDefaultColors()">${t('restoreDefault')}</button>
                    <button class="btn btn-secondary" onclick="applyEyeCareColors()">${t('eyeCareMode')}</button>
                    <button class="btn btn-secondary" onclick="exportColorThemeFromModal()">${t('exportColorTheme')}</button>
                    <button class="btn btn-secondary" onclick="importColorThemeFromModal()">${t('importColorTheme')}</button>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">${t('cancel')}</button>
                    <button class="btn btn-primary" onclick="applyCustomColors()">${t('apply')}</button>
                </div>
            </div>

            <input type="file" id="importColorFileModal" accept=".json" style="display: none;" onchange="handleColorImportFromModal(event)">
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 獲取所有顏色輸入
    const primaryInput = document.getElementById('primary-color');
    const secondaryInput = document.getElementById('secondary-color');
    const accentInput = document.getElementById('accent-color');
    const bgInput = document.getElementById('bg-color');
    const surfaceInput = document.getElementById('surface-color');
    const textInput = document.getElementById('text-color');
    const textMutedInput = document.getElementById('text-muted');
    const headerBgInput = document.getElementById('header-bg');
    const sidebarBgInput = document.getElementById('sidebar-bg');
    const mainContentBgInput = document.getElementById('main-content-bg');
    const contentBgInput = document.getElementById('content-bg');

    function updatePreview() {
        document.getElementById('preview-primary').style.backgroundColor = primaryInput.value;
        document.getElementById('preview-secondary').style.backgroundColor = secondaryInput.value;
        document.getElementById('preview-accent').style.backgroundColor = accentInput.value;
        document.getElementById('preview-surface').style.backgroundColor = surfaceInput.value;
        document.getElementById('preview-text').style.color = textInput.value;
        document.getElementById('preview-text-muted').style.color = textMutedInput.value;
    }
    
    // 為所有輸入添加事件監聽器
    [primaryInput, secondaryInput, accentInput, bgInput, surfaceInput, textInput, textMutedInput,
     headerBgInput, sidebarBgInput, mainContentBgInput, contentBgInput].forEach(input => {
        input.addEventListener('input', updatePreview);
    });
    
    updatePreview(); // 初始化預覽
    
    // 點擊外部關閉
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

        function applyCustomColors() {
    const primary = document.getElementById('primary-color').value;
    const secondary = document.getElementById('secondary-color').value;
    const accent = document.getElementById('accent-color').value;
    const bg = document.getElementById('bg-color').value;
    const surface = document.getElementById('surface-color').value;
    const textColor = document.getElementById('text-color').value;
    const textMuted = document.getElementById('text-muted').value;
const borderColor = document.getElementById('border-color').value;
// 獲取界面背景色
const headerBg = document.getElementById('header-bg').value;
    const sidebarBg = document.getElementById('sidebar-bg').value;
    const mainContentBg = document.getElementById('main-content-bg').value;
    const contentBg = document.getElementById('content-bg').value;
    
    const root = document.documentElement;
    root.style.setProperty('--primary-color', primary);
    root.style.setProperty('--secondary-color', secondary);
    root.style.setProperty('--accent-color', accent);
    root.style.setProperty('--bg-color', bg);
    root.style.setProperty('--surface-color', surface);
    root.style.setProperty('--text-color', textColor);
    root.style.setProperty('--text-muted', textMuted);
    root.style.setProperty('--border-color', borderColor);
    
    // 設定界面背景色
    root.style.setProperty('--header-bg', headerBg);
    root.style.setProperty('--sidebar-bg', sidebarBg);
    root.style.setProperty('--main-content-bg', mainContentBg);
    root.style.setProperty('--content-bg', contentBg);

    // 儲存所有自訂顏色（包含邊框顏色）
localStorage.setItem('characterCreatorCustomColors', JSON.stringify({
    primary, secondary, accent, bg, surface, textColor, textMuted, borderColor,
    headerBg, sidebarBg, mainContentBg, contentBg
}));
    
    document.querySelector('.modal').remove();
}


        function adjustBrightness(hex, factor) {
    // 移除 # 符號
    hex = hex.replace('#', '');
    
    // 轉換為 RGB
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    
    // 調整亮度
    const newR = Math.max(0, Math.min(255, Math.round(r + (255 - r) * factor)));
    const newG = Math.max(0, Math.min(255, Math.round(g + (255 - g) * factor)));
    const newB = Math.max(0, Math.min(255, Math.round(b + (255 - b) * factor)));
    
    // 轉回 hex
    const toHex = (n) => n.toString(16).padStart(2, '0');
    return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
}

        function applyDefaultColors() {
    const root = document.documentElement;
    root.style.setProperty('--primary-color', 'var(--default-primary)');
    root.style.setProperty('--secondary-color', 'var(--default-secondary)');
    root.style.setProperty('--accent-color', 'var(--default-accent)');
    root.style.setProperty('--bg-color', 'var(--default-bg)');
    root.style.setProperty('--surface-color', 'var(--default-surface)');
    root.style.setProperty('--text-color', 'var(--default-text)');
    root.style.setProperty('--text-muted', 'var(--default-text-muted)');
    root.style.setProperty('--border-color', '#e2e8f0');
    
    // 三區域背景色
    root.style.setProperty('--header-bg', 'var(--default-header-bg)');
    root.style.setProperty('--sidebar-bg', 'var(--default-sidebar-bg)');
    root.style.setProperty('--main-content-bg', 'var(--default-main-content-bg)');
    root.style.setProperty('--content-bg', 'var(--default-content-bg)');
    
    // 更新對話框中的所有顏色選擇器
    document.getElementById('primary-color').value = '#4E5E79';
    document.getElementById('secondary-color').value = '#1a202c';
    document.getElementById('accent-color').value = '#8b7355';
    document.getElementById('bg-color').value = '#f7f5f3';
    document.getElementById('surface-color').value = '#ffffff';
    document.getElementById('text-color').value = '#2d3748';
    document.getElementById('text-muted').value = '#718096';
    // 更新界面背景色
    document.getElementById('border-color').value = '#e2e8f0';
    document.getElementById('header-bg').value = '#f1f5f9';
    document.getElementById('sidebar-bg').value = '#f8fafc';
    document.getElementById('main-content-bg').value = '#fafbfc';
    document.getElementById('content-bg').value = '#ffffff';
    
    updatePreview();
    
    // 移除儲存的自訂顏色
    localStorage.removeItem('characterCreatorCustomColors');
    
    document.querySelector('.modal').remove();
}

function applyEyeCareColors() {
    const root = document.documentElement;
    
    // 使用 CSS 變數中定義的護眼配色
    root.style.setProperty('--primary-color', 'var(--eyecare-primary)');
    root.style.setProperty('--secondary-color', 'var(--eyecare-secondary)');
    root.style.setProperty('--accent-color', 'var(--eyecare-accent)');
    root.style.setProperty('--bg-color', 'var(--eyecare-bg)');
    root.style.setProperty('--surface-color', 'var(--eyecare-surface)');
    root.style.setProperty('--text-color', 'var(--eyecare-text)');
    root.style.setProperty('--text-muted', 'var(--eyecare-text-muted)');
    root.style.setProperty('--border-color', 'var(--eyecare-border)');
    
    // 護眼三區域背景色
    root.style.setProperty('--header-bg', 'var(--eyecare-header-bg)');
    root.style.setProperty('--sidebar-bg', 'var(--eyecare-sidebar-bg)');
    root.style.setProperty('--main-content-bg', 'var(--eyecare-main-content-bg)');
    root.style.setProperty('--content-bg', 'var(--eyecare-content-bg)');
    
    // 儲存護眼配色（使用實際顏色值）
    localStorage.setItem('characterCreatorCustomColors', JSON.stringify({
        primary: '#404040',             // 主色：淡灰
        secondary: '#6e6e6e',           // 次色：中灰
        accent: '#4b768b',              // 強調色：白
        bg: '#7d7d7d',                  // 全局背景
        surface: '#2a2a2a',             // 面板、卡片
        textColor: '#e0e0e0',           // 主文字
        textMuted: '#aaaaaa',           // 次文字
        borderColor: '#525252',         // 邊框
        headerBg: '#000000',            // 頂部欄背景
        sidebarBg: '#1f1f1f',           // 側邊欄背景
        mainContentBg: '#1a1a1a',       // 主內容背景
        contentBg: '#292929'            // 內容區背景
    }));
    
    document.querySelector('.modal').remove();
}

function exportColorThemeFromModal() {
    // 從對話框中的輸入框讀取當前設定的顏色
    const currentColors = {
        primary: document.getElementById('primary-color').value,
        secondary: document.getElementById('secondary-color').value,
        accent: document.getElementById('accent-color').value,
        bg: document.getElementById('bg-color').value,
        surface: document.getElementById('surface-color').value,
        textColor: document.getElementById('text-color').value,
        textMuted: document.getElementById('text-muted').value,
        headerBg: document.getElementById('header-bg').value,
        sidebarBg: document.getElementById('sidebar-bg').value,
        mainContentBg: document.getElementById('main-content-bg').value,
        contentBg: document.getElementById('content-bg').value,
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()
    };

    const colorTheme = {
        name: prompt('請輸入配色主題名稱：') || '自訂配色',
        colors: currentColors,
        exportDate: new Date().toISOString(),
        version: '1.0.0'
    };

    const blob = new Blob([JSON.stringify(colorTheme, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${colorTheme.name}_配色主題.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importColorThemeFromModal() {
    document.getElementById('importColorFileModal').click();
}

function handleColorImportFromModal(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const themeData = JSON.parse(e.target.result);
            
            if (themeData.colors) {
                const confirmImport = confirm(`確定要匯入配色主題「${themeData.name || '未命名'}」嗎？`);
                
                if (confirmImport) {
                    // 更新對話框中的顏色選擇器
const colors = themeData.colors;
if (colors.primary) document.getElementById('primary-color').value = colors.primary;
if (colors.secondary) document.getElementById('secondary-color').value = colors.secondary;
if (colors.accent) document.getElementById('accent-color').value = colors.accent;
if (colors.bg) document.getElementById('bg-color').value = colors.bg;
if (colors.surface) document.getElementById('surface-color').value = colors.surface;
if (colors.textColor) document.getElementById('text-color').value = colors.textColor;
if (colors.textMuted) document.getElementById('text-muted').value = colors.textMuted;
if (colors.borderColor) document.getElementById('border-color').value = colors.borderColor;
if (colors.headerBg) document.getElementById('header-bg').value = colors.headerBg;
if (colors.sidebarBg) document.getElementById('sidebar-bg').value = colors.sidebarBg;
if (colors.mainContentBg) document.getElementById('main-content-bg').value = colors.mainContentBg;
if (colors.contentBg) document.getElementById('content-bg').value = colors.contentBg;
                
                    
                    alert(`配色主題「${themeData.name || '未命名'}」匯入成功！請點擊「套用」來應用設定。`);
                }
            } else {
                alert('檔案格式不正確，請選擇有效的配色主題檔案');
            }
        } catch (error) {
            alert('檔案讀取失敗：' + error.message);
        }
    };
    reader.readAsText(file);
    
    event.target.value = '';
}

function applyImportedColors(colors) {
    const root = document.documentElement;
    
    if (colors.primary) root.style.setProperty('--primary-color', colors.primary);
    if (colors.secondary) root.style.setProperty('--secondary-color', colors.secondary);
    if (colors.accent) root.style.setProperty('--accent-color', colors.accent);
    if (colors.bg) root.style.setProperty('--bg-color', colors.bg);
    if (colors.surface) root.style.setProperty('--surface-color', colors.surface);
    if (colors.textColor) root.style.setProperty('--text-color', colors.textColor);
    if (colors.textMuted) root.style.setProperty('--text-muted', colors.textMuted);
    if (colors.borderColor) root.style.setProperty('--border-color', colors.borderColor);
    if (colors.headerBg) root.style.setProperty('--header-bg', colors.headerBg);
    if (colors.sidebarBg) root.style.setProperty('--sidebar-bg', colors.sidebarBg);
    if (colors.mainContentBg) root.style.setProperty('--main-content-bg', colors.mainContentBg);
    if (colors.contentBg) root.style.setProperty('--content-bg', colors.contentBg);
    
    // 儲存匯入的配色
    localStorage.setItem('characterCreatorCustomColors', JSON.stringify(colors));
}

        function showSaveNotification() {
    // 創建儲存成功提示
        const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
        z-index: 9999;
        box-shadow: var(--shadow-medium);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    notification.textContent = t('saved');
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 2000);
}

// 變更追蹤函數：
function markAsChanged() {
    hasUnsavedChanges = true;
    updateSaveButtonStates();
}

function markAsSaved() {
    hasUnsavedChanges = false;
    lastSavedData = JSON.stringify(characters);
    updateSaveButtonStates();
}

function updateSaveButtonStates() {
    // 更新所有儲存按鈕的外觀
setTimeout(() => {
    const saveButtons = document.querySelectorAll('button[onclick*="saveData()"]');
    saveButtons.forEach(btn => {
        if (hasUnsavedChanges) {
            btn.classList.add('btn-warning');
            btn.classList.remove('btn-secondary');
            // 更新按鈕文字顯示有未儲存變更
            if (btn.textContent.includes('💾')) {
                btn.innerHTML = '💾 ' + (currentLang === 'zh' ? '有尚未儲存的變更' : 'Unsaved Changes');
            }
        } else {
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-secondary');
            // 恢復正常文字
            if (btn.textContent.includes('💾')) {
                btn.innerHTML = t('save');
            }
        }
    });
      }, 50);
}


        function exportAllData() {
    const exportData = {
        characters: characters,
        customSections: customSections, // 新增
        exportDate: new Date().toISOString(),
        version: '1.0.0'
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chronicler_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

        function importAllData() {
            document.getElementById('importAllFile').click();
        }

        function handleImportAll(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.characters && Array.isArray(data.characters)) {
                const totalItems = data.characters.length + (data.customSections ? data.customSections.length : 0);
                const confirmImport = confirm(`確定要匯入 ${data.characters.length} 個角色${data.customSections ? ` 和 ${data.customSections.length} 個自定義區塊` : ''}嗎？這將覆蓋現有的所有資料！`);
                
                if (confirmImport) {
                    characters = data.characters;
                    customSections = data.customSections || []; // 新增
                    
                    currentCharacterId = characters[0]?.id || null;
                    currentVersionId = characters[0]?.versions[0]?.id || null;
                    currentCustomSectionId = customSections[0]?.id || null;
                    currentCustomVersionId = customSections[0]?.versions[0]?.id || null;
                    currentMode = 'character';
                    compareVersions = [];
                    
                    renderAll();
                    saveData();
                    alert('資料匯入成功！');
                }
            } else {
                alert('檔案格式不正確，請選擇有效的備份檔案');
            }
        } catch (error) {
            alert('檔案讀取失敗：' + error.message);
        }
    };
    reader.readAsText(file);
}

        function loadData() {
    try {
        const saved = localStorage.getItem('characterCreatorData');
        if (saved) {
            characters = JSON.parse(saved);
            if (characters.length > 0) {
                currentCharacterId = characters[0].id;
                currentVersionId = characters[0].versions[0].id;
            }
        }

        const savedWorldBooks = localStorage.getItem('characterCreatorWorldBooks');
if (savedWorldBooks) {
    worldBooks = JSON.parse(savedWorldBooks);
    if (worldBooks.length > 0 && !currentWorldBookId) {
        currentWorldBookId = worldBooks[0].id;
        currentWorldBookVersionId = worldBooks[0].versions[0].id;
    }
}
        
        // 新增：載入自定義區塊
        const savedCustom = localStorage.getItem('characterCreatorCustomData');
        if (savedCustom) {
            customSections = JSON.parse(savedCustom);
            if (customSections.length > 0 && !currentCustomSectionId) {
                currentCustomSectionId = customSections[0].id;
                currentCustomVersionId = customSections[0].versions[0].id;
            }
        }
        
        markAsSaved();
    } catch (error) {
        console.error('載入資料失敗：', error);
    }
}

        function addCharacter() {
    const character = {
        id: generateId(),
        name: `Character ${characters.length + 1}`,
        versions: [{
            id: generateId(),
            name: 'Version 1',
            avatar: '',
            description: '',
            personality: '',
            scenario: '',
            dialogue: '',
            firstMessage: '',
            creator: '',
            charVersion: '',
            creatorNotes: '',
            tags: ''
        }]
    };
    characters.push(character);
    currentCharacterId = character.id;
    currentVersionId = character.versions[0].id;
    renderAll();
    markAsChanged(); // 標記有變更
}

        function removeCharacter(characterId) {
    if (characters.length <= 1) {
        alert(t('keepOneCharacter'));
        return;
    }
    
    const character = characters.find(c => c.id === characterId);
    const confirmDelete = confirm(t('deleteConfirm', character?.name || '未命名角色'));
    
    if (confirmDelete) {
        characters = characters.filter(c => c.id !== characterId);
        if (currentCharacterId === characterId) {
            currentCharacterId = characters[0]?.id || null;
            currentVersionId = characters[0]?.versions[0]?.id || null;
        }
        renderAll();
        saveData(); 
    }
}

        function addVersion(characterId) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        const newVersion = {
            id: generateId(),
            name: `Version ${character.versions.length + 1}`,
            avatar: '',
            description: '',
            personality: '',
            scenario: '',
            dialogue: '',
            firstMessage: '',
            creator: '',
            charVersion: '',
            creatorNotes: '',
            tags: ''
        };
        character.versions.push(newVersion);
        currentVersionId = newVersion.id;
        renderAll();
        markAsChanged(); // 標記有變更
    }
}

        function removeVersion(characterId, versionId) {
    const character = characters.find(c => c.id === characterId);
    if (character && character.versions.length > 1) {
        const version = character.versions.find(v => v.id === versionId);
        const confirmDelete = confirm(t('deleteVersionConfirm', version?.name || '未命名版本'));
        
        if (confirmDelete) {
            character.versions = character.versions.filter(v => v.id !== versionId);
            if (currentVersionId === versionId) {
                currentVersionId = character.versions[0].id;
            }
            renderAll();
            saveData(); 
        }
    } else {
        alert(t('keepOneVersion'));
    }
}

function selectSidebarItem(type, id, subId = null) {
    // 清理之前的狀態
    viewMode = 'single';
    compareVersions = [];
    
    if (type === 'character') {
        currentMode = 'character';
        currentCharacterId = id;
        const character = characters.find(c => c.id === id);
        if (character) {
            currentVersionId = subId || character.versions[0].id;
        }
    } else if (type === 'custom') {
        currentMode = 'custom';
        currentCustomSectionId = id;
        const section = customSections.find(s => s.id === id);
        if (section) {
            currentCustomVersionId = subId || section.versions[0].id;
        }
    } else if (type === 'worldbook') {
    currentMode = 'worldbook';
    currentWorldBookId = id;
    const worldBook = worldBooks.find(wb => wb.id === id);
    if (worldBook) {
        currentWorldBookVersionId = subId || worldBook.versions[0].id;
    }
}
    
    renderAll();
}

        function selectCharacter(characterId) {
    currentMode = 'character'; // 確保這行存在
    currentCharacterId = characterId;
    const character = characters.find(c => c.id === characterId);
    if (character) {
        currentVersionId = character.versions[0].id;
    }
    viewMode = 'single'; // 新增這行，重置檢視模式
    compareVersions = []; // 新增這行，清空比較選擇
    renderAll();
}

        function selectVersion(characterId, versionId) {
    currentCharacterId = characterId;
    currentVersionId = versionId;
    viewMode = 'single';
    
    // 確保對應角色的版本列表是展開的
    const versionsList = document.getElementById(`versions-${characterId}`);
    const characterHeader = document.querySelector(`[onclick="toggleCharacterVersions('${characterId}')"]`);
    const expandIcon = characterHeader?.querySelector('.expand-icon');
    
    if (versionsList && !versionsList.classList.contains('expanded')) {
        versionsList.classList.add('expanded');
        if (expandIcon) {
            expandIcon.style.transform = 'rotate(0deg)';
        }
    }
    
    renderAll();
}

function showCustomVersionSelector() {
    const currentSection = customSections.find(s => s.id === currentCustomSectionId);
    if (!currentSection) return;

    compareVersions = [];

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${t('selectVersionsToCompare') || '選擇要對比的版本'}</h3>
                <button class="close-modal" onclick="this.closest('.modal').remove()">×</button>
            </div>
            
            <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9em;">
                ${t('selectTwoVersions') || '選擇2個版本進行對比'} 
                (<span style="color: var(--text-color); font-weight: 500;">${t('currentSelected') || '目前已選'}: <span id="selected-count">0</span>/2</span>)
            </p>
            
            <div class="version-checkboxes">
                ${currentSection.versions.map(version => `
                    <div class="version-checkbox" data-version-id="${version.id}" onclick="toggleVersionSelection('${version.id}')">
                        <input type="checkbox" id="check-${version.id}" onchange="event.stopPropagation()">
                        <label for="check-${version.id}">${version.name}</label>
                    </div>
                `).join('')}
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">${t('cancel')}</button>
                <button class="btn btn-primary" onclick="applyVersionComparison()" id="apply-compare" disabled>${t('startCompare') || '開始對比'}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    updateSelectedCount();
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function switchToCharacterMode() {
    currentMode = 'character';
    viewMode = 'single';
    compareVersions = [];
    renderAll();
}

function switchToCustomMode() {
    currentMode = 'custom';
    viewMode = 'single';
    compareVersions = [];
    renderAll();
}

       function toggleCompareMode() {
    if (viewMode === 'single') {
        let currentItem, versionsArray;
        
        if (currentMode === 'character') {
            currentItem = characters.find(c => c.id === currentCharacterId);
            versionsArray = currentItem?.versions || [];
        } else if (currentMode === 'worldbook') {
            currentItem = worldBooks.find(wb => wb.id === currentWorldBookId);
            versionsArray = currentItem?.versions || [];
        } else if (currentMode === 'custom') {
            currentItem = customSections.find(s => s.id === currentCustomSectionId);
            versionsArray = currentItem?.versions || [];
        }
        
        if (currentItem && versionsArray.length > 1) {
            compareVersions = [];
            showVersionSelector();
        } else {
            alert(t('needTwoVersions'));
        }
    } else {
        viewMode = 'single';
        compareVersions = [];
        renderAll();
    }
}

function saveData() {
    try {
        localStorage.setItem('characterCreatorData', JSON.stringify(characters));
        localStorage.setItem('characterCreatorCustomData', JSON.stringify(customSections)); // 新增
        markAsSaved();
        localStorage.setItem('characterCreatorWorldBooks', JSON.stringify(worldBooks));

    } catch (error) {
        console.error('儲存資料失敗：', error);
        alert('儲存失敗，請檢查瀏覽器存儲空間');
    }
}
        function showVersionSelector() {
    let currentItem, versionsArray;
    
    if (currentMode === 'character') {
        currentItem = characters.find(c => c.id === currentCharacterId);
        versionsArray = currentItem?.versions || [];
    } else if (currentMode === 'worldbook') {
        currentItem = worldBooks.find(wb => wb.id === currentWorldBookId);
        versionsArray = currentItem?.versions || [];
    } else if (currentMode === 'custom') {
        currentItem = customSections.find(s => s.id === currentCustomSectionId);
        versionsArray = currentItem?.versions || [];
    }
    
    if (!currentItem) return;

    // 重要：每次打開對話框都清空之前的選擇，不管之前在什麼模式
    compareVersions = [];

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${t('selectVersionsToCompare') || '選擇要對比的版本'}</h3>
                <button class="close-modal" onclick="this.closest('.modal').remove()">×</button>
            </div>
            
            <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9em;">
                ${t('selectTwoVersions') || '選擇2個版本進行對比'} 
                (<span style="color: var(--text-color); font-weight: 500;">${t('currentSelected') || '目前已選'}: <span id="selected-count">0</span>/2</span>)
            </p>
            
            <div class="version-checkboxes">
                ${versionsArray.map(version => `
                    <div class="version-checkbox" data-version-id="${version.id}" onclick="toggleVersionSelection('${version.id}')">
                        <input type="checkbox" id="check-${version.id}" onchange="event.stopPropagation()">
                        <label for="check-${version.id}">${version.name}</label>
                    </div>
                `).join('')}
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">${t('cancel')}</button>
                <button class="btn btn-primary" onclick="applyVersionComparison()" id="apply-compare" disabled>${t('startCompare') || '開始對比'}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 初始化計數顯示（確保顯示為0）
    updateSelectedCount();
    
    // 點擊外部關閉
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
        function toggleVersionSelection(versionId) {
    const checkbox = document.getElementById(`check-${versionId}`);
    const container = document.querySelector(`[data-version-id="${versionId}"]`);
    
    if (!checkbox || !container) {
        console.error('找不到對應的元素:', versionId);
        return;
    }
    
    if (checkbox.checked) {
        // 取消選擇
        checkbox.checked = false;
        container.classList.remove('selected');
        compareVersions = compareVersions.filter(id => id !== versionId);
        console.log('取消選擇:', versionId, '目前選擇:', compareVersions);
    } else {
        // 新增選擇
        if (compareVersions.length < 2) {
            checkbox.checked = true;
            container.classList.add('selected');
            compareVersions.push(versionId);
            console.log('新增選擇:', versionId, '目前選擇:', compareVersions);
        } else {
            // 如果已經選了2個，什麼都不做（無聲忽略）
            console.log('已達最大選擇數量，忽略點擊');
            return;
        }
    }
    
    updateSelectedCount();
}

        function updateSelectedCount() {
    const countElement = document.getElementById('selected-count');
    const applyButton = document.getElementById('apply-compare');
    
    if (countElement) {
        countElement.textContent = compareVersions.length;
    }
    
    if (applyButton) {
        applyButton.disabled = compareVersions.length !== 2;
        
        // 更新按鈕文字提示
        if (compareVersions.length === 0) {
            applyButton.textContent = t('startCompare') || '開始對比';
        } else if (compareVersions.length === 1) {
            applyButton.textContent = `${t('needOneMore') || '還需選擇1個版本'}`;
        } else {
            applyButton.textContent = t('startCompare') || '開始對比';
        }
    }
    
    // 更新其他選項的視覺狀態
    const allVersionBoxes = document.querySelectorAll('.version-checkbox');
    allVersionBoxes.forEach(box => {
        const versionId = box.dataset.versionId;
        const isSelected = compareVersions.includes(versionId);
        const checkbox = box.querySelector('input[type="checkbox"]');
        const label = box.querySelector('label');
        
        if (compareVersions.length >= 2 && !isSelected) {
            // 已選滿2個且此項目未被選中 - 變灰色且禁用
            box.style.opacity = '0.4';
            box.style.pointerEvents = 'none';
            if (checkbox) checkbox.disabled = true;
            if (label) label.style.color = 'var(--text-muted)';
        } else {
            // 恢復正常狀態
            box.style.opacity = '1';
            box.style.pointerEvents = 'auto';
            if (checkbox) checkbox.disabled = false;
            if (label) label.style.color = '';
        }
    });
}

        function applyVersionComparison() {
            if (compareVersions.length >= 2) {
                viewMode = 'compare';
                document.querySelector('.modal').remove();
                renderAll();
            }
        }

        function updateField(characterId, versionId, field, value) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        const version = character.versions.find(v => v.id === versionId);
        if (version) {
            version[field] = value;
            updateStats();
            markAsChanged(); // 標記有變更
        }
    }
}

function updateCharacterName(characterId, name) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        character.name = name;
        renderSidebar();
        markAsChanged(); // 標記有變更
    }
}

function updateVersionName(characterId, versionId, name) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        const version = character.versions.find(v => v.id === versionId);
        if (version) {
            version.name = name;
            renderSidebar();
            markAsChanged(); // 標記有變更
        }
    }
}

        function handleImageUpload(characterId, versionId, file) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateField(characterId, versionId, 'avatar', e.target.result);
                    renderContent();
                };
                reader.readAsDataURL(file);
            }
        }

function addCustomSection() {
    const section = {
        id: generateId(),
        name: `Notebook ${customSections.length + 1}`,
        versions: [{
            id: generateId(),
            name: 'Version 1',
            fields: [{
                id: generateId(),
                name: 'Field 1',
                content: ''
            }]
        }]
    };
    customSections.push(section);
    currentMode = 'custom';
    currentCustomSectionId = section.id;
    currentCustomVersionId = section.versions[0].id;
    renderAll();
    markAsChanged();
}

function selectCustomSection(sectionId) {
    currentMode = 'custom';
    currentCustomSectionId = sectionId;
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        currentCustomVersionId = section.versions[0].id;
    }
    renderAll();
}

function selectCustomVersion(sectionId, versionId) {
    currentMode = 'custom';
    currentCustomSectionId = sectionId;
    currentCustomVersionId = versionId;
    renderAll();
}

        function updateStats() {
    const statsElements = document.querySelectorAll('.field-stats');
    statsElements.forEach(element => {
        const textareaId = element.dataset.target;
        const textarea = document.getElementById(textareaId);
        if (textarea) {
            const text = textarea.value;
            const charCount = text.length;
            let tokenCount = countTokens(text);

            // 若此欄位是要排除 token 的，就不顯示 token
            if (textareaId.includes('creator-') ||
                textareaId.includes('charVersion-') ||
                textareaId.includes('creatorNotes-') ||
                textareaId.includes('tags-')) {
                element.textContent = `${charCount} ${t('chars')}`;
            } else {
                element.textContent = `${charCount} ${t('chars')} / ${tokenCount} ${t('tokens')}`;
            }
        }
    });
    
    // 更新每個版本的統計顯示
    characters.forEach(character => {
        character.versions.forEach(version => {
            const versionStatsElement = document.getElementById(`version-stats-${version.id}`);
            if (versionStatsElement) {
                const allText = [
                    version.description, version.personality, version.scenario, 
                    version.dialogue, version.firstMessage
                ].filter(Boolean).join(' ');
                
                const chars = allText.length;
                const tokens = countTokens(allText);
                
                versionStatsElement.textContent = t('versionStats', chars, tokens);
            }
        });
    });

    // 新增：即時更新側邊欄的版本統計
    updateSidebarStats();
    // 更新自定義欄位的統計顯示
customSections.forEach(section => {
    section.versions.forEach(version => {
        const versionStatsElement = document.getElementById(`custom-version-stats-${version.id}`);
        if (versionStatsElement) {
            const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
            const chars = allText.length;
            const tokens = countTokens(allText);
            
            versionStatsElement.textContent = t('versionStats', chars, tokens);
        }
        
        // 更新每個欄位的統計
        version.fields.forEach(field => {
            const fieldStatsElement = document.querySelector(`[data-target="custom-field-${field.id}"]`);
            if (fieldStatsElement) {
                const chars = field.content.length;
                const tokens = countTokens(field.content);
                fieldStatsElement.textContent = `${chars} ${t('chars')} / ${tokens} ${t('tokens')}`;
            }
            // 更新世界書的統計顯示
worldBooks.forEach(worldBook => {
    worldBook.versions.forEach(version => {
        // 更新每個條目的統計
        version.entries.forEach(entry => {
            const fieldStatsElement = document.querySelector(`[data-target="worldbook-content-${entry.id}"]`);
            if (fieldStatsElement) {
                const chars = entry.content.length;
                const tokens = countTokens(entry.content);
                fieldStatsElement.textContent = `${chars} ${t('chars')} / ${tokens} ${t('tokens')}`;
            }
        });
        
        // 更新版本統計
        const versionStatsElement = document.getElementById(`worldbook-version-stats-${version.id}`);
        if (versionStatsElement) {
            const entryCount = version.entries.length;
            const allText = version.entries.map(entry => entry.content).filter(Boolean).join(' ');
            const chars = allText.length;
            const tokens = countTokens(allText);
            versionStatsElement.textContent = `${entryCount} ${currentLang === 'zh' ? '個條目' : 'entries'} - ${chars} ${t('chars')} / ${tokens} ${t('tokens')}`;
        }
    });
});
        });
    });
});
}

// 新增函數：更新側邊欄統計
function updateSidebarStats() {
    characters.forEach(character => {
        character.versions.forEach(version => {
            // 找到側邊欄中對應版本的統計元素
            const versionElement = document.querySelector(`[onclick="selectVersion('${character.id}', '${version.id}')"] span[style*="italic"]`);
            if (versionElement) {
                const allText = [
                    version.description, 
                    version.personality, 
                    version.scenario, 
                    version.dialogue, 
                    version.firstMessage
                ].filter(Boolean).join(' ');
                
                const chars = allText.length;
                const tokens = countTokens(allText);
                
                versionElement.textContent = `${chars}字 / ${tokens}tokens`;
            }
        });
    });
}
    
function exportCustomTXT(sectionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (!section) return;

    if (section.versions.length === 1) {
        downloadCustomTXT(section, section.versions[0]);
    } else {
        const versionIndex = prompt(t('selectVersion', section.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < section.versions.length) {
            downloadCustomTXT(section, section.versions[index]);
        }
    }
}

function exportCustomMarkdown(sectionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (!section) return;

    if (section.versions.length === 1) {
        downloadCustomMarkdown(section, section.versions[0]);
    } else {
        const versionIndex = prompt(t('selectVersion', section.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < section.versions.length) {
            downloadCustomMarkdown(section, section.versions[index]);
        }
    }
}

function downloadCustomTXT(section, version) {
    let content = `${section.name} - ${version.name}\n`;
    content += `${'='.repeat(content.length - 1)}\n\n`;
    
    version.fields.forEach(field => {
        if (field.content.trim()) {
            content += `${field.name}:\n`;
            content += `${'-'.repeat(field.name.length + 1)}\n`;
            content += `${field.content.trim()}\n\n`;
        }
    });
    
    // 添加統計資訊
    const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
    const chars = allText.length;
    const tokens = countTokens(allText);
    content += `\n統計資訊:\n`;
    content += `字數: ${chars}\n`;
    content += `Token數: ${tokens}\n`;
    content += `匯出時間: ${new Date().toLocaleString()}\n`;

    const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${section.name}_${version.name}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function downloadCustomMarkdown(section, version) {
    let content = `# ${section.name} - ${version.name}\n\n`;
    
    version.fields.forEach(field => {
        if (field.content.trim()) {
            content += `## ${field.name}\n\n`;
            content += `${field.content.trim()}\n\n`;
        }
    });
    
    // 添加統計資訊
    const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
    const chars = allText.length;
    const tokens = countTokens(allText);
    content += `---\n\n`;
    content += `### 統計資訊\n\n`;
    content += `- **字數**: ${chars}\n`;
    content += `- **Token數**: ${tokens}\n`;
    content += `- **匯出時間**: ${new Date().toLocaleString()}\n`;

    const blob = new Blob([content], { type: 'text/markdown; charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${section.name}_${version.name}.md`;
    a.click();
    URL.revokeObjectURL(url);
}
        function renderSidebar() {
    const container = document.getElementById('sidebarContent');
    container.innerHTML = characters.map(character => `
        <div class="character-item">
           <div class="character-header ${character.id === currentCharacterId ? 'active' : ''}" 
     onclick="toggleCharacterVersions('${character.id}')">
                <span class="expand-icon">▼</span>
                <div class="character-info">
                    <span>${character.name}</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">${character.versions.length}</span>
                </div>
            </div>
            <div class="version-list" id="versions-${character.id}">
                ${character.versions.map(version => {
                    // 計算該版本的文字統計
const allText = [
    version.description, 
    version.personality, 
    version.scenario, 
    version.dialogue, 
    version.firstMessage
].filter(Boolean).join(' '); // filter(Boolean) 會移除空值和空字串

const chars = allText.length;
const tokens = countTokens(allText);
                    
                    return `
                        <div class="version-item ${version.id === currentVersionId ? 'active' : ''}" 
     onclick="selectSidebarItem('character', '${character.id}', '${version.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <span style="display: inline-flex; align-items: center; gap: 6px;">
                                    ${version.avatar ? `<img src="${version.avatar}" alt="Avatar" style="width: 16px; height: 16px; border-radius: 3px;">` : ''}
                                    ${version.name}
                                </span>
                                <span style="font-size: 0.75em; font-style: italic; color: var(--text-muted); opacity: 0.8;">
                                    ${chars}字 / ${tokens}tokens
                                </span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `).join('');
    
    // 展開當前選中角色的版本列表
    const currentVersionsList = document.getElementById(`versions-${currentCharacterId}`);
    if (currentVersionsList) {
        currentVersionsList.classList.add('expanded');
    }
    
    // 更新側邊欄文字
    document.querySelector('.sidebar-section-title').textContent = t('characterList');
    const addButtons = document.querySelectorAll('.sidebar-add-btn');
    if (addButtons[0]) addButtons[0].textContent = t('addCharacter');
    if (addButtons[1]) addButtons[1].textContent = t('importCharacter');
    
    const worldBookTitle = document.querySelectorAll('.sidebar-section-title')[1];
    if (worldBookTitle) {
        worldBookTitle.textContent = t('worldBook');
    }

    // 渲染自定義區塊列表
const customContainer = document.getElementById('customSectionContent');
if (customContainer) {
    customContainer.innerHTML = customSections.map(section => `
        <div class="character-item">
            <div class="character-header ${section.id === currentCustomSectionId && currentMode === 'custom' ? 'active' : ''}" 
                 onclick="toggleCustomSectionVersions('${section.id}')">
                <span class="expand-icon">▼</span>
                <div class="character-info">
                    <span>${section.name}</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">${section.versions.length}</span>
                </div>
            </div>
            <div class="version-list" id="custom-versions-${section.id}">
                ${section.versions.map(version => {
                    // 計算該版本的文字統計
                    const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
                    const chars = allText.length;
                    const tokens = countTokens(allText);
                    
                    return `
                        <div class="version-item ${version.id === currentCustomVersionId && currentMode === 'custom' ? 'active' : ''}" 
                             onclick="selectSidebarItem('custom', '${section.id}', '${version.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <span>${version.name}</span>
                                <span style="font-size: 0.75em; font-style: italic; color: var(--text-muted); opacity: 0.8;">
                                    ${chars}字 / ${tokens}tokens
                                </span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `).join('');
    
    // 展開當前選中區塊的版本列表
    if (currentMode === 'custom' && currentCustomSectionId) {
        const currentVersionsList = document.getElementById(`custom-versions-${currentCustomSectionId}`);
        if (currentVersionsList) {
            currentVersionsList.classList.add('expanded');
        }
    }
}
// 渲染世界書列表
const worldBookContainer = document.getElementById('worldBookContent');
if (worldBookContainer) {
    worldBookContainer.innerHTML = worldBooks.map(worldBook => `
        <div class="character-item">
            <div class="character-header ${worldBook.id === currentWorldBookId && currentMode === 'worldbook' ? 'active' : ''}" 
                 onclick="toggleWorldBookVersions('${worldBook.id}')">
                <span class="expand-icon">▼</span>
                <div class="character-info">
                    <span>${worldBook.name}</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">${worldBook.versions.length}</span>
                </div>
            </div>
            <div class="version-list" id="worldbook-versions-${worldBook.id}">
                ${worldBook.versions.map(version => {
    const entryCount = version.entries.length;
    const allText = version.entries.map(entry => entry.content).filter(Boolean).join(' ');
    const chars = allText.length;
    const tokens = countTokens(allText);
    
    return `
        <div class="version-item ${version.id === currentWorldBookVersionId && currentMode === 'worldbook' ? 'active' : ''}" 
             onclick="selectSidebarItem('worldbook', '${worldBook.id}', '${version.id}')">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <span>${version.name}</span>
                <span style="font-size: 0.75em; font-style: italic; color: var(--text-muted); opacity: 0.8;">
                    ${entryCount}條目 / ${chars}字 / ${tokens}tokens
                </span>
            </div>
        </div>
    `;
}).join('')}
            </div>
        </div>
    `).join('');
    
    // 展開當前選中世界書的版本列表
    if (currentMode === 'worldbook' && currentWorldBookId) {
        const currentVersionsList = document.getElementById(`worldbook-versions-${currentWorldBookId}`);
        if (currentVersionsList) {
            currentVersionsList.classList.add('expanded');
        }
    }
}

// 更新世界書標題和按鈕文字
const worldBookButtons = document.querySelectorAll('#worldbook-content .sidebar-add-btn');
if (worldBookButtons[0]) worldBookButtons[0].textContent = t('addWorldBook');
if (worldBookButtons[1]) worldBookButtons[1].textContent = t('importWorldBook');

// 更新自定義欄位標題
const customFieldTitle = document.querySelectorAll('.sidebar-section-title')[2]; // 第三個區塊
if (customFieldTitle) {
    customFieldTitle.textContent = t('customFields');
}
const addCustomBtn = document.querySelector('button[onclick="addCustomSection()"]');
if (addCustomBtn) {
    addCustomBtn.textContent = t('addCustomField');
}
}

function toggleCustomSectionVersions(sectionId) {
    const versionsList = document.getElementById(`custom-versions-${sectionId}`);
    const isExpanded = versionsList.classList.contains('expanded');

    // 先選中區塊
    currentMode = 'custom';
    currentCustomSectionId = sectionId;
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        currentCustomVersionId = section.versions[0].id;
    }
    viewMode = 'single';
    compareVersions = [];

    // 重新渲染以更新選中狀態
    renderAll();
    
    // 渲染完成後再處理展開/收合狀態
    setTimeout(() => {
        const newVersionsList = document.getElementById(`custom-versions-${sectionId}`);
        const expandIcon = document.querySelector(`[onclick="toggleCustomSectionVersions('${sectionId}')"] .expand-icon`);
        
        if (isExpanded) {
            newVersionsList.classList.remove('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        } else {
            newVersionsList.classList.add('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }, 10);
}

function copyVersion(characterId, versionId) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        const originalVersion = character.versions.find(v => v.id === versionId);
        if (originalVersion) {
            const newVersion = {
                id: generateId(),
                name: originalVersion.name + ' - Copy',
                avatar: originalVersion.avatar,
                description: originalVersion.description,
                personality: originalVersion.personality,
                scenario: originalVersion.scenario,
                dialogue: originalVersion.dialogue,
                firstMessage: originalVersion.firstMessage,
                creator: originalVersion.creator,
                charVersion: originalVersion.charVersion,
                creatorNotes: originalVersion.creatorNotes,
                tags: originalVersion.tags
            };
            character.versions.push(newVersion);
            currentVersionId = newVersion.id;
            renderAll();
            markAsChanged(); // 標記有變更
        }
    }
}

function copyCharacter(characterId) {
    const originalCharacter = characters.find(c => c.id === characterId);
    if (originalCharacter) {
        const newCharacter = {
            id: generateId(),
            name: originalCharacter.name + ' - Copy',
            versions: originalCharacter.versions.map(version => ({
                id: generateId(),
                name: version.name,
                avatar: version.avatar,
                description: version.description,
                personality: version.personality,
                scenario: version.scenario,
                dialogue: version.dialogue,
                firstMessage: version.firstMessage,
                creator: version.creator,
                charVersion: version.charVersion,
                creatorNotes: version.creatorNotes,
                tags: version.tags
            }))
        };
        characters.push(newCharacter);
        currentCharacterId = newCharacter.id;
        currentVersionId = newCharacter.versions[0].id;
        renderAll();
        markAsChanged(); // 標記有變更
    }
}


       function toggleCharacterVersions(characterId) {
    const versionsList = document.getElementById(`versions-${characterId}`);
    const isExpanded = versionsList.classList.contains('expanded');

    // 先選中角色
    currentMode = 'character';
    currentCharacterId = characterId;
    const character = characters.find(c => c.id === characterId);
    if (character) {
        currentVersionId = character.versions[0].id;
    }
    viewMode = 'single';
    compareVersions = [];

    // 重新渲染以更新選中狀態
    renderAll();
    
    // 渲染完成後再處理展開/收合狀態
    setTimeout(() => {
        const newVersionsList = document.getElementById(`versions-${characterId}`);
        const expandIcon = document.querySelector(`[onclick="toggleCharacterVersions('${characterId}')"] .expand-icon`);
        
        if (isExpanded) {
            // 如果之前是展開的，現在收合
            newVersionsList.classList.remove('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        } else {
            // 如果之前是收合的，現在展開
            newVersionsList.classList.add('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }, 10);
}

        function renderContent() {
    const container = document.getElementById('contentArea');
    
    // 根據當前模式渲染不同內容
    if (currentMode === 'custom') {
        renderCustomContent();
        return;
    }
    
    if (currentMode === 'worldbook') {
        renderWorldBookContent();
        return;
    }
    
    const currentCharacter = characters.find(c => c.id === currentCharacterId);
    
    if (!currentCharacter) {
        container.innerHTML = `<div style="text-align: center; padding: 80px; color: var(--text-muted);">${t('selectCharacter') || '請選擇一個角色'}</div>`;
        return;
    }

    const versionsToShow = viewMode === 'compare' ? 
        currentCharacter.versions.filter(v => compareVersions.includes(v.id)) : 
        currentCharacter.versions.filter(v => v.id === currentVersionId);

    container.innerHTML = `
        <!-- 角色名稱和控制區 -->
        <div class="character-header-bar">
            <div class="character-title-section">
                <input type="text" class="character-main-title-fixed" value="${currentCharacter.name}" 
                       onchange="updateCharacterName('${currentCharacter.id}', this.value)" 
                       placeholder="${t('characterName')}">
            </div>
           <div class="character-controls">
    <button class="btn ${viewMode === 'single' ? 'btn-primary' : 'btn-secondary'}" onclick="viewMode='single'; compareVersions=[]; renderAll()">${t('singleView')}</button>
    <button class="btn ${viewMode === 'compare' ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCompareMode()">
        ${viewMode === 'compare' ? `${t('compareView')} (${compareVersions.length})` : t('compareView')}
    </button>
    <button class="btn btn-secondary" onclick="addVersion('${currentCharacter.id}')">${t('addVersion')}</button>
    <button class="btn btn-secondary" onclick="copyCharacter('${currentCharacter.id}')">${t('copyCharacter')}</button>
        <button class="btn btn-secondary" onclick="removeCharacter('${currentCharacter.id}')">${t('deleteCharacter')}</button>
    <button class="btn btn-secondary" onclick="saveData(); showSaveNotification()">${t('save')}</button>
</div>
        </div>

        <div class="versions-container ${viewMode}-view">
            ${versionsToShow.map(version => renderVersionPanel(currentCharacter, version)).join('')}
        </div>

        <div class="export-section">
            <h3>${t('exportCharacter') || '匯出角色卡'}</h3>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportJSON('${currentCharacter.id}')">${t('exportJSON')}</button>
                <button class="btn btn-secondary" onclick="exportPNG('${currentCharacter.id}')">${t('exportPNG')}</button>
                <button class="btn btn-secondary" onclick="exportAllVersions('${currentCharacter.id}')">${t('exportAll')}</button>
            </div>
        </div>
    `;

    setTimeout(() => {
        updateStats();
        initAutoResize();
    }, 100);
}


function renderCustomContent() {
    const container = document.getElementById('contentArea');
    const currentSection = customSections.find(s => s.id === currentCustomSectionId);
    
    if (!currentSection) {
        container.innerHTML = `<div style="text-align: center; padding: 80px; color: var(--text-muted);">請選擇一個自定義區塊</div>`;
        return;
    }

    const versionsToShow = viewMode === 'compare' ? 
        currentSection.versions.filter(v => compareVersions.includes(v.id)) : 
        currentSection.versions.filter(v => v.id === currentCustomVersionId);

    container.innerHTML = `
        <!-- 區塊名稱和控制區 -->
        <div class="character-header-bar">
            <div class="character-title-section">
                <input type="text" class="character-main-title-fixed" value="${currentSection.name}" 
                       onchange="updateCustomSectionName('${currentSection.id}', this.value)" 
                       placeholder="${t('sectionName')}">
            </div>
            <div class="character-controls">
                <button class="btn ${viewMode === 'single' ? 'btn-primary' : 'btn-secondary'}" onclick="viewMode='single'; compareVersions=[]; renderAll()">${t('singleView')}</button>
                <button class="btn ${viewMode === 'compare' ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCompareMode()">
                    ${viewMode === 'compare' ? `${t('compareView')} (${compareVersions.length})` : t('compareView')}
                </button>
                <button class="btn btn-secondary" onclick="addCustomVersion('${currentSection.id}')">${t('addVersion')}</button>
                <button class="btn btn-secondary" onclick="copyCustomSection('${currentSection.id}')">${t('copySection')}</button>
                <button class="btn btn-secondary" onclick="removeCustomSection('${currentSection.id}')">${t('deleteSection')}</button>
                <button class="btn btn-secondary" onclick="saveData(); showSaveNotification()">${t('save')}</button>
            </div>
        </div>

        <div class="versions-container ${viewMode}-view">
            ${versionsToShow.map(version => renderCustomVersionPanel(currentSection, version)).join('')}
        </div>

        <div class="export-section">
            <h3>匯出自定義內容</h3>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportCustomTXT('${currentSection.id}')">${t('exportTXT')}</button>
                <button class="btn btn-secondary" onclick="exportCustomMarkdown('${currentSection.id}')">${t('exportMarkdown')}</button>
            </div>
        </div>
    `;

    setTimeout(() => {
        updateStats();
        initAutoResize();
    }, 100);
}

function renderCustomVersionPanel(section, version) {
    return `
        <div class="version-panel">
            <div class="version-header">
                <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
                    <input type="text" class="version-title" value="${version.name}" 
                           onchange="updateCustomVersionName('${section.id}', '${version.id}', this.value)"
                           style="font-size: 1.2em; font-weight: 600; margin: 0; padding: 8px 12px; border: 1px solid transparent; border-radius: 6px; background: transparent; color: var(--text-color); transition: all 0.2s ease;">
                    <div class="version-stats" id="custom-version-stats-${version.id}" style="font-size: 0.85em; color: var(--text-muted); padding-left: 12px;">
                        ${t('versionStats', 0, 0)}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-small" onclick="copyCustomVersion('${section.id}', '${version.id}')">${t('copy')}</button>
                    ${section.versions.length > 1 ? `<button class="btn btn-secondary btn-small" onclick="removeCustomVersion('${section.id}', '${version.id}')">${t('delete')}</button>` : ''}
                </div>
            </div>

            <!-- 動態欄位區域 -->
            <div id="custom-fields-${version.id}">
                ${version.fields.map(field => renderCustomField(section.id, version.id, field)).join('')}
            </div>
            
            <!-- 新增欄位按鈕 -->
            <button class="btn btn-secondary" onclick="addCustomField('${section.id}', '${version.id}')" style="margin-top: 16px;">
                + ${t('addField')}
            </button>
        </div>
    `;
}

function confirmRemoveCustomField(sectionId, versionId, fieldId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            const field = version.fields.find(f => f.id === fieldId);
            if (field) {
                const confirmDelete = confirm(`確定要刪除欄位「${field.name}」嗎？\n\n⚠️ 刪除後無法復原，請確保已備份重要資料！`);
                
                if (confirmDelete) {
                    removeCustomField(sectionId, versionId, fieldId);
                }
            }
        }
    }
}

function renderCustomField(sectionId, versionId, field) {
    return `
        <div class="field-group" id="field-${field.id}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
    <div style="flex: 1;">
        <input type="text" value="${field.name}" 
               onchange="updateCustomFieldName('${sectionId}', '${versionId}', '${field.id}', this.value)"
               placeholder="${t('fieldNamePlaceholder')}"
               style="background: transparent; border: 1px solid transparent; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; font-weight: 500;">
        <span class="field-stats" data-target="custom-field-${field.id}" style="margin-left: 12px; font-size: 0.85em; color: var(--text-muted);">0 ${t('chars')} / 0 ${t('tokens')}</span>
    </div>
    <button class="btn btn-secondary btn-small" onclick="confirmRemoveCustomField('${sectionId}', '${versionId}', '${field.id}')" style="margin-left: 12px;">
        ${t('deleteField')}
    </button>
</div>
            <textarea class="field-input auto-resize" id="custom-field-${field.id}" 
                      placeholder="${t('customFieldPlaceholder')}"
                      oninput="updateCustomFieldContent('${sectionId}', '${versionId}', '${field.id}', this.value); updateStats(); autoResizeTextarea(this);">${field.content}</textarea>
        </div>
    `;
}

function updateCustomSectionName(sectionId, name) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        section.name = name;
        renderSidebar();
        markAsChanged();
    }
}

function updateCustomVersionName(sectionId, versionId, name) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            version.name = name;
            renderSidebar();
            markAsChanged();
        }
    }
}

function addCustomVersion(sectionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const newVersion = {
            id: generateId(),
            name: `Version ${section.versions.length + 1}`,
            fields: [{
                id: generateId(),
                name: 'Default Field',
                content: ''
            }]
        };
        section.versions.push(newVersion);
        currentCustomVersionId = newVersion.id;
        renderAll();
        markAsChanged();
    }
}

function copyCustomVersion(sectionId, versionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const originalVersion = section.versions.find(v => v.id === versionId);
        if (originalVersion) {
            const newVersion = {
                id: generateId(),
                name: originalVersion.name + ' - Copy',
                fields: originalVersion.fields.map(field => ({
                    id: generateId(),
                    name: field.name,
                    content: field.content
                }))
            };
            section.versions.push(newVersion);
            currentCustomVersionId = newVersion.id;
            renderAll();
            markAsChanged();
        }
    }
}

function copyCustomSection(sectionId) {
    const originalSection = customSections.find(s => s.id === sectionId);
    if (originalSection) {
        const newSection = {
            id: generateId(),
            name: originalSection.name + ' - Copy',
            versions: originalSection.versions.map(version => ({
                id: generateId(),
                name: version.name,
                fields: version.fields.map(field => ({
                    id: generateId(),
                    name: field.name,
                    content: field.content
                }))
            }))
        };
        customSections.push(newSection);
        currentCustomSectionId = newSection.id;
        currentCustomVersionId = newSection.versions[0].id;
        renderAll();
        markAsChanged();
    }
}

function addCustomField(sectionId, versionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            const newField = {
                id: generateId(),
                name: `Field ${version.fields.length + 1}`,
                content: ''
            };
            version.fields.push(newField);
            renderCustomContent();
            markAsChanged();
        }
    }
}

function updateCustomFieldName(sectionId, versionId, fieldId, name) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            const field = version.fields.find(f => f.id === fieldId);
            if (field) {
                field.name = name;
                markAsChanged();
            }
        }
    }
}

function updateCustomFieldContent(sectionId, versionId, fieldId, content) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            const field = version.fields.find(f => f.id === fieldId);
            if (field) {
                field.content = content;
                updateStats();
                markAsChanged();
            }
        }
    }
}

function removeCustomField(sectionId, versionId, fieldId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version && version.fields.length > 1) {
            version.fields = version.fields.filter(f => f.id !== fieldId);
            renderCustomContent();
            markAsChanged();
        } else {
            alert('至少需要保留一個欄位');
        }
    }
}

function removeCustomVersion(sectionId, versionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section && section.versions.length > 1) {
        const version = section.versions.find(v => v.id === versionId);
        const confirmDelete = confirm(t('deleteVersionConfirm', version?.name || '未命名版本'));
        
        if (confirmDelete) {
            section.versions = section.versions.filter(v => v.id !== versionId);
            if (currentCustomVersionId === versionId) {
                currentCustomVersionId = section.versions[0].id;
            }
            renderAll();
            saveData();
        }
    } else {
        alert(t('keepOneVersion'));
    }
}

function removeCustomSection(sectionId) {
    const section = customSections.find(s => s.id === sectionId);
    const confirmDelete = confirm(`確定要刪除區塊「${section?.name || '未命名區塊'}」嗎？\n\n⚠️ 刪除後無法復原，請確保已備份重要資料！`);
    
    if (confirmDelete) {
        customSections = customSections.filter(s => s.id !== sectionId);
        if (currentCustomSectionId === sectionId) {
            if (customSections.length > 0) {
                currentCustomSectionId = customSections[0].id;
                currentCustomVersionId = customSections[0].versions[0].id;
            } else {
                // 如果刪光了就切回角色模式
                currentMode = 'character';
                currentCustomSectionId = null;
                currentCustomVersionId = null;
            }
        }
        renderAll();
        saveData();
    }
}

// 世界書相關函數 - 在現有 JavaScript 中添加以下函數

// 新增世界書
function addWorldBook() {
    const worldBook = {
        id: generateId(),
        name: `Lorebook ${worldBooks.length + 1}`,
        description: '',
        versions: [{
            id: generateId(),
            name: 'Version 1',
            entries: []
        }]
    };
    worldBooks.push(worldBook);
    currentMode = 'worldbook';
    currentWorldBookId = worldBook.id;
    currentWorldBookVersionId = worldBook.versions[0].id;
    renderAll();
    markAsChanged();
}

// 選中世界書
function selectWorldBook(worldBookId) {
    currentMode = 'worldbook';
    currentWorldBookId = worldBookId;
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        currentWorldBookVersionId = worldBook.versions[0].id;
    }
    viewMode = 'single';
    compareVersions = [];
    renderAll();
}

// 選中世界書版本
function selectWorldBookVersion(worldBookId, versionId) {
    currentMode = 'worldbook';
    currentWorldBookId = worldBookId;
    currentWorldBookVersionId = versionId;
    viewMode = 'single';
    renderAll();
}

// 切換世界書版本列表
function toggleWorldBookVersions(worldBookId) {
    const versionsList = document.getElementById(`worldbook-versions-${worldBookId}`);
    const isExpanded = versionsList.classList.contains('expanded');

    // 先選中世界書
    currentMode = 'worldbook';
    currentWorldBookId = worldBookId;
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        currentWorldBookVersionId = worldBook.versions[0].id;
    }
    viewMode = 'single';
    compareVersions = [];

    // 重新渲染以更新選中狀態
    renderAll();
    
    // 渲染完成後再處理展開/收合狀態
    setTimeout(() => {
        const newVersionsList = document.getElementById(`worldbook-versions-${worldBookId}`);
        const expandIcon = document.querySelector(`[onclick="toggleWorldBookVersions('${worldBookId}')"] .expand-icon`);
        
        if (isExpanded) {
            newVersionsList.classList.remove('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        } else {
            newVersionsList.classList.add('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }, 10);
}

// 新增世界書版本
function addWorldBookVersion(worldBookId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const newVersion = {
            id: generateId(),
            name: `Version ${worldBook.versions.length + 1}`,
            entries: []
        };
        worldBook.versions.push(newVersion);
        currentWorldBookVersionId = newVersion.id;
        renderAll();
        markAsChanged();
    }
}

// 複製世界書版本
function copyWorldBookVersion(worldBookId, versionId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const originalVersion = worldBook.versions.find(v => v.id === versionId);
        if (originalVersion) {
            const newVersion = {
                id: generateId(),
                name: originalVersion.name + ' - Copy',
                entries: originalVersion.entries.map(entry => ({
                    id: generateId(),
                    key: [...entry.key],
                    keysecondary: [...entry.keysecondary],
                    content: entry.content,
                    comment: entry.comment,
                    constant: entry.constant,
                    vectorized: entry.vectorized || false,
                    selective: entry.selective,
                    useProbability: entry.useProbability,
                    disable: entry.disable,
                    insertion_order: entry.insertion_order,
                    depth: entry.depth,
                    probability: entry.probability,
                    position: entry.position,
                    role: entry.role
                }))
            };
            worldBook.versions.push(newVersion);
            currentWorldBookVersionId = newVersion.id;
            renderAll();
            markAsChanged();
        }
    }
}

// 複製世界書
function copyWorldBook(worldBookId) {
    const originalWorldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (originalWorldBook) {
        const newWorldBook = {
            id: generateId(),
            name: originalWorldBook.name + ' - Copy',
            description: originalWorldBook.description,
            versions: originalWorldBook.versions.map(version => ({
                id: generateId(),
                name: version.name,
                entries: version.entries.map(entry => ({
                    id: generateId(),
                    key: [...entry.key],
                    keysecondary: [...entry.keysecondary],
                    content: entry.content,
                    comment: entry.comment,
                    constant: entry.constant,
                    vectorized: entry.vectorized || false,
                    selective: entry.selective,
                    useProbability: entry.useProbability,
                    disable: entry.disable,
                    insertion_order: entry.insertion_order,
                    depth: entry.depth,
                    probability: entry.probability,
                    position: entry.position,
                    role: entry.role
                }))
            }))
        };
        worldBooks.push(newWorldBook);
        currentWorldBookId = newWorldBook.id;
        currentWorldBookVersionId = newWorldBook.versions[0].id;
        renderAll();
        markAsChanged();
    }
}

// 刪除世界書版本
function removeWorldBookVersion(worldBookId, versionId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook && worldBook.versions.length > 1) {
        const version = worldBook.versions.find(v => v.id === versionId);
        const confirmDelete = confirm(t('deleteVersionConfirm', version?.name || '未命名版本'));
        
        if (confirmDelete) {
            worldBook.versions = worldBook.versions.filter(v => v.id !== versionId);
            if (currentWorldBookVersionId === versionId) {
                currentWorldBookVersionId = worldBook.versions[0].id;
            }
            renderAll();
            saveData();
        }
    } else {
        alert(t('keepOneVersion'));
    }
}

// 刪除世界書
function removeWorldBook(worldBookId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    const confirmDelete = confirm(t('deleteWorldBook') + ` "${worldBook?.name || '未命名世界書'}"？\n\n⚠️ 刪除後無法復原，請確保已備份重要資料！`);
    
    if (confirmDelete) {
        worldBooks = worldBooks.filter(wb => wb.id !== worldBookId);
        if (currentWorldBookId === worldBookId) {
            if (worldBooks.length > 0) {
                currentWorldBookId = worldBooks[0].id;
                currentWorldBookVersionId = worldBooks[0].versions[0].id;
            } else {
                currentMode = 'character';
                currentWorldBookId = null;
                currentWorldBookVersionId = null;
            }
        }
        renderAll();
        saveData();
    }
}

// 更新世界書名稱
function updateWorldBookName(worldBookId, name) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        worldBook.name = name;
        renderSidebar();
        markAsChanged();
    }
}

// 更新世界書版本名稱
function updateWorldBookVersionName(worldBookId, versionId, name) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            version.name = name;
            renderSidebar();
            markAsChanged();
        }
    }
}

// 新增條目
function addWorldBookEntry(worldBookId, versionId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const newEntry = {
    id: generateId(),
    uid: version.entries.length,
    displayIndex: version.entries.length,
    key: [],
    keysecondary: [],
    content: '',
    comment: '',
    constant: false,
    vectorized: false,
    selective: true,
    selectiveLogic: 0,
    addMemo: true,
    useProbability: false,
    disable: false,
    order: 100,  // 在匯出時會轉為 insertion_order
    position: 0,
    excludeRecursion: false,
    preventRecursion: false,
    delayUntilRecursion: false,
    probability: 100,
    depth: 4,
    group: '',
    groupOverride: false,
    groupWeight: 100,
    scanDepth: null,
    caseSensitive: null,
    matchWholeWords: null,
    useGroupScoring: null,
    automationId: '',
    role: 0,
    sticky: 0,
    cooldown: 0,
    delay: 0,
    // 匹配選項
    matchPersonaDescription: false,
    matchCharacterDescription: false,
    matchCharacterPersonality: false,
    matchCharacterDepthPrompt: false,
    matchScenario: false,
    matchCreatorNotes: false
};
            version.entries.push(newEntry);
            renderWorldBookContent();
            markAsChanged();
        }
    }
}

// 刪除條目
function removeWorldBookEntry(worldBookId, versionId, entryId) {
    const confirmDelete = confirm(t('deleteEntry') + '？\n\n⚠️ 刪除後無法復原！');
    
    if (confirmDelete) {
        const worldBook = worldBooks.find(wb => wb.id === worldBookId);
        if (worldBook) {
            const version = worldBook.versions.find(v => v.id === versionId);
            if (version) {
                version.entries = version.entries.filter(e => e.id !== entryId);
                renderWorldBookContent();
                markAsChanged();
            }
        }
    }
}

// 更新條目欄位
function updateWorldBookEntry(worldBookId, versionId, entryId, field, value) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                if (field === 'key' || field === 'keysecondary') {
                    // 處理關鍵字陣列
                    entry[field] = value.split(',').map(k => k.trim()).filter(k => k);
                } else {
                    entry[field] = value;
                }
                markAsChanged();
            }
        }
    }
}

// 新增：更新條目模式
function updateEntryMode(worldBookId, versionId, entryId, mode) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                // 重置所有模式
                entry.constant = false;
                entry.vectorized = false;
                entry.selective = true;
                
                // 設定選中的模式
                switch (mode) {
                    case 'constant':
                        entry.constant = true;
                        break;
                    case 'vectorized':
                        entry.vectorized = true;
                        break;
                    case 'selective':
                    default:
                        entry.selective = true;
                        break;
                }
                markAsChanged();
            }
        }
    }
}

// 新增：切換條目啟用狀態
function toggleEntryEnabled(worldBookId, versionId, entryId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                entry.disable = !entry.disable;
                // 不重新渲染，只更新狀態圖示
                updateEntryStatusIcon(entryId, entry);
                markAsChanged();
            }
        }
    }
}

        function updateEntryStatusIcon(entryId, entry) {
    // 找到對應條目的狀態圖示元素
    const entryPanel = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (entryPanel) {
        const statusIcon = entryPanel.querySelector('.entry-status-icon');
        if (statusIcon) {
            // 更新圖示
            let icon = '';
            if (entry.constant) {
                icon = '🔵'; // 藍燈：常駐模式
            } else if (entry.vectorized) {
                icon = '🔗'; // 鏈接：向量化模式
            } else {
                icon = '🟢'; // 綠燈：選擇模式
            }
            statusIcon.textContent = icon;
        }
    }
}


// 匯入世界書
function importWorldBook() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(event) {
        handleWorldBookImport(event);
    };
    input.click();
}

// 處理世界書匯入
function handleWorldBookImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // 檢查是否為 SillyTavern 世界書格式
            if (data.entries && typeof data.entries === 'object') {
                importSillyTavernWorldBook(data, file.name);
            } else {
                alert('檔案格式不正確，請選擇有效的世界書檔案');
            }
        } catch (error) {
            alert('檔案讀取失敗：' + error.message);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// 匯入 SillyTavern 格式世界書
function importSillyTavernWorldBook(data, filename) {
    const worldBook = {
        id: generateId(),
        name: data.name || filename.replace('.json', '') || 'Imported Lorebook',
        description: data.description || '',
        versions: [{
            id: generateId(),
            name: 'Imported Version',
            entries: []
        }]
    };

    // 轉換條目格式
    const entries = Object.values(data.entries);
    worldBook.versions[0].entries = entries.map((entry, index) => ({
        id: generateId(),
        uid: entry.uid || index,
        displayIndex: entry.displayIndex || index,
        key: Array.isArray(entry.key) ? entry.key : [],
        keysecondary: Array.isArray(entry.keysecondary) ? entry.keysecondary : [],
        content: entry.content || '',
        comment: entry.comment || '',
        constant: entry.constant || false,
        vectorized: entry.vectorized || false,
        selective: entry.selective !== false, // 預設為 true
        selectiveLogic: entry.selectiveLogic || 0,
        addMemo: entry.addMemo !== false,
        useProbability: entry.useProbability || false,
        disable: entry.disable || false,
        insertion_order: entry.order || entry.insertion_order || 100,
        depth: entry.depth || 4,
        probability: entry.probability || 100,
        position: entry.position || 0,
        role: entry.role || 0,
        excludeRecursion: entry.excludeRecursion || false,
        preventRecursion: entry.preventRecursion || false,
        matchPersonaDescription: entry.matchPersonaDescription || false,
        matchCharacterDescription: entry.matchCharacterDescription || false,
        matchCharacterPersonality: entry.matchCharacterPersonality || false,
        matchCharacterDepthPrompt: entry.matchCharacterDepthPrompt || false,
        matchScenario: entry.matchScenario || false,
        matchCreatorNotes: entry.matchCreatorNotes || false,
        delayUntilRecursion: entry.delayUntilRecursion || false,
        group: entry.group || '',
        groupOverride: entry.groupOverride || false,
        groupWeight: entry.groupWeight || 100,
        scanDepth: entry.scanDepth || null,
        caseSensitive: entry.caseSensitive || null,
        matchWholeWords: entry.matchWholeWords || null,
        useGroupScoring: entry.useGroupScoring || null,
        automationId: entry.automationId || '',
        sticky: entry.sticky || 0,
        cooldown: entry.cooldown || 0,
        delay: entry.delay || 0
    }));

    worldBooks.push(worldBook);
    currentMode = 'worldbook';
    currentWorldBookId = worldBook.id;
    currentWorldBookVersionId = worldBook.versions[0].id;
    viewMode = 'single';
    compareVersions = [];
    renderAll();
    markAsChanged();
    alert(`世界書「${worldBook.name}」匯入成功！包含 ${entries.length} 個條目。`);
}

// 匯出世界書
function exportWorldBook(worldBookId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (!worldBook) return;

    if (worldBook.versions.length === 1) {
        downloadWorldBook(worldBook, worldBook.versions[0]);
    } else {
        const versionIndex = prompt(t('selectVersion', worldBook.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < worldBook.versions.length) {
            downloadWorldBook(worldBook, worldBook.versions[index]);
        }
    }
}

// 下載世界書
function downloadWorldBook(worldBook, version) {
    const exportData = {
        name: worldBook.name,
        description: worldBook.description || '',
        entries: {}
    };

    // 轉換為 SillyTavern 格式
    version.entries.forEach((entry, index) => {
        exportData.entries[index.toString()] = {
            uid: index,
            key: entry.key,
            keysecondary: entry.keysecondary,
            comment: entry.comment,
            content: entry.content,
            constant: entry.constant,
            vectorized: entry.vectorized || false,
            selective: entry.selective,
            selectiveLogic: entry.selectiveLogic || 0,
            addMemo: entry.addMemo !== false,
            order: entry.insertion_order || 100,
            position: entry.position || 0,
            disable: entry.disable || false,
            excludeRecursion: entry.excludeRecursion || false,
            preventRecursion: entry.preventRecursion || false,
            matchPersonaDescription: entry.matchPersonaDescription || false,
            matchCharacterDescription: entry.matchCharacterDescription || false,
            matchCharacterPersonality: entry.matchCharacterPersonality || false,
            matchCharacterDepthPrompt: entry.matchCharacterDepthPrompt || false,
            matchScenario: entry.matchScenario || false,
            matchCreatorNotes: entry.matchCreatorNotes || false,
            delayUntilRecursion: entry.delayUntilRecursion || false,
            probability: entry.probability || 100,
            useProbability: entry.useProbability || false,
            depth: entry.depth || 4,
            group: entry.group || '',
            groupOverride: entry.groupOverride || false,
            groupWeight: entry.groupWeight || 100,
            scanDepth: entry.scanDepth || null,
            caseSensitive: entry.caseSensitive || null,
            matchWholeWords: entry.matchWholeWords || null,
            useGroupScoring: entry.useGroupScoring || null,
            automationId: entry.automationId || '',
            role: entry.role || 0,
            sticky: entry.sticky || 0,
            cooldown: entry.cooldown || 0,
            delay: entry.delay || 0,
            displayIndex: index
        };
    });

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${worldBook.name}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// 渲染世界書內容
function renderWorldBookContent() {
    const container = document.getElementById('contentArea');
    const currentWorldBook = worldBooks.find(wb => wb.id === currentWorldBookId);
    
    if (!currentWorldBook) {
        container.innerHTML = `<div style="text-align: center; padding: 80px; color: var(--text-muted);">請選擇一個世界書</div>`;
        return;
    }

    const versionsToShow = viewMode === 'compare' ? 
        currentWorldBook.versions.filter(v => compareVersions.includes(v.id)) : 
        currentWorldBook.versions.filter(v => v.id === currentWorldBookVersionId);

    container.innerHTML = `
        <!-- 世界書名稱和控制區 -->
        <div class="character-header-bar">
            <div class="character-title-section">
                <input type="text" class="character-main-title-fixed" value="${currentWorldBook.name}" 
                       onchange="updateWorldBookName('${currentWorldBook.id}', this.value)" 
                       placeholder="${t('worldBookName')}">
            </div>
            <div class="character-controls">
                <button class="btn ${viewMode === 'single' ? 'btn-primary' : 'btn-secondary'}" onclick="viewMode='single'; compareVersions=[]; renderAll()">${t('singleView')}</button>
                <button class="btn ${viewMode === 'compare' ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCompareMode()">
                    ${viewMode === 'compare' ? `${t('compareView')} (${compareVersions.length})` : t('compareView')}
                </button>
                <button class="btn btn-secondary" onclick="addWorldBookVersion('${currentWorldBook.id}')">${t('addVersion')}</button>
                <button class="btn btn-secondary" onclick="copyWorldBook('${currentWorldBook.id}')">${t('copyWorldBook')}</button>
                <button class="btn btn-secondary" onclick="removeWorldBook('${currentWorldBook.id}')">${t('deleteWorldBook')}</button>
                <button class="btn btn-secondary" onclick="saveData(); showSaveNotification()">${t('save')}</button>
            </div>
        </div>

        <div class="versions-container ${viewMode}-view">
            ${versionsToShow.map(version => renderWorldBookVersionPanel(currentWorldBook, version)).join('')}
        </div>

        <div class="export-section">
            <h3>${t('exportWorldBook')}</h3>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportWorldBook('${currentWorldBook.id}')">${t('exportWorldBook')}</button>
            </div>
        </div>
    `;

    setTimeout(() => {
        updateStats();
        initAutoResize();
    }, 100);
}

// 渲染世界書版本面板
function renderWorldBookVersionPanel(worldBook, version) {
    return `
        <div class="version-panel">
            <div class="version-header">
                <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
                    <input type="text" class="version-title" value="${version.name}" 
                           onchange="updateWorldBookVersionName('${worldBook.id}', '${version.id}', this.value)"
                           style="font-size: 1.2em; font-weight: 600; margin: 0; padding: 8px 12px; border: 1px solid transparent; border-radius: 6px; background: transparent; color: var(--text-color); transition: all 0.2s ease;">
                    <div class="version-stats" id="worldbook-version-stats-${version.id}" style="font-size: 0.85em; color: var(--text-muted); padding-left: 12px;">
    ${(() => {
        const entryCount = version.entries.length;
        const allText = version.entries.map(entry => entry.content).filter(Boolean).join(' ');
        const chars = allText.length;
        const tokens = countTokens(allText);
        return `${entryCount} ${currentLang === 'zh' ? '個條目' : 'entries'} - ${chars} ${t('chars')} / ${tokens} ${t('tokens')}`;
    })()}
</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-small" onclick="copyWorldBookVersion('${worldBook.id}', '${version.id}')">${t('copy')}</button>
                    ${worldBook.versions.length > 1 ? `<button class="btn btn-secondary btn-small" onclick="removeWorldBookVersion('${worldBook.id}', '${version.id}')">${t('delete')}</button>` : ''}
                </div>
            </div>

            <!-- 條目列表 -->
            <div class="entries-container">
                <h4 style="margin-bottom: 16px; color: var(--text-color); display: flex; justify-content: space-between; align-items: center;">
                    ${t('entryName')} (${version.entries.length})
                    <button class="btn btn-secondary btn-small" onclick="addWorldBookEntry('${worldBook.id}', '${version.id}')">${t('addEntry')}</button>
                </h4>
                
                ${version.entries.map(entry => renderWorldBookEntry(worldBook.id, version.id, entry)).join('')}
            </div>
        </div>
    `;
}

// 渲染世界書條目
function renderWorldBookEntry(worldBookId, versionId, entry) {
    // 判斷狀態指示燈
    let statusIcon = '';
    if (entry.constant) {
        statusIcon = '🔵'; // 藍燈：常駐模式
    } else if (entry.vectorized) {
        statusIcon = '🔗'; // 鏈接：向量化模式
    } else {
        statusIcon = '🟢'; // 綠燈：選擇模式
    }

    return `
        <div class="entry-panel" data-entry-id="${entry.id}" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 16px; background: var(--bg-color);">
            <!-- 條目標題區 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h5 style="color: var(--text-color); margin: 0; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2em;">${statusIcon}</span>
                    條目 ${entry.uid || 0}
                    <label style="display: inline-flex; align-items: center; margin-left: 12px; cursor: pointer;">
                        <input type="checkbox" ${!entry.disable ? 'checked' : ''} 
                               onchange="toggleEntryEnabled('${worldBookId}', '${versionId}', '${entry.id}')"
                               style="margin-right: 6px;">
                        <span style="font-size: 0.9em; color: var(--text-muted);">啟用條目</span>
                    </label>
                </h5>
                <button class="btn btn-secondary btn-small" onclick="removeWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}')">刪除條目</button>
            </div>

            <!-- 基本設定 -->
            <div class="entry-section" style="margin-bottom: 20px;">
                <h6 style="color: var(--text-color); margin-bottom: 12px; font-size: 0.9em; text-transform: uppercase;">基本設定</h6>
                
                <!-- 第一行：備註、觸發模式、位置、深度 -->
                <div style="display: grid; grid-template-columns: 2fr 120px 160px 100px; gap: 12px; margin-bottom: 12px;">
                    <div class="field-group" style="margin-bottom: 0;">
                        <label class="field-label">備註</label>
                        <input type="text" class="field-input" 
                               placeholder="條目標題..."
                               value="${entry.comment || ''}"
                               onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'comment', this.value)">
                    </div>
                    <div class="field-group" style="margin-bottom: 0;">
                        <label class="field-label">觸發模式</label>
                        <select class="field-input" onchange="updateEntryModeFromSelect('${worldBookId}', '${versionId}', '${entry.id}', this.value)">
                            <option value="selective" ${entry.selective && !entry.constant && !entry.vectorized ? 'selected' : ''}>🟢</option>
                            <option value="constant" ${entry.constant ? 'selected' : ''}>🔵</option>
                            <option value="vectorized" ${entry.vectorized ? 'selected' : ''}>🔗</option>
                        </select>
                    </div>
                    <div class="field-group" style="margin-bottom: 0;">
                        <label class="field-label">位置</label>
                        <select class="field-input" onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'position', parseInt(this.value))">
                            <option value="0" ${entry.position === 0 ? 'selected' : ''}>Before Char Defs</option>
                            <option value="1" ${entry.position === 1 ? 'selected' : ''}>After Char Defs</option>
                            <option value="2" ${entry.position === 2 ? 'selected' : ''}>Top of Author's Note</option>
                            <option value="3" ${entry.position === 3 ? 'selected' : ''}>Bottom of Author's Note</option>
                            <option value="4" ${entry.position === 4 ? 'selected' : ''}>@ Depth</option>
                        </select>
                    </div>
                    <div class="field-group" style="margin-bottom: 0;">
                        <label class="field-label">深度</label>
                        <input type="number" class="field-input" value="${entry.depth || 4}" min="0" max="10"
                               onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'depth', parseInt(this.value))">
                    </div>
                </div>
                
                <!-- 關鍵字 -->
                <div class="field-group" style="margin-bottom: 12px;">
                    <label class="field-label">主要關鍵字</label>
                    <input type="text" class="field-input" 
                           placeholder="關鍵字，用逗號分隔..."
                           value="${entry.key.join(', ')}"
                           onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'key', this.value)">
                </div>

                <!-- 次要關鍵字 -->
                <div class="field-group" style="margin-bottom: 12px;">
                    <label class="field-label">副關鍵詞</label>
                    <input type="text" class="field-input" 
                           placeholder="次要關鍵字，用逗號分隔..."
                           value="${entry.keysecondary.join(', ')}"
                           onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'keysecondary', this.value)">
                </div>
                
                <!-- 內容 -->
                <div class="field-group" style="margin-bottom: 12px;">
    <label class="field-label">
        內容
        <span class="field-stats" data-target="worldbook-content-${entry.id}" style="margin-left: 12px; font-size: 0.85em; color: var(--text-muted);">0 ${t('chars')} / 0 ${t('tokens')}</span>
    </label>
    <textarea class="field-input scrollable" id="worldbook-content-${entry.id}" 
          placeholder="當觸發關鍵字時要插入的內容..."
          style="min-height: 120px; resize: vertical;"
          oninput="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'content', this.value); updateStats();">${entry.content}</textarea>
                </div>
            </div>

            <!-- 高級設定 -->
            <details style="margin-bottom: 20px;">
                <summary style="cursor: pointer; color: var(--text-color); font-weight: 500; margin-bottom: 12px;">高級設定</summary>
                <div style="padding: 12px 0; border-top: 1px solid var(--border-color);">
                    
                    <!-- 優先順序和機率 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">優先順序</label>
                            <input type="number" class="field-input" value="${entry.order || 100}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'order', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">觸發機率 (%)</label>
                            <input type="number" class="field-input" value="${entry.probability || 100}" min="1" max="100"
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'probability', parseInt(this.value))">
                        </div>
                    </div>

                    <!-- 分組設定 -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">分組</label>
                            <input type="text" class="field-input" value="${entry.group || ''}" 
                                   placeholder="分組名稱..."
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'group', this.value)">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">分組權重</label>
                            <input type="number" class="field-input" value="${entry.groupWeight || 100}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'groupWeight', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">掃描深度</label>
                            <input type="number" class="field-input" value="${entry.scanDepth || ''}" 
                                   placeholder="null"
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'scanDepth', this.value ? parseInt(this.value) : null)">
                        </div>
                    </div>

                    <!-- 開關選項 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.useProbability ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'useProbability', this.checked)">
                            <span style="margin-left: 6px;">使用機率</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.addMemo ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'addMemo', this.checked)">
                            <span style="margin-left: 6px;">添加備忘</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.groupOverride ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'groupOverride', this.checked)">
                            <span style="margin-left: 6px;">覆蓋分組</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.caseSensitive ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'caseSensitive', this.checked)">
                            <span style="margin-left: 6px;">區分大小寫</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.matchWholeWords ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'matchWholeWords', this.checked)">
                            <span style="margin-left: 6px;">匹配整詞</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.useGroupScoring ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'useGroupScoring', this.checked)">
                            <span style="margin-left: 6px;">使用分組評分</span>
                        </label>
                    </div>

                    <!-- 遞迴控制 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.excludeRecursion ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'excludeRecursion', this.checked)">
                            <span style="margin-left: 6px;">排除遞迴</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.preventRecursion ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'preventRecursion', this.checked)">
                            <span style="margin-left: 6px;">防止遞迴</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.delayUntilRecursion ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'delayUntilRecursion', this.checked)">
                            <span style="margin-left: 6px;">延遲至遞迴</span>
                        </label>
                    </div>

                    <!-- 其他設定 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">粘性</label>
                            <input type="number" class="field-input" value="${entry.sticky || 0}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'sticky', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">冷卻時間</label>
                            <input type="number" class="field-input" value="${entry.cooldown || 0}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'cooldown', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">延遲</label>
                            <input type="number" class="field-input" value="${entry.delay || 0}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'delay', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">自動化 ID</label>
                            <input type="text" class="field-input" value="${entry.automationId || ''}" 
                                   placeholder="自動化識別碼..."
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'automationId', this.value)">
                        </div>
                    </div>
                </div>
            </details>
        </div>
    `;
}

function updateEntryModeFromSelect(worldBookId, versionId, entryId, mode) {
    updateEntryMode(worldBookId, versionId, entryId, mode);
    // 不重新渲染，只更新狀態圖示
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                updateEntryStatusIcon(entryId, entry);
            }
        }
    }
}

function toggleLanguageMenu() {
    const menu = document.getElementById('lang-menu');
    const isVisible = menu.style.display !== 'none';
    
    if (isVisible) {
        menu.style.display = 'none';
    } else {
        menu.style.display = 'block';
        updateLanguageMenu();
    }
}
function updateLanguageMenu() {
    const options = document.querySelectorAll('.language-option');
    options.forEach(option => {
        const lang = option.getAttribute('onclick').match(/'(.+)'/)[1];
        if (lang === currentLang) {
            option.classList.add('active');
        } else {
            option.classList.remove('active');
        }
    });
}

function updateEntryMode(worldBookId, versionId, entryId, mode) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                // 重置所有模式
                entry.constant = false;
                entry.vectorized = false;
                entry.selective = true;
                
                // 設定選中的模式
                switch (mode) {
                    case 'constant':
                        entry.constant = true;
                        entry.selective = false;
                        break;
                    case 'vectorized':
                        entry.vectorized = true;
                        entry.selective = false;
                        break;
                    case 'selective':
                    default:
                        entry.selective = true;
                        break;
                }
                markAsChanged();
            }
        }
    }
}

function selectLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('characterCreatorLang', lang);
    
    // 隱藏選單
    document.getElementById('lang-menu').style.display = 'none';
    
    // 更新按鈕文字
    document.getElementById('lang-current').textContent = lang === 'zh' ? '中文' : 'English';
    
    renderAll(); // 這裡會觸發 updateSaveButtonStates()
}

        function renderVersionPanel(character, version) {
    return `
        <div class="version-panel">
           <div class="version-header">
    <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
        <input type="text" class="version-title" value="${version.name}" 
               onchange="updateVersionName('${character.id}', '${version.id}', this.value)"
               style="font-size: 1.2em; font-weight: 600; margin: 0; padding: 8px 12px; border: 1px solid transparent; border-radius: 6px; background: transparent; color: var(--text-color); transition: all 0.2s ease;">
        <div class="version-stats" id="version-stats-${version.id}" style="font-size: 0.85em; color: var(--text-muted); padding-left: 12px;">
            ${t('versionStats', 0, 0)}
        </div>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="btn btn-secondary btn-small" onclick="copyVersion('${character.id}', '${version.id}')">${t('copy')}</button>
        ${character.versions.length > 1 ? `<button class="btn btn-secondary btn-small" onclick="removeVersion('${character.id}', '${version.id}')">${t('delete')}</button>` : ''}
    </div>
</div>

            <div class="character-basic-info">
    <div class="avatar-section">
        <div class="avatar-preview" onclick="triggerImageUpload('${character.id}', '${version.id}')" style="cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            ${version.avatar ? `<img src="${version.avatar}" alt="Avatar">` : `<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 0.9em; text-align: center;"><div style="font-size: 2em; margin-bottom: 8px;">📷</div><div>點擊上傳圖片</div></div>`}
        </div>
        <input type="file" class="file-input" id="avatar-upload-${version.id}" accept="image/*" 
               onchange="handleImageUpload('${character.id}', '${version.id}', this.files[0])">
    </div>
    
    <div class="basic-info-fields">
        <!-- 第一行：創作者 + 角色版本 -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="field-group" style="margin-bottom: 0;">
                <label class="field-label">
                    ${t('creator')}
                    <span class="field-stats" data-target="creator-${version.id}">0 ${t('chars')}</span>
                </label>
                <input type="text" class="field-input" id="creator-${version.id}" 
                       placeholder="${t('creatorPlaceholder')}"
                       oninput="updateField('${character.id}', '${version.id}', 'creator', this.value); updateStats()" 
                       value="${version.creator || ''}">
            </div>

            <div class="field-group" style="margin-bottom: 0;">
                <label class="field-label">
                    ${t('charVersion')}
                    <span class="field-stats" data-target="charVersion-${version.id}">0 ${t('chars')}</span>
                </label>
                <input type="text" class="field-input" id="charVersion-${version.id}" 
                       placeholder="${t('versionPlaceholder')}"
                       oninput="updateField('${character.id}', '${version.id}', 'charVersion', this.value); updateStats()" 
                       value="${version.charVersion || ''}">
            </div>
        </div>

        <!-- 第二行：創作者備註（獨立一行，較高的文字框） -->
        <div class="field-group" style="margin-bottom: 20px;">
            <label class="field-label">
                ${t('creatorNotes')}
                <span class="field-stats" data-target="creatorNotes-${version.id}">0 ${t('chars')}</span>
            </label>
            <textarea class="field-input" id="creatorNotes-${version.id}" 
                      placeholder="${t('notesPlaceholder')}"
                      style="min-height: 60px; resize: vertical;"
                      oninput="updateField('${character.id}', '${version.id}', 'creatorNotes', this.value); updateStats()">${version.creatorNotes || ''}</textarea>
        </div>

        <!-- 第三行：嵌入標籤（獨立一行，拉長） -->
        <div class="field-group" style="margin-bottom: 0;">
            <label class="field-label">
                ${t('tags')}
                <span class="field-stats" data-target="tags-${version.id}">0 ${t('chars')}</span>
            </label>
            <input type="text" class="field-input" id="tags-${version.id}" 
                   placeholder="${t('tagsPlaceholder')}"
                   oninput="updateField('${character.id}', '${version.id}', 'tags', this.value); updateStats()" 
                   value="${version.tags || ''}">
        </div>
    </div>
</div>

            <div class="field-group">
                <label class="field-label">
                    ${t('description')}
                    <span class="field-stats" data-target="desc-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="desc-${version.id}" 
          placeholder="${t('descPlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'description', this.value); updateStats(); autoResizeTextarea(this);">${version.description}</textarea>

            </div>

            <div class="field-group">
                <label class="field-label">
                    ${t('personality')}
                    <span class="field-stats" data-target="personality-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="personality-${version.id}" 
          placeholder="${t('personalityPlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'personality', this.value); updateStats(); autoResizeTextarea(this);">${version.personality}</textarea>

            </div>

            <div class="field-group">
                <label class="field-label">
                    ${t('scenario')}
                    <span class="field-stats" data-target="scenario-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="scenario-${version.id}" 
          placeholder="${t('scenarioPlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'scenario', this.value); updateStats(); autoResizeTextarea(this);">${version.scenario}</textarea>

            </div>

            <div class="field-group">
                <label class="field-label">
                    ${t('dialogue')}
                    <span class="field-stats" data-target="dialogue-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="dialogue-${version.id}" 
          placeholder="${t('dialoguePlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'dialogue', this.value); updateStats(); autoResizeTextarea(this);">${version.dialogue}</textarea>

            </div>

            <div class="field-group">
                <label class="field-label">
                    ${t('firstMessage')}
                    <span class="field-stats" data-target="firstmsg-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="firstmsg-${version.id}" 
          placeholder="${t('firstMsgPlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'firstMessage', this.value); updateStats(); autoResizeTextarea(this);">${version.firstMessage}</textarea>

            </div>
        </div>
    `;
}

        function renderAll() {
            renderSidebar();
            renderContent();
            updateTotalStats();
            updateLanguageUI();
            updateSaveButtonStates();
        }
function updateLanguageUI() {
    // 更新標題和副標題
    document.querySelector('.app-title').textContent = t('appTitle');
    document.querySelector('.app-subtitle').textContent = t('appSubtitle');
    
    // 更新按鈕文字
    document.querySelector('button[onclick="showColorPicker()"]').textContent = t('customColor');
    document.querySelector('button[onclick="exportAllData()"]').textContent = t('exportData');
    document.querySelector('button[onclick="importAllData()"]').textContent = t('importData');
    
    // 更新語言按鈕文字
    const langCurrent = document.getElementById('lang-current');
    if (langCurrent) {
        langCurrent.textContent = currentLang === 'zh' ? '中文' : 'English';
    }
    
    // 確保按鈕狀態正確顯示
    updateSaveButtonStates();
}

function triggerImageUpload(characterId, versionId) {
    document.getElementById(`avatar-upload-${versionId}`).click();
}

       function updateTotalStats() {
    if (currentMode === 'character') {
        const currentCharacter = characters.find(c => c.id === currentCharacterId);
        if (!currentCharacter) return;

        if (viewMode === 'compare') {
            // 對比模式：顯示每個版本的詳細統計
            const versionsToCount = currentCharacter.versions.filter(v => compareVersions.includes(v.id));
            
            let statsHTML = '';
            versionsToCount.forEach(version => {
                const allText = [
                    version.description, version.personality, version.scenario, 
                    version.dialogue, version.firstMessage
                ].join(' ');
                
                const chars = allText.length;
                const tokens = countTokens(allText);
                
                statsHTML += `<div>${version.name} - ${chars} ${t('chars')} / ${tokens} ${t('tokens')}</div>`;
            });
            
            // 更新總計區域的HTML結構
            const statsBar = document.querySelector('.stats-bar .total-stats');
            if (statsBar) {
                statsBar.innerHTML = `
                    <div style="font-weight: 600; font-size: 1.1em; color: var(--text-color); margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;">${t('total')}</div>
                    ${statsHTML}
                `;
            }
        } else {
            // 單一檢視：顯示單個版本統計
            let totalChars = 0;
            let totalTokens = 0;
            
            const versionsToCount = currentCharacter.versions.filter(v => v.id === currentVersionId);

            versionsToCount.forEach(version => {
                const allText = [
                    version.description, version.personality, version.scenario, 
                    version.dialogue, version.firstMessage
                ].join(' ');

                totalChars += allText.length;
                totalTokens += countTokens(allText);
            });

            // 恢復原本的顯示方式
            const statsBar = document.querySelector('.stats-bar .total-stats');
            if (statsBar) {
                statsBar.innerHTML = `${t('total')} - <span id="total-chars">${totalChars}</span> ${t('chars')} / <span id="total-tokens">${totalTokens}</span> ${t('tokens')}`;
            }
        }
    } else if (currentMode === 'custom') {
        // 自定義模式的統計
        const currentSection = customSections.find(s => s.id === currentCustomSectionId);
        if (!currentSection) return;

        if (viewMode === 'compare') {
            // 對比模式
            const versionsToCount = currentSection.versions.filter(v => compareVersions.includes(v.id));
            
            let statsHTML = '';
            versionsToCount.forEach(version => {
                const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
                const chars = allText.length;
                const tokens = countTokens(allText);
                
                statsHTML += `<div>${version.name} - ${chars} ${t('chars')} / ${tokens} ${t('tokens')}</div>`;
            });
            
            const statsBar = document.querySelector('.stats-bar .total-stats');
            if (statsBar) {
                statsBar.innerHTML = `
                    <div style="font-weight: 600; font-size: 1.1em; color: var(--text-color); margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;">${t('total')}</div>
                    ${statsHTML}
                `;
            }
        } else {
            // 單一檢視
            let totalChars = 0;
            let totalTokens = 0;
            
            const versionsToCount = currentSection.versions.filter(v => v.id === currentCustomVersionId);

            versionsToCount.forEach(version => {
                const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
                totalChars += allText.length;
                totalTokens += countTokens(allText);
            });

            const statsBar = document.querySelector('.stats-bar .total-stats');
            if (statsBar) {
                statsBar.innerHTML = `${t('total')} - <span id="total-chars">${totalChars}</span> ${t('chars')} / <span id="total-tokens">${totalTokens}</span> ${t('tokens')}`;
            }
        }
    }
}

        function exportJSON(characterId) {
    const character = characters.find(c => c.id === characterId);
    if (!character) return;

    if (character.versions.length === 1) {
        downloadJSON(character, character.versions[0]);
    } else {
        const versionIndex = prompt(t('selectVersion', character.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < character.versions.length) {
            downloadJSON(character, character.versions[index]);
        }
    }
}

        function downloadJSON(character, version) {
            const characterData = {
                name: character.name,
                description: version.description,
                personality: version.personality,
                scenario: version.scenario,
                first_mes: version.firstMessage,
                mes_example: version.dialogue,
                creatorcomment: version.creatorNotes,
                avatar: "none",
                talkativeness: "0.5",
                fav: false,
                tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                spec: "chara_card_v3",
                spec_version: "3.0",
                data: {
                    name: character.name,
                    description: version.description,
                    personality: version.personality,
                    scenario: version.scenario,
                    first_mes: version.firstMessage,
                    mes_example: version.dialogue,
                    creator_notes: version.creatorNotes,
                    system_prompt: "",
                    post_history_instructions: "",
                    tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    creator: version.creator,
                    character_version: version.charVersion,
                    alternate_greetings: [],
                    extensions: {
                        talkativeness: "0.5",
                        fav: false,
                        world: "",
                        depth_prompt: {
                            prompt: "",
                            depth: 4,
                            role: "system"
                        }
                    },
                    group_only_greetings: []
                },
                create_date: new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
            };

            const blob = new Blob([JSON.stringify(characterData, null, 4)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportPNG(characterId) {
    const character = characters.find(c => c.id === characterId);
    if (!character) return;

    // 選擇版本
    let selectedVersion;
    if (character.versions.length === 1) {
        selectedVersion = character.versions[0];
    } else {
        const versionIndex = prompt(t('selectVersion', character.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < character.versions.length) {
            selectedVersion = character.versions[index];
        } else {
            return;
        }
    }

            // 創建與JSON相同的資料結構
            const characterData = {
                name: character.name,
                description: selectedVersion.description,
                personality: selectedVersion.personality,
                scenario: selectedVersion.scenario,
                first_mes: selectedVersion.firstMessage,
                mes_example: selectedVersion.dialogue,
                creatorcomment: selectedVersion.creatorNotes,
                avatar: "none",
                talkativeness: "0.5",
                fav: false,
                tags: selectedVersion.tags ? selectedVersion.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                spec: "chara_card_v3",
                spec_version: "3.0",
                data: {
                    name: character.name,
                    description: selectedVersion.description,
                    personality: selectedVersion.personality,
                    scenario: selectedVersion.scenario,
                    first_mes: selectedVersion.firstMessage,
                    mes_example: selectedVersion.dialogue,
                    creator_notes: selectedVersion.creatorNotes,
                    system_prompt: "",
                    post_history_instructions: "",
                    tags: selectedVersion.tags ? selectedVersion.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    creator: selectedVersion.creator,
                    character_version: selectedVersion.charVersion,
                    alternate_greetings: [],
                    extensions: {
                        talkativeness: "0.5",
                        fav: false,
                        world: "",
                        depth_prompt: {
                            prompt: "",
                            depth: 4,
                            role: "system"
                        }
                    },
                    group_only_greetings: []
                },
                create_date: new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
            };

            // 將JSON轉為Base64
            const jsonString = JSON.stringify(characterData);
            const base64Data = btoa(unescape(encodeURIComponent(jsonString)));

            // 創建或使用現有的頭像圖片
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            if (selectedVersion.avatar) {
                // 如果有頭像，使用頭像作為PNG圖片
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // 嵌入chara metadata並下載
                    createPNGWithMetadata(canvas, base64Data, character.name);
                };
                img.src = selectedVersion.avatar;
            } else {
                // 如果沒有頭像，創建預設圖片
                canvas.width = 400;
                canvas.height = 600;
                
                // 創建漸層背景
                const gradient = ctx.createLinearGradient(0, 0, 0, 600);
                gradient.addColorStop(0, '#f7f5f3');
                gradient.addColorStop(1, '#e2e8f0');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 600);
                
                // 添加角色名稱
                ctx.fillStyle = '#2d3748';
                ctx.font = 'bold 24px "Noto Serif CJK JP", serif';
                ctx.textAlign = 'center';
                ctx.fillText(character.name, 200, 300);
                
                // 添加副標題
                ctx.font = '16px "Noto Serif CJK JP", serif';
                ctx.fillStyle = '#718096';
                ctx.fillText('Character Card', 200, 330);
                
                // 嵌入chara metadata並下載
                createPNGWithMetadata(canvas, base64Data, character.name);
            }
        }

        function createPNGWithMetadata(canvas, base64Data, characterName, callback) {
    // 將Canvas轉為ImageData
    canvas.toBlob(function(blob) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const arrayBuffer = e.target.result;
            const uint8Array = new Uint8Array(arrayBuffer);
            
            // 在PNG中嵌入tEXt chunk with "chara" keyword
            const modifiedPNG = addTextChunkToPNG(uint8Array, 'chara', base64Data);
            
            // 下載修改後的PNG
            const modifiedBlob = new Blob([modifiedPNG], { type: 'image/png' });
            const url = URL.createObjectURL(modifiedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${characterName}.png`;
            a.click();
            URL.revokeObjectURL(url);
            
            // 呼叫回調函數（如果有提供）
            if (callback) {
                setTimeout(callback, 100);
            }
        };
        reader.readAsArrayBuffer(blob);
    }, 'image/png');
}

        function addTextChunkToPNG(pngData, keyword, text) {
            // PNG檔案結構：8位元組PNG簽名 + 數個chunks + IEND chunk
            const signature = pngData.slice(0, 8);
            let pos = 8;
            const chunks = [];
            
            // 讀取所有現有的chunks
            while (pos < pngData.length) {
                const length = (pngData[pos] << 24) | (pngData[pos + 1] << 16) | (pngData[pos + 2] << 8) | pngData[pos + 3];
                const type = String.fromCharCode(pngData[pos + 4], pngData[pos + 5], pngData[pos + 6], pngData[pos + 7]);
                const chunkData = pngData.slice(pos, pos + 12 + length);
                
                chunks.push(chunkData);
                
                if (type === 'IEND') break;
                pos += 12 + length;
            }
            
            // 創建tEXt chunk
            const keywordBytes = new TextEncoder().encode(keyword);
            const textBytes = new TextEncoder().encode(text);
            const chunkData = new Uint8Array(keywordBytes.length + 1 + textBytes.length);
            chunkData.set(keywordBytes, 0);
            chunkData[keywordBytes.length] = 0; // null separator
            chunkData.set(textBytes, keywordBytes.length + 1);
            
            // 計算CRC
            const crc = calculateCRC32([0x74, 0x45, 0x58, 0x74, ...chunkData]); // "tEXt" + data
            
            // 組裝tEXt chunk
            const textChunk = new Uint8Array(12 + chunkData.length);
            const lengthBytes = [(chunkData.length >>> 24) & 0xFF, (chunkData.length >>> 16) & 0xFF, (chunkData.length >>> 8) & 0xFF, chunkData.length & 0xFF];
            textChunk.set(lengthBytes, 0);
            textChunk.set([0x74, 0x45, 0x58, 0x74], 4); // "tEXt"
            textChunk.set(chunkData, 8);
            textChunk.set([(crc >>> 24) & 0xFF, (crc >>> 16) & 0xFF, (crc >>> 8) & 0xFF, crc & 0xFF], 8 + chunkData.length);
            
            // 重新組裝PNG：簽名 + 原有chunks (除了IEND) + tEXt chunk + IEND
            const iendChunk = chunks.pop(); // 移除IEND
            const totalLength = signature.length + chunks.reduce((sum, chunk) => sum + chunk.length, 0) + textChunk.length + iendChunk.length;
            const result = new Uint8Array(totalLength);
            
            let offset = 0;
            result.set(signature, offset);
            offset += signature.length;
            
            for (const chunk of chunks) {
                result.set(chunk, offset);
                offset += chunk.length;
            }
            
            result.set(textChunk, offset);
            offset += textChunk.length;
            
            result.set(iendChunk, offset);
            
            return result;
        }

        function calculateCRC32(data) {
            const crcTable = [];
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) {
                    if (c & 1) {
                        c = 0xEDB88320 ^ (c >>> 1);
                    } else {
                        c = c >>> 1;
                    }
                }
                crcTable[i] = c;
            }
            
            let crc = 0xFFFFFFFF;
            for (let i = 0; i < data.length; i++) {
                crc = crcTable[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
            }
            return (crc ^ 0xFFFFFFFF) >>> 0;
        }

        function exportAllVersions(characterId) {
    const character = characters.find(c => c.id === characterId);
    if (!character) return;

    // 顯示格式選擇對話框
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${t('exportAllTitle')}</h3>
                <button class="close-modal" onclick="this.closest('.modal').remove()">×</button>
            </div>
            
            <p style="margin-bottom: 20px; color: var(--text-muted); font-size: 0.9em;">
                ${t('exportAllDesc', character.name, character.versions.length)}
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
                <div class="format-option" onclick="selectExportFormat('json')" data-format="json">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                        <input type="radio" name="export-format" value="json" style="margin: 0;">
                        <div>
                            <strong>${t('jsonFormat')}</strong>
                            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 4px;">
                                ${t('jsonDesc')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="format-option" onclick="selectExportFormat('png')" data-format="png">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                        <input type="radio" name="export-format" value="png" style="margin: 0;">
                        <div>
                            <strong>${t('pngFormat')}</strong>
                            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 4px;">
                                ${t('pngDesc')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">${t('cancel')}</button>
                <button class="btn btn-primary" onclick="startBatchExport('${characterId}')" id="start-export" disabled>${t('startExport')}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 點擊外部關閉
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
let selectedExportFormat = null;

function selectExportFormat(format) {
    selectedExportFormat = format;
    
    // 更新選中狀態
    document.querySelectorAll('.format-option').forEach(option => {
        const container = option.querySelector('div');
        const radio = option.querySelector('input[type="radio"]');
        
        if (option.dataset.format === format) {
            container.style.borderColor = 'var(--primary-color)';
            container.style.backgroundColor = 'var(--bg-color)';
            radio.checked = true;
        } else {
            container.style.borderColor = 'var(--border-color)';
            container.style.backgroundColor = 'transparent';
            radio.checked = false;
        }
    });
    
    // 啟用開始匯出按鈕
    document.getElementById('start-export').disabled = false;
}

function startBatchExport(characterId) {
    if (!selectedExportFormat) return;
    
    const character = characters.find(c => c.id === characterId);
    if (!character) return;
    
    // 關閉對話框
    document.querySelector('.modal').remove();
    
    // 顯示進度提示
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 500;
        z-index: 9999;
        box-shadow: var(--shadow-large);
        max-width: 300px;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <div>
                <div>${t('exporting', character.versions.length)}</div>
                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 4px;" id="export-progress">${t('preparing')}</div>
            </div>
        </div>
    `;
    
    // 添加旋轉動畫
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // 開始批次匯出
    if (selectedExportFormat === 'json') {
        exportAllVersionsJSON(character, notification);
    } else {
        exportAllVersionsPNG(character, notification);
    }
    
    // 重置選擇
    selectedExportFormat = null;
}

function exportAllVersionsJSON(character, notification) {
    const progressElement = notification.querySelector('#export-progress');
    
    character.versions.forEach((version, index) => {
        setTimeout(() => {
            progressElement.textContent = `JSON ${index + 1}/${character.versions.length}: ${version.name}`;
            downloadJSON(character, version);
            
            // 最後一個檔案匯出完成
            if (index === character.versions.length - 1) {
                setTimeout(() => {
                    notification.remove();
                    showCompletionNotification(character.versions.length, 'JSON');
                }, 500);
            }
        }, index * 300); // 每個檔案間隔300ms
    });
}

function exportAllVersionsPNG(character, notification) {
    const progressElement = notification.querySelector('#export-progress');
    let completed = 0;
    
    character.versions.forEach((version, index) => {
        setTimeout(() => {
            progressElement.textContent = `PNG ${index + 1}/${character.versions.length}: ${version.name}`;
            
            // 為PNG匯出創建特殊的完成回調
            exportVersionPNG(character, version, () => {
                completed++;
                if (completed === character.versions.length) {
                    notification.remove();
                    showCompletionNotification(character.versions.length, 'PNG');
                }
            });
        }, index * 800); // PNG需要更長間隔，因為處理時間較長
    });
}

function exportVersionPNG(character, version, callback) {
    // 創建與原exportPNG相同的資料結構
    const characterData = {
        name: character.name,
        description: version.description,
        personality: version.personality,
        scenario: version.scenario,
        first_mes: version.firstMessage,
        mes_example: version.dialogue,
        creatorcomment: version.creatorNotes,
        avatar: "none",
        talkativeness: "0.5",
        fav: false,
        tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
        spec: "chara_card_v3",
        spec_version: "3.0",
        data: {
            name: character.name,
            description: version.description,
            personality: version.personality,
            scenario: version.scenario,
            first_mes: version.firstMessage,
            mes_example: version.dialogue,
            creator_notes: version.creatorNotes,
            system_prompt: "",
            post_history_instructions: "",
            tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
            creator: version.creator,
            character_version: version.charVersion,
            alternate_greetings: [],
            extensions: {
                talkativeness: "0.5",
                fav: false,
                world: "",
                depth_prompt: {
                    prompt: "",
                    depth: 4,
                    role: "system"
                }
            },
            group_only_greetings: []
        },
        create_date: new Date().toLocaleString('zh-TW', {
            year: 'numeric',
            month: 'numeric', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
    };

    // 將JSON轉為Base64
    const jsonString = JSON.stringify(characterData);
    const base64Data = btoa(unescape(encodeURIComponent(jsonString)));

    // 創建或使用現有的頭像圖片
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    if (version.avatar) {
        // 如果有頭像，使用頭像作為PNG圖片
        const img = new Image();
        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            // 嵌入chara metadata並下載
            createPNGWithMetadata(canvas, base64Data, `${character.name}_${version.name}`, callback);
        };
        img.src = version.avatar;
    } else {
        // 如果沒有頭像，創建預設圖片
        canvas.width = 400;
        canvas.height = 600;
        
        // 創建漸層背景
        const gradient = ctx.createLinearGradient(0, 0, 0, 600);
        gradient.addColorStop(0, '#f7f5f3');
        gradient.addColorStop(1, '#e2e8f0');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 400, 600);
        
        // 添加角色名稱
        ctx.fillStyle = '#2d3748';
        ctx.font = 'bold 24px "Noto Serif CJK JP", serif';
        ctx.textAlign = 'center';
        ctx.fillText(character.name, 200, 280);
        
        // 添加版本名稱
        ctx.font = '18px "Noto Serif CJK JP", serif';
        ctx.fillStyle = '#718096';
        ctx.fillText(version.name, 200, 310);
        
        // 添加副標題
        ctx.font = '16px "Noto Serif CJK JP", serif';
        ctx.fillText('Character Card', 200, 340);
        
        // 嵌入chara metadata並下載
        createPNGWithMetadata(canvas, base64Data, `${character.name}_${version.name}`, callback);
    }
}

function showCompletionNotification(count, format) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 500;
        z-index: 9999;
        box-shadow: var(--shadow-large);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    notification.innerHTML = t('exportComplete', count, format);
    
    document.body.appendChild(notification);
    
    // 滑入動畫
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // 3秒後移除
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

        function importCharacter() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            if (file.type === 'application/json' || file.name.endsWith('.json')) {
                // 處理JSON檔案
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        importCharacterFromData(data);
                    } catch (error) {
                        alert('JSON檔案格式錯誤，請確認是有效的角色卡檔案');
                    }
                };
                reader.readAsText(file);
           } else if (file.type === 'image/png' || file.name.endsWith('.png')) {
    // 處理PNG檔案
    const readerForBuffer = new FileReader();
    readerForBuffer.onload = function(e) {
        try {
            const arrayBuffer = e.target.result;
            const charaData = extractCharaFromPNG(new Uint8Array(arrayBuffer));

            if (charaData) {
                const jsonString = atob(charaData);
                const data = JSON.parse(decodeURIComponent(escape(jsonString)));

                // 再開一個 FileReader 讀 base64 圖片
                const readerForImage = new FileReader();
                readerForImage.onload = function(ev) {
                    data.avatar = ev.target.result; // base64 格式
                    console.log("base64 avatar:", data.avatar);
                    importCharacterFromData(data);
                };
                readerForImage.readAsDataURL(file); // 讀成 base64
            } else {
                alert('PNG檔案中未找到角色資料，請確認這是有效的角色卡PNG檔案');
            }
        } catch (error) {
            alert('PNG檔案讀取失敗：' + error.message);
        }
    };
    readerForBuffer.readAsArrayBuffer(file);
        }else {
                alert('請選擇JSON或PNG格式的角色卡檔案');
            }
        }

        function extractCharaFromPNG(pngData) {
            // 跳過PNG簽名
            let pos = 8;
            
            while (pos < pngData.length) {
                // 讀取chunk長度
                const length = (pngData[pos] << 24) | (pngData[pos + 1] << 16) | (pngData[pos + 2] << 8) | pngData[pos + 3];
                
                // 讀取chunk類型
                const type = String.fromCharCode(pngData[pos + 4], pngData[pos + 5], pngData[pos + 6], pngData[pos + 7]);
                
                if (type === 'tEXt') {
                    // 讀取tEXt chunk的資料
                    const textData = pngData.slice(pos + 8, pos + 8 + length);
                    
                    // 尋找null分隔符
                    let nullPos = -1;
                    for (let i = 0; i < textData.length; i++) {
                        if (textData[i] === 0) {
                            nullPos = i;
                            break;
                        }
                    }
                    
                    if (nullPos !== -1) {
                        // 提取keyword和text
                        const keyword = new TextDecoder().decode(textData.slice(0, nullPos));
                        const text = new TextDecoder().decode(textData.slice(nullPos + 1));
                        
                        if (keyword === 'chara') {
                            return text;
                        }
                    }
                }
                
                if (type === 'IEND') break;
                pos += 12 + length;
            }
            
            return null;
        }

        function importCharacterFromData(data) {
    const character = {
        id: generateId(),
        name: data.name || 'Imported Character',
        versions: [{
            id: generateId(),
            name: 'Imported Version',
            avatar: data.avatar && data.avatar !== 'none' ? data.avatar : '',
            creator: data.data?.creator || data.creator || '',
            charVersion: data.data?.character_version || data.character_version || '',
            creatorNotes: data.data?.creator_notes || data.creatorcomment || '',
            tags: Array.isArray(data.tags) ? data.tags.join(', ') : (data.data?.tags ? data.data.tags.join(', ') : ''),
            description: data.data?.description || data.description || '',
            personality: data.data?.personality || data.personality || '',
            scenario: data.data?.scenario || data.scenario || '',
            dialogue: data.data?.mes_example || data.mes_example || '',
            firstMessage: data.data?.first_mes || data.first_mes || ''
        }]
    };
    characters.push(character);
    currentCharacterId = character.id;
    currentVersionId = character.versions[0].id;
    renderAll();
    markAsChanged(); // 標記有變更
    alert(t('importSuccess'));
}

document.addEventListener('click', function(e) {
            const langContainer = document.querySelector('.language-menu-container');
            const langMenu = document.getElementById('lang-menu');
            
            if (langContainer && !langContainer.contains(e.target) && langMenu) {
                langMenu.style.display = 'none';
            }
        });

        // 初始化應用程式
        function initApp() {
            // 在 initApp 函數中，找到載入自訂顏色的部分
const savedColors = localStorage.getItem('characterCreatorCustomColors');
if (savedColors) {
    const colors = JSON.parse(savedColors);
    const root = document.documentElement;
    root.style.setProperty('--primary-color', colors.primary);
    root.style.setProperty('--secondary-color', colors.secondary);
    root.style.setProperty('--accent-color', colors.accent);
    root.style.setProperty('--bg-color', colors.bg);
    if (colors.surface) {
        root.style.setProperty('--surface-color', colors.surface);
    }
    if (colors.textColor) {
        root.style.setProperty('--text-color', colors.textColor);
    }
    if (colors.textMuted) {
        root.style.setProperty('--text-muted', colors.textMuted);
    }
    // 新增：載入邊框顏色
if (colors.borderColor) {
    root.style.setProperty('--border-color', colors.borderColor);
}
    // 新增：載入界面色彩
    if (colors.headerBg) {
    root.style.setProperty('--header-bg', colors.headerBg);
}
if (colors.sidebarBg) {
    root.style.setProperty('--sidebar-bg', colors.sidebarBg);
}
if (colors.mainContentBg) {
    root.style.setProperty('--main-content-bg', colors.mainContentBg);
}
if (colors.contentBg) {
    root.style.setProperty('--content-bg', colors.contentBg);
}
}

// 離開頁面前的警告：
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        const message = currentLang === 'zh' ? 
            '你有未儲存的變更，確定要離開嗎？' : 
            'You have unsaved changes. Are you sure you want to leave?';
        
        e.preventDefault();
        e.returnValue = message; // 標準方式
        return message; // 某些瀏覽器需要
    }
});

            // 使用CSS預設值，不需要額外設定

            // 載入角色資料
loadData();

// 如果沒有角色，創建預設角色
if (characters.length === 0) {
    addCharacter();
}

// 如果沒有自定義區塊，創建預設區塊
if (customSections.length === 0) {
    // 不自動創建，讓用戶手動新增
}

// 確保有正確的初始狀態
if (!currentMode) {
    currentMode = 'character';
}

renderAll();

             updateLanguageUI();
             updateSaveButtonStates();

            // 定期更新統計
            setInterval(updateTotalStats, 2000);

            // 響應式處理
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('show');
                }
            });
        }

        // 啟動應用程式
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
