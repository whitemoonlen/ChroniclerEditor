// è¨ˆç®—åŸå§‹åœ–ç‰‡çš„ç¸®æ”¾æ¯”ä¾‹
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è¨­å®šè¼¸å‡ºå°ºå¯¸ï¼ˆä¿æŒ2:3æ¯”ä¾‹ï¼‰
            const outputWidth = 400;
            const outputHeight = 600;
            canvas.width = outputWidth;
            canvas.height = outputHeight;
            
            // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
            const scaleX = img.naturalWidth / img.offsetWidth;
            const scaleY = img.naturalHeight / img.offsetHeight;
            
            // ç¹ªè£½è£å‰ªå¾Œçš„åœ–ç‰‡
            ctx.drawImage(
                img,
                cropX * scaleX,
                cropY * scaleY,
                cropWidth * scaleX,
                cropHeight * scaleY,
                0,
                0,
                outputWidth,
                outputHeight
            );
            
            // è½‰ç‚ºbase64
            const croppedImageData = canvas.toDataURL('image/png', 0.9);
            
            // åŸ·è¡Œå›èª¿
            if (window.currentCropCallback) {
                window.currentCropCallback(croppedImageData);
                window.currentCropCallback = null;
            }
            
            // é—œé–‰å½ˆçª—
            document.querySelector('.crop-modal').remove();
        }

        function updateStats() {
            const statsElements = document.querySelectorAll('.field-stats');
            statsElements.forEach(element => {
                const textareaId = element.dataset.target;
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    const text = textarea.value;
                    const charCount = text.length;
                    const tokenCount = countTokens(text);
                    element.textContent = `${charCount} å­— / ${tokenCount} tokens`;
                }
            });

            // æ›´æ–°metaæ¬„ä½çš„çµ±è¨ˆ
            const metaElements = document.querySelectorAll('.meta-field-input');
            metaElements.forEach(element => {
                const text = element.value;
                const charCount = text.length;
                const tokenCount = countTokens(text);
                // å¯ä»¥é¸æ“‡æ˜¯å¦é¡¯ç¤ºmetaæ¬„ä½çš„çµ±è¨ˆï¼Œé€™è£¡å…ˆä¿æŒç°¡æ½”
            });
        }

        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            container.innerHTML = characters.map(character => `
                <div class="character-item">
                    <div class="character-header ${character.id === currentCharacterId && document.getElementById(\`versions-\${character.id}\`)?.classList.contains('expanded') ? 'expanded' : (character.id === currentCharacterId ? 'active' : '')}" 
                         onclick="toggleCharacterVersions('${character.id}')">
                        <span>${character.name}</span>
                        <span style="font-size: 0.8em; opacity: 0.7;">${character.versions.length}</span>
                    </div>
                    <div class="version-list" id="versions-${character.id}">
                        ${character.versions.map(version => `
                            <div class="version-item ${version.id === currentVersionId ? 'active' : ''}" 
                                 onclick="selectVersion('${character.id}', '${version.id}')">
                                ${version.name}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleCharacterVersions(characterId) {
            selectCharacter(characterId);
            
            // åˆ‡æ›ç‰ˆæœ¬åˆ—è¡¨çš„é¡¯ç¤ºç‹€æ…‹
            const versionsList = document.getElementById(`versions-${characterId}`);
            const characterHeader = document.querySelector(`[onclick="toggleCharacterVersions('${characterId}')"]`);
            
            if (versionsList && characterHeader) {
                const isExpanded = versionsList.classList.contains('expanded');
                
                // é—œé–‰æ‰€æœ‰å…¶ä»–å±•é–‹çš„ç‰ˆæœ¬åˆ—è¡¨
                document.querySelectorAll('.version-list').forEach(list => {
                    list.classList.remove('expanded');
                });
                document.querySelectorAll('.character-header').forEach(header => {
                    header.classList.remove('expanded');
                });
                
                // åˆ‡æ›ç•¶å‰çš„ç‹€æ…‹
                if (!isExpanded) {
                    versionsList.classList.add('expanded');
                    characterHeader.classList.add('expanded');
                }
            }
        }

        function renderContent() {
            const container = document.getElementById('contentArea');
            const currentCharacter = characters.find(c => c.id === currentCharacterId);
            
            if (!currentCharacter) {
                container.innerHTML = '<div style="text-align: center; padding: 80px; color: var(--text-muted);">è«‹é¸æ“‡ä¸€å€‹è§’è‰²</div>';
                return;
            }

            const versionsToShow = viewMode === 'compare' ? 
                currentCharacter.versions.filter(v => compareVersions.includes(v.id)) : 
                currentCharacter.versions.filter(v => v.id === currentVersionId);

            container.innerHTML = `
                <div class="view-controls">
                    <button class="btn ${viewMode === 'single' ? 'btn-primary' : 'btn-secondary'}" onclick="viewMode='single'; compareVersions=[]; renderAll()">å–®ä¸€æª¢è¦–</button>
                    <button class="btn ${viewMode === 'compare' ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCompareMode()">
                        ${viewMode === 'compare' ? `å°æ¯”æª¢è¦– (${compareVersions.length})` : 'å°æ¯”æª¢è¦–'}
                    </button>
                    <button class="btn btn-secondary" onclick="addVersion('${currentCharacter.id}')">æ–°å¢ç‰ˆæœ¬</button>
                    <input type="text" class="field-input" style="width: 200px; margin: 0;" value="${currentCharacter.name}" 
                           onchange="updateCharacterName('${currentCharacter.id}', this.value)" placeholder="è§’è‰²åç¨±">
                    <button class="btn btn-danger btn-small" onclick="removeCharacter('${currentCharacter.id}')">åˆªé™¤è§’è‰²</button>
                </div>

                <div class="stats-bar">
                    <div class="total-stats" style="font-weight: 500; color: var(--text-color);">
                        ç¸½è¨ˆ - <span id="total-chars">0</span> å­— / <span id="total-tokens">0</span> tokens
                    </div>
                </div>

                <div class="versions-container ${viewMode}-view">
                    ${versionsToShow.map(version => renderVersionPanel(currentCharacter, version)).join('')}
                </div>

                <div class="export-section">
                    <h3>åŒ¯å‡ºè§’è‰²å¡</h3>
                    <div class="export-buttons">
                        <button class="btn btn-warning" onclick="exportJSON('${currentCharacter.id}')">åŒ¯å‡º JSON</button>
                        <button class="btn btn-warning" onclick="exportPNG('${currentCharacter.id}')">åŒ¯å‡º PNG</button>
                        <button class="btn btn-warning" onclick="exportAllVersions('${currentCharacter.id}')">åŒ¯å‡ºæ‰€æœ‰ç‰ˆæœ¬</button>
                    </div>
                </div>
            `;

            setTimeout(updateStats, 100);
        }

        function renderVersionPanel(character, version) {
            return `
                <div class="version-panel">
                    <div class="version-header">
                        <input type="text" class="version-title" value="${version.name}" 
                               onchange="updateVersionName('${character.id}', '${version.id}', this.value)">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-success btn-small" onclick="saveData(); showSaveNotification()">ğŸ’¾ å„²å­˜</button>
                            ${character.versions.length > 1 ? `<button class="btn btn-danger btn-small" onclick="removeVersion('${character.id}', '${version.id}')">åˆªé™¤</button>` : ''}
                        </div>
                    </div>

                    <div class="character-info-section">
                        <div class="avatar-container">
                            <div class="avatar-display">
                                ${version.avatar ? 
                                    `<img src="${version.avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" alt="è§’è‰²åœ–ç‰‡">` : 
                                    '<span>ç„¡åœ–ç‰‡</span>'
                                }
                                <div class="avatar-upload-overlay">
                                    <label class="file-label">
                                        é¸æ“‡åœ–ç‰‡
                                        <input type="file" class="file-input" accept="image/*" 
                                               onchange="handleImageUpload('${character.id}', '${version.id}', this.files[0])">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="character-meta-fields">
                            <div class="meta-field-group">
                                <label class="meta-field-label">å‰µä½œè€…</label>
                                <input type="text" class="meta-field-input" id="creator-${version.id}" 
                                       placeholder="å‰µä½œè€…åç¨±ï¼ˆå¯é¸ï¼‰..."
                                       oninput="updateField('${character.id}', '${version.id}', 'creator', this.value); updateStats()" 
                                       value="${version.creator || ''}">
                            </div>

                            <div class="meta-field-group">
                                <label class="meta-field-label">è§’è‰²ç‰ˆæœ¬</label>
                                <input type="text" class="meta-field-input" id="charVersion-${version.id}" 
                                       placeholder="ç‰ˆæœ¬è™Ÿç¢¼æˆ–æè¿°ï¼ˆå¯é¸ï¼‰..."
                                       oninput="updateField('${character.id}', '${version.id}', 'charVersion', this.value); updateStats()" 
                                       value="${version.charVersion || ''}">
                            </div>

                            <div class="meta-field-group">
                                <label class="meta-field-label">å‰µä½œè€…å‚™è¨»</label>
                                <input type="text" class="meta-field-input" id="creatorNotes-${version.id}" 
                                       placeholder="å‰µä½œå‚™è¨»æˆ–èªªæ˜ï¼ˆå¯é¸ï¼‰..."
                                       oninput="updateField('${character.id}', '${version.id}', 'creatorNotes', this.value); updateStats()" 
                                       value="${version.creatorNotes || ''}">
                            </div>

                            <div class="meta-field-group">
                                <label class="meta-field-label">åµŒå…¥æ¨™ç±¤</label>
                                <input type="text" class="meta-field-input" id="tags-${version.id}" 
                                       placeholder="æ¨™ç±¤ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼ˆå¯é¸ï¼‰..."
                                       oninput="updateField('${character.id}', '${version.id}', 'tags', this.value); updateStats()" 
                                       value="${version.tags || ''}">
                            </div>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            è§’è‰²æè¿°
                            <span class="field-stats" data-target="desc-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="desc-${version.id}" 
                                  placeholder="æè¿°è§’è‰²çš„å¤–è²Œã€èƒŒæ™¯ã€è¨­å®šç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'description', this.value); updateStats()">${version.description}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å€‹æ€§æ‘˜è¦
                            <span class="field-stats" data-target="personality-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="personality-${version.id}" 
                                  placeholder="è§’è‰²çš„æ€§æ ¼ç‰¹å¾µã€è¡Œç‚ºæ¨¡å¼ã€èªªè©±æ–¹å¼ç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'personality', this.value); updateStats()">${version.personality}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å ´æ™¯è¨­æƒ³
                            <span class="field-stats" data-target="scenario-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="scenario-${version.id}" 
                                  placeholder="è§’è‰²æ‰€è™•çš„æƒ…å¢ƒã€ç’°å¢ƒã€ç•¶å‰ç‹€æ³ç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'scenario', this.value); updateStats()">${version.scenario}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å°è©±ç¯„ä¾‹
                            <span class="field-stats" data-target="dialogue-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="dialogue-${version.id}" 
                                  placeholder="{{user}}: ä½ å¥½ï¼\n{{char}}: ä½ å¥½å‘€ï¼å¾ˆé«˜èˆˆè¦‹åˆ°ä½ ï½"
                                  oninput="updateField('${character.id}', '${version.id}', 'dialogue', this.value); updateStats()">${version.dialogue}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            åˆå§‹è¨Šæ¯
                            <span class="field-stats" data-target="firstmsg-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="firstmsg-${version.id}" 
                                  placeholder="è§’è‰²çš„ç¬¬ä¸€å¥è©±æˆ–é–‹å ´ç™½..."
                                  oninput="updateField('${character.id}', '${version.id}', 'firstMessage', this.value); updateStats()">${version.firstMessage}</textarea>
                    </div>
                </div>
            `;
        }

        function renderAll() {
            renderSidebar();
            renderContent();
            updateTotalStats();
        }

        function updateTotalStats() {
            const currentCharacter = characters.find(c => c.id === currentCharacterId);
            if (!currentCharacter) return;

            let totalChars = 0;
            let totalTokens = 0;
            
            const versionsToCount = viewMode === 'compare' ? 
                currentCharacter.versions.filter(v => compareVersions.includes(v.id)) : 
                currentCharacter.versions.filter(v => v.id === currentVersionId);

            versionsToCount.forEach(version => {
                const allText = [
                    version.description, version.personality, version.scenario, 
                    version.dialogue, version.firstMessage, version.creator, 
                    version.charVersion, version.creatorNotes, version.tags
                ].join(' ');
                totalChars += allText.length;
                totalTokens += countTokens(allText);
            });

            const charsElement = document.getElementById('total-chars');
            const tokensElement = document.getElementById('total-tokens');
            if (charsElement) charsElement.textContent = totalChars;
            if (tokensElement) tokensElement.textContent = totalTokens;
        }

        function exportJSON(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            if (character.versions.length === 1) {
                downloadJSON(character, character.versions[0]);
            } else {
                const versionIndex = prompt(`é¸æ“‡è¦åŒ¯å‡ºçš„ç‰ˆæœ¬ (1-${character.versions.length}):`);
                const index = parseInt(versionIndex) - 1;
                if (index >= 0 && index < character.versions.length) {
                    downloadJSON(character, character.versions[index]);
                }
            }
        }

        function downloadJSON(character, version) {
            const characterData = {
                name: character.name,
                description: version.description,
                personality: version.personality,
                scenario: version.scenario,
                first_mes: version.firstMessage,
                mes_example: version.dialogue,
                creatorcomment: version.creatorNotes,
                avatar: "none",
                talkativeness: "0.5",
                fav: false,
                tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                spec: "chara_card_v3",
                spec_version: "3.0",
                data: {
                    name: character.name,
                    description: version.description,
                    personality: version.personality,
                    scenario: version.scenario,
                    first_mes: version.firstMessage,
                    mes_example: version.dialogue,
                    creator_notes: version.creatorNotes,
                    system_prompt: "",
                    post_history_instructions: "",
                    tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    creator: version.creator,
                    character_version: version.charVersion,
                    alternate_greetings: [],
                    extensions: {
                        talkativeness: "0.5",
                        fav: false,
                        world: "",
                        depth_prompt: {
                            prompt: "",
                            depth: 4,
                            role: "system"
                        }
                    },
                    group_only_greetings: []
                },
                create_date: new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
            };

            const blob = new Blob([JSON.stringify(characterData, null, 4)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportPNG(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            // é¸æ“‡ç‰ˆæœ¬
            let selectedVersion;
            if (character.versions.length === 1) {
                selectedVersion = character.versions[0];
            } else {
                const versionIndex = prompt(`é¸æ“‡è¦åŒ¯å‡ºçš„ç‰ˆæœ¬ (1-${character.versions.length}):`);
                const index = parseInt(versionIndex) - 1;
                if (index >= 0 && index < character.versions.length) {
                    selectedVersion = character.versions[index];
                } else {
                    return;
                }
            }

            // å‰µå»ºèˆ‡JSONç›¸åŒçš„è³‡æ–™çµæ§‹
            const characterData = {
                name: character.name,
                description: selectedVersion.description,
                personality: selectedVersion.personality,
                scenario: selectedVersion.scenario,
                first_mes: selectedVersion.firstMessage,
                mes_example: selectedVersion.dialogue,
                creatorcomment: selectedVersion.creatorNotes,
                avatar: "none",
                talkativeness: "0.5",
                fav: false,
                tags: selectedVersion.tags ? selectedVersion.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                spec: "chara_card_v3",
                spec_version: "3.0",
                data: {
                    name: character.name,
                    description: selectedVersion.description,
                    personality: selectedVersion.personality,
                    scenario: selectedVersion.scenario,
                    first_mes: selectedVersion.firstMessage,
                    mes_example: selectedVersion.dialogue,
                    creator_notes: selectedVersion.creatorNotes,
                    system_prompt: "",
                    post_history_instructions: "",
                    tags: selectedVersion.tags ? selectedVersion.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    creator: selectedVersion.creator,
                    character_version: selectedVersion.charVersion,
                    alternate_greetings: [],
                    extensions: {
                        talkativeness: "0.5",
                        fav: false,
                        world: "",
                        depth_prompt: {
                            prompt: "",
                            depth: 4,
                            role: "system"
                        }
                    },
                    group_only_greetings: []
                },
                create_date: new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
            };

            // å°‡JSONè½‰ç‚ºBase64
            const jsonString = JSON.stringify(characterData);
            const base64Data = btoa(unescape(encodeURIComponent(jsonString)));

            // å‰µå»ºæˆ–ä½¿ç”¨ç¾æœ‰çš„é ­åƒåœ–ç‰‡
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            if (selectedVersion.avatar) {
                // å¦‚æœæœ‰é ­åƒï¼Œä½¿ç”¨é ­åƒä½œç‚ºPNGåœ–ç‰‡
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // åµŒå…¥chara metadataä¸¦ä¸‹è¼‰
                    createPNGWithMetadata(canvas, base64Data, character.name);
                };
                img.src = selectedVersion.avatar;
            } else {
                // å¦‚æœæ²’æœ‰é ­åƒï¼Œå‰µå»ºé è¨­åœ–ç‰‡
                canvas.width = 400;
                canvas.height = 600;
                
                // å‰µå»ºæ¼¸å±¤èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, 0, 600);
                gradient.addColorStop(0, '#f7f5f3');
                gradient.addColorStop(1, '#e2e8f0');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 600);
                
                // æ·»åŠ è§’è‰²åç¨±
                ctx.fillStyle = '#2d3748';
                ctx.font = 'bold 24px "Noto Serif CJK JP", serif';
                ctx.textAlign = 'center';
                ctx.fillText(character.name, 200, 300);
                
                // æ·»åŠ å‰¯æ¨™é¡Œ
                ctx.font = '16px "Noto Serif CJK JP", serif';
                ctx.fillStyle = '#718096';
                ctx.fillText('Character Card', 200, 330);
                
                // åµŒå…¥chara metadataä¸¦ä¸‹è¼‰
                createPNGWithMetadata(canvas, base64Data, character.name);
            }
        }

        function createPNGWithMetadata(canvas, base64Data, characterName) {
            // å°‡Canvasè½‰ç‚ºImageData
            canvas.toBlob(function(blob) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    // åœ¨PNGä¸­åµŒå…¥tEXt chunk with "chara" keyword
                    const modifiedPNG = addTextChunkToPNG(uint8Array, 'chara', base64Data);
                    
                    // ä¸‹è¼‰ä¿®æ”¹å¾Œçš„PNG
                    const modifiedBlob = new Blob([modifiedPNG], { type: 'image/png' });
                    const url = URL.createObjectURL(modifiedBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${characterName}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                };
                reader.readAsArrayBuffer(blob);
            }, 'image/png');
        }

        function addTextChunkToPNG(pngData, keyword, text) {
            // PNGæª”æ¡ˆçµæ§‹ï¼š8ä½å…ƒçµ„PNGç°½å + æ•¸å€‹chunks + IEND chunk
            const signature = pngData.slice(0, 8);
            let pos = 8;
            const chunks = [];
            
            // è®€å–æ‰€æœ‰ç¾æœ‰çš„chunks
            while (pos < pngData.length) {
                const length = (pngData[pos] << 24) | (pngData[pos + 1] << 16) | (pngData[pos + 2] << 8) | pngData[pos + 3];
                const type = String.fromCharCode(pngData[pos + 4], pngData[pos + 5], pngData[pos + 6], pngData[pos + 7]);
                const chunkData = pngData.slice(pos, pos + 12 + length);
                
                chunks.push(chunkData);
                
                if (type === 'IEND') break;
                pos += 12 + length;
            }
            
            // å‰µå»ºtEXt chunk
            const keywordBytes = new TextEncoder().encode(keyword);
            const textBytes = new TextEncoder().encode(text);
            const chunkData = new Uint8Array(keywordBytes.length + 1 + textBytes.length);
            chunkData.set(keywordBytes, 0);
            chunkData[keywordBytes.length] = 0; // null separator
            chunkData.set(textBytes, keywordBytes.length + 1);
            
            // è¨ˆç®—CRC
            const crc = calculateCRC32([0x74, 0x45, 0x58, 0x74, ...chunkData]); // "tEXt" + data
            
            // çµ„è£tEXt chunk
            const textChunk = new Uint8Array(12 + chunkData.length);
            const lengthBytes = [(chunkData.length >>> 24) & 0xFF, (chunkData.length >>> 16) & 0xFF, (chunkData.length >>> 8) & 0xFF, chunkData.length & 0xFF];
            textChunk.set(lengthBytes, 0);
            textChunk.set([0x74, 0x45, 0x58, 0x74], 4); // "tEXt"
            textChunk.set(chunkData, 8);
            textChunk.set([(crc >>> 24) & 0xFF, (crc >>> 16) & 0xFF, (crc >>> 8) & 0xFF, crc & 0xFF], 8 + chunkData.length);
            
            // é‡æ–°çµ„è£PNGï¼šç°½å + åŸæœ‰chunks (é™¤äº†IEND) + tEXt chunk + IEND
            const iendChunk = chunks.pop(); // ç§»é™¤IEND
            const totalLength = signature.length + chunks.reduce((sum, chunk) => sum + chunk.length, 0) + textChunk.length + iendChunk.length;
            const result = new Uint8Array(totalLength);
            
            let offset = 0;
            result.set(signature, offset);
            offset += signature.length;
            
            for (const chunk of chunks) {
                result.set(chunk, offset);
                offset += chunk.length;
            }
            
            result.set(textChunk, offset);
            offset += textChunk.length;
            
            result.set(iendChunk, offset);
            
            return result;
        }

        function calculateCRC32(data) {
            const crcTable = [];
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) {
                    if (c & 1) {
                        c = 0xEDB88320 ^ (c >>> 1);
                    } else {
                        c = c >>> 1;
                    }
                }
                crcTable[i] = c;
            }
            
            let crc = 0xFFFFFFFF;
            for (let i = 0; i < data.length; i++) {
                crc = crcTable[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
            }
            return (crc ^ 0xFFFFFFFF) >>> 0;
        }

        function exportAllVersions(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            character.versions.forEach((version, index) => {
                setTimeout(() => downloadJSON(character, version), index * 200);
            });
        }

        function importCharacter() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type === 'application/json' || file.name.endsWith('.json')) {
                // è™•ç†JSONæª”æ¡ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        importCharacterFromData(data);
                    } catch (error) {
                        alert('JSONæª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„è§’è‰²å¡æª”æ¡ˆ');
                    }
                };
                reader.readAsText(file);
            } else if (file.type === 'image/png' || file.name.endsWith('.png')) {
                // è™•ç†PNGæª”æ¡ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const charaData = extractCharaFromPNG(new Uint8Array(arrayBuffer));
                        
                        if (charaData) {
                            // è§£ç¢¼Base64
                            const jsonString = atob(charaData);
                            const data = JSON.parse(decodeURIComponent(escape(jsonString)));
                            importCharacterFromData(data, file); // å‚³éåŸå§‹æª”æ¡ˆä½œç‚ºåœ–ç‰‡
                        } else {
                            alert('PNGæª”æ¡ˆä¸­æœªæ‰¾åˆ°è§’è‰²è³‡æ–™ï¼Œè«‹ç¢ºèªé€™æ˜¯æœ‰æ•ˆçš„è§’è‰²å¡PNGæª”æ¡ˆ');
                        }
                    } catch (error) {
                        alert('PNGæª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('è«‹é¸æ“‡JSONæˆ–PNGæ ¼å¼çš„è§’è‰²å¡æª”æ¡ˆ');
            }
        }

        function extractCharaFromPNG(pngData) {
            // è·³éPNGç°½å
            let pos = 8;
            
            while (pos < pngData.length) {
                // è®€å–chunké•·åº¦
                const length = (pngData[pos] << 24) | (pngData[pos + 1] << 16) | (pngData[pos + 2] << 8) | pngData[pos + 3];
                
                // è®€å–chunké¡å‹
                const type = String.fromCharCode(pngData[pos + 4], pngData[pos + 5], pngData[pos + 6], pngData[pos + 7]);
                
                if (type === 'tEXt') {
                    // è®€å–tEXt chunkçš„è³‡æ–™
                    const textData = pngData.slice(pos + 8, pos + 8 + length);
                    
                    // å°‹æ‰¾nullåˆ†éš”ç¬¦
                    let nullPos = -1;
                    for (let i = 0; i < textData.length; i++) {
                        if (textData[i] === 0) {
                            nullPos = i;
                            break;
                        }
                    }
                    
                    if (nullPos !== -1) {
                        // æå–keywordå’Œtext
                        const keyword = new TextDecoder().decode(textData.slice(0, nullPos));
                        const text = new TextDecoder().decode(textData.slice(nullPos + 1));
                        
                        if (keyword === 'chara') {
                            return text;
                        }
                    }
                }
                
                if (type === 'IEND') break;
                pos += 12 + length;
            }
            
            return null;
        }

        function importCharacterFromData(data, imageFile = null) {
            const character = {
                id: generateId(),
                name: data.name || 'åŒ¯å…¥è§’è‰²',
                versions: [{
                    id: generateId(),
                    name: 'åŒ¯å…¥ç‰ˆæœ¬',
                    avatar: '',
                    creator: data.data?.creator || data.creator || '',
                    charVersion: data.data?.character_version || data.character_version || '',
                    creatorNotes: data.data?.creator_notes || data.creatorcomment || '',
                    tags: Array.isArray(data.tags) ? data.tags.join(', ') : (data.data?.tags ? data.data.tags.join(', ') : ''),
                    description: data.data?.description || data.description || '',
                    personality: data.data?.personality || data.personality || '',
                    scenario: data.data?.scenario || data.scenario || '',
                    dialogue: data.data?.mes_example || data.mes_example || '',
                    firstMessage: data.data?.first_mes || data.first_mes || ''
                }]
            };

            // å¦‚æœæ˜¯PNGæª”æ¡ˆï¼Œå°‡åœ–ç‰‡è¨­å®šç‚ºé ­åƒ
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    character.versions[0].avatar = e.target.result;
                    finishImport();
                };
                reader.readAsDataURL(imageFile);
            } else {
                finishImport();
            }

            function finishImport() {
                characters.push(character);
                currentCharacterId = character.id;
                currentVersionId = character.versions[0].id;
                renderAll();
                saveData();
                alert('è§’è‰²åŒ¯å…¥æˆåŠŸï¼');
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initApp() {
            // è¼‰å…¥å„²å­˜çš„è‡ªè¨‚é¡è‰²ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­
            const savedColors = localStorage.getItem('characterCreatorCustomColors');
            if (savedColors) {
                const colors = JSON.parse(savedColors);
                const root = document.documentElement;
                root.style.setProperty('--primary-color', colors.primary);
                root.style.setProperty('--secondary-color', colors.secondary);
                root.style.setProperty('--accent-color', colors.accent);
                root.style.setProperty('--bg-color', colors.bg);
            }
            // ä½¿ç”¨CSSé è¨­å€¼ï¼Œä¸éœ€è¦é¡å¤–è¨­å®š

            // è¼‰å…¥è§’è‰²è³‡æ–™
            loadData();

            // å¦‚æœæ²’æœ‰è§’è‰²ï¼Œå‰µå»ºé è¨­è§’è‰²
            if (characters.length === 0) {
                addCharacter();
            } else {
                renderAll();
            }

            // å®šæœŸæ›´æ–°çµ±è¨ˆ
            setInterval(updateTotalStats, 2000);

            // éŸ¿æ‡‰å¼è™•ç†
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('show');
                }
            });
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', initApp);
    </script>    <script>
        let characters = [];
        let currentCharacterId = null;
        let currentVersionId = null;
        let viewMode = 'single'; // 'single' æˆ– 'compare'
        let sidebarCollapsed = false;
        let compareVersions = []; // ç”¨æ–¼å°æ¯”æª¢è¦–çš„ç‰ˆæœ¬é¸æ“‡

        // ä¸»é¡Œé…è‰² - è‹±å€«é¢¨ä½å½©åº¦é…è‰²
        const themes = {
            classic: { primary: '#2d3748', secondary: '#1a202c', accent: '#8b7355', bg: '#f7f5f3' },
            warm: { primary: '#744210', secondary: '#553c9a', accent: '#d69e2e', bg: '#fefcf0' },
            cool: { primary: '#2c5282', secondary: '#2a4365', accent: '#3182ce', bg: '#f0f8ff' },
            forest: { primary: '#22543d', secondary: '#1a202c', accent: '#38a169', bg: '#f0fff4' },
            vintage: { primary: '#553c9a', secondary: '#44337a', accent: '#9f7aea', bg: '#faf5ff' },
            minimal: { primary: '#4a5568', secondary: '#2d3748', accent: '#718096', bg: '#f8f9fa' }
        };

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function countTokens(text) {
            if (!text) return 0;
            
            // æ›´ç²¾æº–çš„tokenè¨ˆç®—ï¼Œæ¨¡æ“¬GPT-4çš„BPE tokenizer
            // é è™•ç†ï¼šç§»é™¤å¤šé¤˜ç©ºç™½
            text = text.trim().replace(/\s+/g, ' ');
            
            let tokenCount = 0;
            let i = 0;
            
            while (i < text.length) {
                const char = text[i];
                
                // ä¸­æ–‡å­—ç¬¦ï¼ˆåŒ…æ‹¬æ—¥æ–‡ã€éŸ“æ–‡ï¼‰- é€šå¸¸æ˜¯1 token
                if (/[\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(char)) {
                    tokenCount += 1;
                    i++;
                }
                // è‹±æ–‡å–®è©è™•ç†
                else if (/[a-zA-Z]/.test(char)) {
                    let wordStart = i;
                    while (i < text.length && /[a-zA-Z]/.test(text[i])) {
                        i++;
                    }
                    const word = text.slice(wordStart, i);
                    
                    // è‹±æ–‡å–®è©çš„tokenä¼°ç®—
                    if (word.length <= 3) {
                        tokenCount += 1;
                    } else if (word.length <= 6) {
                        tokenCount += 1.5;
                    } else if (word.length <= 10) {
                        tokenCount += 2;
                    } else {
                        tokenCount += Math.ceil(word.length / 4);
                    }
                }
                // æ•¸å­—è™•ç†
                else if (/[0-9]/.test(char)) {
                    let numStart = i;
                    while (i < text.length && /[0-9.,]/.test(text[i])) {
                        i++;
                    }
                    const num = text.slice(numStart, i);
                    // æ•¸å­—é€šå¸¸æ¯2-4ä½æ˜¯1å€‹token
                    tokenCount += Math.ceil(num.replace(/[.,]/g, '').length / 3);
                }
                // æ¨™é»ç¬¦è™Ÿå’Œç‰¹æ®Šå­—ç¬¦
                else if (/[^\s]/.test(char)) {
                    // å¸¸è¦‹æ¨™é»ç¬¦è™Ÿçµ„åˆ
                    if (i < text.length - 1) {
                        const twoChar = text.slice(i, i + 2);
                        if (['--', '...', '!!', '??', '::'].includes(twoChar)) {
                            tokenCount += 1;
                            i += 2;
                            continue;
                        }
                    }
                    
                    // å–®å€‹æ¨™é»ç¬¦è™Ÿ
                    if (/[.!?,:;()[\]{}"'`~@#$%^&*+=<>|\\/-]/.test(char)) {
                        tokenCount += 0.5;
                    } else {
                        tokenCount += 1;
                    }
                    i++;
                }
                // ç©ºç™½å­—ç¬¦
                else {
                    // ç©ºæ ¼é€šå¸¸ä¸å–®ç¨è¨ˆç®—tokenï¼Œä½†æœƒå½±éŸ¿åˆ†è©
                    i++;
                }
            }
            
            // åŠ ä¸Šä¸€äº›ç‰¹æ®Šæ ¼å¼çš„é¡å¤–tokenï¼ˆå¦‚{{user}}, {{char}}ç­‰ï¼‰
            const specialTokens = text.match(/\{\{(user|char|random|pick|roll)\}\}/g);
            if (specialTokens) {
                tokenCount += specialTokens.length * 0.5;
            }
            
            return Math.ceil(tokenCount);
        }

        function toggleSidebar() {
            // ç§»é™¤å´é‚Šæ¬„åˆ‡æ›åŠŸèƒ½
        }

        function changeTheme(themeName) {
            // ç§»é™¤ä¸»é¡Œåˆ‡æ›åŠŸèƒ½ï¼Œåªä¿ç•™è‡ªè¨‚é¡è‰²
        }

        function showColorPicker() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">è‡ªè¨‚ä¸»é¡Œé¡è‰²</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    
                    <div class="color-input-group">
                        <label>ä¸»è¦é¡è‰²</label>
                        <input type="color" class="color-input" id="primary-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim()}">
                    </div>
                    
                    <div class="color-input-group">
                        <label>æ¬¡è¦é¡è‰²</label>
                        <input type="color" class="color-input" id="secondary-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim()}">
                    </div>
                    
                    <div class="color-input-group">
                        <label>å¼·èª¿é¡è‰²</label>
                        <input type="color" class="color-input" id="accent-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim()}">
                    </div>

                    <div class="color-input-group">
                        <label>èƒŒæ™¯é¡è‰²</label>
                        <input type="color" class="color-input" id="bg-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim()}">
                    </div>
                    
                    <div class="color-preview">
                        <div class="color-preview-item" id="preview-primary">ä¸»è¦</div>
                        <div class="color-preview-item" id="preview-secondary">æ¬¡è¦</div>
                        <div class="color-preview-item" id="preview-accent">å¼·èª¿</div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="applyCustomColors()">å¥—ç”¨</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // é è¦½é¡è‰²è®ŠåŒ–
            const primaryInput = document.getElementById('primary-color');
            const secondaryInput = document.getElementById('secondary-color');
            const accentInput = document.getElementById('accent-color');
            const bgInput = document.getElementById('bg-color');
            
            function updatePreview() {
                document.getElementById('preview-primary').style.backgroundColor = primaryInput.value;
                document.getElementById('preview-secondary').style.backgroundColor = secondaryInput.value;
                document.getElementById('preview-accent').style.backgroundColor = accentInput.value;
            }
            
            primaryInput.addEventListener('input', updatePreview);
            secondaryInput.addEventListener('input', updatePreview);
            accentInput.addEventListener('input', updatePreview);
            bgInput.addEventListener('input', updatePreview);
            
            updatePreview();
            
            // é»æ“Šå¤–éƒ¨é—œé–‰
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function applyCustomColors() {
            const primary = document.getElementById('primary-color').value;
            const secondary = document.getElementById('secondary-color').value;
            const accent = document.getElementById('accent-color').value;
            const bg = document.getElementById('bg-color').value;
            
            const root = document.documentElement;
            root.style.setProperty('--primary-color', primary);
            root.style.setProperty('--secondary-color', secondary);
            root.style.setProperty('--accent-color', accent);
            root.style.setProperty('--bg-color', bg);
            
            // å„²å­˜è‡ªè¨‚é¡è‰²
            localStorage.setItem('characterCreatorCustomColors', JSON.stringify({
                primary, secondary, accent, bg
            }));
            
            document.querySelector('.modal').remove();
        }

        function saveData() {
            try {
                localStorage.setItem('characterCreatorData', JSON.stringify(characters));
                // éœé»˜å„²å­˜
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—ï¼š', error);
            }
        }

        function showSaveNotification() {
            // å‰µå»ºå„²å­˜æˆåŠŸæç¤º
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 0.9em;
                font-weight: 500;
                z-index: 9999;
                box-shadow: var(--shadow-medium);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = 'âœ“ å·²å„²å­˜åˆ°ç€è¦½å™¨';
            
            document.body.appendChild(notification);
            
            // æ»‘å…¥å‹•ç•«
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 3ç§’å¾Œç§»é™¤
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        function exportAllData() {
            const exportData = {
                characters: characters,
                exportDate: new Date().toISOString(),
                version: '1.0.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronicler_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importAllData() {
            document.getElementById('importAllFile').click();
        }

        function handleImportAll(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.characters && Array.isArray(data.characters)) {
                        const confirmImport = confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${data.characters.length} å€‹è§’è‰²å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è³‡æ–™ï¼`);
                        
                        if (confirmImport) {
                            characters = data.characters;
                            currentCharacterId = characters[0]?.id || null;
                            currentVersionId = characters[0]?.versions[0]?.id || null;
                            compareVersions = [];
                            
                            renderAll();
                            saveData();
                            alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                        }
                    } else {
                        alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„å‚™ä»½æª”æ¡ˆ');
                    }
                } catch (error) {
                    alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('characterCreatorData');
                if (saved) {
                    characters = JSON.parse(saved);
                    if (characters.length > 0) {
                        currentCharacterId = characters[0].id;
                        currentVersionId = characters[0].versions[0].id;
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š', error);
            }
        }

        function addCharacter() {
            const character = {
                id: generateId(),
                name: `è§’è‰² ${characters.length + 1}`,
                versions: [{
                    id: generateId(),
                    name: 'ç‰ˆæœ¬ 1',
                    avatar: '',
                    description: '',
                    personality: '',
                    scenario: '',
                    dialogue: '',
                    firstMessage: '',
                    creator: '',
                    charVersion: '',
                    creatorNotes: '',
                    tags: ''
                }]
            };
            characters.push(character);
            currentCharacterId = character.id;
            currentVersionId = character.versions[0].id;
            renderAll();
            saveData();
        }

        function removeCharacter(characterId) {
            if (characters.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹è§’è‰²');
                return;
            }
            characters = characters.filter(c => c.id !== characterId);
            if (currentCharacterId === characterId) {
                currentCharacterId = characters[0]?.id || null;
                currentVersionId = characters[0]?.versions[0]?.id || null;
            }
            renderAll();
            saveData();
        }

        function addVersion(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (character) {
                const newVersion = {
                    id: generateId(),
                    name: `ç‰ˆæœ¬ ${character.versions.length + 1}`,
                    avatar: '',
                    description: '',
                    personality: '',
                    scenario: '',
                    dialogue: '',
                    firstMessage: '',
                    creator: '',
                    charVersion: '',
                    creatorNotes: '',
                    tags: ''
                };
                character.versions.push(newVersion);
                currentVersionId = newVersion.id;
                renderAll();
                saveData();
            }
        }

        function removeVersion(characterId, versionId) {
            const character = characters.find(c => c.id === characterId);
            if (character && character.versions.length > 1) {
                character.versions = character.versions.filter(v => v.id !== versionId);
                if (currentVersionId === versionId) {
                    currentVersionId = character.versions[0].id;
                }
                renderAll();
                saveData();
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç‰ˆæœ¬');
            }
        }

        function selectCharacter(characterId) {
            currentCharacterId = characterId;
            const character = characters.find(c => c.id === characterId);
            if (character) {
                currentVersionId = character.versions[0].id;
            }
            renderAll();
        }

        function selectVersion(characterId, versionId) {
            currentCharacterId = characterId;
            currentVersionId = versionId;
            viewMode = 'single';
            renderAll();
        }

        function toggleCompareMode() {
            if (viewMode === 'single') {
                const currentCharacter = characters.find(c => c.id === currentCharacterId);
                if (currentCharacter && currentCharacter.versions.length > 1) {
                    showVersionSelector();
                } else {
                    alert('éœ€è¦è‡³å°‘2å€‹ç‰ˆæœ¬æ‰èƒ½é€²è¡Œå°æ¯”');
                }
            } else {
                viewMode = 'single';
                compareVersions = [];
                renderAll();
            }
        }

        function showVersionSelector() {
            const currentCharacter = characters.find(c => c.id === currentCharacterId);
            if (!currentCharacter) return;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">é¸æ“‡è¦å°æ¯”çš„ç‰ˆæœ¬</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    
                    <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9em;">é¸æ“‡2-3å€‹ç‰ˆæœ¬é€²è¡Œå°æ¯” (ç›®å‰å·²é¸: <span id="selected-count">0</span>/3)</p>
                    
                    <div class="version-checkboxes">
                        ${currentCharacter.versions.map(version => `
                            <div class="version-checkbox" data-version-id="${version.id}" onclick="toggleVersionSelection('${version.id}')">
                                <input type="checkbox" id="check-${version.id}" onchange="event.stopPropagation()">
                                <label for="check-${version.id}">${version.name}</label>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="applyVersionComparison()" id="apply-compare" disabled>é–‹å§‹å°æ¯”</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ¢å¾©ä¹‹å‰çš„é¸æ“‡
            compareVersions.forEach(versionId => {
                const checkbox = document.getElementById(`check-${versionId}`);
                const container = document.querySelector(`[data-version-id="${versionId}"]`);
                if (checkbox && container) {
                    checkbox.checked = true;
                    container.classList.add('selected');
                }
            });
            updateSelectedCount();
            
            // é»æ“Šå¤–éƒ¨é—œé–‰
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function toggleVersionSelection(versionId) {
            const checkbox = document.getElementById(`check-${versionId}`);
            const container = document.querySelector(`[data-version-id="${versionId}"]`);
            
            if (checkbox.checked) {
                // å–æ¶ˆé¸æ“‡
                checkbox.checked = false;
                container.classList.remove('selected');
                compareVersions = compareVersions.filter(id => id !== versionId);
            } else {
                // æ–°å¢é¸æ“‡
                if (compareVersions.length < 3) {
                    checkbox.checked = true;
                    container.classList.add('selected');
                    compareVersions.push(versionId);
                } else {
                    alert('æœ€å¤šåªèƒ½é¸æ“‡3å€‹ç‰ˆæœ¬');
                }
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selected-count');
            const applyButton = document.getElementById('apply-compare');
            
            if (countElement) {
                countElement.textContent = compareVersions.length;
            }
            
            if (applyButton) {
                applyButton.disabled = compareVersions.length < 2;
            }
        }

        function applyVersionComparison() {
            if (compareVersions.length >= 2) {
                viewMode = 'compare';
                document.querySelector('.modal').remove();
                renderAll();
            }
        }

        function updateField(characterId, versionId, field, value) {
            const character = characters.find(c => c.id === characterId);
            if (character) {
                const version = character.versions.find(v => v.id === versionId);
                if (version) {
                    version[field] = value;
                    updateStats();
                    saveData();
                }
            }
        }

        function updateCharacterName(characterId, name) {
            const character = characters.find(c => c.id === characterId);
            if (character) {
                character.name = name;
                renderSidebar();
                saveData();
            }
        }

        function updateVersionName(characterId, versionId, name) {
            const character = characters.find(c => c.id === characterId);
            if (character) {
                const version = character.versions.find(v => v.id === versionId);
                if (version) {
                    version.name = name;
                    renderSidebar();
                    saveData();
                }
            }
        }

        function handleImageUpload(characterId, versionId, file) {
            if (file) {
                showImageCropModal(file, function(croppedImageData) {
                    updateField(characterId, versionId, 'avatar', croppedImageData);
                    renderContent();
                });
            }
        }

        function showImageCropModal(file, callback) {
            const modal = document.createElement('div');
            modal.className = 'crop-modal';
            modal.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                modal.innerHTML = `
                    <div class="crop-modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">è£å‰ªåœ–ç‰‡</h3>
                            <button class="close-modal" onclick="this.closest('.crop-modal').remove()">Ã—</button>
                        </div>
                        
                        <div class="crop-info">
                            æ‹–æ‹½é¸æ“‡æ¡†ä¾†èª¿æ•´è£å‰ªå€åŸŸã€‚åœ–ç‰‡å°‡è¢«è£å‰ªç‚º 2:3 æ¯”ä¾‹ï¼ˆå¯¬:é«˜ï¼‰
                        </div>
                        
                        <div class="crop-container" id="cropContainer">
                            <img class="crop-image" id="cropImage" src="${e.target.result}" alt="å¾…è£å‰ªåœ–ç‰‡">
                            <div class="crop-overlay" id="cropOverlay">
                                <div class="crop-handle nw"></div>
                                <div class="crop-handle ne"></div>
                                <div class="crop-handle sw"></div>
                                <div class="crop-handle se"></div>
                            </div>
                        </div>
                        
                        <div class="crop-controls">
                            <button class="btn btn-secondary" onclick="resetCropArea()">é‡ç½®</button>
                            <button class="btn btn-secondary" onclick="this.closest('.crop-modal').remove()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="applyCrop()">ç¢ºèªè£å‰ª</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // ç­‰å¾…åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–è£å‰ªå€åŸŸ
                const img = document.getElementById('cropImage');
                img.onload = function() {
                    initializeCropArea();
                };
                
                // å¦‚æœåœ–ç‰‡å·²ç¶“è¼‰å…¥ï¼Œç›´æ¥åˆå§‹åŒ–
                if (img.complete) {
                    initializeCropArea();
                }
                
                // å„²å­˜å›èª¿å‡½æ•¸
                window.currentCropCallback = callback;
                
                // é»æ“Šå¤–éƒ¨é—œé–‰
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            };
            
            reader.readAsDataURL(file);
        }

        function initializeCropArea() {
            const container = document.getElementById('cropContainer');
            const img = document.getElementById('cropImage');
            const overlay = document.getElementById('cropOverlay');
            
            const containerRect = container.getBoundingClientRect();
            const imgRect = img.getBoundingClientRect();
            
            // è¨ˆç®—åœ–ç‰‡åœ¨å®¹å™¨ä¸­çš„å¯¦éš›å°ºå¯¸å’Œä½ç½®
            const imgWidth = img.offsetWidth;
            const imgHeight = img.offsetHeight;
            
            // è¨­å®šåˆå§‹è£å‰ªå€åŸŸï¼ˆ2:3æ¯”ä¾‹ï¼Œå±…ä¸­ï¼‰
            let cropWidth, cropHeight;
            if (imgWidth / imgHeight > 2/3) {
                // åœ–ç‰‡è¼ƒå¯¬ï¼Œä»¥é«˜åº¦ç‚ºæº–
                cropHeight = imgHeight * 0.8;
                cropWidth = cropHeight * (2/3);
            } else {
                // åœ–ç‰‡è¼ƒé«˜ï¼Œä»¥å¯¬åº¦ç‚ºæº–
                cropWidth = imgWidth * 0.8;
                cropHeight = cropWidth * (3/2);
            }
            
            const cropX = (imgWidth - cropWidth) / 2;
            const cropY = (imgHeight - cropHeight) / 2;
            
            overlay.style.left = cropX + 'px';
            overlay.style.top = cropY + 'px';
            overlay.style.width = cropWidth + 'px';
            overlay.style.height = cropHeight + 'px';
            
            // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
            addCropInteraction();
        }

        function addCropInteraction() {
            const overlay = document.getElementById('cropOverlay');
            const container = document.getElementById('cropContainer');
            const img = document.getElementById('cropImage');
            
            let isDragging = false;
            let isResizing = false;
            let startX, startY, startLeft, startTop, startWidth, startHeight;
            let resizeHandle = null;
            
            // æ‹–æ‹½ç§»å‹•
            overlay.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('crop-handle')) {
                    isResizing = true;
                    resizeHandle = e.target.classList[1]; // nw, ne, sw, se
                } else {
                    isDragging = true;
                }
                
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(overlay.style.left);
                startTop = parseInt(overlay.style.top);
                startWidth = parseInt(overlay.style.width);
                startHeight = parseInt(overlay.style.height);
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging && !isResizing) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                if (isDragging) {
                    let newLeft = startLeft + deltaX;
                    let newTop = startTop + deltaY;
                    
                    // é™åˆ¶åœ¨åœ–ç‰‡ç¯„åœå…§
                    newLeft = Math.max(0, Math.min(newLeft, img.offsetWidth - startWidth));
                    newTop = Math.max(0, Math.min(newTop, img.offsetHeight - startHeight));
                    
                    overlay.style.left = newLeft + 'px';
                    overlay.style.top = newTop + 'px';
                } else if (isResizing) {
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    let newLeft = startLeft;
                    let newTop = startTop;
                    
                    // æ ¹æ“šæ‹–æ‹½çš„è§’åº¦èª¿æ•´å°ºå¯¸ï¼Œä¿æŒ2:3æ¯”ä¾‹
                    if (resizeHandle.includes('e')) {
                        newWidth = startWidth + deltaX;
                    }
                    if (resizeHandle.includes('w')) {
                        newWidth = startWidth - deltaX;
                        newLeft = startLeft + deltaX;
                    }
                    if (resizeHandle.includes('s')) {
                        newHeight = startHeight + deltaY;
                    }
                    if (resizeHandle.includes('n')) {
                        newHeight = startHeight - deltaY;
                        newTop = startTop + deltaY;
                    }
                    
                    // ä¿æŒ2:3æ¯”ä¾‹
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        newHeight = newWidth * (3/2);
                    } else {
                        newWidth = newHeight * (2/3);
                    }
                    
                    // é™åˆ¶æœ€å°å°ºå¯¸
                    newWidth = Math.max(50, newWidth);
                    newHeight = Math.max(75, newHeight);
                    
                    // é™åˆ¶åœ¨åœ–ç‰‡ç¯„åœå…§
                    if (newLeft + newWidth > img.offsetWidth) {
                        newWidth = img.offsetWidth - newLeft;
                        newHeight = newWidth * (3/2);
                    }
                    if (newTop + newHeight > img.offsetHeight) {
                        newHeight = img.offsetHeight - newTop;
                        newWidth = newHeight * (2/3);
                    }
                    if (newLeft < 0) {
                        newLeft = 0;
                    }
                    if (newTop < 0) {
                        newTop = 0;
                    }
                    
                    overlay.style.width = newWidth + 'px';
                    overlay.style.height = newHeight + 'px';
                    overlay.style.left = newLeft + 'px';
                    overlay.style.top = newTop + 'px';
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
                isResizing = false;
                resizeHandle = null;
            });
        }

        function resetCropArea() {
            initializeCropArea();
        }

        function applyCrop() {
            const img = document.getElementById('cropImage');
            const overlay = document.getElementById('cropOverlay');
            
            const cropX = parseInt(overlay.style.left);
            const cropY = parseInt(overlay.style.top);
            const cropWidth = parseInt(overlay.style.width);
            const cropHeight = parseInt(overlay.style.height);
            
            // è¨ˆç®—åŸå§‹<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicler Editor</title>
    <style>
        /* å­—é«” */
        @import url("https://fontsapi.zeoseven.com/563/main/result.css");
        
        :root {
            --primary-color: #2d3748;
            --secondary-color: #1a202c;
            --accent-color: #8b7355;
            --bg-color: #f7f5f3;
            --surface-color: #ffffff;
            --text-color: #2d3748;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-large: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Serif CJK JP", 'Georgia', 'Times New Roman', serif;
            font-weight: normal;
            background: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: var(--bg-color);
        }

        /* å´é‚Šæ¬„ - ç²¾ç°¡è¨­è¨ˆ */
        .sidebar {
            width: 280px;
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-light);
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-color);
        }

        .sidebar-title {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 15px;
        }

        .sidebar-controls {
            display: flex;
            gap: 8px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .character-item {
            margin-bottom: 8px;
        }

        .character-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s ease;
            color: var(--text-color);
        }

        .character-header:hover {
            background: var(--bg-color);
            border-color: var(--border-color);
        }

        .character-header.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .character-header.expanded {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .version-list {
            padding-left: 16px;
            margin-top: 4px;
            display: none;
        }

        .version-list.expanded {
            display: block;
        }

        .version-item {
            padding: 8px 16px;
            margin: 2px 0;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
            color: var(--text-muted);
        }

        .version-item:hover {
            background: var(--bg-color);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .version-item.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* ä¸»è¦å…§å®¹å€ - è‹±å€«é¢¨æ ¼ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-color);
        }

        .header {
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .toggle-sidebar {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .toggle-sidebar:hover {
            background: var(--bg-color);
            color: var(--text-color);
        }

        .app-title-container {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .app-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.02em;
        }

        .app-version {
            font-size: 0.75em;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-color);
        }

        .view-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--surface-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            align-items: center;
            flex-wrap: wrap;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--surface-color);
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        /* æŒ‰éˆ•æ¨£å¼ - è‹±å€«é¢¨æ ¼ */
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85em;
            transition: all 0.2s ease;
            background: var(--surface-color);
            color: var(--text-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-light);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-color);
        }

        .btn-accent {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        /* ç‰ˆæœ¬é¢æ¿ - æ–‡å­¸ç·¨è¼¯å™¨é¢¨æ ¼ */
        .versions-container {
            display: grid;
            gap: 24px;
        }

        .versions-container.single-view {
            grid-template-columns: 1fr;
        }

        .versions-container.compare-view {
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        }

        .version-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
        }

        .version-panel:hover {
            box-shadow: var(--shadow-medium);
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .version-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
            background: transparent;
            border: 1px solid transparent;
            padding: 6px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .version-title:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-color);
        }

        /* è¡¨å–®æ¬„ä½ - ç²¾ç·»è¨­è¨ˆ */
        .field-group {
            margin-bottom: 24px;
        }

        .field-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .field-stats {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-left: 12px;
            font-style: italic;
        }

        .field-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            font-family: "Noto Serif CJK JP", 'Georgia', serif;
            transition: all 0.2s ease;
            background: var(--surface-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(45, 55, 72, 0.1);
        }

        textarea.field-input {
            min-height: 120px;
            resize: vertical;
        }

        /* è§’è‰²åœ–ç‰‡å’Œè³‡è¨Šå€åŸŸ */
        .character-info-section {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 24px;
            margin-bottom: 24px;
            align-items: start;
        }

        .avatar-container {
            width: 200px;
            position: relative;
        }

        .avatar-display {
            width: 100%;
            aspect-ratio: 2/3;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            object-fit: cover;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.9em;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .avatar-upload-overlay {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
        }

        .character-meta-fields {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .meta-field-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .meta-field-label {
            font-size: 0.85em;
            font-weight: 500;
            color: var(--text-color);
        }

        .meta-field-input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.85em;
            font-family: "Noto Serif CJK JP", 'Georgia', serif;
            transition: all 0.2s ease;
            background: var(--surface-color);
            color: var(--text-color);
        }

        .meta-field-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(45, 55, 72, 0.1);
        }

        .file-input {
            display: none;
        }

        .file-label {
            padding: 8px 16px;
            background: var(--success-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            border: 1px solid var(--success-color);
            transition: all 0.2s ease;
            font-size: 0.85em;
        }

        .file-label:hover {
            background: transparent;
            color: var(--success-color);
        }

        /* åº•éƒ¨æ¬„ä½å€åŸŸ */
        .bottom-fields {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .bottom-fields .field-group {
            margin-bottom: 16px;
        }

        .bottom-fields .field-input {
            padding: 8px 12px;
            font-size: 0.85em;
        }

        .bottom-fields h4 {
            margin-bottom: 16px;
            color: var(--text-muted);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        /* åŒ¯å‡ºå€åŸŸ */
        .export-section {
            margin-top: 32px;
            padding: 24px;
            background: var(--surface-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: var(--shadow-light);
        }

        .export-section h3 {
            margin-bottom: 16px;
            color: var(--text-color);
            font-size: 1.1em;
            font-weight: 600;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* å½ˆçª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(45, 55, 72, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 5% auto;
            padding: 32px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 520px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-large);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            color: var(--danger-color);
            background: var(--bg-color);
        }

        .color-input-group {
            margin-bottom: 20px;
        }

        .color-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .color-input {
            width: 100%;
            height: 48px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .color-input:hover {
            border-color: var(--primary-color);
        }

        .color-preview {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            padding: 16px;
            background: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .color-preview-item {
            flex: 1;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: white;
            font-size: 0.8em;
        }

        .version-compare-controls {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .version-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .version-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .version-checkbox:hover {
            border-color: var(--primary-color);
        }

        .version-checkbox.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .version-checkbox input[type="checkbox"] {
            margin: 0;
        }

        /* åœ–ç‰‡è£å‰ªå½ˆçª— */
        .crop-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .crop-modal-content {
            background-color: var(--surface-color);
            margin: 2% auto;
            padding: 24px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-large);
        }

        .crop-container {
            position: relative;
            max-width: 100%;
            margin: 20px 0;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .crop-image {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .crop-overlay {
            position: absolute;
            border: 2px solid var(--primary-color);
            background: rgba(45, 55, 72, 0.1);
            cursor: move;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            border: 2px solid white;
            border-radius: 50%;
        }

        .crop-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .crop-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .crop-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        .crop-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .crop-info {
            text-align: center;
            margin: 16px 0;
            color: var(--text-muted);
            font-size: 0.9em;
        }

        /* ä¸»é¡Œé¡è‰²é¸æ“‡å™¨ */
        .theme-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .theme-preset {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .theme-preset:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }

        .theme-preset.active {
            border-color: var(--primary-color);
            border-width: 3px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 100;
                width: 280px;
                transform: translateX(-280px);
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                transform: translateX(-280px);
                width: 280px;
            }
            
            .versions-container.compare-view {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 12px 16px;
            }

            .content-area {
                padding: 16px;
            }
        }

        /* é è¨­ä¸»é¡Œé…è‰² */
        .theme-classic { background: linear-gradient(135deg, #2d3748, #8b7355); }
        .theme-warm { background: linear-gradient(135deg, #744210, #d69e2e); }
        .theme-cool { background: linear-gradient(135deg, #2c5282, #3182ce); }
        .theme-forest { background: linear-gradient(135deg, #22543d, #38a169); }
        .theme-vintage { background: linear-gradient(135deg, #553c9a, #9f7aea); }
        .theme-minimal { background: linear-gradient(135deg, #4a5568, #718096); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å´é‚Šæ¬„ -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">è§’è‰²ç®¡ç†</div>
                <div class="sidebar-controls">
                    <button class="btn btn-primary btn-small" onclick="addCharacter()">æ–°å¢</button>
                    <button class="btn btn-secondary btn-small" onclick="saveData()">å„²å­˜</button>
                </div>
            </div>
            <div class="sidebar-content" id="sidebarContent">
                <!-- è§’è‰²åˆ—è¡¨æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <div class="app-title-container">
                        <h1 class="app-title">Chronicler Editor</h1>
                        <span class="app-version">v1.0.0</span>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="btn btn-secondary" onclick="showColorPicker()">è‡ªè¨‚é¡è‰²</button>
                    <button class="btn btn-secondary" onclick="exportAllData()">åŒ¯å‡ºè³‡æ–™</button>
                    <button class="btn btn-secondary" onclick="importAllData()">åŒ¯å…¥è³‡æ–™</button>
                    <button class="btn btn-secondary" onclick="importCharacter()">åŒ¯å…¥è§’è‰²</button>
                    <input type="file" id="importFile" accept=".json,.png" style="display: none;" onchange="handleImport(event)">
                    <input type="file" id="importAllFile" accept=".json" style="display: none;" onchange="handleImportAll(event)">
                </div>
            </div>

            <div class="content-area" id="contentArea">
                <!-- å…§å®¹æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        let characters = [];
        let currentCharacterId = null;
        let currentVersionId = null;
        let viewMode = 'single'; // 'single' æˆ– 'compare'
        let sidebarCollapsed = false;
        let compareVersions = []; // ç”¨æ–¼å°æ¯”æª¢è¦–çš„ç‰ˆæœ¬é¸æ“‡

        // ä¸»é¡Œé…è‰² - è‹±å€«é¢¨ä½å½©åº¦é…è‰²
        const themes = {
            classic: { primary: '#2d3748', secondary: '#1a202c', accent: '#8b7355', bg: '#f7f5f3' },
            warm: { primary: '#744210', secondary: '#553c9a', accent: '#d69e2e', bg: '#fefcf0' },
            cool: { primary: '#2c5282', secondary: '#2a4365', accent: '#3182ce', bg: '#f0f8ff' },
            forest: { primary: '#22543d', secondary: '#1a202c', accent: '#38a169', bg: '#f0fff4' },
            vintage: { primary: '#553c9a', secondary: '#44337a', accent: '#9f7aea', bg: '#faf5ff' },
            minimal: { primary: '#4a5568', secondary: '#2d3748', accent: '#718096', bg: '#f8f9fa' }
        };

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function countTokens(text) {
            if (!text) return 0;
            
            // æ›´ç²¾æº–çš„tokenè¨ˆç®—ï¼Œæ¨¡æ“¬GPT-4çš„BPE tokenizer
            // é è™•ç†ï¼šç§»é™¤å¤šé¤˜ç©ºç™½
            text = text.trim().replace(/\s+/g, ' ');
            
            let tokenCount = 0;
            let i = 0;
            
            while (i < text.length) {
                const char = text[i];
                
                // ä¸­æ–‡å­—ç¬¦ï¼ˆåŒ…æ‹¬æ—¥æ–‡ã€éŸ“æ–‡ï¼‰- é€šå¸¸æ˜¯1 token
                if (/[\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(char)) {
                    tokenCount += 1;
                    i++;
                }
                // è‹±æ–‡å–®è©è™•ç†
                else if (/[a-zA-Z]/.test(char)) {
                    let wordStart = i;
                    while (i < text.length && /[a-zA-Z]/.test(text[i])) {
                        i++;
                    }
                    const word = text.slice(wordStart, i);
                    
                    // è‹±æ–‡å–®è©çš„tokenä¼°ç®—
                    if (word.length <= 3) {
                        tokenCount += 1;
                    } else if (word.length <= 6) {
                        tokenCount += 1.5;
                    } else if (word.length <= 10) {
                        tokenCount += 2;
                    } else {
                        tokenCount += Math.ceil(word.length / 4);
                    }
                }
                // æ•¸å­—è™•ç†
                else if (/[0-9]/.test(char)) {
                    let numStart = i;
                    while (i < text.length && /[0-9.,]/.test(text[i])) {
                        i++;
                    }
                    const num = text.slice(numStart, i);
                    // æ•¸å­—é€šå¸¸æ¯2-4ä½æ˜¯1å€‹token
                    tokenCount += Math.ceil(num.replace(/[.,]/g, '').length / 3);
                }
                // æ¨™é»ç¬¦è™Ÿå’Œç‰¹æ®Šå­—ç¬¦
                else if (/[^\s]/.test(char)) {
                    // å¸¸è¦‹æ¨™é»ç¬¦è™Ÿçµ„åˆ
                    if (i < text.length - 1) {
                        const twoChar = text.slice(i, i + 2);
                        if (['--', '...', '!!', '??', '::'].includes(twoChar)) {
                            tokenCount += 1;
                            i += 2;
                            continue;
                        }
                    }
                    
                    // å–®å€‹æ¨™é»ç¬¦è™Ÿ
                    if (/[.!?,:;()[\]{}"'`~@#$%^&*+=<>|\\/-]/.test(char)) {
                        tokenCount += 0.5;
                    } else {
                        tokenCount += 1;
                    }
                    i++;
                }
                // ç©ºç™½å­—ç¬¦
                else {
                    // ç©ºæ ¼é€šå¸¸ä¸å–®ç¨è¨ˆç®—tokenï¼Œä½†æœƒå½±éŸ¿åˆ†è©
                    i++;
                }
            }
            
            // åŠ ä¸Šä¸€äº›ç‰¹æ®Šæ ¼å¼çš„é¡å¤–tokenï¼ˆå¦‚{{user}}, {{char}}ç­‰ï¼‰
            const specialTokens = text.match(/\{\{(user|char|random|pick|roll)\}\}/g);
            if (specialTokens) {
                tokenCount += specialTokens.length * 0.5;
            }
            
            return Math.ceil(tokenCount);
        }

        function toggleSidebar() {
            // ç§»é™¤å´é‚Šæ¬„åˆ‡æ›åŠŸèƒ½
        }

        function changeTheme(themeName) {
            // ç§»é™¤ä¸»é¡Œåˆ‡æ›åŠŸèƒ½ï¼Œåªä¿ç•™è‡ªè¨‚é¡è‰²
        }

        function showColorPicker() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">è‡ªè¨‚ä¸»é¡Œé¡è‰²</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    
                    <div class="color-input-group">
                        <label>ä¸»è¦é¡è‰²</label>
                        <input type="color" class="color-input" id="primary-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim()}">
                    </div>
                    
                    <div class="color-input-group">
                        <label>æ¬¡è¦é¡è‰²</label>
                        <input type="color" class="color-input" id="secondary-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim()}">
                    </div>
                    
                    <div class="color-input-group">
                        <label>å¼·èª¿é¡è‰²</label>
                        <input type="color" class="color-input" id="accent-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim()}">
                    </div>

                    <div class="color-input-group">
                        <label>èƒŒæ™¯é¡è‰²</label>
                        <input type="color" class="color-input" id="bg-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim()}">
                    </div>
                    
                    <div class="color-preview">
                        <div class="color-preview-item" id="preview-primary">ä¸»è¦</div>
                        <div class="color-preview-item" id="preview-secondary">æ¬¡è¦</div>
                        <div class="color-preview-item" id="preview-accent">å¼·èª¿</div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="applyCustomColors()">å¥—ç”¨</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // é è¦½é¡è‰²è®ŠåŒ–
            const primaryInput = document.getElementById('primary-color');
            const secondaryInput = document.getElementById('secondary-color');
            const accentInput = document.getElementById('accent-color');
            const bgInput = document.getElementById('bg-color');
            
            function updatePreview() {
                document.getElementById('preview-primary').style.backgroundColor = primaryInput.value;
                document.getElementById('preview-secondary').style.backgroundColor = secondaryInput.value;
                document.getElementById('preview-accent').style.backgroundColor = accentInput.value;
            }
            
            primaryInput.addEventListener('input', updatePreview);
            secondaryInput.addEventListener('input', updatePreview);
            accentInput.addEventListener('input', updatePreview);
            bgInput.addEventListener('input', updatePreview);
            
            updatePreview();
            
            // é»æ“Šå¤–éƒ¨é—œé–‰
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function applyCustomColors() {
            const primary = document.getElementById('primary-color').value;
            const secondary = document.getElementById('secondary-color').value;
            const accent = document.getElementById('accent-color').value;
            const bg = document.getElementById('bg-color').value;
            
            const root = document.documentElement;
            root.style.setProperty('--primary-color', primary);
            root.style.setProperty('--secondary-color', secondary);
            root.style.setProperty('--accent-color', accent);
            root.style.setProperty('--bg-color', bg);
            
            // å„²å­˜è‡ªè¨‚é¡è‰²
            localStorage.setItem('characterCreatorCustomColors', JSON.stringify({
                primary, secondary, accent, bg
            }));
            
            document.querySelector('.modal').remove();
        }

        function saveData() {
            try {
                localStorage.setItem('characterCreatorData', JSON.stringify(characters));
                // éœé»˜å„²å­˜
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—ï¼š', error);
            }
        }

        function showSaveNotification() {
            // å‰µå»ºå„²å­˜æˆåŠŸæç¤º
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 0.9em;
                font-weight: 500;
                z-index: 9999;
                box-shadow: var(--shadow-medium);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = 'âœ“ å·²å„²å­˜åˆ°ç€è¦½å™¨';
            
            document.body.appendChild(notification);
            
            // æ»‘å…¥å‹•ç•«
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 3ç§’å¾Œç§»é™¤
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        function exportAllData() {
            const exportData = {
                characters: characters,
                exportDate: new Date().toISOString(),
                version: '1.0.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronicler_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importAllData() {
            document.getElementById('importAllFile').click();
        }

        function handleImportAll(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.characters && Array.isArray(data.characters)) {
                        const confirmImport = confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${data.characters.length} å€‹è§’è‰²å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è³‡æ–™ï¼`);
                        
                        if (confirmImport) {
                            characters = data.characters;
                            currentCharacterId = characters[0]?.id || null;
                            currentVersionId = characters[0]?.versions[0]?.id || null;
                            compareVersions = [];
                            
                            renderAll();
                            saveData();
                            alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                        }
                    } else {
                        alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„å‚™ä»½æª”æ¡ˆ');
                    }
                } catch (error) {
                    alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('characterCreatorData');
                if (saved) {
                    characters = JSON.parse(saved);
                    if (characters.length > 0) {
                        currentCharacterId = characters[0].id;
                        currentVersionId = characters[0].versions[0].id;
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š', error);
            }
        }

        function addCharacter() {
            const character = {
                id: generateId(),
                name: `è§’è‰² ${characters.length + 1}`,
                versions: [{
                    id: generateId(),
                    name: 'ç‰ˆæœ¬ 1',
                    avatar: '',
                    description: '',
                    personality: '',
                    scenario: '',
                    dialogue: '',
                    firstMessage: '',
                    creator: '',
                    charVersion: '',
                    creatorNotes: '',
                    tags: ''
                }]
            };
            characters.push(character);
            currentCharacterId = character.id;
            currentVersionId = character.versions[0].id;
            renderAll();
            saveData();
        }

        function removeCharacter(characterId) {
            if (characters.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹è§’è‰²');
                return;
            }
            characters = characters.filter(c => c.id !== characterId);
            if (currentCharacterId === characterId) {
                currentCharacterId = characters[0]?.id || null;
                currentVersionId = characters[0]?.versions[0]?.id || null;
            }
            renderAll();
            saveData();
        }

        function addVersion(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (character) {
                const newVersion = {
                    id: generateId(),
                    name: `ç‰ˆæœ¬ ${character.versions.length + 1}`,
                    avatar: '',
                    description: '',
                    personality: '',
                    scenario: '',
                    dialogue: '',
                    firstMessage: '',
                    creator: '',
                    charVersion: '',
                    creatorNotes: '',
                    tags: ''
                };
                character.versions.push(newVersion);
                currentVersionId = newVersion.id;
                renderAll();
                saveData();
            }
        }

        function removeVersion(characterId, versionId) {
            const character = characters.find(c => c.id === characterId);
            if (character && character.versions.length > 1) {
                character.versions = character.versions.filter(v => v.id !== versionId);
                if (currentVersionId === versionId) {
                    currentVersionId = character.versions[0].id;
                }
                renderAll();
                saveData();
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç‰ˆæœ¬');
            }
        }

        function selectCharacter(characterId) {
            currentCharacterId = characterId;
            const character = characters.find(c => c.id === characterId);
            if (character) {
                currentVersionId = character.versions[0].id;
            }
            renderAll();
        }

        function selectVersion(characterId, versionId) {
            currentCharacterId = characterId;
            currentVersionId = versionId;
            viewMode = 'single';
            renderAll();
        }

        function toggleCompareMode() {
            if (viewMode === 'single') {
                const currentCharacter = characters.find(c => c.id === currentCharacterId);
                if (currentCharacter && currentCharacter.versions.length > 1) {
                    showVersionSelector();
                } else {
                    alert('éœ€è¦è‡³å°‘2å€‹ç‰ˆæœ¬æ‰èƒ½é€²è¡Œå°æ¯”');
                }
            } else {
                viewMode = 'single';
                compareVersions = [];
                renderAll();
            }
        }

        function showVersionSelector() {
            const currentCharacter = characters.find(c => c.id === currentCharacterId);
            if (!currentCharacter) return;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">é¸æ“‡è¦å°æ¯”çš„ç‰ˆæœ¬</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    
                    <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9em;">é¸æ“‡2-3å€‹ç‰ˆæœ¬é€²è¡Œå°æ¯” (ç›®å‰å·²é¸: <span id="selected-count">0</span>/3)</p>
                    
                    <div class="version-checkboxes">
                        ${currentCharacter.versions.map(version => `
                            <div class="version-checkbox" data-version-id="${version.id}" onclick="toggleVersionSelection('${version.id}')">
                                <input type="checkbox" id="check-${version.id}" onchange="event.stopPropagation()">
                                <label for="check-${version.id}">${version.name}</label>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="applyVersionComparison()" id="apply-compare" disabled>é–‹å§‹å°æ¯”</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ¢å¾©ä¹‹å‰çš„é¸æ“‡
            compareVersions.forEach(versionId => {
                const checkbox = document.getElementById(`check-${versionId}`);
                const container = document.querySelector(`[data-version-id="${versionId}"]`);
                if (checkbox && container) {
                    checkbox.checked = true;
                    container.classList.add('selected');
                }
            });
            updateSelectedCount();
            
            // é»æ“Šå¤–éƒ¨é—œé–‰
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function toggleVersionSelection(versionId) {
            const checkbox = document.getElementById(`check-${versionId}`);
            const container = document.querySelector(`[data-version-id="${versionId}"]`);
            
            if (checkbox.checked) {
                // å–æ¶ˆé¸æ“‡
                checkbox.checked = false;
                container.classList.remove('selected');
                compareVersions = compareVersions.filter(id => id !== versionId);
            } else {
                // æ–°å¢é¸æ“‡
                if (compareVersions.length < 3) {
                    checkbox.checked = true;
                    container.classList.add('selected');
                    compareVersions.push(versionId);
                } else {
                    alert('æœ€å¤šåªèƒ½é¸æ“‡3å€‹ç‰ˆæœ¬');
                }
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selected-count');
            const applyButton = document.getElementById('apply-compare');
            
            if (countElement) {
                countElement.textContent = compareVersions.length;
            }
            
            if (applyButton) {
                applyButton.disabled = compareVersions.length < 2;
            }
        }

        function applyVersionComparison() {
            if (compareVersions.length >= 2) {
                viewMode = 'compare';
                document.querySelector('.modal').remove();
                renderAll();
            }
        }

        function updateField(characterId, versionId, field, value) {
            const character = characters.find(c => c.id === characterId);
            if (character) {
                const version = character.versions.find(v => v.id === versionId);
                if (version) {
                    version[field] = value;
                    updateStats();
                    saveData();
                }
            }
        }

        function updateCharacterName(characterId, name) {
            const character = characters.find(c => c.id === characterId);
            if (character) {
                character.name = name;
                renderSidebar();
                saveData();
            }
        }

        function updateVersionName(characterId, versionId, name) {
            const character = characters.find(c => c.id === characterId);
            if (character) {
                const version = character.versions.find(v => v.id === versionId);
                if (version) {
                    version.name = name;
                    renderSidebar();
                    saveData();
                }
            }
        }

        function handleImageUpload(characterId, versionId, file) {
            if (file) {
                showImageCropModal(file, function(croppedImageData) {
                    updateField(characterId, versionId, 'avatar', croppedImageData);
                    renderContent();
                });
            }
        }

        function showImageCropModal(file, callback) {
            const modal = document.createElement('div');
            modal.className = 'crop-modal';
            modal.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                modal.innerHTML = `
                    <div class="crop-modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">è£å‰ªåœ–ç‰‡</h3>
                            <button class="close-modal" onclick="this.closest('.crop-modal').remove()">Ã—</button>
                        </div>
                        
                        <div class="crop-info">
                            æ‹–æ‹½é¸æ“‡æ¡†ä¾†èª¿æ•´è£å‰ªå€åŸŸã€‚åœ–ç‰‡å°‡è¢«è£å‰ªç‚º 2:3 æ¯”ä¾‹ï¼ˆå¯¬:é«˜ï¼‰
                        </div>
                        
                        <div class="crop-container" id="cropContainer">
                            <img class="crop-image" id="cropImage" src="${e.target.result}" alt="å¾…è£å‰ªåœ–ç‰‡">
                            <div class="crop-overlay" id="cropOverlay">
                                <div class="crop-handle nw"></div>
                                <div class="crop-handle ne"></div>
                                <div class="crop-handle sw"></div>
                                <div class="crop-handle se"></div>
                            </div>
                        </div>
                        
                        <div class="crop-controls">
                            <button class="btn btn-secondary" onclick="resetCropArea()">é‡ç½®</button>
                            <button class="btn btn-secondary" onclick="this.closest('.crop-modal').remove()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="applyCrop()">ç¢ºèªè£å‰ª</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // ç­‰å¾…åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–è£å‰ªå€åŸŸ
                const img = document.getElementById('cropImage');
                img.onload = function() {
                    initializeCropArea();
                };
                
                // å¦‚æœåœ–ç‰‡å·²ç¶“è¼‰å…¥ï¼Œç›´æ¥åˆå§‹åŒ–
                if (img.complete) {
                    initializeCropArea();
                }
                
                // å„²å­˜å›èª¿å‡½æ•¸
                window.currentCropCallback = callback;
                
                // é»æ“Šå¤–éƒ¨é—œé–‰
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            };
            
            reader.readAsDataURL(file);
        }

        function initializeCropArea() {
            const container = document.getElementById('cropContainer');
            const img = document.getElementById('cropImage');
            const overlay = document.getElementById('cropOverlay');
            
            const containerRect = container.getBoundingClientRect();
            const imgRect = img.getBoundingClientRect();
            
            // è¨ˆç®—åœ–ç‰‡åœ¨å®¹å™¨ä¸­çš„å¯¦éš›å°ºå¯¸å’Œä½ç½®
            const imgWidth = img.offsetWidth;
            const imgHeight = img.offsetHeight;
            
            // è¨­å®šåˆå§‹è£å‰ªå€åŸŸï¼ˆ2:3æ¯”ä¾‹ï¼Œå±…ä¸­ï¼‰
            let cropWidth, cropHeight;
            if (imgWidth / imgHeight > 2/3) {
                // åœ–ç‰‡è¼ƒå¯¬ï¼Œä»¥é«˜åº¦ç‚ºæº–
                cropHeight = imgHeight * 0.8;
                cropWidth = cropHeight * (2/3);
            } else {
                // åœ–ç‰‡è¼ƒé«˜ï¼Œä»¥å¯¬åº¦ç‚ºæº–
                cropWidth = imgWidth * 0.8;
                cropHeight = cropWidth * (3/2);
            }
            
            const cropX = (imgWidth - cropWidth) / 2;
            const cropY = (imgHeight - cropHeight) / 2;
            
            overlay.style.left = cropX + 'px';
            overlay.style.top = cropY + 'px';
            overlay.style.width = cropWidth + 'px';
            overlay.style.height = cropHeight + 'px';
            
            // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
            addCropInteraction();
        }

        function addCropInteraction() {
            const overlay = document.getElementById('cropOverlay');
            const container = document.getElementById('cropContainer');
            const img = document.getElementById('cropImage');
            
            let isDragging = false;
            let isResizing = false;
            let startX, startY, startLeft, startTop, startWidth, startHeight;
            let resizeHandle = null;
            
            // æ‹–æ‹½ç§»å‹•
            overlay.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('crop-handle')) {
                    isResizing = true;
                    resizeHandle = e.target.classList[1]; // nw, ne, sw, se
                } else {
                    isDragging = true;
                }
                
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(overlay.style.left);
                startTop = parseInt(overlay.style.top);
                startWidth = parseInt(overlay.style.width);
                startHeight = parseInt(overlay.style.height);
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging && !isResizing) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                if (isDragging) {
                    let newLeft = startLeft + deltaX;
                    let newTop = startTop + deltaY;
                    
                    // é™åˆ¶åœ¨åœ–ç‰‡ç¯„åœå…§
                    newLeft = Math.max(0, Math.min(newLeft, img.offsetWidth - startWidth));
                    newTop = Math.max(0, Math.min(newTop, img.offsetHeight - startHeight));
                    
                    overlay.style.left = newLeft + 'px';
                    overlay.style.top = newTop + 'px';
                } else if (isResizing) {
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    let newLeft = startLeft;
                    let newTop = startTop;
                    
                    // æ ¹æ“šæ‹–æ‹½çš„è§’åº¦èª¿æ•´å°ºå¯¸ï¼Œä¿æŒ2:3æ¯”ä¾‹
                    if (resizeHandle.includes('e')) {
                        newWidth = startWidth + deltaX;
                    }
                    if (resizeHandle.includes('w')) {
                        newWidth = startWidth - deltaX;
                        newLeft = startLeft + deltaX;
                    }
                    if (resizeHandle.includes('s')) {
                        newHeight = startHeight + deltaY;
                    }
                    if (resizeHandle.includes('n')) {
                        newHeight = startHeight - deltaY;
                        newTop = startTop + deltaY;
                    }
                    
                    // ä¿æŒ2:3æ¯”ä¾‹
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        newHeight = newWidth * (3/2);
                    } else {
                        newWidth = newHeight * (2/3);
                    }
                    
                    // é™åˆ¶æœ€å°å°ºå¯¸
                    newWidth = Math.max(50, newWidth);
                    newHeight = Math.max(75, newHeight);
                    
                    // é™åˆ¶åœ¨åœ–ç‰‡ç¯„åœå…§
                    if (newLeft + newWidth > img.offsetWidth) {
                        newWidth = img.offsetWidth - newLeft;
                        newHeight = newWidth * (3/2);
                    }
                    if (newTop + newHeight > img.offsetHeight) {
                        newHeight = img.offsetHeight - newTop;
                        newWidth = newHeight * (2/3);
                    }
                    if (newLeft < 0) {
                        newLeft = 0;
                    }
                    if (newTop < 0) {
                        newTop = 0;
                    }
                    
                    overlay.style.width = newWidth + 'px';
                    overlay.style.height = newHeight + 'px';
                    overlay.style.left = newLeft + 'px';
                    overlay.style.top = newTop + 'px';
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
                isResizing = false;
                resizeHandle = null;
            });
        }

        function resetCropArea() {
            initializeCropArea();
        }

        function applyCrop() {
            const img = document.getElementById('cropImage');
            const overlay = document.getElementById('cropOverlay');
            
            const cropX = parseInt(overlay.style.left);
            const cropY = parseInt(overlay.style.top);
            const cropWidth = parseInt(overlay.style.width);
            const cropHeight = parseInt(overlay.style.height);
            
            // è¨ˆç®—åŸå§‹åœ–ç‰‡çš„ç¸®æ”¾æ¯”ä¾‹
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è¨­å®šè¼¸å‡ºå°ºå¯¸ï¼ˆä¿æŒ2:3æ¯”ä¾‹ï¼‰
            const outputWidth = 400;
            const outputHeight = 600;
            canvas.width = outputWidth;
            canvas.height = outputHeight;
            
            // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
            const scaleX = img.naturalWidth / img.offsetWidth;
            const scaleY = img.naturalHeight / img.offsetHeight;
            
            // ç¹ªè£½è£å‰ªå¾Œçš„åœ–ç‰‡
            ctx.drawImage(
                img,
                cropX * scaleX,
                cropY * scaleY,
                cropWidth * scaleX,
                cropHeight * scaleY,
                0,
                0,
                outputWidth,
                outputHeight
            );
            
            // è½‰ç‚ºbase64
            const croppedImageData = canvas.toDataURL('image/png', 0.9);
            
            // åŸ·è¡Œå›èª¿
            if (window.currentCropCallback) {
                window.currentCropCallback(croppedImageData);
                window.currentCropCallback = null;
            }
            
            // é—œé–‰å½ˆçª—
            document.querySelector('.crop-modal').remove();
        }

        function updateStats() {
            const statsElements = document.querySelectorAll('.field-stats');
            statsElements.forEach(element => {
                const textareaId = element.dataset.target;
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    const text = textarea.value;
                    const charCount = text.length;
                    const tokenCount = countTokens(text);
                    element.textContent = `${charCount} å­— / ${tokenCount} tokens`;
                }
            });

            // æ›´æ–°metaæ¬„ä½çš„çµ±è¨ˆ
            const metaElements = document.querySelectorAll('.meta-field-input');
            metaElements.forEach(element => {
                const text = element.value;
                const charCount = text.length;
                const tokenCount = countTokens(text);
                // å¯ä»¥é¸æ“‡æ˜¯å¦é¡¯ç¤ºmetaæ¬„ä½çš„çµ±è¨ˆï¼Œé€™è£¡å…ˆä¿æŒç°¡æ½”
            });
        }

        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            container.innerHTML = characters.map(character => `
                <div class="character-item">
                    <div class="character-header ${character.id === currentCharacterId && document.getElementById(`versions-${character.id}`)?.classList.contains('expanded') ? 'expanded' : (character.id === currentCharacterId ? 'active' : '')}" 
                         onclick="toggleCharacterVersions('${character.id}')">
                        <span>${character.name}</span>
                        <span style="font-size: 0.8em; opacity: 0.7;">${character.versions.length}</span>
                    </div>
                    <div class="version-list" id="versions-${character.id}">
                        ${character.versions.map(version => `
                            <div class="version-item ${version.id === currentVersionId ? 'active' : ''}" 
                                 onclick="selectVersion('${character.id}', '${version.id}')">
                                ${version.name}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleCharacterVersions(characterId) {
            selectCharacter(characterId);
            
            // åˆ‡æ›ç‰ˆæœ¬åˆ—è¡¨çš„é¡¯ç¤ºç‹€æ…‹
            const versionsList = document.getElementById(`versions-${characterId}`);
            const characterHeader = document.querySelector(`[onclick="toggleCharacterVersions('${characterId}')"]`);
            
            if (versionsList && characterHeader) {
                const isExpanded = versionsList.classList.contains('expanded');
                
                // é—œé–‰æ‰€æœ‰å…¶ä»–å±•é–‹çš„ç‰ˆæœ¬åˆ—è¡¨
                document.querySelectorAll('.version-list').forEach(list => {
                    list.classList.remove('expanded');
                });
                document.querySelectorAll('.character-header').forEach(header => {
                    header.classList.remove('expanded');
                });
                
                // åˆ‡æ›ç•¶å‰çš„ç‹€æ…‹
                if (!isExpanded) {
                    versionsList.classList.add('expanded');
                    characterHeader.classList.add('expanded');
                }
            }
        }

        function renderContent() {
            const container = document.getElementById('contentArea');
            const currentCharacter = characters.find(c => c.id === currentCharacterId);
            
            if (!currentCharacter) {
                container.innerHTML = '<div style="text-align: center; padding: 80px; color: var(--text-muted);">è«‹é¸æ“‡ä¸€å€‹è§’è‰²</div>';
                return;
            }

            const versionsToShow = viewMode === 'compare' ? 
                currentCharacter.versions.filter(v => compareVersions.includes(v.id)) : 
                currentCharacter.versions.filter(v => v.id === currentVersionId);

            container.innerHTML = `
                <div class="view-controls">
                    <button class="btn ${viewMode === 'single' ? 'btn-primary' : 'btn-secondary'}" onclick="viewMode='single'; compareVersions=[]; renderAll()">å–®ä¸€æª¢è¦–</button>
                    <button class="btn ${viewMode === 'compare' ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCompareMode()">
                        ${viewMode === 'compare' ? `å°æ¯”æª¢è¦– (${compareVersions.length})` : 'å°æ¯”æª¢è¦–'}
                    </button>
                    <button class="btn btn-secondary" onclick="addVersion('${currentCharacter.id}')">æ–°å¢ç‰ˆæœ¬</button>
                    <input type="text" class="field-input" style="width: 200px; margin: 0;" value="${currentCharacter.name}" 
                           onchange="updateCharacterName('${currentCharacter.id}', this.value)" placeholder="è§’è‰²åç¨±">
                    <button class="btn btn-danger btn-small" onclick="removeCharacter('${currentCharacter.id}')">åˆªé™¤è§’è‰²</button>
                </div>

                <div class="stats-bar">
                    <div class="total-stats" style="font-weight: 500; color: var(--text-color);">
                        ç¸½è¨ˆ - <span id="total-chars">0</span> å­— / <span id="total-tokens">0</span> tokens
                    </div>
                </div>

                <div class="versions-container ${viewMode}-view">
                    ${versionsToShow.map(version => renderVersionPanel(currentCharacter, version)).join('')}
                </div>

                <div class="export-section">
                    <h3>åŒ¯å‡ºè§’è‰²å¡</h3>
                    <div class="export-buttons">
                        <button class="btn btn-warning" onclick="exportJSON('${currentCharacter.id}')">åŒ¯å‡º JSON</button>
                        <button class="btn btn-warning" onclick="exportPNG('${currentCharacter.id}')">åŒ¯å‡º PNG</button>
                        <button class="btn btn-warning" onclick="exportAllVersions('${currentCharacter.id}')">åŒ¯å‡ºæ‰€æœ‰ç‰ˆæœ¬</button>
                    </div>
                </div>
            `;

            setTimeout(updateStats, 100);
        }

        function renderVersionPanel(character, version) {
            return `
                <div class="version-panel">
                    <div class="version-header">
                        <input type="text" class="version-title" value="${version.name}" 
                               onchange="updateVersionName('${character.id}', '${version.id}', this.value)">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-success btn-small" onclick="saveData(); showSaveNotification()">ğŸ’¾ å„²å­˜</button>
                            ${character.versions.length > 1 ? `<button class="btn btn-danger btn-small" onclick="removeVersion('${character.id}', '${version.id}')">åˆªé™¤</button>` : ''}
                        </div>
                    </div>

                    <div class="character-info-section">
                        <div class="avatar-container">
                            <div class="avatar-display">
                                ${version.avatar ? 
                                    `<img src="${version.avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" alt="è§’è‰²åœ–ç‰‡">` : 
                                    '<span>ç„¡åœ–ç‰‡</span>'
                                }
                                <div class="avatar-upload-overlay">
                                    <label class="file-label">
                                        é¸æ“‡åœ–ç‰‡
                                        <input type="file" class="file-input" accept="image/*" 
                                               onchange="handleImageUpload('${character.id}', '${version.id}', this.files[0])">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="character-meta-fields">
                            <div class="meta-field-group">
                                <label class="meta-field-label">å‰µä½œè€…</label>
                                <input type="text" class="meta-field-input" id="creator-${version.id}" 
                                       placeholder="å‰µä½œè€…åç¨±ï¼ˆå¯é¸ï¼‰..."
                                       oninput="updateField('${character.id}', '${version.id}', 'creator', this.value); updateStats()" 
                                       value="${version.creator || ''}">
                            </div>

                            <div class="meta-field-group">
                                <label class="meta-field-label">è§’è‰²ç‰ˆæœ¬</label>
                                <input type="text" class="meta-field-input" id="charVersion-${version.id}" 
                                       placeholder="ç‰ˆæœ¬è™Ÿç¢¼æˆ–æè¿°ï¼ˆå¯é¸ï¼‰..."
                                       oninput="updateField('${character.id}', '${version.id}', 'charVersion', this.value); updateStats()" 
                                       value="${version.charVersion || ''}">
                            </div>

                            <div class="meta-field-group">
                                <label class="meta-field-label">å‰µä½œè€…å‚™è¨»</label>
                                <input type="text" class="meta-field-input" id="creatorNotes-${version.id}" 
                                       placeholder="å‰µä½œå‚™è¨»æˆ–èªªæ˜ï¼ˆå¯é¸ï¼‰..."
                                       oninput="updateField('${character.id}', '${version.id}', 'creatorNotes', this.value); updateStats()" 
                                       value="${version.creatorNotes || ''}">
                            </div>

                            <div class="meta-field-group">
                                <label class="meta-field-label">åµŒå…¥æ¨™ç±¤</label>
                                <input type="text" class="meta-field-input" id="tags-${version.id}" 
                                       placeholder="æ¨™ç±¤ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼ˆå¯é¸ï¼‰..."
                                       oninput="updateField('${character.id}', '${version.id}', 'tags', this.value); updateStats()" 
                                       value="${version.tags || ''}">
                            </div>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            è§’è‰²æè¿°
                            <span class="field-stats" data-target="desc-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="desc-${version.id}" 
                                  placeholder="æè¿°è§’è‰²çš„å¤–è²Œã€èƒŒæ™¯ã€è¨­å®šç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'description', this.value); updateStats()">${version.description}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å€‹æ€§æ‘˜è¦
                            <span class="field-stats" data-target="personality-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="personality-${version.id}" 
                                  placeholder="è§’è‰²çš„æ€§æ ¼ç‰¹å¾µã€è¡Œç‚ºæ¨¡å¼ã€èªªè©±æ–¹å¼ç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'personality', this.value); updateStats()">${version.personality}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å ´æ™¯è¨­æƒ³
                            <span class="field-stats" data-target="scenario-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="scenario-${version.id}" 
                                  placeholder="è§’è‰²æ‰€è™•çš„æƒ…å¢ƒã€ç’°å¢ƒã€ç•¶å‰ç‹€æ³ç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'scenario', this.value); updateStats()">${version.scenario}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å°è©±ç¯„ä¾‹
                            <span class="field-stats" data-target="dialogue-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="dialogue-${version.id}" 
                                  placeholder="{{user}}: ä½ å¥½ï¼\n{{char}}: ä½ å¥½å‘€ï¼å¾ˆé«˜èˆˆè¦‹åˆ°ä½ ï½"
                                  oninput="updateField('${character.id}', '${version.id}', 'dialogue', this.value); updateStats()">${version.dialogue}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            åˆå§‹è¨Šæ¯
                            <span class="field-stats" data-target="firstmsg-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="firstmsg-${version.id}" 
                                  placeholder="è§’è‰²çš„ç¬¬ä¸€å¥è©±æˆ–é–‹å ´ç™½..."
                                  oninput="updateField('${character.id}', '${version.id}', 'firstMessage', this.value); updateStats()">${version.firstMessage}</textarea>
                    </div>
                </div>
            `;
        } class="file-input" accept="image/*" 
                                       onchange="handleImageUpload('${character.id}', '${version.id}', this.files[0])">
                            </label>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            è§’è‰²æè¿°
                            <span class="field-stats" data-target="desc-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="desc-${version.id}" 
                                  placeholder="æè¿°è§’è‰²çš„å¤–è²Œã€èƒŒæ™¯ã€è¨­å®šç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'description', this.value); updateStats()">${version.description}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å€‹æ€§æ‘˜è¦
                            <span class="field-stats" data-target="personality-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="personality-${version.id}" 
                                  placeholder="è§’è‰²çš„æ€§æ ¼ç‰¹å¾µã€è¡Œç‚ºæ¨¡å¼ã€èªªè©±æ–¹å¼ç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'personality', this.value); updateStats()">${version.personality}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å ´æ™¯è¨­æƒ³
                            <span class="field-stats" data-target="scenario-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="scenario-${version.id}" 
                                  placeholder="è§’è‰²æ‰€è™•çš„æƒ…å¢ƒã€ç’°å¢ƒã€ç•¶å‰ç‹€æ³ç­‰..."
                                  oninput="updateField('${character.id}', '${version.id}', 'scenario', this.value); updateStats()">${version.scenario}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            å°è©±ç¯„ä¾‹
                            <span class="field-stats" data-target="dialogue-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="dialogue-${version.id}" 
                                  placeholder="{{user}}: ä½ å¥½ï¼\n{{char}}: ä½ å¥½å‘€ï¼å¾ˆé«˜èˆˆè¦‹åˆ°ä½ ï½"
                                  oninput="updateField('${character.id}', '${version.id}', 'dialogue', this.value); updateStats()">${version.dialogue}</textarea>
                    </div>

                    <div class="field-group">
                        <label class="field-label">
                            åˆå§‹è¨Šæ¯
                            <span class="field-stats" data-target="firstmsg-${version.id}">0 å­— / 0 tokens</span>
                        </label>
                        <textarea class="field-input" id="firstmsg-${version.id}" 
                                  placeholder="è§’è‰²çš„ç¬¬ä¸€å¥è©±æˆ–é–‹å ´ç™½..."
                                  oninput="updateField('${character.id}', '${version.id}', 'firstMessage', this.value); updateStats()">${version.firstMessage}</textarea>
                    </div>

                    <div class="bottom-fields">
                        <h4>é™„åŠ è³‡è¨Š</h4>
                        
                        <div class="field-group">
                            <label class="field-label">
                                å‰µä½œè€…
                                <span class="field-stats" data-target="creator-${version.id}">0 å­— / 0 tokens</span>
                            </label>
                            <input type="text" class="field-input" id="creator-${version.id}" 
                                   placeholder="å‰µä½œè€…åç¨±ï¼ˆå¯é¸ï¼‰..."
                                   oninput="updateField('${character.id}', '${version.id}', 'creator', this.value); updateStats()" 
                                   value="${version.creator || ''}">
                        </div>

                        <div class="field-group">
                            <label class="field-label">
                                è§’è‰²ç‰ˆæœ¬
                                <span class="field-stats" data-target="charVersion-${version.id}">0 å­— / 0 tokens</span>
                            </label>
                            <input type="text" class="field-input" id="charVersion-${version.id}" 
                                   placeholder="ç‰ˆæœ¬è™Ÿç¢¼æˆ–æè¿°ï¼ˆå¯é¸ï¼‰..."
                                   oninput="updateField('${character.id}', '${version.id}', 'charVersion', this.value); updateStats()" 
                                   value="${version.charVersion || ''}">
                        </div>

                        <div class="field-group">
                            <label class="field-label">
                                å‰µä½œè€…å‚™è¨»
                                <span class="field-stats" data-target="creatorNotes-${version.id}">0 å­— / 0 tokens</span>
                            </label>
                            <input type="text" class="field-input" id="creatorNotes-${version.id}" 
                                   placeholder="å‰µä½œå‚™è¨»æˆ–èªªæ˜ï¼ˆå¯é¸ï¼‰..."
                                   oninput="updateField('${character.id}', '${version.id}', 'creatorNotes', this.value); updateStats()" 
                                   value="${version.creatorNotes || ''}">
                        </div>

                        <div class="field-group">
                            <label class="field-label">
                                åµŒå…¥æ¨™ç±¤
                                <span class="field-stats" data-target="tags-${version.id}">0 å­— / 0 tokens</span>
                            </label>
                            <input type="text" class="field-input" id="tags-${version.id}" 
                                   placeholder="æ¨™ç±¤ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼ˆå¯é¸ï¼‰..."
                                   oninput="updateField('${character.id}', '${version.id}', 'tags', this.value); updateStats()" 
                                   value="${version.tags || ''}">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAll() {
            renderSidebar();
            renderContent();
            updateTotalStats();
        }

        function updateTotalStats() {
            const currentCharacter = characters.find(c => c.id === currentCharacterId);
            if (!currentCharacter) return;

            let totalChars = 0;
            let totalTokens = 0;
            
            const versionsToCount = viewMode === 'compare' ? 
                currentCharacter.versions.filter(v => compareVersions.includes(v.id)) : 
                currentCharacter.versions.filter(v => v.id === currentVersionId);

            versionsToCount.forEach(version => {
                const allText = [
                    version.description, version.personality, version.scenario, 
                    version.dialogue, version.firstMessage, version.creator, 
                    version.charVersion, version.creatorNotes, version.tags
                ].join(' ');
                totalChars += allText.length;
                totalTokens += countTokens(allText);
            });

            const charsElement = document.getElementById('total-chars');
            const tokensElement = document.getElementById('total-tokens');
            if (charsElement) charsElement.textContent = totalChars;
            if (tokensElement) tokensElement.textContent = totalTokens;
        }

        function exportJSON(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            if (character.versions.length === 1) {
                downloadJSON(character, character.versions[0]);
            } else {
                const versionIndex = prompt(`é¸æ“‡è¦åŒ¯å‡ºçš„ç‰ˆæœ¬ (1-${character.versions.length}):`);
                const index = parseInt(versionIndex) - 1;
                if (index >= 0 && index < character.versions.length) {
                    downloadJSON(character, character.versions[index]);
                }
            }
        }

        function downloadJSON(character, version) {
            const characterData = {
                name: character.name,
                description: version.description,
                personality: version.personality,
                scenario: version.scenario,
                first_mes: version.firstMessage,
                mes_example: version.dialogue,
                creatorcomment: version.creatorNotes,
                avatar: "none",
                talkativeness: "0.5",
                fav: false,
                tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                spec: "chara_card_v3",
                spec_version: "3.0",
                data: {
                    name: character.name,
                    description: version.description,
                    personality: version.personality,
                    scenario: version.scenario,
                    first_mes: version.firstMessage,
                    mes_example: version.dialogue,
                    creator_notes: version.creatorNotes,
                    system_prompt: "",
                    post_history_instructions: "",
                    tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    creator: version.creator,
                    character_version: version.charVersion,
                    alternate_greetings: [],
                    extensions: {
                        talkativeness: "0.5",
                        fav: false,
                        world: "",
                        depth_prompt: {
                            prompt: "",
                            depth: 4,
                            role: "system"
                        }
                    },
                    group_only_greetings: []
                },
                create_date: new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
            };

            const blob = new Blob([JSON.stringify(characterData, null, 4)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportPNG(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            // é¸æ“‡ç‰ˆæœ¬
            let selectedVersion;
            if (character.versions.length === 1) {
                selectedVersion = character.versions[0];
            } else {
                const versionIndex = prompt(`é¸æ“‡è¦åŒ¯å‡ºçš„ç‰ˆæœ¬ (1-${character.versions.length}):`);
                const index = parseInt(versionIndex) - 1;
                if (index >= 0 && index < character.versions.length) {
                    selectedVersion = character.versions[index];
                } else {
                    return;
                }
            }

            // å‰µå»ºèˆ‡JSONç›¸åŒçš„è³‡æ–™çµæ§‹
            const characterData = {
                name: character.name,
                description: selectedVersion.description,
                personality: selectedVersion.personality,
                scenario: selectedVersion.scenario,
                first_mes: selectedVersion.firstMessage,
                mes_example: selectedVersion.dialogue,
                creatorcomment: selectedVersion.creatorNotes,
                avatar: "none",
                talkativeness: "0.5",
                fav: false,
                tags: selectedVersion.tags ? selectedVersion.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                spec: "chara_card_v3",
                spec_version: "3.0",
                data: {
                    name: character.name,
                    description: selectedVersion.description,
                    personality: selectedVersion.personality,
                    scenario: selectedVersion.scenario,
                    first_mes: selectedVersion.firstMessage,
                    mes_example: selectedVersion.dialogue,
                    creator_notes: selectedVersion.creatorNotes,
                    system_prompt: "",
                    post_history_instructions: "",
                    tags: selectedVersion.tags ? selectedVersion.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    creator: selectedVersion.creator,
                    character_version: selectedVersion.charVersion,
                    alternate_greetings: [],
                    extensions: {
                        talkativeness: "0.5",
                        fav: false,
                        world: "",
                        depth_prompt: {
                            prompt: "",
                            depth: 4,
                            role: "system"
                        }
                    },
                    group_only_greetings: []
                },
                create_date: new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
            };

            // å°‡JSONè½‰ç‚ºBase64
            const jsonString = JSON.stringify(characterData);
            const base64Data = btoa(unescape(encodeURIComponent(jsonString)));

            // å‰µå»ºæˆ–ä½¿ç”¨ç¾æœ‰çš„é ­åƒåœ–ç‰‡
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            if (selectedVersion.avatar) {
                // å¦‚æœæœ‰é ­åƒï¼Œä½¿ç”¨é ­åƒä½œç‚ºPNGåœ–ç‰‡
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // åµŒå…¥chara metadataä¸¦ä¸‹è¼‰
                    createPNGWithMetadata(canvas, base64Data, character.name);
                };
                img.src = selectedVersion.avatar;
            } else {
                // å¦‚æœæ²’æœ‰é ­åƒï¼Œå‰µå»ºé è¨­åœ–ç‰‡
                canvas.width = 400;
                canvas.height = 600;
                
                // å‰µå»ºæ¼¸å±¤èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, 0, 600);
                gradient.addColorStop(0, '#f7f5f3');
                gradient.addColorStop(1, '#e2e8f0');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 600);
                
                // æ·»åŠ è§’è‰²åç¨±
                ctx.fillStyle = '#2d3748';
                ctx.font = 'bold 24px "Noto Serif CJK JP", serif';
                ctx.textAlign = 'center';
                ctx.fillText(character.name, 200, 300);
                
                // æ·»åŠ å‰¯æ¨™é¡Œ
                ctx.font = '16px "Noto Serif CJK JP", serif';
                ctx.fillStyle = '#718096';
                ctx.fillText('Character Card', 200, 330);
                
                // åµŒå…¥chara metadataä¸¦ä¸‹è¼‰
                createPNGWithMetadata(canvas, base64Data, character.name);
            }
        }

        function createPNGWithMetadata(canvas, base64Data, characterName) {
            // å°‡Canvasè½‰ç‚ºImageData
            canvas.toBlob(function(blob) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    // åœ¨PNGä¸­åµŒå…¥tEXt chunk with "chara" keyword
                    const modifiedPNG = addTextChunkToPNG(uint8Array, 'chara', base64Data);
                    
                    // ä¸‹è¼‰ä¿®æ”¹å¾Œçš„PNG
                    const modifiedBlob = new Blob([modifiedPNG], { type: 'image/png' });
                    const url = URL.createObjectURL(modifiedBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${characterName}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                };
                reader.readAsArrayBuffer(blob);
            }, 'image/png');
        }

        function addTextChunkToPNG(pngData, keyword, text) {
            // PNGæª”æ¡ˆçµæ§‹ï¼š8ä½å…ƒçµ„PNGç°½å + æ•¸å€‹chunks + IEND chunk
            const signature = pngData.slice(0, 8);
            let pos = 8;
            const chunks = [];
            
            // è®€å–æ‰€æœ‰ç¾æœ‰çš„chunks
            while (pos < pngData.length) {
                const length = (pngData[pos] << 24) | (pngData[pos + 1] << 16) | (pngData[pos + 2] << 8) | pngData[pos + 3];
                const type = String.fromCharCode(pngData[pos + 4], pngData[pos + 5], pngData[pos + 6], pngData[pos + 7]);
                const chunkData = pngData.slice(pos, pos + 12 + length);
                
                chunks.push(chunkData);
                
                if (type === 'IEND') break;
                pos += 12 + length;
            }
            
            // å‰µå»ºtEXt chunk
            const keywordBytes = new TextEncoder().encode(keyword);
            const textBytes = new TextEncoder().encode(text);
            const chunkData = new Uint8Array(keywordBytes.length + 1 + textBytes.length);
            chunkData.set(keywordBytes, 0);
            chunkData[keywordBytes.length] = 0; // null separator
            chunkData.set(textBytes, keywordBytes.length + 1);
            
            // è¨ˆç®—CRC
            const crc = calculateCRC32([0x74, 0x45, 0x58, 0x74, ...chunkData]); // "tEXt" + data
            
            // çµ„è£tEXt chunk
            const textChunk = new Uint8Array(12 + chunkData.length);
            const lengthBytes = [(chunkData.length >>> 24) & 0xFF, (chunkData.length >>> 16) & 0xFF, (chunkData.length >>> 8) & 0xFF, chunkData.length & 0xFF];
            textChunk.set(lengthBytes, 0);
            textChunk.set([0x74, 0x45, 0x58, 0x74], 4); // "tEXt"
            textChunk.set(chunkData, 8);
            textChunk.set([(crc >>> 24) & 0xFF, (crc >>> 16) & 0xFF, (crc >>> 8) & 0xFF, crc & 0xFF], 8 + chunkData.length);
            
            // é‡æ–°çµ„è£PNGï¼šç°½å + åŸæœ‰chunks (é™¤äº†IEND) + tEXt chunk + IEND
            const iendChunk = chunks.pop(); // ç§»é™¤IEND
            const totalLength = signature.length + chunks.reduce((sum, chunk) => sum + chunk.length, 0) + textChunk.length + iendChunk.length;
            const result = new Uint8Array(totalLength);
            
            let offset = 0;
            result.set(signature, offset);
            offset += signature.length;
            
            for (const chunk of chunks) {
                result.set(chunk, offset);
                offset += chunk.length;
            }
            
            result.set(textChunk, offset);
            offset += textChunk.length;
            
            result.set(iendChunk, offset);
            
            return result;
        }

        function calculateCRC32(data) {
            const crcTable = [];
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) {
                    if (c & 1) {
                        c = 0xEDB88320 ^ (c >>> 1);
                    } else {
                        c = c >>> 1;
                    }
                }
                crcTable[i] = c;
            }
            
            let crc = 0xFFFFFFFF;
            for (let i = 0; i < data.length; i++) {
                crc = crcTable[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
            }
            return (crc ^ 0xFFFFFFFF) >>> 0;
        }

        function exportAllVersions(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;

            character.versions.forEach((version, index) => {
                setTimeout(() => downloadJSON(character, version), index * 200);
            });
        }

        function importCharacter() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type === 'application/json' || file.name.endsWith('.json')) {
                // è™•ç†JSONæª”æ¡ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        importCharacterFromData(data);
                    } catch (error) {
                        alert('JSONæª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„è§’è‰²å¡æª”æ¡ˆ');
                    }
                };
                reader.readAsText(file);
            } else if (file.type === 'image/png' || file.name.endsWith('.png')) {
                // è™•ç†PNGæª”æ¡ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const charaData = extractCharaFromPNG(new Uint8Array(arrayBuffer));
                        
                        if (charaData) {
                            // è§£ç¢¼Base64
                            const jsonString = atob(charaData);
                            const data = JSON.parse(decodeURIComponent(escape(jsonString)));
                            importCharacterFromData(data, file); // å‚³éåŸå§‹æª”æ¡ˆä½œç‚ºåœ–ç‰‡
                        } else {
                            alert('PNGæª”æ¡ˆä¸­æœªæ‰¾åˆ°è§’è‰²è³‡æ–™ï¼Œè«‹ç¢ºèªé€™æ˜¯æœ‰æ•ˆçš„è§’è‰²å¡PNGæª”æ¡ˆ');
                        }
                    } catch (error) {
                        alert('PNGæª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('è«‹é¸æ“‡JSONæˆ–PNGæ ¼å¼çš„è§’è‰²å¡æª”æ¡ˆ');
            }
        }

        function extractCharaFromPNG(pngData) {
            // è·³éPNGç°½å
            let pos = 8;
            
            while (pos < pngData.length) {
                // è®€å–chunké•·åº¦
                const length = (pngData[pos] << 24) | (pngData[pos + 1] << 16) | (pngData[pos + 2] << 8) | pngData[pos + 3];
                
                // è®€å–chunké¡å‹
                const type = String.fromCharCode(pngData[pos + 4], pngData[pos + 5], pngData[pos + 6], pngData[pos + 7]);
                
                if (type === 'tEXt') {
                    // è®€å–tEXt chunkçš„è³‡æ–™
                    const textData = pngData.slice(pos + 8, pos + 8 + length);
                    
                    // å°‹æ‰¾nullåˆ†éš”ç¬¦
                    let nullPos = -1;
                    for (let i = 0; i < textData.length; i++) {
                        if (textData[i] === 0) {
                            nullPos = i;
                            break;
                        }
                    }
                    
                    if (nullPos !== -1) {
                        // æå–keywordå’Œtext
                        const keyword = new TextDecoder().decode(textData.slice(0, nullPos));
                        const text = new TextDecoder().decode(textData.slice(nullPos + 1));
                        
                        if (keyword === 'chara') {
                            return text;
                        }
                    }
                }
                
                if (type === 'IEND') break;
                pos += 12 + length;
            }
            
            return null;
        }

        function importCharacterFromData(data, imageFile = null) {
            const character = {
                id: generateId(),
                name: data.name || 'åŒ¯å…¥è§’è‰²',
                versions: [{
                    id: generateId(),
                    name: 'åŒ¯å…¥ç‰ˆæœ¬',
                    avatar: '',
                    creator: data.data?.creator || data.creator || '',
                    charVersion: data.data?.character_version || data.character_version || '',
                    creatorNotes: data.data?.creator_notes || data.creatorcomment || '',
                    tags: Array.isArray(data.tags) ? data.tags.join(', ') : (data.data?.tags ? data.data.tags.join(', ') : ''),
                    description: data.data?.description || data.description || '',
                    personality: data.data?.personality || data.personality || '',
                    scenario: data.data?.scenario || data.scenario || '',
                    dialogue: data.data?.mes_example || data.mes_example || '',
                    firstMessage: data.data?.first_mes || data.first_mes || ''
                }]
            };

            // å¦‚æœæ˜¯PNGæª”æ¡ˆï¼Œå°‡åœ–ç‰‡è¨­å®šç‚ºé ­åƒ
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    character.versions[0].avatar = e.target.result;
                    finishImport();
                };
                reader.readAsDataURL(imageFile);
            } else {
                finishImport();
            }

            function finishImport() {
                characters.push(character);
                currentCharacterId = character.id;
                currentVersionId = character.versions[0].id;
                renderAll();
                saveData();
                alert('è§’è‰²åŒ¯å…¥æˆåŠŸï¼');
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initApp() {
            // è¼‰å…¥å„²å­˜çš„è‡ªè¨‚é¡è‰²ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­
            const savedColors = localStorage.getItem('characterCreatorCustomColors');
            if (savedColors) {
                const colors = JSON.parse(savedColors);
                const root = document.documentElement;
                root.style.setProperty('--primary-color', colors.primary);
                root.style.setProperty('--secondary-color', colors.secondary);
                root.style.setProperty('--accent-color', colors.accent);
                root.style.setProperty('--bg-color', colors.bg);
            }
            // ä½¿ç”¨CSSé è¨­å€¼ï¼Œä¸éœ€è¦é¡å¤–è¨­å®š

            // è¼‰å…¥è§’è‰²è³‡æ–™
            loadData();

            // å¦‚æœæ²’æœ‰è§’è‰²ï¼Œå‰µå»ºé è¨­è§’è‰²
            if (characters.length === 0) {
                addCharacter();
            } else {
                renderAll();
            }

            // å®šæœŸæ›´æ–°çµ±è¨ˆ
            setInterval(updateTotalStats, 2000);

            // éŸ¿æ‡‰å¼è™•ç†
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('show');
                }
            });
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
