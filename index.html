<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicler Editor</title>
    <style>
        /* å­—é«” */
        @import url("https://fontsapi.zeoseven.com/563/main/result.css");
        
        :root {
    --primary-color: #4E5E79;
    --secondary-color: #1a202c;
    --accent-color: #8b7355;
    --bg-color: #f7f5f3;
    --surface-color: #ffffff;
    --text-color: #2d3748;
    --text-muted: #718096;
    --border-color: #e2e8f0;
    --success-color: #48bb78;
    --warning-color: #ed8936;
    --danger-color: #f56565;
    --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-large: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --header-bg: #f1f5f9;      /* é ‚éƒ¨æ¬„èƒŒæ™¯ - æ¯”ä¸»è¦èƒŒæ™¯ç¨æ·±ä¸€é» */
    --sidebar-bg: #f8fafc;     /* å´é‚Šæ¬„èƒŒæ™¯ - æ¯”ä¸»è¦èƒŒæ™¯ç¨äº®ä¸€é» */
    --main-content-bg: #fafbfc; /* ä¸»è¦å…§å®¹å€åŸŸèƒŒæ™¯ - æ›´æ·ºçš„ç°ç™½ */
    --content-bg: #ffffff;     /* ä¸»è¦å…§å®¹å€èƒŒæ™¯ - ä¿æŒç™½è‰² */

    /* é è¨­é…è‰²å‚™ä»½ */
    --default-primary: #4E5E79;
    --default-secondary: #1a202c;
    --default-accent: #8b7355;
    --default-bg: #f7f5f3;
    --default-surface: #ffffff;
    --default-text: #2d3748;
    --default-text-muted: #718096;
    /* æ–°å¢é è¨­ç•Œé¢è‰²å½© */
    --default-header-bg: #f1f5f9;
    --default-sidebar-bg: #f8fafc;
    --default-content-bg: #ffffff;
    --default-main-content-bg: #fafbfc;

/* è­·çœ¼é…è‰² - é»‘ç™½ç°ä¸»èª¿ (macOS æ·±è‰²é¢¨æ ¼) */
--eyecare-primary: #404040;           /* æ·¡ç°ï¼Œä½œç‚ºä¸»è‰²èˆ‡é¸ä¸­æ™‚çš„èƒŒæ™¯ */
--eyecare-secondary: #6e6e6e;         /* ä¸­ç°ï¼Œç”¨æ–¼ hover æˆ–å¼·èª¿å€å¡Š */
--eyecare-accent: #4b768b;            /* ç™½è‰²ï¼Œç´”æ·¨å°æ¯”é»ç¶´ï¼ˆä¾‹å¦‚ active æŒ‰éˆ•ï¼‰ */
--eyecare-bg: #7d7d7d;                /* èƒŒæ™¯ä¸»é«”ï¼Œè¿‘é»‘è‰²ä½†å¸¶ç°éš */
--eyecare-surface: #2a2a2a;           /* å¡ç‰‡èˆ‡é¢æ¿å€ï¼Œç•¥äº®æ–¼èƒŒæ™¯ä»¥åˆ†å±¤ */
--eyecare-text: #e0e0e0;              /* ä¸»æ–‡å­—è‰²ï¼Œäº®ç°ç™½ */
--eyecare-text-muted: #aaaaaa;        /* è¼”åŠ©æ–‡å­—ï¼ŒæŸ”ç° */
--eyecare-border: #525252;            /* é‚Šæ¡†é¡è‰²ï¼Œæ·±ç°ä½†ä¸å®Œå…¨éš±æ²’ */
--eyecare-header-bg: #000000;         /* é ‚éƒ¨å€èƒŒæ™¯ï¼Œèˆ‡é¢æ¿åŒèª¿ä¸€è‡´ */
--eyecare-sidebar-bg: #1f1f1f;        /* å´é‚Šæ¬„èƒŒæ™¯ï¼Œæ›´æ¥è¿‘ç´”é»‘ */
--eyecare-content-bg: #292929;        /* å…§å®¹å€åŸŸèƒŒæ™¯ï¼Œæ·±ç°èˆ‡ä¸»èƒŒæ™¯åšå€éš” */
--eyecare-main-content-bg: #1a1a1a;   /* æ•´é«”æœ€åº•èƒŒæ™¯ï¼Œæœ€æ·±ä½†ä»éç´”é»‘ */

}


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Serif CJK JP", 'Georgia', 'Times New Roman', serif;
            font-weight: normal;
            background: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            line-height: 1.6;
        }


        .app-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: var(--bg-color);
}

.field-input.scrollable {
    max-height: 200px;
    overflow-y: auto;
    resize: vertical;
    min-height: 60px;
}

        /* é ‚éƒ¨ä¸»æ¬„ä½ */
        .top-header {
    background: var(--header-bg);
    box-shadow: var(--shadow-light);
    z-index: 10;
    border-top: 4px solid var(--accent-color); /* ç›´æ¥åœ¨é ‚éƒ¨æ¬„åŠ ä¸Šé‚Šæ¡† */
}

            .header-content {
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
   /* èªè¨€é¸å–®æ¨£å¼ */
.language-menu-container {
    position: relative;
    display: inline-block;
}

.language-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: var(--shadow-medium);
    z-index: 1001;
    min-width: 120px;
    margin-top: 4px;
}

.language-option {
    padding: 8px 16px;
    cursor: pointer;
    font-size: 0.85em;
    color: var(--text-color);
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--border-color);
}

.language-option:last-child {
    border-bottom: none;
}

.language-option:hover {
    background: var(--bg-color);
}

.language-option.active {
    background: var(--primary-color);
    color: white;
}
/* ä¸‹æ–¹å®¹å™¨ */
.bottom-container {
    display: flex;
    flex: 1;
    overflow: hidden;
}
        /* å´é‚Šæ¬„ */
        .sidebar {
    width: 280px;
    background: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    box-shadow: var(--shadow-light);
    
    /* å¼·åˆ¶æ»¾å‹•æ¢åœ¨å·¦é‚Š */
    direction: rtl;
    
    /* æ»¾å‹•æ¢æ¨£å¼ */
    scrollbar-width: thin;
    scrollbar-color: var(--accent-color) transparent;
}

.sidebar::-webkit-scrollbar {
    width: 3px !important;
}

.sidebar::-webkit-scrollbar-track {
    background: transparent !important;
}

.sidebar::-webkit-scrollbar-thumb {
    background: var(--accent-color) !important;
    border-radius: 1.5px !important;
    min-height: 20px !important;
    max-height: 40px !important;
    background-clip: padding-box !important;
    border: 2px solid transparent !important;
}

.sidebar::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color) !important;
}

.sidebar-section {
    border-bottom: 1px solid var(--border-color);
}

.sidebar-section:last-child {
    border-bottom: none;
}

.sidebar-section-header {
    padding: 16px 20px;
    background: transparent; /* æ”¹ç‚ºé€æ˜èƒŒæ™¯ */
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--border-color);
}

.sidebar-section-header:hover {
    background: var(--bg-color); /* hoveræ™‚åªæ˜¯ç¨å¾®è®Šè‰² */
}

.sidebar-section-title {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--text-color); /* æ”¹ç‚ºæ­£å¸¸æ–‡å­—è‰² */
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.sidebar-section-icon {
    font-size: 0.8em;
    color: var(--text-muted); /* æ”¹ç‚ºæ¬¡è¦æ–‡å­—è‰² */
    transition: transform 0.2s ease;
}

.sidebar-section-content {
    padding: 16px;
    transition: all 0.3s ease;
    overflow: hidden;
    background: transparent; 
}

.sidebar-section-content.collapsed {
    max-height: 0;
    padding: 0 16px;
}

.sidebar-add-btn {
    width: 100%;
    margin-top: 12px;
    padding: 8px 16px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85em;
    transition: all 0.2s ease;
    background: var(--surface-color);
    color: var(--text-color);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.sidebar-add-btn:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-light);
}

        .character-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: transparent;
    border: none;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
    transition: all 0.2s ease;
    color: var(--text-color);
    margin-bottom: 2px;
}

/* å…§å®¹æ¢å¾©æ­£å¸¸æ–¹å‘ */
.sidebar > * {
    direction: ltr;
}

.character-header:hover {
    background: var(--bg-color);
}

.character-header.active {
    background: transparent;
    color: var(--accent-color); /* é¸ä¸­æ™‚ä½¿ç”¨å¼·èª¿è‰²æ–‡å­— */
    font-weight: 600;
}
/* ä¸‰è§’ç¬¦è™Ÿæ¨£å¼ - å·¦å´ */
.character-header .expand-icon {
    font-size: 0.8em;
    color: var(--text-muted);
    transition: all 0.2s ease;
    transform: rotate(-90deg); /* é è¨­æ”¶åˆç‹€æ…‹ */
    margin-right: 8px;
}

.character-header.active .expand-icon {
    color: var(--accent-color);
    transform: rotate(0deg); /* å±•é–‹ç‹€æ…‹ */
}
        .version-list {
    padding-left: 12px;
    margin-top: 4px;
    display: none;
}
/* è§’è‰²åç¨±å’Œç‰ˆæœ¬æ•¸é‡å®¹å™¨ */
.character-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex: 1;
}
.version-list.expanded {
    display: block;
}

.version-item {
    padding: 8px 16px;
    margin: 2px 0;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.2s ease;
    color: var(--text-muted);
}

.version-item:hover {
    background: var(--bg-color);
    color: var(--text-color);
}

.version-item.active {
    background: transparent;
    color: var(--accent-color); /* åªç”¨å¼·èª¿è‰²æ–‡å­—è¡¨ç¤ºé¸ä¸­ */
    font-weight: 600;
}

 /* è§’è‰²å */
.character-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    background: var(--content-bg);
    border-radius: 8px;
    margin-bottom: 24px;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-light);
}

.character-title-section {
    flex: 0 0 auto;
}

.character-main-title-fixed {
    font-size: 1.5em !important;
    font-weight: 700 !important;
    margin: 0 !important;
    padding: 8px 16px !important;
    border: 1px solid transparent !important;
    border-radius: 6px !important;
    background: transparent !important;
    color: var(--text-color) !important;
    transition: all 0.2s ease !important;
    min-width: 200px;
}

.character-main-title-fixed:focus {
    outline: none !important;
    border-color: var(--primary-color) !important;
    background: var(--bg-color) !important;
}

.character-main-title-fixed:hover {
    border-color: var(--border-color) !important;
}

.character-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}



        /* ä¸»è¦å…§å®¹å€ - è‹±å€«é¢¨æ ¼ */
        .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--main-content-bg);
}
        .header {
            display: none;
}

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .toggle-sidebar {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .toggle-sidebar:hover {
            background: var(--bg-color);
            color: var(--text-color);
        }

        .app-title-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }

        .app-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.02em;
        }

        .app-version {
            font-size: 0.75em;
            color: var(--text-muted);
            font-weight: 400;
        }

        .app-subtitle {
            font-size: 0.7em;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 2px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--main-content-bg);
        }

        .view-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--content-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            align-items: center;
            flex-wrap: wrap;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--content-bg);
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        /* æŒ‰éˆ•æ¨£å¼ - è‹±å€«é¢¨æ ¼ */
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85em;
            transition: all 0.2s ease;
            background: var(--surface-color);
            color: var(--text-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-light);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-color);
        }

        .btn-accent {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        /* ç‰ˆæœ¬é¢æ¿ - æ–‡å­¸ç·¨è¼¯å™¨é¢¨æ ¼ */
        .versions-container {
            display: grid;
            gap: 24px;
        }

        .versions-container.single-view {
            grid-template-columns: 1fr;
        }

        .versions-container.compare-view {
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        }

        .version-panel {
            background: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-light);
        }

        .version-panel:hover {
            box-shadow: var(--shadow-medium);
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .version-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
            background: transparent;
            border: 1px solid transparent;
            padding: 6px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .version-title:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-color);
        }

        /* ç‚ºæ–‡å­—æ¬„ä½æ·»åŠ è‡ªå‹•èª¿æ•´é«˜åº¦åŠŸèƒ½ï¼š */

textarea.field-input {
    min-height: 120px;
    resize: vertical;
    overflow: hidden; /* éš±è—æ»¾å‹•æ¢ */
    transition: height 0.2s ease; /* å¹³æ»‘éæ¸¡æ•ˆæœ */
}

/* æ–‡å­—æ¬„ä½å¯ä»¥è‡ªå‹•æ“´å±• */
textarea.field-input.auto-resize {
    resize: none; /* ç¦ç”¨æ‰‹å‹•èª¿æ•´ */
    overflow-y: hidden;
}
        
        .character-main-title {
    font-size: 1.4em !important;
    font-weight: 700 !important;
    margin: 0 !important;
    padding: 8px 12px !important;
    border: 1px solid transparent !important;
    border-radius: 6px !important;
    background: transparent !important;
    color: var(--text-color) !important;
    transition: all 0.2s ease !important;
}

.character-main-title:focus {
    outline: none !important;
    border-color: var(--primary-color) !important;
    background: var(--bg-color) !important;
}

.character-main-title:hover {
    border-color: var(--border-color) !important;
}


        /* è¡¨å–®æ¬„ä½ - ç²¾ç·»è¨­è¨ˆ */
        .field-group {
            margin-bottom: 24px;
        }

        .field-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .field-stats {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-left: 12px;
            font-style: italic;
        }

        .field-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em;
            font-family: "Noto Serif CJK JP", 'Georgia', serif;
            transition: all 0.2s ease;
            background: var(--surface-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(45, 55, 72, 0.1);
        }

        textarea.field-input {
            min-height: 120px;
            resize: vertical;
        }

        /* é ­åƒå’ŒåŸºæœ¬è³‡è¨Šä½ˆå±€ */
        .character-basic-info {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            align-items: flex-start;
        }

        .avatar-section {
            flex-shrink: 0;
        }

        .avatar-preview {
            width: auto;
            max-width: auto;
            height: 360px;
            aspect-ratio: 2/3;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            object-fit: cover;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8em;
            text-align: center;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        .avatar-upload-btn {
            width: 100%;
            margin-top: 12px;
            display: block;
        }

        .basic-info-fields {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-content: start;
}


        .file-input {
            display: none;
        }

        .file-label {
    padding: 8px 16px;
    background: var(--surface-color);
    color: var(--text-color);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
    font-size: 0.85em;
}

.file-label:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-light);
}

        /* åº•éƒ¨æ¬„ä½å€åŸŸ */
        .bottom-fields {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .bottom-fields .field-group {
            margin-bottom: 16px;
        }

        .bottom-fields .field-input {
            padding: 8px 12px;
            font-size: 0.85em;
        }

        .bottom-fields h4 {
            margin-bottom: 16px;
            color: var(--text-muted);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        /* åŒ¯å‡ºå€åŸŸ */
        .export-section {
            margin-top: 32px;
            padding: 24px;
            background: var(--content-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: var(--shadow-light);
        }

        .export-section h3 {
            margin-bottom: 16px;
            color: var(--text-color);
            font-size: 1.1em;
            font-weight: 600;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* å½ˆçª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(45, 55, 72, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 5% auto;
            padding: 32px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 520px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-large);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            color: var(--danger-color);
            background: var(--bg-color);
        }

        .color-input-group {
            margin-bottom: 20px;
        }

        .color-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .color-input {
            width: 100%;
            height: 48px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .color-input:hover {
            border-color: var(--primary-color);
        }

        .color-preview {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            padding: 16px;
            background: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .color-preview-item {
            flex: 1;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: white;
            font-size: 0.8em;
        }

        .version-compare-controls {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .version-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .version-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .version-checkbox:hover {
            border-color: var(--primary-color);
        }

        .version-checkbox.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .version-checkbox input[type="checkbox"] {
            margin: 0;
        }

        /* ä¸»é¡Œé¡è‰²é¸æ“‡å™¨ */
        .theme-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .theme-preset {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .theme-preset:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }

        .theme-preset.active {
            border-color: var(--primary-color);
            border-width: 3px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }
    
    .header-controls {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .bottom-container {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        max-height: 40vh;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
    }
    
    .versions-container.compare-view {
        grid-template-columns: 1fr;
    }

    .content-area {
        padding: 16px;
    }

        .character-header-bar {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }
    
    .character-title-section {
        text-align: center;
    }
    
    .character-controls {
        justify-content: center;
    }
}
}
/* è¢å¹•éŸ¿æ‡‰å¼ */
@media (max-width: 1024px) {
    .character-header-bar {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
    }
    
    .character-title-section {
        text-align: center;
    }
    
    .character-controls {
        justify-content: center;
    }
}
        /* é è¨­ä¸»é¡Œé…è‰² */
        .theme-classic { background: linear-gradient(135deg, #4E5E79, #8b7355); }
        .theme-warm { background: linear-gradient(135deg, #744210, #d69e2e); }
        .theme-cool { background: linear-gradient(135deg, #2c5282, #3182ce); }
        .theme-forest { background: linear-gradient(135deg, #22543d, #38a169); }
        .theme-vintage { background: linear-gradient(135deg, #553c9a, #9f7aea); }
        .theme-minimal { background: linear-gradient(135deg, #4a5568, #718096); }
    </style>
</head>
<body>
    
    <div class="app-container">
    <div class="app-container">
    <!-- é ‚éƒ¨ä¸»æ¬„ä½ -->
    <div class="top-header">
        <div class="header-content">
            <div class="header-left">
                <div class="app-title-container">
                    <div style="display: flex; align-items: baseline; gap: 12px;">
                        <h1 class="app-title">Chronicler Editor</h1>
                        <span class="app-version">v1.0.0 beta</span>
                    </div>
                    <div class="app-subtitle">æœ¬å·¥å…·è³‡æ–™å„²å­˜åœ¨ä½ çš„æœ¬æ©Ÿç€è¦½å™¨ä¸­ï¼Œè«‹å®šæœŸå‚™ä»½ä»¥å…è³‡æ–™ä¸Ÿå¤±ã€‚</div>
                </div>
            </div>
            <div class="header-controls">
    <button class="btn btn-secondary" onclick="showColorPicker()">è‡ªè¨‚é¡è‰²</button>
    <button class="btn btn-secondary" onclick="exportAllData()">åŒ¯å‡ºè³‡æ–™</button>
    <button class="btn btn-secondary" onclick="importAllData()">åŒ¯å…¥è³‡æ–™</button>
    
    <!-- èªè¨€é¸å–® -->
    <div class="language-menu-container">
        <button class="btn btn-secondary" onclick="toggleLanguageMenu()" id="lang-toggle">
            <span id="lang-current">ä¸­æ–‡</span> â–¼
        </button>
        <div class="language-menu" id="lang-menu" style="display: none;">
            <div class="language-option" onclick="selectLanguage('zh')">ä¸­æ–‡</div>
            <div class="language-option" onclick="selectLanguage('en')">English</div>
        </div>
    </div>
    
    <input type="file" id="importFile" accept=".json,.png" style="display: none;" onchange="handleImport(event)">
    <input type="file" id="importAllFile" accept=".json" style="display: none;" onchange="handleImportAll(event)">
</div>
        </div>
    </div>

    <!-- ä¸‹æ–¹å…§å®¹å€ -->
    <div class="bottom-container">
        <!-- å´é‚Šæ¬„ -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
    <div class="sidebar-section-header" onclick="toggleSection('characters')">
        <span class="sidebar-section-title">è§’è‰²åˆ—è¡¨</span>
        <span class="sidebar-section-icon" id="characters-icon">â–¼</span>
    </div>
    <div class="sidebar-section-content" id="characters-content">
        <div id="sidebarContent">
            <!-- è§’è‰²åˆ—è¡¨æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
        </div>
        <button class="btn btn-secondary sidebar-add-btn" onclick="addCharacter()">æ–°å¢è§’è‰²</button>
        <button class="btn btn-secondary sidebar-add-btn" onclick="importCharacter()">åŒ¯å…¥è§’è‰²</button>
    </div>
</div>

<!-- ä¸–ç•Œæ›¸å€å¡Š -->
<div class="sidebar-section">
    <div class="sidebar-section-header" onclick="toggleSection('worldbook')">
        <span class="sidebar-section-title">ä¸–ç•Œæ›¸</span>
        <span class="sidebar-section-icon" id="worldbook-icon">â–¼</span>
    </div>
    <div class="sidebar-section-content collapsed" id="worldbook-content">
        <div id="worldBookContent">
            <!-- ä¸–ç•Œæ›¸åˆ—è¡¨æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
        </div>
        <button class="btn btn-secondary sidebar-add-btn" onclick="addWorldBook()">æ–°å¢ä¸–ç•Œæ›¸</button>
        <button class="btn btn-secondary sidebar-add-btn" onclick="importWorldBook()">åŒ¯å…¥ä¸–ç•Œæ›¸</button>
    </div>
</div>

<!-- è‡ªå®šç¾©æ¬„ä½å€å¡Š -->
<div class="sidebar-section">
    <div class="sidebar-section-header" onclick="toggleSection('custom')">
        <span class="sidebar-section-title">è‡ªå®šç¾©æ¬„ä½</span>
        <span class="sidebar-section-icon" id="custom-icon">â–¼</span>
    </div>
    <div class="sidebar-section-content" id="custom-content">
        <div id="customSectionContent">
            <!-- è‡ªå®šç¾©å€å¡Šåˆ—è¡¨æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
        </div>
        <button class="btn btn-secondary sidebar-add-btn" onclick="addCustomSection()">æ–°å¢è‡ªå®šç¾©æ¬„ä½</button>
    </div>
</div>
        </div>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <div class="content-area" id="contentArea">
                <!-- å…§å®¹æœƒåœ¨é€™è£¡ç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

    <script>

const translations = {
    zh: {
        // ç•Œé¢æ–‡å­—
        appTitle: 'Chronicler Editor',
        appSubtitle: 'æœ¬å·¥å…·è³‡æ–™å„²å­˜åœ¨ä½ çš„æœ¬æ©Ÿç€è¦½å™¨ä¸­ï¼Œè«‹å®šæœŸå‚™ä»½ä»¥å…è³‡æ–™ä¸Ÿå¤±ã€‚',
        customColor: 'è‡ªè¨‚é¡è‰²',
        exportData: 'åŒ¯å‡ºè³‡æ–™',
        importData: 'åŒ¯å…¥è³‡æ–™',
        importCharacter: 'åŒ¯å…¥è§’è‰²',
        
        // å´é‚Šæ¬„
        characterList: 'è§’è‰²åˆ—è¡¨',
        worldBook: 'ä¸–ç•Œæ›¸',
        addCharacter: 'æ–°å¢è§’è‰²',
        comingSoon: 'å³å°‡æ¨å‡º...',

        // ä¸–ç•Œæ›¸
worldBook: 'ä¸–ç•Œæ›¸',
addWorldBook: 'æ–°å¢ä¸–ç•Œæ›¸',
worldBookName: 'ä¸–ç•Œæ›¸åç¨±',
worldBookDesc: 'ä¸–ç•Œæ›¸æè¿°',
addEntry: 'æ–°å¢æ¢ç›®',
entryName: 'æ¢ç›®åç¨±',
keywords: 'é—œéµå­—',
secondaryKeys: 'æ¬¡è¦é—œéµå­—',
entryContent: 'æ¢ç›®å…§å®¹',
entryComment: 'æ¢ç›®è¨»é‡‹',
deleteEntry: 'åˆªé™¤æ¢ç›®',
keywordsPlaceholder: 'é—œéµå­—ï¼Œç”¨é€—è™Ÿåˆ†éš”...',
secondaryKeysPlaceholder: 'æ¬¡è¦é—œéµå­—ï¼Œç”¨é€—è™Ÿåˆ†éš”...',
entryContentPlaceholder: 'ç•¶è§¸ç™¼é—œéµå­—æ™‚è¦æ’å…¥çš„å…§å®¹...',
entryCommentPlaceholder: 'æ¢ç›®çš„è¨»é‡‹æˆ–èªªæ˜...',
insertionOrder: 'æ’å…¥é †åº',
entryEnabled: 'å•Ÿç”¨æ¢ç›®',
selectiveMode: 'é¸æ“‡æ¨¡å¼',
constantMode: 'å¸¸é§æ¨¡å¼',
deleteWorldBook: 'åˆªé™¤ä¸–ç•Œæ›¸',
copyWorldBook: 'è¤‡è£½ä¸–ç•Œæ›¸',
exportWorldBook: 'åŒ¯å‡ºä¸–ç•Œæ›¸',
importWorldBook: 'åŒ¯å…¥ä¸–ç•Œæ›¸',


        // è‡ªå®šç¾©
customFields: 'ç­†è¨˜æœ¬',
addCustomField: 'æ–°ç­†è¨˜',
customSection: 'è‡ªå®šç¾©å€å¡Š',
addField: 'æ–°å¢æ¬„ä½',
fieldName: 'æ¬„ä½åç¨±',
fieldContent: 'æ¬„ä½å…§å®¹',
deleteField: 'åˆªé™¤æ¬„ä½',
customFieldPlaceholder: 'è¼¸å…¥è‡ªå®šç¾©å…§å®¹...',
fieldNamePlaceholder: 'æ¬„ä½åç¨±...',
exportTXT: 'åŒ¯å‡º TXT',
exportMarkdown: 'åŒ¯å‡º Markdown',
copySection: 'è¤‡è£½å€å¡Šçµ„',
deleteSection: 'åˆªé™¤å€å¡Š',
sectionName: 'å€å¡Šåç¨±',
        
        // ä¸»è¦åŠŸèƒ½
        singleView: 'å–®ä¸€æª¢è¦–',
        compareView: 'å°æ¯”æª¢è¦–',
        addVersion: 'æ–°å¢ç‰ˆæœ¬',
        characterName: 'è§’è‰²åç¨±',
        deleteCharacter: 'åˆªé™¤è§’è‰²',
        copyCharacter: 'è¤‡è£½è§’è‰²çµ„',
        unsavedChanges: 'æœ‰å°šæœªå„²å­˜çš„è®Šæ›´',
        saveChanged: 'ğŸ’¾ å·²è®Šæ›´å„²å­˜',
        
        // è¡¨å–®æ¬„ä½
        creator: 'å‰µä½œè€…',
        charVersion: 'è§’è‰²ç‰ˆæœ¬',
        creatorNotes: 'å‰µä½œè€…å‚™è¨»',
        tags: 'åµŒå…¥æ¨™ç±¤',
        description: 'è§’è‰²æè¿°',
        personality: 'å€‹æ€§æ‘˜è¦',
        scenario: 'å ´æ™¯è¨­æƒ³',
        dialogue: 'å°è©±ç¯„ä¾‹',
        firstMessage: 'åˆå§‹è¨Šæ¯',
        
        // ä½”ä½ç¬¦æ–‡å­—
        creatorPlaceholder: 'å‰µä½œè€…åç¨±ï¼ˆå¯é¸ï¼‰...',
        versionPlaceholder: 'ç‰ˆæœ¬è™Ÿç¢¼æˆ–æè¿°ï¼ˆå¯é¸ï¼‰...',
        notesPlaceholder: 'å‰µä½œå‚™è¨»æˆ–èªªæ˜ï¼ˆå¯é¸ï¼‰...',
        tagsPlaceholder: 'æ¨™ç±¤ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼ˆå¯é¸ï¼‰...',
        descPlaceholder: 'æè¿°è§’è‰²çš„å¤–è²Œã€èƒŒæ™¯ã€è¨­å®šç­‰...',
        personalityPlaceholder: 'è§’è‰²çš„æ€§æ ¼ç‰¹å¾µã€è¡Œç‚ºæ¨¡å¼ã€èªªè©±æ–¹å¼ç­‰...',
        scenarioPlaceholder: 'è§’è‰²æ‰€è™•çš„æƒ…å¢ƒã€ç’°å¢ƒã€ç•¶å‰ç‹€æ³ç­‰...',
        dialoguePlaceholder: '{{user}}: ä½ å¥½ï¼\n{{char}}: ä½ å¥½å‘€ï¼å¾ˆé«˜èˆˆè¦‹åˆ°ä½ ï½',
        firstMsgPlaceholder: 'è§’è‰²çš„ç¬¬ä¸€å¥è©±æˆ–é–‹å ´ç™½...',
        
        // æŒ‰éˆ•
        save: 'ğŸ’¾ å„²å­˜',
        copy: 'ğŸ“‹ è¤‡è£½ç‰ˆæœ¬',
        delete: 'åˆªé™¤',
        selectImage: 'é¸æ“‡åœ–ç‰‡',
        exportJSON: 'åŒ¯å‡º JSON',
        exportPNG: 'åŒ¯å‡º PNG',
        exportAll: 'åŒ¯å‡ºæ‰€æœ‰ç‰ˆæœ¬',
        
        // çµ±è¨ˆ
        chars: 'å­—',
        tokens: 'tokens',
        total: 'ç¸½è¨ˆ',
        
        // å°è©±æ¡†
        customTheme: 'è‡ªè¨‚ä¸»é¡Œé¡è‰²',
        primaryColor: 'ä¸»è¦é¡è‰²',
        secondaryColor: 'æ¬¡è¦é¡è‰²',
        accentColor: 'å¼·èª¿é¡è‰²',
        bgColor: 'èƒŒæ™¯é¡è‰²',
        surfaceColor: 'æŒ‰éˆ•èˆ‡æ–‡å­—æ¡†é¡è‰²',
        textColor: 'æ–‡å­—é¡è‰²',
        textMutedColor: 'æ¬¡è¦æ–‡å­—é¡è‰²',
        restoreDefault: 'æ¢å¾©é è¨­',
        eyeCareMode: 'è­·çœ¼é…è‰²',
        borderColor: 'é‚Šæ¡†é¡è‰²',
        exportColorTheme: 'åŒ¯å‡ºé…è‰²',
importColorTheme: 'åŒ¯å…¥é…è‰²',
        cancel: 'å–æ¶ˆ',
        apply: 'å¥—ç”¨',
        headerBgColor: 'é ‚éƒ¨æ¬„èƒŒæ™¯',
        sidebarBgColor: 'å´é‚Šæ¬„èƒŒæ™¯', 
        mainContentBgColor: 'ä¸»è¦å…§å®¹å€èƒŒæ™¯',
        contentBgColor: 'å…§å®¹é¢æ¿èƒŒæ™¯',
        
        // æç¤ºè¨Šæ¯
        saved: 'âœ“ å·²å„²å­˜åˆ°ç€è¦½å™¨',
        importSuccess: 'è§’è‰²åŒ¯å…¥æˆåŠŸï¼',
        deleteConfirm: 'ç¢ºå®šè¦åˆªé™¤è§’è‰²ã€Œ$1ã€å—ï¼Ÿ\n\nâš ï¸ åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œè«‹ç¢ºä¿å·²å‚™ä»½é‡è¦è³‡æ–™ï¼',
        deleteVersionConfirm: 'ç¢ºå®šè¦åˆªé™¤ç‰ˆæœ¬ã€Œ$1ã€å—ï¼Ÿ\n\nâš ï¸ åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œè«‹ç¢ºä¿å·²å‚™ä»½é‡è¦è³‡æ–™ï¼',
        needTwoVersions: 'éœ€è¦è‡³å°‘2å€‹ç‰ˆæœ¬æ‰èƒ½é€²è¡Œå°æ¯”',
        keepOneCharacter: 'è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹è§’è‰²',
        keepOneVersion: 'è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç‰ˆæœ¬',
        maxTwoVersions: 'æœ€å¤šåªèƒ½é¸æ“‡2å€‹ç‰ˆæœ¬',
        
        // åŒ¯å‡ºç›¸é—œ
        selectVersion: 'é¸æ“‡è¦åŒ¯å‡ºçš„ç‰ˆæœ¬ (1-$1):',
        exportAllTitle: 'åŒ¯å‡ºæ‰€æœ‰ç‰ˆæœ¬',
        exportAllDesc: 'è§’è‰²ã€Œ$1ã€å…±æœ‰ $2 å€‹ç‰ˆæœ¬ï¼Œè«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼ï¼š',
        jsonFormat: 'JSON æ ¼å¼',
        jsonDesc: 'ç´”æ–‡å­—æ ¼å¼ï¼Œé©åˆåŒ¯å…¥å…¶ä»–å·¥å…·æˆ–å‚™ä»½',
        pngFormat: 'PNG åœ–ç‰‡æ ¼å¼',
        pngDesc: 'åŒ…å«åœ–ç‰‡çš„è§’è‰²å¡ï¼Œé©åˆåˆ†äº«æˆ–åœ¨ SillyTavern ä¸­ä½¿ç”¨',
        startExport: 'é–‹å§‹åŒ¯å‡º',
        exporting: 'æ­£åœ¨åŒ¯å‡º $1 å€‹ç‰ˆæœ¬...',
        preparing: 'æº–å‚™ä¸­...',
        exportComplete: 'âœ“ å·²æˆåŠŸåŒ¯å‡º $1 å€‹$2æª”æ¡ˆï¼',
        noImage: 'ç„¡åœ–ç‰‡',
        versionStats: '$1å­— / $2tokens',
        exportCharacter: 'åŒ¯å‡ºè§’è‰²å¡',
        selectCharacter: 'è«‹é¸æ“‡ä¸€å€‹è§’è‰²',

        // å°æ¯”æª¢è¦–ï¼š
selectVersionsToCompare: 'é¸æ“‡è¦å°æ¯”çš„ç‰ˆæœ¬',
selectTwoVersions: 'é¸æ“‡2å€‹ç‰ˆæœ¬é€²è¡Œå°æ¯”',
currentSelected: 'ç›®å‰å·²é¸',
startCompare: 'é–‹å§‹å°æ¯”',
needOneMore: 'é‚„éœ€é¸æ“‡1å€‹ç‰ˆæœ¬'

    },
    
    en: {
        // Interface text
        appTitle: 'Chronicler Editor',
        appSubtitle: 'Data is stored locally in your browser. Please backup regularly to prevent data loss.',
        customColor: 'Custom Colors',
        exportData: 'Export Data',
        importData: 'Import Data',
        importCharacter: 'Import Character',
        
        // Sidebar
        characterList: 'Characters',
        worldBook: 'World Book',
        addCharacter: 'Add Character',
        comingSoon: 'Coming Soon...',
        
        // Main functions
        singleView: 'Single View',
        compareView: 'Compare View',
        addVersion: 'Add Version',
        characterName: 'Character Name',
        deleteCharacter: 'Delete Character',
        copyCharacter: 'Duplicate Character',
        unsavedChanges: 'Unsaved Changes',
        saveChanged: 'ğŸ’¾ Changes Saved',
        
        // Form fields
        creator: 'Creator',
        charVersion: 'Character Version',
        creatorNotes: 'Creator Notes',
        tags: 'Tags',
        description: 'Description',
        personality: 'Personality',
        scenario: 'Scenario',
        dialogue: 'Example Dialogue',
        firstMessage: 'First Message',
        
        // Placeholders
        creatorPlaceholder: 'Creator name (optional)...',
        versionPlaceholder: 'Version number or description (optional)...',
        notesPlaceholder: 'Creator notes or description (optional)...',
        tagsPlaceholder: 'Tags, separated by commas (optional)...',
        descPlaceholder: 'Describe character appearance, background, settings...',
        personalityPlaceholder: 'Character traits, behavior patterns, speech style...',
        scenarioPlaceholder: 'Character situation, environment, current circumstances...',
        dialoguePlaceholder: '{{user}}: Hello!\\n{{char}}: Hi there! Nice to meet you~',
        firstMsgPlaceholder: 'Character\'s first message or greeting...',
        
        // Buttons
        save: 'ğŸ’¾ Save',
        copy: 'ğŸ“‹ Duplicate Version',
        delete: 'Delete',
        selectImage: 'Select Image',
        exportJSON: 'Export JSON',
        exportPNG: 'Export PNG',
        exportAll: 'Export All Versions',
        
        // Statistics
        chars: 'chars',
        tokens: 'tokens',
        total: 'Total',

       // Lorebook
worldBook: 'Lorebooks',
addWorldBook: 'Add Lorebook',
worldBookName: 'Lorebook Name',
worldBookDesc: 'Lorebook Description', 
addEntry: 'Add Entry',
entryName: 'Entry Name',
keywords: 'Keywords',
secondaryKeys: 'Secondary Keywords',
entryContent: 'Entry Content',
entryComment: 'Entry Comment',
deleteEntry: 'Delete Entry',
keywordsPlaceholder: 'Keywords, separated by commas...',
secondaryKeysPlaceholder: 'Secondary keywords, separated by commas...',
entryContentPlaceholder: 'Content to insert when keywords are triggered...',
entryCommentPlaceholder: 'Comment or description for this entry...',
insertionOrder: 'Insertion Order',
entryEnabled: 'Enable Entry',
selectiveMode: 'Selective Mode',
constantMode: 'Constant Mode',
deleteWorldBook: 'Delete Lorebook',
copyWorldBook: 'Duplicate Lorebook',
exportWorldBook: 'Export Lorebook',
importWorldBook: 'Import Lorebook',

        // è‡ªå®šç¾©
customFields: 'Notebook',
addCustomField: 'New Notebook',
customSection: 'Custom Section',
addField: 'Add Field',
fieldName: 'Field Name',
fieldContent: 'Field Content',
deleteField: 'Delete Field',
customFieldPlaceholder: 'Enter custom content...',
fieldNamePlaceholder: 'Field name...',
exportTXT: 'Export TXT',
exportMarkdown: 'Export Markdown',
copySection: 'Duplicate Section',
deleteSection: 'Delete Section',
sectionName: 'Section Name',
        
        // Dialogs
        customTheme: 'Custom Theme Colors',
        primaryColor: 'Primary Color',
        secondaryColor: 'Secondary Color',
        accentColor: 'Accent Color',
        bgColor: 'Background Color',
        surfaceColor: 'Button and Text Box Color',
        textColor: 'Text Color',
        textMutedColor: 'Muted Text Color',
        restoreDefault: 'Restore Default',
        eyeCareMode: 'Eye Care Colors',
        exportColorTheme: 'Export Colors',
        importColorTheme: 'Import Colors',
        borderColor: 'Border Color',
        cancel: 'Cancel',
        apply: 'Apply',
        headerBgColor: 'Header Background',
        sidebarBgColor: 'Sidebar Background',
        mainContentBgColor: 'Main Content Background', 
        contentBgColor: 'Content Panel Background',
        
        // Messages
        saved: 'âœ“ Saved to browser',
        importSuccess: 'Character imported successfully!',
        deleteConfirm: 'Are you sure you want to delete character "$1"?\\n\\nâš ï¸ This cannot be undone. Please ensure you have backed up important data!',
        deleteVersionConfirm: 'Are you sure you want to delete version "$1"?\\n\\nâš ï¸ This cannot be undone. Please ensure you have backed up important data!',
        needTwoVersions: 'Need at least 2 versions to compare',
        keepOneCharacter: 'Must keep at least one character',
        keepOneVersion: 'Must keep at least one version',
        maxTwoVersions: 'Can only select up to 2 versions',
        
        // Compare View
        selectVersionsToCompare: 'Select Versions to Compare',
selectTwoVersions: 'Select 2 versions to compare',
currentSelected: 'Currently selected',
startCompare: 'Start Compare',
needOneMore: 'Need 1 more version',

        // Export related
        selectVersion: 'Select version to export (1-$1):',
        exportAllTitle: 'Export All Versions',
        exportAllDesc: 'Character "$1" has $2 versions. Please select export format:',
        jsonFormat: 'JSON Format',
        jsonDesc: 'Plain text format, suitable for importing to other tools or backup',
        pngFormat: 'PNG Image Format',
        pngDesc: 'Character card with images, suitable for sharing or use in SillyTavern',
        startExport: 'Start Export',
        exporting: 'Exporting $1 versions...',
        preparing: 'Preparing...',
        exportComplete: 'âœ“ Successfully exported $1 $2 files!',
        noImage: 'No Image',
        versionStats: '$1chars / $2tokens',
        exportCharacter: 'Export Character Card',
        selectCharacter: 'Please select a character'
    }
};

let currentLang = localStorage.getItem('characterCreatorLang') || 'zh';

// ç¿»è­¯å‡½æ•¸
function t(key, ...args) {
    let text = translations[currentLang][key] || key;
    // è™•ç†åƒæ•¸æ›¿æ› $1, $2 ç­‰
    args.forEach((arg, index) => {
        text = text.replace(`$${index + 1}`, arg);
    });
    return text;
}

function switchLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('characterCreatorLang', lang);
    renderAll(); // é€™è£¡æœƒè§¸ç™¼ updateSaveButtonStates()
}
        let characters = [];
        let currentCharacterId = null;
        let currentVersionId = null;
        let viewMode = 'single'; // 'single' æˆ– 'compare'
        let sidebarCollapsed = false;
        let compareVersions = []; // ç”¨æ–¼å°æ¯”æª¢è¦–çš„ç‰ˆæœ¬é¸æ“‡
        let hasUnsavedChanges = false;
        let lastSavedData = null;
        let customSections = []; // æ–°å¢è‡ªå®šç¾©å€å¡Šé™£åˆ—
        let worldBooks = []; // æ–°å¢ä¸–ç•Œæ›¸é™£åˆ—
        let currentMode = 'character'; // æ–°å¢æ¨¡å¼ç‹€æ…‹ï¼š'character'ã€'custom' æˆ– 'worldbook'
        let currentWorldBookId = null; // ç•¶å‰é¸ä¸­çš„ä¸–ç•Œæ›¸ID
        let currentWorldBookVersionId = null; // ç•¶å‰é¸ä¸­çš„ä¸–ç•Œæ›¸ç‰ˆæœ¬ID
        let currentCustomSectionId = null; // ç•¶å‰é¸ä¸­çš„è‡ªå®šç¾©å€å¡ŠID
        let currentCustomVersionId = null; // ç•¶å‰é¸ä¸­çš„è‡ªå®šç¾©ç‰ˆæœ¬ID

        // ä¸»é¡Œé…è‰² - è‹±å€«é¢¨ä½å½©åº¦é…è‰²
        const themes = {
            classic: { primary: '#4E5E79', secondary: '#1a202c', accent: '#8b7355', bg: '#f7f5f3' },
            warm: { primary: '#744210', secondary: '#553c9a', accent: '#d69e2e', bg: '#fefcf0' },
            cool: { primary: '#2c5282', secondary: '#2a4365', accent: '#3182ce', bg: '#f0f8ff' },
            forest: { primary: '#22543d', secondary: '#1a202c', accent: '#38a169', bg: '#f0fff4' },
            vintage: { primary: '#553c9a', secondary: '#44337a', accent: '#9f7aea', bg: '#faf5ff' },
            minimal: { primary: '#4a5568', secondary: '#2d3748', accent: '#718096', bg: '#f8f9fa' }
        };

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
function toggleSection(sectionName) {
    const content = document.getElementById(`${sectionName}-content`);
    const icon = document.getElementById(`${sectionName}-icon`);
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        icon.textContent = 'â–¼';
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.classList.add('collapsed');
        icon.textContent = 'â–¶';
        icon.style.transform = 'rotate(-90deg)';
    }
}

function autoResizeTextarea(textarea) {
    // é‡ç½®é«˜åº¦ä»¥ç²å¾—æº–ç¢ºçš„ scrollHeight
    textarea.style.height = 'auto';
    
    // è¨ˆç®—æ‰€éœ€é«˜åº¦ï¼Œæœ€å°120px
    const minHeight = 120;
    const maxHeight = 500; // è¨­å®šæœ€å¤§é«˜åº¦é¿å…éé•·
    let newHeight = Math.max(minHeight, textarea.scrollHeight);
    newHeight = Math.min(maxHeight, newHeight);
    
    // è¨­å®šæ–°é«˜åº¦
    textarea.style.height = newHeight + 'px';
}

function initAutoResize() {
    // ç‚ºæ‰€æœ‰ textarea æ·»åŠ è‡ªå‹•èª¿æ•´åŠŸèƒ½
    const textareas = document.querySelectorAll('textarea.field-input');
    textareas.forEach(textarea => {
        // æ·»åŠ  auto-resize class
        textarea.classList.add('auto-resize');
        
        // åˆå§‹èª¿æ•´å¤§å°
        autoResizeTextarea(textarea);
        
        // ç›£è½è¼¸å…¥äº‹ä»¶
        textarea.addEventListener('input', function() {
            autoResizeTextarea(this);
        });
        
        // ç›£è½è²¼ä¸Šäº‹ä»¶
        textarea.addEventListener('paste', function() {
            // ç¨å¾®å»¶é²ä»¥ç¢ºä¿è²¼ä¸Šçš„å…§å®¹å·²ç¶“æ’å…¥
            setTimeout(() => {
                autoResizeTextarea(this);
            }, 10);
        });
    });
}

        function countTokens(text) {
            if (!text) return 0;
            
            // æ›´ç²¾æº–çš„tokenè¨ˆç®—ï¼Œæ¨¡æ“¬GPT-4çš„BPE tokenizer
            // é è™•ç†ï¼šç§»é™¤å¤šé¤˜ç©ºç™½
            text = text.trim().replace(/\s+/g, ' ');
            
            let tokenCount = 0;
            let i = 0;
            
            while (i < text.length) {
                const char = text[i];
                
                // ä¸­æ–‡å­—ç¬¦ï¼ˆåŒ…æ‹¬æ—¥æ–‡ã€éŸ“æ–‡ï¼‰- é€šå¸¸æ˜¯1 token
                if (/[\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(char)) {
                    tokenCount += 1;
                    i++;
                }
                // è‹±æ–‡å–®è©è™•ç†
                else if (/[a-zA-Z]/.test(char)) {
                    let wordStart = i;
                    while (i < text.length && /[a-zA-Z]/.test(text[i])) {
                        i++;
                    }
                    const word = text.slice(wordStart, i);
                    
                    // è‹±æ–‡å–®è©çš„tokenä¼°ç®—
                    if (word.length <= 3) {
                        tokenCount += 1;
                    } else if (word.length <= 6) {
                        tokenCount += 1.5;
                    } else if (word.length <= 10) {
                        tokenCount += 2;
                    } else {
                        tokenCount += Math.ceil(word.length / 4);
                    }
                }
                // æ•¸å­—è™•ç†
                else if (/[0-9]/.test(char)) {
                    let numStart = i;
                    while (i < text.length && /[0-9.,]/.test(text[i])) {
                        i++;
                    }
                    const num = text.slice(numStart, i);
                    // æ•¸å­—é€šå¸¸æ¯2-4ä½æ˜¯1å€‹token
                    tokenCount += Math.ceil(num.replace(/[.,]/g, '').length / 3);
                }
                // æ¨™é»ç¬¦è™Ÿå’Œç‰¹æ®Šå­—ç¬¦
                else if (/[^\s]/.test(char)) {
                    // å¸¸è¦‹æ¨™é»ç¬¦è™Ÿçµ„åˆ
                    if (i < text.length - 1) {
                        const twoChar = text.slice(i, i + 2);
                        if (['--', '...', '!!', '??', '::'].includes(twoChar)) {
                            tokenCount += 1;
                            i += 2;
                            continue;
                        }
                    }
                    
                    // å–®å€‹æ¨™é»ç¬¦è™Ÿ
                    if (/[.!?,:;()[\]{}"'`~@#$%^&*+=<>|\\/-]/.test(char)) {
                        tokenCount += 0.5;
                    } else {
                        tokenCount += 1;
                    }
                    i++;
                }
                // ç©ºç™½å­—ç¬¦
                else {
                    // ç©ºæ ¼é€šå¸¸ä¸å–®ç¨è¨ˆç®—tokenï¼Œä½†æœƒå½±éŸ¿åˆ†è©
                    i++;
                }
            }
            
            // åŠ ä¸Šä¸€äº›ç‰¹æ®Šæ ¼å¼çš„é¡å¤–tokenï¼ˆå¦‚{{user}}, {{char}}ç­‰ï¼‰
            const specialTokens = text.match(/\{\{(user|char|random|pick|roll)\}\}/g);
            if (specialTokens) {
                tokenCount += specialTokens.length * 0.5;
            }
            
            return Math.ceil(tokenCount);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebarCollapsed = !sidebarCollapsed;
            
            if (window.innerWidth <= 768) {
                // æ‰‹æ©Ÿç‰ˆï¼šä½¿ç”¨ show/hide é¡åˆ¥
                sidebar.classList.toggle('show');
            } else {
                // æ¡Œé¢ç‰ˆï¼šä½¿ç”¨ collapsed é¡åˆ¥ä¾†æ”¹è®Šå¯¬åº¦
                sidebar.classList.toggle('collapsed', sidebarCollapsed);
            }
        }

        function changeTheme(themeName) {
            // ç§»é™¤ä¸»é¡Œåˆ‡æ›åŠŸèƒ½ï¼Œåªä¿ç•™è‡ªè¨‚é¡è‰²
        }

        function showColorPicker() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${t('customTheme')}</h3>
                <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
            </div>
            
            <div class="color-input-group">
                <label>${t('primaryColor')}</label>
                <input type="color" class="color-input" id="primary-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim()}">
            </div>
            
            <div class="color-input-group">
                <label>${t('secondaryColor')}</label>
                <input type="color" class="color-input" id="secondary-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim()}">
            </div>
            
            <div class="color-input-group">
                <label>${t('accentColor')}</label>
                <input type="color" class="color-input" id="accent-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('bgColor')}</label>
                <input type="color" class="color-input" id="bg-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim()}">
            </div>
            
            <div class="color-input-group">
                <label>${t('surfaceColor')}</label>
                <input type="color" class="color-input" id="surface-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--surface-color').trim()}">
            </div>
            
            <div class="color-input-group">
                <label>${t('textColor')}</label>
                <input type="color" class="color-input" id="text-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('textMutedColor')}</label>
                <input type="color" class="color-input" id="text-muted" value="${getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim()}">
            </div>
        <div class="color-input-group">
    <label>${t('borderColor')}</label>
    <input type="color" class="color-input" id="border-color" value="${getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()}">
</div>

            <div class="color-input-group">
                <label>${t('headerBgColor')}</label>
                <input type="color" class="color-input" id="header-bg" value="${getComputedStyle(document.documentElement).getPropertyValue('--header-bg').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('sidebarBgColor')}</label>
                <input type="color" class="color-input" id="sidebar-bg" value="${getComputedStyle(document.documentElement).getPropertyValue('--sidebar-bg').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('mainContentBgColor')}</label>
                <input type="color" class="color-input" id="main-content-bg" value="${getComputedStyle(document.documentElement).getPropertyValue('--main-content-bg').trim()}">
            </div>

            <div class="color-input-group">
                <label>${t('contentBgColor')}</label>
                <input type="color" class="color-input" id="content-bg" value="${getComputedStyle(document.documentElement).getPropertyValue('--content-bg').trim()}">
            </div>

            <div class="color-preview">
                <div class="color-preview-item" id="preview-primary">${currentLang === 'zh' ? 'ä¸»è¦' : 'Primary'}</div>
                <div class="color-preview-item" id="preview-secondary">${currentLang === 'zh' ? 'æ¬¡è¦' : 'Secondary'}</div>
                <div class="color-preview-item" id="preview-accent">${currentLang === 'zh' ? 'å¼·èª¿' : 'Accent'}</div>
                <div class="color-preview-item" id="preview-surface" style="color: var(--text-color);">${currentLang === 'zh' ? 'ä»‹é¢' : 'Surface'}</div>
                <div class="color-preview-item" id="preview-text" style="background: var(--surface-color); color: white; border: 1px solid var(--border-color);">${currentLang === 'zh' ? 'æ–‡å­—' : 'Text'}</div>
                <div class="color-preview-item" id="preview-text-muted" style="background: var(--surface-color); color: white; border: 1px solid var(--border-color);">${currentLang === 'zh' ? 'æ¬¡æ–‡å­—' : 'Muted'}</div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="applyDefaultColors()">${t('restoreDefault')}</button>
                    <button class="btn btn-secondary" onclick="applyEyeCareColors()">${t('eyeCareMode')}</button>
                    <button class="btn btn-secondary" onclick="exportColorThemeFromModal()">${t('exportColorTheme')}</button>
                    <button class="btn btn-secondary" onclick="importColorThemeFromModal()">${t('importColorTheme')}</button>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">${t('cancel')}</button>
                    <button class="btn btn-primary" onclick="applyCustomColors()">${t('apply')}</button>
                </div>
            </div>

            <input type="file" id="importColorFileModal" accept=".json" style="display: none;" onchange="handleColorImportFromModal(event)">
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // ç²å–æ‰€æœ‰é¡è‰²è¼¸å…¥
    const primaryInput = document.getElementById('primary-color');
    const secondaryInput = document.getElementById('secondary-color');
    const accentInput = document.getElementById('accent-color');
    const bgInput = document.getElementById('bg-color');
    const surfaceInput = document.getElementById('surface-color');
    const textInput = document.getElementById('text-color');
    const textMutedInput = document.getElementById('text-muted');
    const headerBgInput = document.getElementById('header-bg');
    const sidebarBgInput = document.getElementById('sidebar-bg');
    const mainContentBgInput = document.getElementById('main-content-bg');
    const contentBgInput = document.getElementById('content-bg');

    function updatePreview() {
        document.getElementById('preview-primary').style.backgroundColor = primaryInput.value;
        document.getElementById('preview-secondary').style.backgroundColor = secondaryInput.value;
        document.getElementById('preview-accent').style.backgroundColor = accentInput.value;
        document.getElementById('preview-surface').style.backgroundColor = surfaceInput.value;
        document.getElementById('preview-text').style.color = textInput.value;
        document.getElementById('preview-text-muted').style.color = textMutedInput.value;
    }
    
    // ç‚ºæ‰€æœ‰è¼¸å…¥æ·»åŠ äº‹ä»¶ç›£è½å™¨
    [primaryInput, secondaryInput, accentInput, bgInput, surfaceInput, textInput, textMutedInput,
     headerBgInput, sidebarBgInput, mainContentBgInput, contentBgInput].forEach(input => {
        input.addEventListener('input', updatePreview);
    });
    
    updatePreview(); // åˆå§‹åŒ–é è¦½
    
    // é»æ“Šå¤–éƒ¨é—œé–‰
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

        function applyCustomColors() {
    const primary = document.getElementById('primary-color').value;
    const secondary = document.getElementById('secondary-color').value;
    const accent = document.getElementById('accent-color').value;
    const bg = document.getElementById('bg-color').value;
    const surface = document.getElementById('surface-color').value;
    const textColor = document.getElementById('text-color').value;
    const textMuted = document.getElementById('text-muted').value;
const borderColor = document.getElementById('border-color').value;
// ç²å–ç•Œé¢èƒŒæ™¯è‰²
const headerBg = document.getElementById('header-bg').value;
    const sidebarBg = document.getElementById('sidebar-bg').value;
    const mainContentBg = document.getElementById('main-content-bg').value;
    const contentBg = document.getElementById('content-bg').value;
    
    const root = document.documentElement;
    root.style.setProperty('--primary-color', primary);
    root.style.setProperty('--secondary-color', secondary);
    root.style.setProperty('--accent-color', accent);
    root.style.setProperty('--bg-color', bg);
    root.style.setProperty('--surface-color', surface);
    root.style.setProperty('--text-color', textColor);
    root.style.setProperty('--text-muted', textMuted);
    root.style.setProperty('--border-color', borderColor);
    
    // è¨­å®šç•Œé¢èƒŒæ™¯è‰²
    root.style.setProperty('--header-bg', headerBg);
    root.style.setProperty('--sidebar-bg', sidebarBg);
    root.style.setProperty('--main-content-bg', mainContentBg);
    root.style.setProperty('--content-bg', contentBg);

    // å„²å­˜æ‰€æœ‰è‡ªè¨‚é¡è‰²ï¼ˆåŒ…å«é‚Šæ¡†é¡è‰²ï¼‰
localStorage.setItem('characterCreatorCustomColors', JSON.stringify({
    primary, secondary, accent, bg, surface, textColor, textMuted, borderColor,
    headerBg, sidebarBg, mainContentBg, contentBg
}));
    
    document.querySelector('.modal').remove();
}


        function adjustBrightness(hex, factor) {
    // ç§»é™¤ # ç¬¦è™Ÿ
    hex = hex.replace('#', '');
    
    // è½‰æ›ç‚º RGB
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    
    // èª¿æ•´äº®åº¦
    const newR = Math.max(0, Math.min(255, Math.round(r + (255 - r) * factor)));
    const newG = Math.max(0, Math.min(255, Math.round(g + (255 - g) * factor)));
    const newB = Math.max(0, Math.min(255, Math.round(b + (255 - b) * factor)));
    
    // è½‰å› hex
    const toHex = (n) => n.toString(16).padStart(2, '0');
    return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
}

        function applyDefaultColors() {
    const root = document.documentElement;
    root.style.setProperty('--primary-color', 'var(--default-primary)');
    root.style.setProperty('--secondary-color', 'var(--default-secondary)');
    root.style.setProperty('--accent-color', 'var(--default-accent)');
    root.style.setProperty('--bg-color', 'var(--default-bg)');
    root.style.setProperty('--surface-color', 'var(--default-surface)');
    root.style.setProperty('--text-color', 'var(--default-text)');
    root.style.setProperty('--text-muted', 'var(--default-text-muted)');
    root.style.setProperty('--border-color', '#e2e8f0');
    
    // ä¸‰å€åŸŸèƒŒæ™¯è‰²
    root.style.setProperty('--header-bg', 'var(--default-header-bg)');
    root.style.setProperty('--sidebar-bg', 'var(--default-sidebar-bg)');
    root.style.setProperty('--main-content-bg', 'var(--default-main-content-bg)');
    root.style.setProperty('--content-bg', 'var(--default-content-bg)');
    
    // æ›´æ–°å°è©±æ¡†ä¸­çš„æ‰€æœ‰é¡è‰²é¸æ“‡å™¨
    document.getElementById('primary-color').value = '#4E5E79';
    document.getElementById('secondary-color').value = '#1a202c';
    document.getElementById('accent-color').value = '#8b7355';
    document.getElementById('bg-color').value = '#f7f5f3';
    document.getElementById('surface-color').value = '#ffffff';
    document.getElementById('text-color').value = '#2d3748';
    document.getElementById('text-muted').value = '#718096';
    // æ›´æ–°ç•Œé¢èƒŒæ™¯è‰²
    document.getElementById('border-color').value = '#e2e8f0';
    document.getElementById('header-bg').value = '#f1f5f9';
    document.getElementById('sidebar-bg').value = '#f8fafc';
    document.getElementById('main-content-bg').value = '#fafbfc';
    document.getElementById('content-bg').value = '#ffffff';
    
    updatePreview();
    
    // ç§»é™¤å„²å­˜çš„è‡ªè¨‚é¡è‰²
    localStorage.removeItem('characterCreatorCustomColors');
    
    document.querySelector('.modal').remove();
}

function applyEyeCareColors() {
    const root = document.documentElement;
    
    // ä½¿ç”¨ CSS è®Šæ•¸ä¸­å®šç¾©çš„è­·çœ¼é…è‰²
    root.style.setProperty('--primary-color', 'var(--eyecare-primary)');
    root.style.setProperty('--secondary-color', 'var(--eyecare-secondary)');
    root.style.setProperty('--accent-color', 'var(--eyecare-accent)');
    root.style.setProperty('--bg-color', 'var(--eyecare-bg)');
    root.style.setProperty('--surface-color', 'var(--eyecare-surface)');
    root.style.setProperty('--text-color', 'var(--eyecare-text)');
    root.style.setProperty('--text-muted', 'var(--eyecare-text-muted)');
    root.style.setProperty('--border-color', 'var(--eyecare-border)');
    
    // è­·çœ¼ä¸‰å€åŸŸèƒŒæ™¯è‰²
    root.style.setProperty('--header-bg', 'var(--eyecare-header-bg)');
    root.style.setProperty('--sidebar-bg', 'var(--eyecare-sidebar-bg)');
    root.style.setProperty('--main-content-bg', 'var(--eyecare-main-content-bg)');
    root.style.setProperty('--content-bg', 'var(--eyecare-content-bg)');
    
    // å„²å­˜è­·çœ¼é…è‰²ï¼ˆä½¿ç”¨å¯¦éš›é¡è‰²å€¼ï¼‰
    localStorage.setItem('characterCreatorCustomColors', JSON.stringify({
        primary: '#404040',             // ä¸»è‰²ï¼šæ·¡ç°
        secondary: '#6e6e6e',           // æ¬¡è‰²ï¼šä¸­ç°
        accent: '#4b768b',              // å¼·èª¿è‰²ï¼šç™½
        bg: '#7d7d7d',                  // å…¨å±€èƒŒæ™¯
        surface: '#2a2a2a',             // é¢æ¿ã€å¡ç‰‡
        textColor: '#e0e0e0',           // ä¸»æ–‡å­—
        textMuted: '#aaaaaa',           // æ¬¡æ–‡å­—
        borderColor: '#525252',         // é‚Šæ¡†
        headerBg: '#000000',            // é ‚éƒ¨æ¬„èƒŒæ™¯
        sidebarBg: '#1f1f1f',           // å´é‚Šæ¬„èƒŒæ™¯
        mainContentBg: '#1a1a1a',       // ä¸»å…§å®¹èƒŒæ™¯
        contentBg: '#292929'            // å…§å®¹å€èƒŒæ™¯
    }));
    
    document.querySelector('.modal').remove();
}

function exportColorThemeFromModal() {
    // å¾å°è©±æ¡†ä¸­çš„è¼¸å…¥æ¡†è®€å–ç•¶å‰è¨­å®šçš„é¡è‰²
    const currentColors = {
        primary: document.getElementById('primary-color').value,
        secondary: document.getElementById('secondary-color').value,
        accent: document.getElementById('accent-color').value,
        bg: document.getElementById('bg-color').value,
        surface: document.getElementById('surface-color').value,
        textColor: document.getElementById('text-color').value,
        textMuted: document.getElementById('text-muted').value,
        headerBg: document.getElementById('header-bg').value,
        sidebarBg: document.getElementById('sidebar-bg').value,
        mainContentBg: document.getElementById('main-content-bg').value,
        contentBg: document.getElementById('content-bg').value,
        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()
    };

    const colorTheme = {
        name: prompt('è«‹è¼¸å…¥é…è‰²ä¸»é¡Œåç¨±ï¼š') || 'è‡ªè¨‚é…è‰²',
        colors: currentColors,
        exportDate: new Date().toISOString(),
        version: '1.0.0'
    };

    const blob = new Blob([JSON.stringify(colorTheme, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${colorTheme.name}_é…è‰²ä¸»é¡Œ.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importColorThemeFromModal() {
    document.getElementById('importColorFileModal').click();
}

function handleColorImportFromModal(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const themeData = JSON.parse(e.target.result);
            
            if (themeData.colors) {
                const confirmImport = confirm(`ç¢ºå®šè¦åŒ¯å…¥é…è‰²ä¸»é¡Œã€Œ${themeData.name || 'æœªå‘½å'}ã€å—ï¼Ÿ`);
                
                if (confirmImport) {
                    // æ›´æ–°å°è©±æ¡†ä¸­çš„é¡è‰²é¸æ“‡å™¨
const colors = themeData.colors;
if (colors.primary) document.getElementById('primary-color').value = colors.primary;
if (colors.secondary) document.getElementById('secondary-color').value = colors.secondary;
if (colors.accent) document.getElementById('accent-color').value = colors.accent;
if (colors.bg) document.getElementById('bg-color').value = colors.bg;
if (colors.surface) document.getElementById('surface-color').value = colors.surface;
if (colors.textColor) document.getElementById('text-color').value = colors.textColor;
if (colors.textMuted) document.getElementById('text-muted').value = colors.textMuted;
if (colors.borderColor) document.getElementById('border-color').value = colors.borderColor;
if (colors.headerBg) document.getElementById('header-bg').value = colors.headerBg;
if (colors.sidebarBg) document.getElementById('sidebar-bg').value = colors.sidebarBg;
if (colors.mainContentBg) document.getElementById('main-content-bg').value = colors.mainContentBg;
if (colors.contentBg) document.getElementById('content-bg').value = colors.contentBg;
                
                    
                    alert(`é…è‰²ä¸»é¡Œã€Œ${themeData.name || 'æœªå‘½å'}ã€åŒ¯å…¥æˆåŠŸï¼è«‹é»æ“Šã€Œå¥—ç”¨ã€ä¾†æ‡‰ç”¨è¨­å®šã€‚`);
                }
            } else {
                alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„é…è‰²ä¸»é¡Œæª”æ¡ˆ');
            }
        } catch (error) {
            alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
        }
    };
    reader.readAsText(file);
    
    event.target.value = '';
}

function applyImportedColors(colors) {
    const root = document.documentElement;
    
    if (colors.primary) root.style.setProperty('--primary-color', colors.primary);
    if (colors.secondary) root.style.setProperty('--secondary-color', colors.secondary);
    if (colors.accent) root.style.setProperty('--accent-color', colors.accent);
    if (colors.bg) root.style.setProperty('--bg-color', colors.bg);
    if (colors.surface) root.style.setProperty('--surface-color', colors.surface);
    if (colors.textColor) root.style.setProperty('--text-color', colors.textColor);
    if (colors.textMuted) root.style.setProperty('--text-muted', colors.textMuted);
    if (colors.borderColor) root.style.setProperty('--border-color', colors.borderColor);
    if (colors.headerBg) root.style.setProperty('--header-bg', colors.headerBg);
    if (colors.sidebarBg) root.style.setProperty('--sidebar-bg', colors.sidebarBg);
    if (colors.mainContentBg) root.style.setProperty('--main-content-bg', colors.mainContentBg);
    if (colors.contentBg) root.style.setProperty('--content-bg', colors.contentBg);
    
    // å„²å­˜åŒ¯å…¥çš„é…è‰²
    localStorage.setItem('characterCreatorCustomColors', JSON.stringify(colors));
}

        function showSaveNotification() {
    // å‰µå»ºå„²å­˜æˆåŠŸæç¤º
        const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
        z-index: 9999;
        box-shadow: var(--shadow-medium);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    notification.textContent = t('saved');
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 2000);
}

// è®Šæ›´è¿½è¹¤å‡½æ•¸ï¼š
function markAsChanged() {
    hasUnsavedChanges = true;
    updateSaveButtonStates();
}

function markAsSaved() {
    hasUnsavedChanges = false;
    lastSavedData = JSON.stringify(characters);
    updateSaveButtonStates();
}

function updateSaveButtonStates() {
    // æ›´æ–°æ‰€æœ‰å„²å­˜æŒ‰éˆ•çš„å¤–è§€
setTimeout(() => {
    const saveButtons = document.querySelectorAll('button[onclick*="saveData()"]');
    saveButtons.forEach(btn => {
        if (hasUnsavedChanges) {
            btn.classList.add('btn-warning');
            btn.classList.remove('btn-secondary');
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºæœ‰æœªå„²å­˜è®Šæ›´
            if (btn.textContent.includes('ğŸ’¾')) {
                btn.innerHTML = 'ğŸ’¾ ' + (currentLang === 'zh' ? 'æœ‰å°šæœªå„²å­˜çš„è®Šæ›´' : 'Unsaved Changes');
            }
        } else {
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-secondary');
            // æ¢å¾©æ­£å¸¸æ–‡å­—
            if (btn.textContent.includes('ğŸ’¾')) {
                btn.innerHTML = t('save');
            }
        }
    });
      }, 50);
}


        function exportAllData() {
    const exportData = {
        characters: characters,
        customSections: customSections, // æ–°å¢
        exportDate: new Date().toISOString(),
        version: '1.0.0'
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chronicler_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

        function importAllData() {
            document.getElementById('importAllFile').click();
        }

        function handleImportAll(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.characters && Array.isArray(data.characters)) {
                const totalItems = data.characters.length + (data.customSections ? data.customSections.length : 0);
                const confirmImport = confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${data.characters.length} å€‹è§’è‰²${data.customSections ? ` å’Œ ${data.customSections.length} å€‹è‡ªå®šç¾©å€å¡Š` : ''}å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è³‡æ–™ï¼`);
                
                if (confirmImport) {
                    characters = data.characters;
                    customSections = data.customSections || []; // æ–°å¢
                    
                    currentCharacterId = characters[0]?.id || null;
                    currentVersionId = characters[0]?.versions[0]?.id || null;
                    currentCustomSectionId = customSections[0]?.id || null;
                    currentCustomVersionId = customSections[0]?.versions[0]?.id || null;
                    currentMode = 'character';
                    compareVersions = [];
                    
                    renderAll();
                    saveData();
                    alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                }
            } else {
                alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„å‚™ä»½æª”æ¡ˆ');
            }
        } catch (error) {
            alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
        }
    };
    reader.readAsText(file);
}

        function loadData() {
    try {
        const saved = localStorage.getItem('characterCreatorData');
        if (saved) {
            characters = JSON.parse(saved);
            if (characters.length > 0) {
                currentCharacterId = characters[0].id;
                currentVersionId = characters[0].versions[0].id;
            }
        }

        const savedWorldBooks = localStorage.getItem('characterCreatorWorldBooks');
if (savedWorldBooks) {
    worldBooks = JSON.parse(savedWorldBooks);
    if (worldBooks.length > 0 && !currentWorldBookId) {
        currentWorldBookId = worldBooks[0].id;
        currentWorldBookVersionId = worldBooks[0].versions[0].id;
    }
}
        
        // æ–°å¢ï¼šè¼‰å…¥è‡ªå®šç¾©å€å¡Š
        const savedCustom = localStorage.getItem('characterCreatorCustomData');
        if (savedCustom) {
            customSections = JSON.parse(savedCustom);
            if (customSections.length > 0 && !currentCustomSectionId) {
                currentCustomSectionId = customSections[0].id;
                currentCustomVersionId = customSections[0].versions[0].id;
            }
        }
        
        markAsSaved();
    } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š', error);
    }
}

        function addCharacter() {
    const character = {
        id: generateId(),
        name: `Character ${characters.length + 1}`,
        versions: [{
            id: generateId(),
            name: 'Version 1',
            avatar: '',
            description: '',
            personality: '',
            scenario: '',
            dialogue: '',
            firstMessage: '',
            creator: '',
            charVersion: '',
            creatorNotes: '',
            tags: ''
        }]
    };
    characters.push(character);
    currentCharacterId = character.id;
    currentVersionId = character.versions[0].id;
    renderAll();
    markAsChanged(); // æ¨™è¨˜æœ‰è®Šæ›´
}

        function removeCharacter(characterId) {
    if (characters.length <= 1) {
        alert(t('keepOneCharacter'));
        return;
    }
    
    const character = characters.find(c => c.id === characterId);
    const confirmDelete = confirm(t('deleteConfirm', character?.name || 'æœªå‘½åè§’è‰²'));
    
    if (confirmDelete) {
        characters = characters.filter(c => c.id !== characterId);
        if (currentCharacterId === characterId) {
            currentCharacterId = characters[0]?.id || null;
            currentVersionId = characters[0]?.versions[0]?.id || null;
        }
        renderAll();
        saveData(); 
    }
}

        function addVersion(characterId) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        const newVersion = {
            id: generateId(),
            name: `Version ${character.versions.length + 1}`,
            avatar: '',
            description: '',
            personality: '',
            scenario: '',
            dialogue: '',
            firstMessage: '',
            creator: '',
            charVersion: '',
            creatorNotes: '',
            tags: ''
        };
        character.versions.push(newVersion);
        currentVersionId = newVersion.id;
        renderAll();
        markAsChanged(); // æ¨™è¨˜æœ‰è®Šæ›´
    }
}

        function removeVersion(characterId, versionId) {
    const character = characters.find(c => c.id === characterId);
    if (character && character.versions.length > 1) {
        const version = character.versions.find(v => v.id === versionId);
        const confirmDelete = confirm(t('deleteVersionConfirm', version?.name || 'æœªå‘½åç‰ˆæœ¬'));
        
        if (confirmDelete) {
            character.versions = character.versions.filter(v => v.id !== versionId);
            if (currentVersionId === versionId) {
                currentVersionId = character.versions[0].id;
            }
            renderAll();
            saveData(); 
        }
    } else {
        alert(t('keepOneVersion'));
    }
}

function selectSidebarItem(type, id, subId = null) {
    // æ¸…ç†ä¹‹å‰çš„ç‹€æ…‹
    viewMode = 'single';
    compareVersions = [];
    
    if (type === 'character') {
        currentMode = 'character';
        currentCharacterId = id;
        const character = characters.find(c => c.id === id);
        if (character) {
            currentVersionId = subId || character.versions[0].id;
        }
    } else if (type === 'custom') {
        currentMode = 'custom';
        currentCustomSectionId = id;
        const section = customSections.find(s => s.id === id);
        if (section) {
            currentCustomVersionId = subId || section.versions[0].id;
        }
    } else if (type === 'worldbook') {
    currentMode = 'worldbook';
    currentWorldBookId = id;
    const worldBook = worldBooks.find(wb => wb.id === id);
    if (worldBook) {
        currentWorldBookVersionId = subId || worldBook.versions[0].id;
    }
}
    
    renderAll();
}

        function selectCharacter(characterId) {
    currentMode = 'character'; // ç¢ºä¿é€™è¡Œå­˜åœ¨
    currentCharacterId = characterId;
    const character = characters.find(c => c.id === characterId);
    if (character) {
        currentVersionId = character.versions[0].id;
    }
    viewMode = 'single'; // æ–°å¢é€™è¡Œï¼Œé‡ç½®æª¢è¦–æ¨¡å¼
    compareVersions = []; // æ–°å¢é€™è¡Œï¼Œæ¸…ç©ºæ¯”è¼ƒé¸æ“‡
    renderAll();
}

        function selectVersion(characterId, versionId) {
    currentCharacterId = characterId;
    currentVersionId = versionId;
    viewMode = 'single';
    
    // ç¢ºä¿å°æ‡‰è§’è‰²çš„ç‰ˆæœ¬åˆ—è¡¨æ˜¯å±•é–‹çš„
    const versionsList = document.getElementById(`versions-${characterId}`);
    const characterHeader = document.querySelector(`[onclick="toggleCharacterVersions('${characterId}')"]`);
    const expandIcon = characterHeader?.querySelector('.expand-icon');
    
    if (versionsList && !versionsList.classList.contains('expanded')) {
        versionsList.classList.add('expanded');
        if (expandIcon) {
            expandIcon.style.transform = 'rotate(0deg)';
        }
    }
    
    renderAll();
}

function showCustomVersionSelector() {
    const currentSection = customSections.find(s => s.id === currentCustomSectionId);
    if (!currentSection) return;

    compareVersions = [];

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${t('selectVersionsToCompare') || 'é¸æ“‡è¦å°æ¯”çš„ç‰ˆæœ¬'}</h3>
                <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
            </div>
            
            <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9em;">
                ${t('selectTwoVersions') || 'é¸æ“‡2å€‹ç‰ˆæœ¬é€²è¡Œå°æ¯”'} 
                (<span style="color: var(--text-color); font-weight: 500;">${t('currentSelected') || 'ç›®å‰å·²é¸'}: <span id="selected-count">0</span>/2</span>)
            </p>
            
            <div class="version-checkboxes">
                ${currentSection.versions.map(version => `
                    <div class="version-checkbox" data-version-id="${version.id}" onclick="toggleVersionSelection('${version.id}')">
                        <input type="checkbox" id="check-${version.id}" onchange="event.stopPropagation()">
                        <label for="check-${version.id}">${version.name}</label>
                    </div>
                `).join('')}
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">${t('cancel')}</button>
                <button class="btn btn-primary" onclick="applyVersionComparison()" id="apply-compare" disabled>${t('startCompare') || 'é–‹å§‹å°æ¯”'}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    updateSelectedCount();
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function switchToCharacterMode() {
    currentMode = 'character';
    viewMode = 'single';
    compareVersions = [];
    renderAll();
}

function switchToCustomMode() {
    currentMode = 'custom';
    viewMode = 'single';
    compareVersions = [];
    renderAll();
}

       function toggleCompareMode() {
    if (viewMode === 'single') {
        let currentItem, versionsArray;
        
        if (currentMode === 'character') {
            currentItem = characters.find(c => c.id === currentCharacterId);
            versionsArray = currentItem?.versions || [];
        } else if (currentMode === 'worldbook') {
            currentItem = worldBooks.find(wb => wb.id === currentWorldBookId);
            versionsArray = currentItem?.versions || [];
        } else if (currentMode === 'custom') {
            currentItem = customSections.find(s => s.id === currentCustomSectionId);
            versionsArray = currentItem?.versions || [];
        }
        
        if (currentItem && versionsArray.length > 1) {
            compareVersions = [];
            showVersionSelector();
        } else {
            alert(t('needTwoVersions'));
        }
    } else {
        viewMode = 'single';
        compareVersions = [];
        renderAll();
    }
}

function saveData() {
    try {
        localStorage.setItem('characterCreatorData', JSON.stringify(characters));
        localStorage.setItem('characterCreatorCustomData', JSON.stringify(customSections)); // æ–°å¢
        markAsSaved();
        localStorage.setItem('characterCreatorWorldBooks', JSON.stringify(worldBooks));

    } catch (error) {
        console.error('å„²å­˜è³‡æ–™å¤±æ•—ï¼š', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨å­˜å„²ç©ºé–“');
    }
}
        function showVersionSelector() {
    let currentItem, versionsArray;
    
    if (currentMode === 'character') {
        currentItem = characters.find(c => c.id === currentCharacterId);
        versionsArray = currentItem?.versions || [];
    } else if (currentMode === 'worldbook') {
        currentItem = worldBooks.find(wb => wb.id === currentWorldBookId);
        versionsArray = currentItem?.versions || [];
    } else if (currentMode === 'custom') {
        currentItem = customSections.find(s => s.id === currentCustomSectionId);
        versionsArray = currentItem?.versions || [];
    }
    
    if (!currentItem) return;

    // é‡è¦ï¼šæ¯æ¬¡æ‰“é–‹å°è©±æ¡†éƒ½æ¸…ç©ºä¹‹å‰çš„é¸æ“‡ï¼Œä¸ç®¡ä¹‹å‰åœ¨ä»€éº¼æ¨¡å¼
    compareVersions = [];

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${t('selectVersionsToCompare') || 'é¸æ“‡è¦å°æ¯”çš„ç‰ˆæœ¬'}</h3>
                <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
            </div>
            
            <p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9em;">
                ${t('selectTwoVersions') || 'é¸æ“‡2å€‹ç‰ˆæœ¬é€²è¡Œå°æ¯”'} 
                (<span style="color: var(--text-color); font-weight: 500;">${t('currentSelected') || 'ç›®å‰å·²é¸'}: <span id="selected-count">0</span>/2</span>)
            </p>
            
            <div class="version-checkboxes">
                ${versionsArray.map(version => `
                    <div class="version-checkbox" data-version-id="${version.id}" onclick="toggleVersionSelection('${version.id}')">
                        <input type="checkbox" id="check-${version.id}" onchange="event.stopPropagation()">
                        <label for="check-${version.id}">${version.name}</label>
                    </div>
                `).join('')}
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">${t('cancel')}</button>
                <button class="btn btn-primary" onclick="applyVersionComparison()" id="apply-compare" disabled>${t('startCompare') || 'é–‹å§‹å°æ¯”'}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // åˆå§‹åŒ–è¨ˆæ•¸é¡¯ç¤ºï¼ˆç¢ºä¿é¡¯ç¤ºç‚º0ï¼‰
    updateSelectedCount();
    
    // é»æ“Šå¤–éƒ¨é—œé–‰
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
        function toggleVersionSelection(versionId) {
    const checkbox = document.getElementById(`check-${versionId}`);
    const container = document.querySelector(`[data-version-id="${versionId}"]`);
    
    if (!checkbox || !container) {
        console.error('æ‰¾ä¸åˆ°å°æ‡‰çš„å…ƒç´ :', versionId);
        return;
    }
    
    if (checkbox.checked) {
        // å–æ¶ˆé¸æ“‡
        checkbox.checked = false;
        container.classList.remove('selected');
        compareVersions = compareVersions.filter(id => id !== versionId);
        console.log('å–æ¶ˆé¸æ“‡:', versionId, 'ç›®å‰é¸æ“‡:', compareVersions);
    } else {
        // æ–°å¢é¸æ“‡
        if (compareVersions.length < 2) {
            checkbox.checked = true;
            container.classList.add('selected');
            compareVersions.push(versionId);
            console.log('æ–°å¢é¸æ“‡:', versionId, 'ç›®å‰é¸æ“‡:', compareVersions);
        } else {
            // å¦‚æœå·²ç¶“é¸äº†2å€‹ï¼Œä»€éº¼éƒ½ä¸åšï¼ˆç„¡è²å¿½ç•¥ï¼‰
            console.log('å·²é”æœ€å¤§é¸æ“‡æ•¸é‡ï¼Œå¿½ç•¥é»æ“Š');
            return;
        }
    }
    
    updateSelectedCount();
}

        function updateSelectedCount() {
    const countElement = document.getElementById('selected-count');
    const applyButton = document.getElementById('apply-compare');
    
    if (countElement) {
        countElement.textContent = compareVersions.length;
    }
    
    if (applyButton) {
        applyButton.disabled = compareVersions.length !== 2;
        
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—æç¤º
        if (compareVersions.length === 0) {
            applyButton.textContent = t('startCompare') || 'é–‹å§‹å°æ¯”';
        } else if (compareVersions.length === 1) {
            applyButton.textContent = `${t('needOneMore') || 'é‚„éœ€é¸æ“‡1å€‹ç‰ˆæœ¬'}`;
        } else {
            applyButton.textContent = t('startCompare') || 'é–‹å§‹å°æ¯”';
        }
    }
    
    // æ›´æ–°å…¶ä»–é¸é …çš„è¦–è¦ºç‹€æ…‹
    const allVersionBoxes = document.querySelectorAll('.version-checkbox');
    allVersionBoxes.forEach(box => {
        const versionId = box.dataset.versionId;
        const isSelected = compareVersions.includes(versionId);
        const checkbox = box.querySelector('input[type="checkbox"]');
        const label = box.querySelector('label');
        
        if (compareVersions.length >= 2 && !isSelected) {
            // å·²é¸æ»¿2å€‹ä¸”æ­¤é …ç›®æœªè¢«é¸ä¸­ - è®Šç°è‰²ä¸”ç¦ç”¨
            box.style.opacity = '0.4';
            box.style.pointerEvents = 'none';
            if (checkbox) checkbox.disabled = true;
            if (label) label.style.color = 'var(--text-muted)';
        } else {
            // æ¢å¾©æ­£å¸¸ç‹€æ…‹
            box.style.opacity = '1';
            box.style.pointerEvents = 'auto';
            if (checkbox) checkbox.disabled = false;
            if (label) label.style.color = '';
        }
    });
}

        function applyVersionComparison() {
            if (compareVersions.length >= 2) {
                viewMode = 'compare';
                document.querySelector('.modal').remove();
                renderAll();
            }
        }

        function updateField(characterId, versionId, field, value) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        const version = character.versions.find(v => v.id === versionId);
        if (version) {
            version[field] = value;
            updateStats();
            markAsChanged(); // æ¨™è¨˜æœ‰è®Šæ›´
        }
    }
}

function updateCharacterName(characterId, name) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        character.name = name;
        renderSidebar();
        markAsChanged(); // æ¨™è¨˜æœ‰è®Šæ›´
    }
}

function updateVersionName(characterId, versionId, name) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        const version = character.versions.find(v => v.id === versionId);
        if (version) {
            version.name = name;
            renderSidebar();
            markAsChanged(); // æ¨™è¨˜æœ‰è®Šæ›´
        }
    }
}

        function handleImageUpload(characterId, versionId, file) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateField(characterId, versionId, 'avatar', e.target.result);
                    renderContent();
                };
                reader.readAsDataURL(file);
            }
        }

function addCustomSection() {
    const section = {
        id: generateId(),
        name: `Notebook ${customSections.length + 1}`,
        versions: [{
            id: generateId(),
            name: 'Version 1',
            fields: [{
                id: generateId(),
                name: 'Field 1',
                content: ''
            }]
        }]
    };
    customSections.push(section);
    currentMode = 'custom';
    currentCustomSectionId = section.id;
    currentCustomVersionId = section.versions[0].id;
    renderAll();
    markAsChanged();
}

function selectCustomSection(sectionId) {
    currentMode = 'custom';
    currentCustomSectionId = sectionId;
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        currentCustomVersionId = section.versions[0].id;
    }
    renderAll();
}

function selectCustomVersion(sectionId, versionId) {
    currentMode = 'custom';
    currentCustomSectionId = sectionId;
    currentCustomVersionId = versionId;
    renderAll();
}

        function updateStats() {
    const statsElements = document.querySelectorAll('.field-stats');
    statsElements.forEach(element => {
        const textareaId = element.dataset.target;
        const textarea = document.getElementById(textareaId);
        if (textarea) {
            const text = textarea.value;
            const charCount = text.length;
            let tokenCount = countTokens(text);

            // è‹¥æ­¤æ¬„ä½æ˜¯è¦æ’é™¤ token çš„ï¼Œå°±ä¸é¡¯ç¤º token
            if (textareaId.includes('creator-') ||
                textareaId.includes('charVersion-') ||
                textareaId.includes('creatorNotes-') ||
                textareaId.includes('tags-')) {
                element.textContent = `${charCount} ${t('chars')}`;
            } else {
                element.textContent = `${charCount} ${t('chars')} / ${tokenCount} ${t('tokens')}`;
            }
        }
    });
    
    // æ›´æ–°æ¯å€‹ç‰ˆæœ¬çš„çµ±è¨ˆé¡¯ç¤º
    characters.forEach(character => {
        character.versions.forEach(version => {
            const versionStatsElement = document.getElementById(`version-stats-${version.id}`);
            if (versionStatsElement) {
                const allText = [
                    version.description, version.personality, version.scenario, 
                    version.dialogue, version.firstMessage
                ].filter(Boolean).join(' ');
                
                const chars = allText.length;
                const tokens = countTokens(allText);
                
                versionStatsElement.textContent = t('versionStats', chars, tokens);
            }
        });
    });

    // æ–°å¢ï¼šå³æ™‚æ›´æ–°å´é‚Šæ¬„çš„ç‰ˆæœ¬çµ±è¨ˆ
    updateSidebarStats();
    // æ›´æ–°è‡ªå®šç¾©æ¬„ä½çš„çµ±è¨ˆé¡¯ç¤º
customSections.forEach(section => {
    section.versions.forEach(version => {
        const versionStatsElement = document.getElementById(`custom-version-stats-${version.id}`);
        if (versionStatsElement) {
            const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
            const chars = allText.length;
            const tokens = countTokens(allText);
            
            versionStatsElement.textContent = t('versionStats', chars, tokens);
        }
        
        // æ›´æ–°æ¯å€‹æ¬„ä½çš„çµ±è¨ˆ
        version.fields.forEach(field => {
            const fieldStatsElement = document.querySelector(`[data-target="custom-field-${field.id}"]`);
            if (fieldStatsElement) {
                const chars = field.content.length;
                const tokens = countTokens(field.content);
                fieldStatsElement.textContent = `${chars} ${t('chars')} / ${tokens} ${t('tokens')}`;
            }
            // æ›´æ–°ä¸–ç•Œæ›¸çš„çµ±è¨ˆé¡¯ç¤º
worldBooks.forEach(worldBook => {
    worldBook.versions.forEach(version => {
        // æ›´æ–°æ¯å€‹æ¢ç›®çš„çµ±è¨ˆ
        version.entries.forEach(entry => {
            const fieldStatsElement = document.querySelector(`[data-target="worldbook-content-${entry.id}"]`);
            if (fieldStatsElement) {
                const chars = entry.content.length;
                const tokens = countTokens(entry.content);
                fieldStatsElement.textContent = `${chars} ${t('chars')} / ${tokens} ${t('tokens')}`;
            }
        });
        
        // æ›´æ–°ç‰ˆæœ¬çµ±è¨ˆ
        const versionStatsElement = document.getElementById(`worldbook-version-stats-${version.id}`);
        if (versionStatsElement) {
            const entryCount = version.entries.length;
            const allText = version.entries.map(entry => entry.content).filter(Boolean).join(' ');
            const chars = allText.length;
            const tokens = countTokens(allText);
            versionStatsElement.textContent = `${entryCount} ${currentLang === 'zh' ? 'å€‹æ¢ç›®' : 'entries'} - ${chars} ${t('chars')} / ${tokens} ${t('tokens')}`;
        }
    });
});
        });
    });
});
}

// æ–°å¢å‡½æ•¸ï¼šæ›´æ–°å´é‚Šæ¬„çµ±è¨ˆ
function updateSidebarStats() {
    characters.forEach(character => {
        character.versions.forEach(version => {
            // æ‰¾åˆ°å´é‚Šæ¬„ä¸­å°æ‡‰ç‰ˆæœ¬çš„çµ±è¨ˆå…ƒç´ 
            const versionElement = document.querySelector(`[onclick="selectVersion('${character.id}', '${version.id}')"] span[style*="italic"]`);
            if (versionElement) {
                const allText = [
                    version.description, 
                    version.personality, 
                    version.scenario, 
                    version.dialogue, 
                    version.firstMessage
                ].filter(Boolean).join(' ');
                
                const chars = allText.length;
                const tokens = countTokens(allText);
                
                versionElement.textContent = `${chars}å­— / ${tokens}tokens`;
            }
        });
    });
}
    
function exportCustomTXT(sectionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (!section) return;

    if (section.versions.length === 1) {
        downloadCustomTXT(section, section.versions[0]);
    } else {
        const versionIndex = prompt(t('selectVersion', section.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < section.versions.length) {
            downloadCustomTXT(section, section.versions[index]);
        }
    }
}

function exportCustomMarkdown(sectionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (!section) return;

    if (section.versions.length === 1) {
        downloadCustomMarkdown(section, section.versions[0]);
    } else {
        const versionIndex = prompt(t('selectVersion', section.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < section.versions.length) {
            downloadCustomMarkdown(section, section.versions[index]);
        }
    }
}

function downloadCustomTXT(section, version) {
    let content = `${section.name} - ${version.name}\n`;
    content += `${'='.repeat(content.length - 1)}\n\n`;
    
    version.fields.forEach(field => {
        if (field.content.trim()) {
            content += `${field.name}:\n`;
            content += `${'-'.repeat(field.name.length + 1)}\n`;
            content += `${field.content.trim()}\n\n`;
        }
    });
    
    // æ·»åŠ çµ±è¨ˆè³‡è¨Š
    const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
    const chars = allText.length;
    const tokens = countTokens(allText);
    content += `\nçµ±è¨ˆè³‡è¨Š:\n`;
    content += `å­—æ•¸: ${chars}\n`;
    content += `Tokenæ•¸: ${tokens}\n`;
    content += `åŒ¯å‡ºæ™‚é–“: ${new Date().toLocaleString()}\n`;

    const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${section.name}_${version.name}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function downloadCustomMarkdown(section, version) {
    let content = `# ${section.name} - ${version.name}\n\n`;
    
    version.fields.forEach(field => {
        if (field.content.trim()) {
            content += `## ${field.name}\n\n`;
            content += `${field.content.trim()}\n\n`;
        }
    });
    
    // æ·»åŠ çµ±è¨ˆè³‡è¨Š
    const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
    const chars = allText.length;
    const tokens = countTokens(allText);
    content += `---\n\n`;
    content += `### çµ±è¨ˆè³‡è¨Š\n\n`;
    content += `- **å­—æ•¸**: ${chars}\n`;
    content += `- **Tokenæ•¸**: ${tokens}\n`;
    content += `- **åŒ¯å‡ºæ™‚é–“**: ${new Date().toLocaleString()}\n`;

    const blob = new Blob([content], { type: 'text/markdown; charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${section.name}_${version.name}.md`;
    a.click();
    URL.revokeObjectURL(url);
}
        function renderSidebar() {
    const container = document.getElementById('sidebarContent');
    container.innerHTML = characters.map(character => `
        <div class="character-item">
           <div class="character-header ${character.id === currentCharacterId ? 'active' : ''}" 
     onclick="toggleCharacterVersions('${character.id}')">
                <span class="expand-icon">â–¼</span>
                <div class="character-info">
                    <span>${character.name}</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">${character.versions.length}</span>
                </div>
            </div>
            <div class="version-list" id="versions-${character.id}">
                ${character.versions.map(version => {
                    // è¨ˆç®—è©²ç‰ˆæœ¬çš„æ–‡å­—çµ±è¨ˆ
const allText = [
    version.description, 
    version.personality, 
    version.scenario, 
    version.dialogue, 
    version.firstMessage
].filter(Boolean).join(' '); // filter(Boolean) æœƒç§»é™¤ç©ºå€¼å’Œç©ºå­—ä¸²

const chars = allText.length;
const tokens = countTokens(allText);
                    
                    return `
                        <div class="version-item ${version.id === currentVersionId ? 'active' : ''}" 
     onclick="selectSidebarItem('character', '${character.id}', '${version.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <span style="display: inline-flex; align-items: center; gap: 6px;">
                                    ${version.avatar ? `<img src="${version.avatar}" alt="Avatar" style="width: 16px; height: 16px; border-radius: 3px;">` : ''}
                                    ${version.name}
                                </span>
                                <span style="font-size: 0.75em; font-style: italic; color: var(--text-muted); opacity: 0.8;">
                                    ${chars}å­— / ${tokens}tokens
                                </span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `).join('');
    
    // å±•é–‹ç•¶å‰é¸ä¸­è§’è‰²çš„ç‰ˆæœ¬åˆ—è¡¨
    const currentVersionsList = document.getElementById(`versions-${currentCharacterId}`);
    if (currentVersionsList) {
        currentVersionsList.classList.add('expanded');
    }
    
    // æ›´æ–°å´é‚Šæ¬„æ–‡å­—
    document.querySelector('.sidebar-section-title').textContent = t('characterList');
    const addButtons = document.querySelectorAll('.sidebar-add-btn');
    if (addButtons[0]) addButtons[0].textContent = t('addCharacter');
    if (addButtons[1]) addButtons[1].textContent = t('importCharacter');
    
    const worldBookTitle = document.querySelectorAll('.sidebar-section-title')[1];
    if (worldBookTitle) {
        worldBookTitle.textContent = t('worldBook');
    }

    // æ¸²æŸ“è‡ªå®šç¾©å€å¡Šåˆ—è¡¨
const customContainer = document.getElementById('customSectionContent');
if (customContainer) {
    customContainer.innerHTML = customSections.map(section => `
        <div class="character-item">
            <div class="character-header ${section.id === currentCustomSectionId && currentMode === 'custom' ? 'active' : ''}" 
                 onclick="toggleCustomSectionVersions('${section.id}')">
                <span class="expand-icon">â–¼</span>
                <div class="character-info">
                    <span>${section.name}</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">${section.versions.length}</span>
                </div>
            </div>
            <div class="version-list" id="custom-versions-${section.id}">
                ${section.versions.map(version => {
                    // è¨ˆç®—è©²ç‰ˆæœ¬çš„æ–‡å­—çµ±è¨ˆ
                    const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
                    const chars = allText.length;
                    const tokens = countTokens(allText);
                    
                    return `
                        <div class="version-item ${version.id === currentCustomVersionId && currentMode === 'custom' ? 'active' : ''}" 
                             onclick="selectSidebarItem('custom', '${section.id}', '${version.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <span>${version.name}</span>
                                <span style="font-size: 0.75em; font-style: italic; color: var(--text-muted); opacity: 0.8;">
                                    ${chars}å­— / ${tokens}tokens
                                </span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `).join('');
    
    // å±•é–‹ç•¶å‰é¸ä¸­å€å¡Šçš„ç‰ˆæœ¬åˆ—è¡¨
    if (currentMode === 'custom' && currentCustomSectionId) {
        const currentVersionsList = document.getElementById(`custom-versions-${currentCustomSectionId}`);
        if (currentVersionsList) {
            currentVersionsList.classList.add('expanded');
        }
    }
}
// æ¸²æŸ“ä¸–ç•Œæ›¸åˆ—è¡¨
const worldBookContainer = document.getElementById('worldBookContent');
if (worldBookContainer) {
    worldBookContainer.innerHTML = worldBooks.map(worldBook => `
        <div class="character-item">
            <div class="character-header ${worldBook.id === currentWorldBookId && currentMode === 'worldbook' ? 'active' : ''}" 
                 onclick="toggleWorldBookVersions('${worldBook.id}')">
                <span class="expand-icon">â–¼</span>
                <div class="character-info">
                    <span>${worldBook.name}</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">${worldBook.versions.length}</span>
                </div>
            </div>
            <div class="version-list" id="worldbook-versions-${worldBook.id}">
                ${worldBook.versions.map(version => {
    const entryCount = version.entries.length;
    const allText = version.entries.map(entry => entry.content).filter(Boolean).join(' ');
    const chars = allText.length;
    const tokens = countTokens(allText);
    
    return `
        <div class="version-item ${version.id === currentWorldBookVersionId && currentMode === 'worldbook' ? 'active' : ''}" 
             onclick="selectSidebarItem('worldbook', '${worldBook.id}', '${version.id}')">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <span>${version.name}</span>
                <span style="font-size: 0.75em; font-style: italic; color: var(--text-muted); opacity: 0.8;">
                    ${entryCount}æ¢ç›® / ${chars}å­— / ${tokens}tokens
                </span>
            </div>
        </div>
    `;
}).join('')}
            </div>
        </div>
    `).join('');
    
    // å±•é–‹ç•¶å‰é¸ä¸­ä¸–ç•Œæ›¸çš„ç‰ˆæœ¬åˆ—è¡¨
    if (currentMode === 'worldbook' && currentWorldBookId) {
        const currentVersionsList = document.getElementById(`worldbook-versions-${currentWorldBookId}`);
        if (currentVersionsList) {
            currentVersionsList.classList.add('expanded');
        }
    }
}

// æ›´æ–°ä¸–ç•Œæ›¸æ¨™é¡Œå’ŒæŒ‰éˆ•æ–‡å­—
const worldBookButtons = document.querySelectorAll('#worldbook-content .sidebar-add-btn');
if (worldBookButtons[0]) worldBookButtons[0].textContent = t('addWorldBook');
if (worldBookButtons[1]) worldBookButtons[1].textContent = t('importWorldBook');

// æ›´æ–°è‡ªå®šç¾©æ¬„ä½æ¨™é¡Œ
const customFieldTitle = document.querySelectorAll('.sidebar-section-title')[2]; // ç¬¬ä¸‰å€‹å€å¡Š
if (customFieldTitle) {
    customFieldTitle.textContent = t('customFields');
}
const addCustomBtn = document.querySelector('button[onclick="addCustomSection()"]');
if (addCustomBtn) {
    addCustomBtn.textContent = t('addCustomField');
}
}

function toggleCustomSectionVersions(sectionId) {
    const versionsList = document.getElementById(`custom-versions-${sectionId}`);
    const isExpanded = versionsList.classList.contains('expanded');

    // å…ˆé¸ä¸­å€å¡Š
    currentMode = 'custom';
    currentCustomSectionId = sectionId;
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        currentCustomVersionId = section.versions[0].id;
    }
    viewMode = 'single';
    compareVersions = [];

    // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
    renderAll();
    
    // æ¸²æŸ“å®Œæˆå¾Œå†è™•ç†å±•é–‹/æ”¶åˆç‹€æ…‹
    setTimeout(() => {
        const newVersionsList = document.getElementById(`custom-versions-${sectionId}`);
        const expandIcon = document.querySelector(`[onclick="toggleCustomSectionVersions('${sectionId}')"] .expand-icon`);
        
        if (isExpanded) {
            newVersionsList.classList.remove('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        } else {
            newVersionsList.classList.add('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }, 10);
}

function copyVersion(characterId, versionId) {
    const character = characters.find(c => c.id === characterId);
    if (character) {
        const originalVersion = character.versions.find(v => v.id === versionId);
        if (originalVersion) {
            const newVersion = {
                id: generateId(),
                name: originalVersion.name + ' - Copy',
                avatar: originalVersion.avatar,
                description: originalVersion.description,
                personality: originalVersion.personality,
                scenario: originalVersion.scenario,
                dialogue: originalVersion.dialogue,
                firstMessage: originalVersion.firstMessage,
                creator: originalVersion.creator,
                charVersion: originalVersion.charVersion,
                creatorNotes: originalVersion.creatorNotes,
                tags: originalVersion.tags
            };
            character.versions.push(newVersion);
            currentVersionId = newVersion.id;
            renderAll();
            markAsChanged(); // æ¨™è¨˜æœ‰è®Šæ›´
        }
    }
}

function copyCharacter(characterId) {
    const originalCharacter = characters.find(c => c.id === characterId);
    if (originalCharacter) {
        const newCharacter = {
            id: generateId(),
            name: originalCharacter.name + ' - Copy',
            versions: originalCharacter.versions.map(version => ({
                id: generateId(),
                name: version.name,
                avatar: version.avatar,
                description: version.description,
                personality: version.personality,
                scenario: version.scenario,
                dialogue: version.dialogue,
                firstMessage: version.firstMessage,
                creator: version.creator,
                charVersion: version.charVersion,
                creatorNotes: version.creatorNotes,
                tags: version.tags
            }))
        };
        characters.push(newCharacter);
        currentCharacterId = newCharacter.id;
        currentVersionId = newCharacter.versions[0].id;
        renderAll();
        markAsChanged(); // æ¨™è¨˜æœ‰è®Šæ›´
    }
}


       function toggleCharacterVersions(characterId) {
    const versionsList = document.getElementById(`versions-${characterId}`);
    const isExpanded = versionsList.classList.contains('expanded');

    // å…ˆé¸ä¸­è§’è‰²
    currentMode = 'character';
    currentCharacterId = characterId;
    const character = characters.find(c => c.id === characterId);
    if (character) {
        currentVersionId = character.versions[0].id;
    }
    viewMode = 'single';
    compareVersions = [];

    // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
    renderAll();
    
    // æ¸²æŸ“å®Œæˆå¾Œå†è™•ç†å±•é–‹/æ”¶åˆç‹€æ…‹
    setTimeout(() => {
        const newVersionsList = document.getElementById(`versions-${characterId}`);
        const expandIcon = document.querySelector(`[onclick="toggleCharacterVersions('${characterId}')"] .expand-icon`);
        
        if (isExpanded) {
            // å¦‚æœä¹‹å‰æ˜¯å±•é–‹çš„ï¼Œç¾åœ¨æ”¶åˆ
            newVersionsList.classList.remove('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        } else {
            // å¦‚æœä¹‹å‰æ˜¯æ”¶åˆçš„ï¼Œç¾åœ¨å±•é–‹
            newVersionsList.classList.add('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }, 10);
}

        function renderContent() {
    const container = document.getElementById('contentArea');
    
    // æ ¹æ“šç•¶å‰æ¨¡å¼æ¸²æŸ“ä¸åŒå…§å®¹
    if (currentMode === 'custom') {
        renderCustomContent();
        return;
    }
    
    if (currentMode === 'worldbook') {
        renderWorldBookContent();
        return;
    }
    
    const currentCharacter = characters.find(c => c.id === currentCharacterId);
    
    if (!currentCharacter) {
        container.innerHTML = `<div style="text-align: center; padding: 80px; color: var(--text-muted);">${t('selectCharacter') || 'è«‹é¸æ“‡ä¸€å€‹è§’è‰²'}</div>`;
        return;
    }

    const versionsToShow = viewMode === 'compare' ? 
        currentCharacter.versions.filter(v => compareVersions.includes(v.id)) : 
        currentCharacter.versions.filter(v => v.id === currentVersionId);

    container.innerHTML = `
        <!-- è§’è‰²åç¨±å’Œæ§åˆ¶å€ -->
        <div class="character-header-bar">
            <div class="character-title-section">
                <input type="text" class="character-main-title-fixed" value="${currentCharacter.name}" 
                       onchange="updateCharacterName('${currentCharacter.id}', this.value)" 
                       placeholder="${t('characterName')}">
            </div>
           <div class="character-controls">
    <button class="btn ${viewMode === 'single' ? 'btn-primary' : 'btn-secondary'}" onclick="viewMode='single'; compareVersions=[]; renderAll()">${t('singleView')}</button>
    <button class="btn ${viewMode === 'compare' ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCompareMode()">
        ${viewMode === 'compare' ? `${t('compareView')} (${compareVersions.length})` : t('compareView')}
    </button>
    <button class="btn btn-secondary" onclick="addVersion('${currentCharacter.id}')">${t('addVersion')}</button>
    <button class="btn btn-secondary" onclick="copyCharacter('${currentCharacter.id}')">${t('copyCharacter')}</button>
        <button class="btn btn-secondary" onclick="removeCharacter('${currentCharacter.id}')">${t('deleteCharacter')}</button>
    <button class="btn btn-secondary" onclick="saveData(); showSaveNotification()">${t('save')}</button>
</div>
        </div>

        <div class="versions-container ${viewMode}-view">
            ${versionsToShow.map(version => renderVersionPanel(currentCharacter, version)).join('')}
        </div>

        <div class="export-section">
            <h3>${t('exportCharacter') || 'åŒ¯å‡ºè§’è‰²å¡'}</h3>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportJSON('${currentCharacter.id}')">${t('exportJSON')}</button>
                <button class="btn btn-secondary" onclick="exportPNG('${currentCharacter.id}')">${t('exportPNG')}</button>
                <button class="btn btn-secondary" onclick="exportAllVersions('${currentCharacter.id}')">${t('exportAll')}</button>
            </div>
        </div>
    `;

    setTimeout(() => {
        updateStats();
        initAutoResize();
    }, 100);
}


function renderCustomContent() {
    const container = document.getElementById('contentArea');
    const currentSection = customSections.find(s => s.id === currentCustomSectionId);
    
    if (!currentSection) {
        container.innerHTML = `<div style="text-align: center; padding: 80px; color: var(--text-muted);">è«‹é¸æ“‡ä¸€å€‹è‡ªå®šç¾©å€å¡Š</div>`;
        return;
    }

    const versionsToShow = viewMode === 'compare' ? 
        currentSection.versions.filter(v => compareVersions.includes(v.id)) : 
        currentSection.versions.filter(v => v.id === currentCustomVersionId);

    container.innerHTML = `
        <!-- å€å¡Šåç¨±å’Œæ§åˆ¶å€ -->
        <div class="character-header-bar">
            <div class="character-title-section">
                <input type="text" class="character-main-title-fixed" value="${currentSection.name}" 
                       onchange="updateCustomSectionName('${currentSection.id}', this.value)" 
                       placeholder="${t('sectionName')}">
            </div>
            <div class="character-controls">
                <button class="btn ${viewMode === 'single' ? 'btn-primary' : 'btn-secondary'}" onclick="viewMode='single'; compareVersions=[]; renderAll()">${t('singleView')}</button>
                <button class="btn ${viewMode === 'compare' ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCompareMode()">
                    ${viewMode === 'compare' ? `${t('compareView')} (${compareVersions.length})` : t('compareView')}
                </button>
                <button class="btn btn-secondary" onclick="addCustomVersion('${currentSection.id}')">${t('addVersion')}</button>
                <button class="btn btn-secondary" onclick="copyCustomSection('${currentSection.id}')">${t('copySection')}</button>
                <button class="btn btn-secondary" onclick="removeCustomSection('${currentSection.id}')">${t('deleteSection')}</button>
                <button class="btn btn-secondary" onclick="saveData(); showSaveNotification()">${t('save')}</button>
            </div>
        </div>

        <div class="versions-container ${viewMode}-view">
            ${versionsToShow.map(version => renderCustomVersionPanel(currentSection, version)).join('')}
        </div>

        <div class="export-section">
            <h3>åŒ¯å‡ºè‡ªå®šç¾©å…§å®¹</h3>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportCustomTXT('${currentSection.id}')">${t('exportTXT')}</button>
                <button class="btn btn-secondary" onclick="exportCustomMarkdown('${currentSection.id}')">${t('exportMarkdown')}</button>
            </div>
        </div>
    `;

    setTimeout(() => {
        updateStats();
        initAutoResize();
    }, 100);
}

function renderCustomVersionPanel(section, version) {
    return `
        <div class="version-panel">
            <div class="version-header">
                <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
                    <input type="text" class="version-title" value="${version.name}" 
                           onchange="updateCustomVersionName('${section.id}', '${version.id}', this.value)"
                           style="font-size: 1.2em; font-weight: 600; margin: 0; padding: 8px 12px; border: 1px solid transparent; border-radius: 6px; background: transparent; color: var(--text-color); transition: all 0.2s ease;">
                    <div class="version-stats" id="custom-version-stats-${version.id}" style="font-size: 0.85em; color: var(--text-muted); padding-left: 12px;">
                        ${t('versionStats', 0, 0)}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-small" onclick="copyCustomVersion('${section.id}', '${version.id}')">${t('copy')}</button>
                    ${section.versions.length > 1 ? `<button class="btn btn-secondary btn-small" onclick="removeCustomVersion('${section.id}', '${version.id}')">${t('delete')}</button>` : ''}
                </div>
            </div>

            <!-- å‹•æ…‹æ¬„ä½å€åŸŸ -->
            <div id="custom-fields-${version.id}">
                ${version.fields.map(field => renderCustomField(section.id, version.id, field)).join('')}
            </div>
            
            <!-- æ–°å¢æ¬„ä½æŒ‰éˆ• -->
            <button class="btn btn-secondary" onclick="addCustomField('${section.id}', '${version.id}')" style="margin-top: 16px;">
                + ${t('addField')}
            </button>
        </div>
    `;
}

function confirmRemoveCustomField(sectionId, versionId, fieldId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            const field = version.fields.find(f => f.id === fieldId);
            if (field) {
                const confirmDelete = confirm(`ç¢ºå®šè¦åˆªé™¤æ¬„ä½ã€Œ${field.name}ã€å—ï¼Ÿ\n\nâš ï¸ åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œè«‹ç¢ºä¿å·²å‚™ä»½é‡è¦è³‡æ–™ï¼`);
                
                if (confirmDelete) {
                    removeCustomField(sectionId, versionId, fieldId);
                }
            }
        }
    }
}

function renderCustomField(sectionId, versionId, field) {
    return `
        <div class="field-group" id="field-${field.id}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
    <div style="flex: 1;">
        <input type="text" value="${field.name}" 
               onchange="updateCustomFieldName('${sectionId}', '${versionId}', '${field.id}', this.value)"
               placeholder="${t('fieldNamePlaceholder')}"
               style="background: transparent; border: 1px solid transparent; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; font-weight: 500;">
        <span class="field-stats" data-target="custom-field-${field.id}" style="margin-left: 12px; font-size: 0.85em; color: var(--text-muted);">0 ${t('chars')} / 0 ${t('tokens')}</span>
    </div>
    <button class="btn btn-secondary btn-small" onclick="confirmRemoveCustomField('${sectionId}', '${versionId}', '${field.id}')" style="margin-left: 12px;">
        ${t('deleteField')}
    </button>
</div>
            <textarea class="field-input auto-resize" id="custom-field-${field.id}" 
                      placeholder="${t('customFieldPlaceholder')}"
                      oninput="updateCustomFieldContent('${sectionId}', '${versionId}', '${field.id}', this.value); updateStats(); autoResizeTextarea(this);">${field.content}</textarea>
        </div>
    `;
}

function updateCustomSectionName(sectionId, name) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        section.name = name;
        renderSidebar();
        markAsChanged();
    }
}

function updateCustomVersionName(sectionId, versionId, name) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            version.name = name;
            renderSidebar();
            markAsChanged();
        }
    }
}

function addCustomVersion(sectionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const newVersion = {
            id: generateId(),
            name: `Version ${section.versions.length + 1}`,
            fields: [{
                id: generateId(),
                name: 'Default Field',
                content: ''
            }]
        };
        section.versions.push(newVersion);
        currentCustomVersionId = newVersion.id;
        renderAll();
        markAsChanged();
    }
}

function copyCustomVersion(sectionId, versionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const originalVersion = section.versions.find(v => v.id === versionId);
        if (originalVersion) {
            const newVersion = {
                id: generateId(),
                name: originalVersion.name + ' - Copy',
                fields: originalVersion.fields.map(field => ({
                    id: generateId(),
                    name: field.name,
                    content: field.content
                }))
            };
            section.versions.push(newVersion);
            currentCustomVersionId = newVersion.id;
            renderAll();
            markAsChanged();
        }
    }
}

function copyCustomSection(sectionId) {
    const originalSection = customSections.find(s => s.id === sectionId);
    if (originalSection) {
        const newSection = {
            id: generateId(),
            name: originalSection.name + ' - Copy',
            versions: originalSection.versions.map(version => ({
                id: generateId(),
                name: version.name,
                fields: version.fields.map(field => ({
                    id: generateId(),
                    name: field.name,
                    content: field.content
                }))
            }))
        };
        customSections.push(newSection);
        currentCustomSectionId = newSection.id;
        currentCustomVersionId = newSection.versions[0].id;
        renderAll();
        markAsChanged();
    }
}

function addCustomField(sectionId, versionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            const newField = {
                id: generateId(),
                name: `Field ${version.fields.length + 1}`,
                content: ''
            };
            version.fields.push(newField);
            renderCustomContent();
            markAsChanged();
        }
    }
}

function updateCustomFieldName(sectionId, versionId, fieldId, name) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            const field = version.fields.find(f => f.id === fieldId);
            if (field) {
                field.name = name;
                markAsChanged();
            }
        }
    }
}

function updateCustomFieldContent(sectionId, versionId, fieldId, content) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version) {
            const field = version.fields.find(f => f.id === fieldId);
            if (field) {
                field.content = content;
                updateStats();
                markAsChanged();
            }
        }
    }
}

function removeCustomField(sectionId, versionId, fieldId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section) {
        const version = section.versions.find(v => v.id === versionId);
        if (version && version.fields.length > 1) {
            version.fields = version.fields.filter(f => f.id !== fieldId);
            renderCustomContent();
            markAsChanged();
        } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ¬„ä½');
        }
    }
}

function removeCustomVersion(sectionId, versionId) {
    const section = customSections.find(s => s.id === sectionId);
    if (section && section.versions.length > 1) {
        const version = section.versions.find(v => v.id === versionId);
        const confirmDelete = confirm(t('deleteVersionConfirm', version?.name || 'æœªå‘½åç‰ˆæœ¬'));
        
        if (confirmDelete) {
            section.versions = section.versions.filter(v => v.id !== versionId);
            if (currentCustomVersionId === versionId) {
                currentCustomVersionId = section.versions[0].id;
            }
            renderAll();
            saveData();
        }
    } else {
        alert(t('keepOneVersion'));
    }
}

function removeCustomSection(sectionId) {
    const section = customSections.find(s => s.id === sectionId);
    const confirmDelete = confirm(`ç¢ºå®šè¦åˆªé™¤å€å¡Šã€Œ${section?.name || 'æœªå‘½åå€å¡Š'}ã€å—ï¼Ÿ\n\nâš ï¸ åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œè«‹ç¢ºä¿å·²å‚™ä»½é‡è¦è³‡æ–™ï¼`);
    
    if (confirmDelete) {
        customSections = customSections.filter(s => s.id !== sectionId);
        if (currentCustomSectionId === sectionId) {
            if (customSections.length > 0) {
                currentCustomSectionId = customSections[0].id;
                currentCustomVersionId = customSections[0].versions[0].id;
            } else {
                // å¦‚æœåˆªå…‰äº†å°±åˆ‡å›è§’è‰²æ¨¡å¼
                currentMode = 'character';
                currentCustomSectionId = null;
                currentCustomVersionId = null;
            }
        }
        renderAll();
        saveData();
    }
}

// ä¸–ç•Œæ›¸ç›¸é—œå‡½æ•¸ - åœ¨ç¾æœ‰ JavaScript ä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•¸

// æ–°å¢ä¸–ç•Œæ›¸
function addWorldBook() {
    const worldBook = {
        id: generateId(),
        name: `Lorebook ${worldBooks.length + 1}`,
        description: '',
        versions: [{
            id: generateId(),
            name: 'Version 1',
            entries: []
        }]
    };
    worldBooks.push(worldBook);
    currentMode = 'worldbook';
    currentWorldBookId = worldBook.id;
    currentWorldBookVersionId = worldBook.versions[0].id;
    renderAll();
    markAsChanged();
}

// é¸ä¸­ä¸–ç•Œæ›¸
function selectWorldBook(worldBookId) {
    currentMode = 'worldbook';
    currentWorldBookId = worldBookId;
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        currentWorldBookVersionId = worldBook.versions[0].id;
    }
    viewMode = 'single';
    compareVersions = [];
    renderAll();
}

// é¸ä¸­ä¸–ç•Œæ›¸ç‰ˆæœ¬
function selectWorldBookVersion(worldBookId, versionId) {
    currentMode = 'worldbook';
    currentWorldBookId = worldBookId;
    currentWorldBookVersionId = versionId;
    viewMode = 'single';
    renderAll();
}

// åˆ‡æ›ä¸–ç•Œæ›¸ç‰ˆæœ¬åˆ—è¡¨
function toggleWorldBookVersions(worldBookId) {
    const versionsList = document.getElementById(`worldbook-versions-${worldBookId}`);
    const isExpanded = versionsList.classList.contains('expanded');

    // å…ˆé¸ä¸­ä¸–ç•Œæ›¸
    currentMode = 'worldbook';
    currentWorldBookId = worldBookId;
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        currentWorldBookVersionId = worldBook.versions[0].id;
    }
    viewMode = 'single';
    compareVersions = [];

    // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
    renderAll();
    
    // æ¸²æŸ“å®Œæˆå¾Œå†è™•ç†å±•é–‹/æ”¶åˆç‹€æ…‹
    setTimeout(() => {
        const newVersionsList = document.getElementById(`worldbook-versions-${worldBookId}`);
        const expandIcon = document.querySelector(`[onclick="toggleWorldBookVersions('${worldBookId}')"] .expand-icon`);
        
        if (isExpanded) {
            newVersionsList.classList.remove('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        } else {
            newVersionsList.classList.add('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }
    }, 10);
}

// æ–°å¢ä¸–ç•Œæ›¸ç‰ˆæœ¬
function addWorldBookVersion(worldBookId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const newVersion = {
            id: generateId(),
            name: `Version ${worldBook.versions.length + 1}`,
            entries: []
        };
        worldBook.versions.push(newVersion);
        currentWorldBookVersionId = newVersion.id;
        renderAll();
        markAsChanged();
    }
}

// è¤‡è£½ä¸–ç•Œæ›¸ç‰ˆæœ¬
function copyWorldBookVersion(worldBookId, versionId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const originalVersion = worldBook.versions.find(v => v.id === versionId);
        if (originalVersion) {
            const newVersion = {
                id: generateId(),
                name: originalVersion.name + ' - Copy',
                entries: originalVersion.entries.map(entry => ({
                    id: generateId(),
                    key: [...entry.key],
                    keysecondary: [...entry.keysecondary],
                    content: entry.content,
                    comment: entry.comment,
                    constant: entry.constant,
                    vectorized: entry.vectorized || false,
                    selective: entry.selective,
                    useProbability: entry.useProbability,
                    disable: entry.disable,
                    insertion_order: entry.insertion_order,
                    depth: entry.depth,
                    probability: entry.probability,
                    position: entry.position,
                    role: entry.role
                }))
            };
            worldBook.versions.push(newVersion);
            currentWorldBookVersionId = newVersion.id;
            renderAll();
            markAsChanged();
        }
    }
}

// è¤‡è£½ä¸–ç•Œæ›¸
function copyWorldBook(worldBookId) {
    const originalWorldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (originalWorldBook) {
        const newWorldBook = {
            id: generateId(),
            name: originalWorldBook.name + ' - Copy',
            description: originalWorldBook.description,
            versions: originalWorldBook.versions.map(version => ({
                id: generateId(),
                name: version.name,
                entries: version.entries.map(entry => ({
                    id: generateId(),
                    key: [...entry.key],
                    keysecondary: [...entry.keysecondary],
                    content: entry.content,
                    comment: entry.comment,
                    constant: entry.constant,
                    vectorized: entry.vectorized || false,
                    selective: entry.selective,
                    useProbability: entry.useProbability,
                    disable: entry.disable,
                    insertion_order: entry.insertion_order,
                    depth: entry.depth,
                    probability: entry.probability,
                    position: entry.position,
                    role: entry.role
                }))
            }))
        };
        worldBooks.push(newWorldBook);
        currentWorldBookId = newWorldBook.id;
        currentWorldBookVersionId = newWorldBook.versions[0].id;
        renderAll();
        markAsChanged();
    }
}

// åˆªé™¤ä¸–ç•Œæ›¸ç‰ˆæœ¬
function removeWorldBookVersion(worldBookId, versionId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook && worldBook.versions.length > 1) {
        const version = worldBook.versions.find(v => v.id === versionId);
        const confirmDelete = confirm(t('deleteVersionConfirm', version?.name || 'æœªå‘½åç‰ˆæœ¬'));
        
        if (confirmDelete) {
            worldBook.versions = worldBook.versions.filter(v => v.id !== versionId);
            if (currentWorldBookVersionId === versionId) {
                currentWorldBookVersionId = worldBook.versions[0].id;
            }
            renderAll();
            saveData();
        }
    } else {
        alert(t('keepOneVersion'));
    }
}

// åˆªé™¤ä¸–ç•Œæ›¸
function removeWorldBook(worldBookId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    const confirmDelete = confirm(t('deleteWorldBook') + ` "${worldBook?.name || 'æœªå‘½åä¸–ç•Œæ›¸'}"ï¼Ÿ\n\nâš ï¸ åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œè«‹ç¢ºä¿å·²å‚™ä»½é‡è¦è³‡æ–™ï¼`);
    
    if (confirmDelete) {
        worldBooks = worldBooks.filter(wb => wb.id !== worldBookId);
        if (currentWorldBookId === worldBookId) {
            if (worldBooks.length > 0) {
                currentWorldBookId = worldBooks[0].id;
                currentWorldBookVersionId = worldBooks[0].versions[0].id;
            } else {
                currentMode = 'character';
                currentWorldBookId = null;
                currentWorldBookVersionId = null;
            }
        }
        renderAll();
        saveData();
    }
}

// æ›´æ–°ä¸–ç•Œæ›¸åç¨±
function updateWorldBookName(worldBookId, name) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        worldBook.name = name;
        renderSidebar();
        markAsChanged();
    }
}

// æ›´æ–°ä¸–ç•Œæ›¸ç‰ˆæœ¬åç¨±
function updateWorldBookVersionName(worldBookId, versionId, name) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            version.name = name;
            renderSidebar();
            markAsChanged();
        }
    }
}

// æ–°å¢æ¢ç›®
function addWorldBookEntry(worldBookId, versionId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const newEntry = {
    id: generateId(),
    uid: version.entries.length,
    displayIndex: version.entries.length,
    key: [],
    keysecondary: [],
    content: '',
    comment: '',
    constant: false,
    vectorized: false,
    selective: true,
    selectiveLogic: 0,
    addMemo: true,
    useProbability: false,
    disable: false,
    order: 100,  // åœ¨åŒ¯å‡ºæ™‚æœƒè½‰ç‚º insertion_order
    position: 0,
    excludeRecursion: false,
    preventRecursion: false,
    delayUntilRecursion: false,
    probability: 100,
    depth: 4,
    group: '',
    groupOverride: false,
    groupWeight: 100,
    scanDepth: null,
    caseSensitive: null,
    matchWholeWords: null,
    useGroupScoring: null,
    automationId: '',
    role: 0,
    sticky: 0,
    cooldown: 0,
    delay: 0,
    // åŒ¹é…é¸é …
    matchPersonaDescription: false,
    matchCharacterDescription: false,
    matchCharacterPersonality: false,
    matchCharacterDepthPrompt: false,
    matchScenario: false,
    matchCreatorNotes: false
};
            version.entries.push(newEntry);
            renderWorldBookContent();
            markAsChanged();
        }
    }
}

// åˆªé™¤æ¢ç›®
function removeWorldBookEntry(worldBookId, versionId, entryId) {
    const confirmDelete = confirm(t('deleteEntry') + 'ï¼Ÿ\n\nâš ï¸ åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼');
    
    if (confirmDelete) {
        const worldBook = worldBooks.find(wb => wb.id === worldBookId);
        if (worldBook) {
            const version = worldBook.versions.find(v => v.id === versionId);
            if (version) {
                version.entries = version.entries.filter(e => e.id !== entryId);
                renderWorldBookContent();
                markAsChanged();
            }
        }
    }
}

// æ›´æ–°æ¢ç›®æ¬„ä½
function updateWorldBookEntry(worldBookId, versionId, entryId, field, value) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                if (field === 'key' || field === 'keysecondary') {
                    // è™•ç†é—œéµå­—é™£åˆ—
                    entry[field] = value.split(',').map(k => k.trim()).filter(k => k);
                } else {
                    entry[field] = value;
                }
                markAsChanged();
            }
        }
    }
}

// æ–°å¢ï¼šæ›´æ–°æ¢ç›®æ¨¡å¼
function updateEntryMode(worldBookId, versionId, entryId, mode) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                // é‡ç½®æ‰€æœ‰æ¨¡å¼
                entry.constant = false;
                entry.vectorized = false;
                entry.selective = true;
                
                // è¨­å®šé¸ä¸­çš„æ¨¡å¼
                switch (mode) {
                    case 'constant':
                        entry.constant = true;
                        break;
                    case 'vectorized':
                        entry.vectorized = true;
                        break;
                    case 'selective':
                    default:
                        entry.selective = true;
                        break;
                }
                markAsChanged();
            }
        }
    }
}

// æ–°å¢ï¼šåˆ‡æ›æ¢ç›®å•Ÿç”¨ç‹€æ…‹
function toggleEntryEnabled(worldBookId, versionId, entryId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                entry.disable = !entry.disable;
                // ä¸é‡æ–°æ¸²æŸ“ï¼Œåªæ›´æ–°ç‹€æ…‹åœ–ç¤º
                updateEntryStatusIcon(entryId, entry);
                markAsChanged();
            }
        }
    }
}

        function updateEntryStatusIcon(entryId, entry) {
    // æ‰¾åˆ°å°æ‡‰æ¢ç›®çš„ç‹€æ…‹åœ–ç¤ºå…ƒç´ 
    const entryPanel = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (entryPanel) {
        const statusIcon = entryPanel.querySelector('.entry-status-icon');
        if (statusIcon) {
            // æ›´æ–°åœ–ç¤º
            let icon = '';
            if (entry.constant) {
                icon = 'ğŸ”µ'; // è—ç‡ˆï¼šå¸¸é§æ¨¡å¼
            } else if (entry.vectorized) {
                icon = 'ğŸ”—'; // éˆæ¥ï¼šå‘é‡åŒ–æ¨¡å¼
            } else {
                icon = 'ğŸŸ¢'; // ç¶ ç‡ˆï¼šé¸æ“‡æ¨¡å¼
            }
            statusIcon.textContent = icon;
        }
    }
}


// åŒ¯å…¥ä¸–ç•Œæ›¸
function importWorldBook() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(event) {
        handleWorldBookImport(event);
    };
    input.click();
}

// è™•ç†ä¸–ç•Œæ›¸åŒ¯å…¥
function handleWorldBookImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // æª¢æŸ¥æ˜¯å¦ç‚º SillyTavern ä¸–ç•Œæ›¸æ ¼å¼
            if (data.entries && typeof data.entries === 'object') {
                importSillyTavernWorldBook(data, file.name);
            } else {
                alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„ä¸–ç•Œæ›¸æª”æ¡ˆ');
            }
        } catch (error) {
            alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// åŒ¯å…¥ SillyTavern æ ¼å¼ä¸–ç•Œæ›¸
function importSillyTavernWorldBook(data, filename) {
    const worldBook = {
        id: generateId(),
        name: data.name || filename.replace('.json', '') || 'Imported Lorebook',
        description: data.description || '',
        versions: [{
            id: generateId(),
            name: 'Imported Version',
            entries: []
        }]
    };

    // è½‰æ›æ¢ç›®æ ¼å¼
    const entries = Object.values(data.entries);
    worldBook.versions[0].entries = entries.map((entry, index) => ({
        id: generateId(),
        uid: entry.uid || index,
        displayIndex: entry.displayIndex || index,
        key: Array.isArray(entry.key) ? entry.key : [],
        keysecondary: Array.isArray(entry.keysecondary) ? entry.keysecondary : [],
        content: entry.content || '',
        comment: entry.comment || '',
        constant: entry.constant || false,
        vectorized: entry.vectorized || false,
        selective: entry.selective !== false, // é è¨­ç‚º true
        selectiveLogic: entry.selectiveLogic || 0,
        addMemo: entry.addMemo !== false,
        useProbability: entry.useProbability || false,
        disable: entry.disable || false,
        insertion_order: entry.order || entry.insertion_order || 100,
        depth: entry.depth || 4,
        probability: entry.probability || 100,
        position: entry.position || 0,
        role: entry.role || 0,
        excludeRecursion: entry.excludeRecursion || false,
        preventRecursion: entry.preventRecursion || false,
        matchPersonaDescription: entry.matchPersonaDescription || false,
        matchCharacterDescription: entry.matchCharacterDescription || false,
        matchCharacterPersonality: entry.matchCharacterPersonality || false,
        matchCharacterDepthPrompt: entry.matchCharacterDepthPrompt || false,
        matchScenario: entry.matchScenario || false,
        matchCreatorNotes: entry.matchCreatorNotes || false,
        delayUntilRecursion: entry.delayUntilRecursion || false,
        group: entry.group || '',
        groupOverride: entry.groupOverride || false,
        groupWeight: entry.groupWeight || 100,
        scanDepth: entry.scanDepth || null,
        caseSensitive: entry.caseSensitive || null,
        matchWholeWords: entry.matchWholeWords || null,
        useGroupScoring: entry.useGroupScoring || null,
        automationId: entry.automationId || '',
        sticky: entry.sticky || 0,
        cooldown: entry.cooldown || 0,
        delay: entry.delay || 0
    }));

    worldBooks.push(worldBook);
    currentMode = 'worldbook';
    currentWorldBookId = worldBook.id;
    currentWorldBookVersionId = worldBook.versions[0].id;
    viewMode = 'single';
    compareVersions = [];
    renderAll();
    markAsChanged();
    alert(`ä¸–ç•Œæ›¸ã€Œ${worldBook.name}ã€åŒ¯å…¥æˆåŠŸï¼åŒ…å« ${entries.length} å€‹æ¢ç›®ã€‚`);
}

// åŒ¯å‡ºä¸–ç•Œæ›¸
function exportWorldBook(worldBookId) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (!worldBook) return;

    if (worldBook.versions.length === 1) {
        downloadWorldBook(worldBook, worldBook.versions[0]);
    } else {
        const versionIndex = prompt(t('selectVersion', worldBook.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < worldBook.versions.length) {
            downloadWorldBook(worldBook, worldBook.versions[index]);
        }
    }
}

// ä¸‹è¼‰ä¸–ç•Œæ›¸
function downloadWorldBook(worldBook, version) {
    const exportData = {
        name: worldBook.name,
        description: worldBook.description || '',
        entries: {}
    };

    // è½‰æ›ç‚º SillyTavern æ ¼å¼
    version.entries.forEach((entry, index) => {
        exportData.entries[index.toString()] = {
            uid: index,
            key: entry.key,
            keysecondary: entry.keysecondary,
            comment: entry.comment,
            content: entry.content,
            constant: entry.constant,
            vectorized: entry.vectorized || false,
            selective: entry.selective,
            selectiveLogic: entry.selectiveLogic || 0,
            addMemo: entry.addMemo !== false,
            order: entry.insertion_order || 100,
            position: entry.position || 0,
            disable: entry.disable || false,
            excludeRecursion: entry.excludeRecursion || false,
            preventRecursion: entry.preventRecursion || false,
            matchPersonaDescription: entry.matchPersonaDescription || false,
            matchCharacterDescription: entry.matchCharacterDescription || false,
            matchCharacterPersonality: entry.matchCharacterPersonality || false,
            matchCharacterDepthPrompt: entry.matchCharacterDepthPrompt || false,
            matchScenario: entry.matchScenario || false,
            matchCreatorNotes: entry.matchCreatorNotes || false,
            delayUntilRecursion: entry.delayUntilRecursion || false,
            probability: entry.probability || 100,
            useProbability: entry.useProbability || false,
            depth: entry.depth || 4,
            group: entry.group || '',
            groupOverride: entry.groupOverride || false,
            groupWeight: entry.groupWeight || 100,
            scanDepth: entry.scanDepth || null,
            caseSensitive: entry.caseSensitive || null,
            matchWholeWords: entry.matchWholeWords || null,
            useGroupScoring: entry.useGroupScoring || null,
            automationId: entry.automationId || '',
            role: entry.role || 0,
            sticky: entry.sticky || 0,
            cooldown: entry.cooldown || 0,
            delay: entry.delay || 0,
            displayIndex: index
        };
    });

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${worldBook.name}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// æ¸²æŸ“ä¸–ç•Œæ›¸å…§å®¹
function renderWorldBookContent() {
    const container = document.getElementById('contentArea');
    const currentWorldBook = worldBooks.find(wb => wb.id === currentWorldBookId);
    
    if (!currentWorldBook) {
        container.innerHTML = `<div style="text-align: center; padding: 80px; color: var(--text-muted);">è«‹é¸æ“‡ä¸€å€‹ä¸–ç•Œæ›¸</div>`;
        return;
    }

    const versionsToShow = viewMode === 'compare' ? 
        currentWorldBook.versions.filter(v => compareVersions.includes(v.id)) : 
        currentWorldBook.versions.filter(v => v.id === currentWorldBookVersionId);

    container.innerHTML = `
        <!-- ä¸–ç•Œæ›¸åç¨±å’Œæ§åˆ¶å€ -->
        <div class="character-header-bar">
            <div class="character-title-section">
                <input type="text" class="character-main-title-fixed" value="${currentWorldBook.name}" 
                       onchange="updateWorldBookName('${currentWorldBook.id}', this.value)" 
                       placeholder="${t('worldBookName')}">
            </div>
            <div class="character-controls">
                <button class="btn ${viewMode === 'single' ? 'btn-primary' : 'btn-secondary'}" onclick="viewMode='single'; compareVersions=[]; renderAll()">${t('singleView')}</button>
                <button class="btn ${viewMode === 'compare' ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCompareMode()">
                    ${viewMode === 'compare' ? `${t('compareView')} (${compareVersions.length})` : t('compareView')}
                </button>
                <button class="btn btn-secondary" onclick="addWorldBookVersion('${currentWorldBook.id}')">${t('addVersion')}</button>
                <button class="btn btn-secondary" onclick="copyWorldBook('${currentWorldBook.id}')">${t('copyWorldBook')}</button>
                <button class="btn btn-secondary" onclick="removeWorldBook('${currentWorldBook.id}')">${t('deleteWorldBook')}</button>
                <button class="btn btn-secondary" onclick="saveData(); showSaveNotification()">${t('save')}</button>
            </div>
        </div>

        <div class="versions-container ${viewMode}-view">
            ${versionsToShow.map(version => renderWorldBookVersionPanel(currentWorldBook, version)).join('')}
        </div>

        <div class="export-section">
            <h3>${t('exportWorldBook')}</h3>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportWorldBook('${currentWorldBook.id}')">${t('exportWorldBook')}</button>
            </div>
        </div>
    `;

    setTimeout(() => {
        updateStats();
        initAutoResize();
    }, 100);
}

// æ¸²æŸ“ä¸–ç•Œæ›¸ç‰ˆæœ¬é¢æ¿
function renderWorldBookVersionPanel(worldBook, version) {
    return `
        <div class="version-panel">
            <div class="version-header">
                <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
                    <input type="text" class="version-title" value="${version.name}" 
                           onchange="updateWorldBookVersionName('${worldBook.id}', '${version.id}', this.value)"
                           style="font-size: 1.2em; font-weight: 600; margin: 0; padding: 8px 12px; border: 1px solid transparent; border-radius: 6px; background: transparent; color: var(--text-color); transition: all 0.2s ease;">
                    <div class="version-stats" id="worldbook-version-stats-${version.id}" style="font-size: 0.85em; color: var(--text-muted); padding-left: 12px;">
    ${(() => {
        const entryCount = version.entries.length;
        const allText = version.entries.map(entry => entry.content).filter(Boolean).join(' ');
        const chars = allText.length;
        const tokens = countTokens(allText);
        return `${entryCount} ${currentLang === 'zh' ? 'å€‹æ¢ç›®' : 'entries'} - ${chars} ${t('chars')} / ${tokens} ${t('tokens')}`;
    })()}
</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-small" onclick="copyWorldBookVersion('${worldBook.id}', '${version.id}')">${t('copy')}</button>
                    ${worldBook.versions.length > 1 ? `<button class="btn btn-secondary btn-small" onclick="removeWorldBookVersion('${worldBook.id}', '${version.id}')">${t('delete')}</button>` : ''}
                </div>
            </div>

            <!-- æ¢ç›®åˆ—è¡¨ -->
            <div class="entries-container">
                <h4 style="margin-bottom: 16px; color: var(--text-color); display: flex; justify-content: space-between; align-items: center;">
                    ${t('entryName')} (${version.entries.length})
                    <button class="btn btn-secondary btn-small" onclick="addWorldBookEntry('${worldBook.id}', '${version.id}')">${t('addEntry')}</button>
                </h4>
                
                ${version.entries.map(entry => renderWorldBookEntry(worldBook.id, version.id, entry)).join('')}
            </div>
        </div>
    `;
}

// æ¸²æŸ“ä¸–ç•Œæ›¸æ¢ç›®
function renderWorldBookEntry(worldBookId, versionId, entry) {
    // åˆ¤æ–·ç‹€æ…‹æŒ‡ç¤ºç‡ˆ
    let statusIcon = '';
    if (entry.constant) {
        statusIcon = 'ğŸ”µ'; // è—ç‡ˆï¼šå¸¸é§æ¨¡å¼
    } else if (entry.vectorized) {
        statusIcon = 'ğŸ”—'; // éˆæ¥ï¼šå‘é‡åŒ–æ¨¡å¼
    } else {
        statusIcon = 'ğŸŸ¢'; // ç¶ ç‡ˆï¼šé¸æ“‡æ¨¡å¼
    }

    return `
        <div class="entry-panel" data-entry-id="${entry.id}" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 16px; background: var(--bg-color);">
            <!-- æ¢ç›®æ¨™é¡Œå€ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h5 style="color: var(--text-color); margin: 0; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2em;">${statusIcon}</span>
                    æ¢ç›® ${entry.uid || 0}
                    <label style="display: inline-flex; align-items: center; margin-left: 12px; cursor: pointer;">
                        <input type="checkbox" ${!entry.disable ? 'checked' : ''} 
                               onchange="toggleEntryEnabled('${worldBookId}', '${versionId}', '${entry.id}')"
                               style="margin-right: 6px;">
                        <span style="font-size: 0.9em; color: var(--text-muted);">å•Ÿç”¨æ¢ç›®</span>
                    </label>
                </h5>
                <button class="btn btn-secondary btn-small" onclick="removeWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}')">åˆªé™¤æ¢ç›®</button>
            </div>

            <!-- åŸºæœ¬è¨­å®š -->
            <div class="entry-section" style="margin-bottom: 20px;">
                <h6 style="color: var(--text-color); margin-bottom: 12px; font-size: 0.9em; text-transform: uppercase;">åŸºæœ¬è¨­å®š</h6>
                
                <!-- ç¬¬ä¸€è¡Œï¼šå‚™è¨»ã€è§¸ç™¼æ¨¡å¼ã€ä½ç½®ã€æ·±åº¦ -->
                <div style="display: grid; grid-template-columns: 2fr 120px 160px 100px; gap: 12px; margin-bottom: 12px;">
                    <div class="field-group" style="margin-bottom: 0;">
                        <label class="field-label">å‚™è¨»</label>
                        <input type="text" class="field-input" 
                               placeholder="æ¢ç›®æ¨™é¡Œ..."
                               value="${entry.comment || ''}"
                               onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'comment', this.value)">
                    </div>
                    <div class="field-group" style="margin-bottom: 0;">
                        <label class="field-label">è§¸ç™¼æ¨¡å¼</label>
                        <select class="field-input" onchange="updateEntryModeFromSelect('${worldBookId}', '${versionId}', '${entry.id}', this.value)">
                            <option value="selective" ${entry.selective && !entry.constant && !entry.vectorized ? 'selected' : ''}>ğŸŸ¢</option>
                            <option value="constant" ${entry.constant ? 'selected' : ''}>ğŸ”µ</option>
                            <option value="vectorized" ${entry.vectorized ? 'selected' : ''}>ğŸ”—</option>
                        </select>
                    </div>
                    <div class="field-group" style="margin-bottom: 0;">
                        <label class="field-label">ä½ç½®</label>
                        <select class="field-input" onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'position', parseInt(this.value))">
                            <option value="0" ${entry.position === 0 ? 'selected' : ''}>Before Char Defs</option>
                            <option value="1" ${entry.position === 1 ? 'selected' : ''}>After Char Defs</option>
                            <option value="2" ${entry.position === 2 ? 'selected' : ''}>Top of Author's Note</option>
                            <option value="3" ${entry.position === 3 ? 'selected' : ''}>Bottom of Author's Note</option>
                            <option value="4" ${entry.position === 4 ? 'selected' : ''}>@ Depth</option>
                        </select>
                    </div>
                    <div class="field-group" style="margin-bottom: 0;">
                        <label class="field-label">æ·±åº¦</label>
                        <input type="number" class="field-input" value="${entry.depth || 4}" min="0" max="10"
                               onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'depth', parseInt(this.value))">
                    </div>
                </div>
                
                <!-- é—œéµå­— -->
                <div class="field-group" style="margin-bottom: 12px;">
                    <label class="field-label">ä¸»è¦é—œéµå­—</label>
                    <input type="text" class="field-input" 
                           placeholder="é—œéµå­—ï¼Œç”¨é€—è™Ÿåˆ†éš”..."
                           value="${entry.key.join(', ')}"
                           onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'key', this.value)">
                </div>

                <!-- æ¬¡è¦é—œéµå­— -->
                <div class="field-group" style="margin-bottom: 12px;">
                    <label class="field-label">å‰¯é—œéµè©</label>
                    <input type="text" class="field-input" 
                           placeholder="æ¬¡è¦é—œéµå­—ï¼Œç”¨é€—è™Ÿåˆ†éš”..."
                           value="${entry.keysecondary.join(', ')}"
                           onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'keysecondary', this.value)">
                </div>
                
                <!-- å…§å®¹ -->
                <div class="field-group" style="margin-bottom: 12px;">
    <label class="field-label">
        å…§å®¹
        <span class="field-stats" data-target="worldbook-content-${entry.id}" style="margin-left: 12px; font-size: 0.85em; color: var(--text-muted);">0 ${t('chars')} / 0 ${t('tokens')}</span>
    </label>
    <textarea class="field-input scrollable" id="worldbook-content-${entry.id}" 
          placeholder="ç•¶è§¸ç™¼é—œéµå­—æ™‚è¦æ’å…¥çš„å…§å®¹..."
          style="min-height: 120px; resize: vertical;"
          oninput="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'content', this.value); updateStats();">${entry.content}</textarea>
                </div>
            </div>

            <!-- é«˜ç´šè¨­å®š -->
            <details style="margin-bottom: 20px;">
                <summary style="cursor: pointer; color: var(--text-color); font-weight: 500; margin-bottom: 12px;">é«˜ç´šè¨­å®š</summary>
                <div style="padding: 12px 0; border-top: 1px solid var(--border-color);">
                    
                    <!-- å„ªå…ˆé †åºå’Œæ©Ÿç‡ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">å„ªå…ˆé †åº</label>
                            <input type="number" class="field-input" value="${entry.order || 100}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'order', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">è§¸ç™¼æ©Ÿç‡ (%)</label>
                            <input type="number" class="field-input" value="${entry.probability || 100}" min="1" max="100"
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'probability', parseInt(this.value))">
                        </div>
                    </div>

                    <!-- åˆ†çµ„è¨­å®š -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">åˆ†çµ„</label>
                            <input type="text" class="field-input" value="${entry.group || ''}" 
                                   placeholder="åˆ†çµ„åç¨±..."
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'group', this.value)">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">åˆ†çµ„æ¬Šé‡</label>
                            <input type="number" class="field-input" value="${entry.groupWeight || 100}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'groupWeight', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">æƒææ·±åº¦</label>
                            <input type="number" class="field-input" value="${entry.scanDepth || ''}" 
                                   placeholder="null"
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'scanDepth', this.value ? parseInt(this.value) : null)">
                        </div>
                    </div>

                    <!-- é–‹é—œé¸é … -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.useProbability ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'useProbability', this.checked)">
                            <span style="margin-left: 6px;">ä½¿ç”¨æ©Ÿç‡</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.addMemo ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'addMemo', this.checked)">
                            <span style="margin-left: 6px;">æ·»åŠ å‚™å¿˜</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.groupOverride ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'groupOverride', this.checked)">
                            <span style="margin-left: 6px;">è¦†è“‹åˆ†çµ„</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.caseSensitive ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'caseSensitive', this.checked)">
                            <span style="margin-left: 6px;">å€åˆ†å¤§å°å¯«</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.matchWholeWords ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'matchWholeWords', this.checked)">
                            <span style="margin-left: 6px;">åŒ¹é…æ•´è©</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.useGroupScoring ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'useGroupScoring', this.checked)">
                            <span style="margin-left: 6px;">ä½¿ç”¨åˆ†çµ„è©•åˆ†</span>
                        </label>
                    </div>

                    <!-- éè¿´æ§åˆ¶ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.excludeRecursion ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'excludeRecursion', this.checked)">
                            <span style="margin-left: 6px;">æ’é™¤éè¿´</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.preventRecursion ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'preventRecursion', this.checked)">
                            <span style="margin-left: 6px;">é˜²æ­¢éè¿´</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" ${entry.delayUntilRecursion ? 'checked' : ''} 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'delayUntilRecursion', this.checked)">
                            <span style="margin-left: 6px;">å»¶é²è‡³éè¿´</span>
                        </label>
                    </div>

                    <!-- å…¶ä»–è¨­å®š -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">ç²˜æ€§</label>
                            <input type="number" class="field-input" value="${entry.sticky || 0}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'sticky', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">å†·å»æ™‚é–“</label>
                            <input type="number" class="field-input" value="${entry.cooldown || 0}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'cooldown', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">å»¶é²</label>
                            <input type="number" class="field-input" value="${entry.delay || 0}" 
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'delay', parseInt(this.value))">
                        </div>
                        <div class="field-group" style="margin-bottom: 0;">
                            <label class="field-label">è‡ªå‹•åŒ– ID</label>
                            <input type="text" class="field-input" value="${entry.automationId || ''}" 
                                   placeholder="è‡ªå‹•åŒ–è­˜åˆ¥ç¢¼..."
                                   onchange="updateWorldBookEntry('${worldBookId}', '${versionId}', '${entry.id}', 'automationId', this.value)">
                        </div>
                    </div>
                </div>
            </details>
        </div>
    `;
}

function updateEntryModeFromSelect(worldBookId, versionId, entryId, mode) {
    updateEntryMode(worldBookId, versionId, entryId, mode);
    // ä¸é‡æ–°æ¸²æŸ“ï¼Œåªæ›´æ–°ç‹€æ…‹åœ–ç¤º
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                updateEntryStatusIcon(entryId, entry);
            }
        }
    }
}

function toggleLanguageMenu() {
    const menu = document.getElementById('lang-menu');
    const isVisible = menu.style.display !== 'none';
    
    if (isVisible) {
        menu.style.display = 'none';
    } else {
        menu.style.display = 'block';
        updateLanguageMenu();
    }
}
function updateLanguageMenu() {
    const options = document.querySelectorAll('.language-option');
    options.forEach(option => {
        const lang = option.getAttribute('onclick').match(/'(.+)'/)[1];
        if (lang === currentLang) {
            option.classList.add('active');
        } else {
            option.classList.remove('active');
        }
    });
}

function updateEntryMode(worldBookId, versionId, entryId, mode) {
    const worldBook = worldBooks.find(wb => wb.id === worldBookId);
    if (worldBook) {
        const version = worldBook.versions.find(v => v.id === versionId);
        if (version) {
            const entry = version.entries.find(e => e.id === entryId);
            if (entry) {
                // é‡ç½®æ‰€æœ‰æ¨¡å¼
                entry.constant = false;
                entry.vectorized = false;
                entry.selective = true;
                
                // è¨­å®šé¸ä¸­çš„æ¨¡å¼
                switch (mode) {
                    case 'constant':
                        entry.constant = true;
                        entry.selective = false;
                        break;
                    case 'vectorized':
                        entry.vectorized = true;
                        entry.selective = false;
                        break;
                    case 'selective':
                    default:
                        entry.selective = true;
                        break;
                }
                markAsChanged();
            }
        }
    }
}

function selectLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('characterCreatorLang', lang);
    
    // éš±è—é¸å–®
    document.getElementById('lang-menu').style.display = 'none';
    
    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    document.getElementById('lang-current').textContent = lang === 'zh' ? 'ä¸­æ–‡' : 'English';
    
    renderAll(); // é€™è£¡æœƒè§¸ç™¼ updateSaveButtonStates()
}

        function renderVersionPanel(character, version) {
    return `
        <div class="version-panel">
           <div class="version-header">
    <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
        <input type="text" class="version-title" value="${version.name}" 
               onchange="updateVersionName('${character.id}', '${version.id}', this.value)"
               style="font-size: 1.2em; font-weight: 600; margin: 0; padding: 8px 12px; border: 1px solid transparent; border-radius: 6px; background: transparent; color: var(--text-color); transition: all 0.2s ease;">
        <div class="version-stats" id="version-stats-${version.id}" style="font-size: 0.85em; color: var(--text-muted); padding-left: 12px;">
            ${t('versionStats', 0, 0)}
        </div>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="btn btn-secondary btn-small" onclick="copyVersion('${character.id}', '${version.id}')">${t('copy')}</button>
        ${character.versions.length > 1 ? `<button class="btn btn-secondary btn-small" onclick="removeVersion('${character.id}', '${version.id}')">${t('delete')}</button>` : ''}
    </div>
</div>

            <div class="character-basic-info">
    <div class="avatar-section">
        <div class="avatar-preview" onclick="triggerImageUpload('${character.id}', '${version.id}')" style="cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            ${version.avatar ? `<img src="${version.avatar}" alt="Avatar">` : `<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 0.9em; text-align: center;"><div style="font-size: 2em; margin-bottom: 8px;">ğŸ“·</div><div>é»æ“Šä¸Šå‚³åœ–ç‰‡</div></div>`}
        </div>
        <input type="file" class="file-input" id="avatar-upload-${version.id}" accept="image/*" 
               onchange="handleImageUpload('${character.id}', '${version.id}', this.files[0])">
    </div>
    
    <div class="basic-info-fields">
        <!-- ç¬¬ä¸€è¡Œï¼šå‰µä½œè€… + è§’è‰²ç‰ˆæœ¬ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="field-group" style="margin-bottom: 0;">
                <label class="field-label">
                    ${t('creator')}
                    <span class="field-stats" data-target="creator-${version.id}">0 ${t('chars')}</span>
                </label>
                <input type="text" class="field-input" id="creator-${version.id}" 
                       placeholder="${t('creatorPlaceholder')}"
                       oninput="updateField('${character.id}', '${version.id}', 'creator', this.value); updateStats()" 
                       value="${version.creator || ''}">
            </div>

            <div class="field-group" style="margin-bottom: 0;">
                <label class="field-label">
                    ${t('charVersion')}
                    <span class="field-stats" data-target="charVersion-${version.id}">0 ${t('chars')}</span>
                </label>
                <input type="text" class="field-input" id="charVersion-${version.id}" 
                       placeholder="${t('versionPlaceholder')}"
                       oninput="updateField('${character.id}', '${version.id}', 'charVersion', this.value); updateStats()" 
                       value="${version.charVersion || ''}">
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šå‰µä½œè€…å‚™è¨»ï¼ˆç¨ç«‹ä¸€è¡Œï¼Œè¼ƒé«˜çš„æ–‡å­—æ¡†ï¼‰ -->
        <div class="field-group" style="margin-bottom: 20px;">
            <label class="field-label">
                ${t('creatorNotes')}
                <span class="field-stats" data-target="creatorNotes-${version.id}">0 ${t('chars')}</span>
            </label>
            <textarea class="field-input" id="creatorNotes-${version.id}" 
                      placeholder="${t('notesPlaceholder')}"
                      style="min-height: 60px; resize: vertical;"
                      oninput="updateField('${character.id}', '${version.id}', 'creatorNotes', this.value); updateStats()">${version.creatorNotes || ''}</textarea>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šåµŒå…¥æ¨™ç±¤ï¼ˆç¨ç«‹ä¸€è¡Œï¼Œæ‹‰é•·ï¼‰ -->
        <div class="field-group" style="margin-bottom: 0;">
            <label class="field-label">
                ${t('tags')}
                <span class="field-stats" data-target="tags-${version.id}">0 ${t('chars')}</span>
            </label>
            <input type="text" class="field-input" id="tags-${version.id}" 
                   placeholder="${t('tagsPlaceholder')}"
                   oninput="updateField('${character.id}', '${version.id}', 'tags', this.value); updateStats()" 
                   value="${version.tags || ''}">
        </div>
    </div>
</div>

            <div class="field-group">
                <label class="field-label">
                    ${t('description')}
                    <span class="field-stats" data-target="desc-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="desc-${version.id}" 
          placeholder="${t('descPlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'description', this.value); updateStats(); autoResizeTextarea(this);">${version.description}</textarea>

            </div>

            <div class="field-group">
                <label class="field-label">
                    ${t('personality')}
                    <span class="field-stats" data-target="personality-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="personality-${version.id}" 
          placeholder="${t('personalityPlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'personality', this.value); updateStats(); autoResizeTextarea(this);">${version.personality}</textarea>

            </div>

            <div class="field-group">
                <label class="field-label">
                    ${t('scenario')}
                    <span class="field-stats" data-target="scenario-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="scenario-${version.id}" 
          placeholder="${t('scenarioPlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'scenario', this.value); updateStats(); autoResizeTextarea(this);">${version.scenario}</textarea>

            </div>

            <div class="field-group">
                <label class="field-label">
                    ${t('dialogue')}
                    <span class="field-stats" data-target="dialogue-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="dialogue-${version.id}" 
          placeholder="${t('dialoguePlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'dialogue', this.value); updateStats(); autoResizeTextarea(this);">${version.dialogue}</textarea>

            </div>

            <div class="field-group">
                <label class="field-label">
                    ${t('firstMessage')}
                    <span class="field-stats" data-target="firstmsg-${version.id}">0 ${t('chars')} / 0 ${t('tokens')}</span>
                </label>
                <textarea class="field-input auto-resize" id="firstmsg-${version.id}" 
          placeholder="${t('firstMsgPlaceholder')}"
          oninput="updateField('${character.id}', '${version.id}', 'firstMessage', this.value); updateStats(); autoResizeTextarea(this);">${version.firstMessage}</textarea>

            </div>
        </div>
    `;
}

        function renderAll() {
            renderSidebar();
            renderContent();
            updateTotalStats();
            updateLanguageUI();
            updateSaveButtonStates();
        }
function updateLanguageUI() {
    // æ›´æ–°æ¨™é¡Œå’Œå‰¯æ¨™é¡Œ
    document.querySelector('.app-title').textContent = t('appTitle');
    document.querySelector('.app-subtitle').textContent = t('appSubtitle');
    
    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    document.querySelector('button[onclick="showColorPicker()"]').textContent = t('customColor');
    document.querySelector('button[onclick="exportAllData()"]').textContent = t('exportData');
    document.querySelector('button[onclick="importAllData()"]').textContent = t('importData');
    
    // æ›´æ–°èªè¨€æŒ‰éˆ•æ–‡å­—
    const langCurrent = document.getElementById('lang-current');
    if (langCurrent) {
        langCurrent.textContent = currentLang === 'zh' ? 'ä¸­æ–‡' : 'English';
    }
    
    // ç¢ºä¿æŒ‰éˆ•ç‹€æ…‹æ­£ç¢ºé¡¯ç¤º
    updateSaveButtonStates();
}

function triggerImageUpload(characterId, versionId) {
    document.getElementById(`avatar-upload-${versionId}`).click();
}

       function updateTotalStats() {
    if (currentMode === 'character') {
        const currentCharacter = characters.find(c => c.id === currentCharacterId);
        if (!currentCharacter) return;

        if (viewMode === 'compare') {
            // å°æ¯”æ¨¡å¼ï¼šé¡¯ç¤ºæ¯å€‹ç‰ˆæœ¬çš„è©³ç´°çµ±è¨ˆ
            const versionsToCount = currentCharacter.versions.filter(v => compareVersions.includes(v.id));
            
            let statsHTML = '';
            versionsToCount.forEach(version => {
                const allText = [
                    version.description, version.personality, version.scenario, 
                    version.dialogue, version.firstMessage
                ].join(' ');
                
                const chars = allText.length;
                const tokens = countTokens(allText);
                
                statsHTML += `<div>${version.name} - ${chars} ${t('chars')} / ${tokens} ${t('tokens')}</div>`;
            });
            
            // æ›´æ–°ç¸½è¨ˆå€åŸŸçš„HTMLçµæ§‹
            const statsBar = document.querySelector('.stats-bar .total-stats');
            if (statsBar) {
                statsBar.innerHTML = `
                    <div style="font-weight: 600; font-size: 1.1em; color: var(--text-color); margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;">${t('total')}</div>
                    ${statsHTML}
                `;
            }
        } else {
            // å–®ä¸€æª¢è¦–ï¼šé¡¯ç¤ºå–®å€‹ç‰ˆæœ¬çµ±è¨ˆ
            let totalChars = 0;
            let totalTokens = 0;
            
            const versionsToCount = currentCharacter.versions.filter(v => v.id === currentVersionId);

            versionsToCount.forEach(version => {
                const allText = [
                    version.description, version.personality, version.scenario, 
                    version.dialogue, version.firstMessage
                ].join(' ');

                totalChars += allText.length;
                totalTokens += countTokens(allText);
            });

            // æ¢å¾©åŸæœ¬çš„é¡¯ç¤ºæ–¹å¼
            const statsBar = document.querySelector('.stats-bar .total-stats');
            if (statsBar) {
                statsBar.innerHTML = `${t('total')} - <span id="total-chars">${totalChars}</span> ${t('chars')} / <span id="total-tokens">${totalTokens}</span> ${t('tokens')}`;
            }
        }
    } else if (currentMode === 'custom') {
        // è‡ªå®šç¾©æ¨¡å¼çš„çµ±è¨ˆ
        const currentSection = customSections.find(s => s.id === currentCustomSectionId);
        if (!currentSection) return;

        if (viewMode === 'compare') {
            // å°æ¯”æ¨¡å¼
            const versionsToCount = currentSection.versions.filter(v => compareVersions.includes(v.id));
            
            let statsHTML = '';
            versionsToCount.forEach(version => {
                const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
                const chars = allText.length;
                const tokens = countTokens(allText);
                
                statsHTML += `<div>${version.name} - ${chars} ${t('chars')} / ${tokens} ${t('tokens')}</div>`;
            });
            
            const statsBar = document.querySelector('.stats-bar .total-stats');
            if (statsBar) {
                statsBar.innerHTML = `
                    <div style="font-weight: 600; font-size: 1.1em; color: var(--text-color); margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;">${t('total')}</div>
                    ${statsHTML}
                `;
            }
        } else {
            // å–®ä¸€æª¢è¦–
            let totalChars = 0;
            let totalTokens = 0;
            
            const versionsToCount = currentSection.versions.filter(v => v.id === currentCustomVersionId);

            versionsToCount.forEach(version => {
                const allText = version.fields.map(field => field.content).filter(Boolean).join(' ');
                totalChars += allText.length;
                totalTokens += countTokens(allText);
            });

            const statsBar = document.querySelector('.stats-bar .total-stats');
            if (statsBar) {
                statsBar.innerHTML = `${t('total')} - <span id="total-chars">${totalChars}</span> ${t('chars')} / <span id="total-tokens">${totalTokens}</span> ${t('tokens')}`;
            }
        }
    }
}

        function exportJSON(characterId) {
    const character = characters.find(c => c.id === characterId);
    if (!character) return;

    if (character.versions.length === 1) {
        downloadJSON(character, character.versions[0]);
    } else {
        const versionIndex = prompt(t('selectVersion', character.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < character.versions.length) {
            downloadJSON(character, character.versions[index]);
        }
    }
}

        function downloadJSON(character, version) {
            const characterData = {
                name: character.name,
                description: version.description,
                personality: version.personality,
                scenario: version.scenario,
                first_mes: version.firstMessage,
                mes_example: version.dialogue,
                creatorcomment: version.creatorNotes,
                avatar: "none",
                talkativeness: "0.5",
                fav: false,
                tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                spec: "chara_card_v3",
                spec_version: "3.0",
                data: {
                    name: character.name,
                    description: version.description,
                    personality: version.personality,
                    scenario: version.scenario,
                    first_mes: version.firstMessage,
                    mes_example: version.dialogue,
                    creator_notes: version.creatorNotes,
                    system_prompt: "",
                    post_history_instructions: "",
                    tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    creator: version.creator,
                    character_version: version.charVersion,
                    alternate_greetings: [],
                    extensions: {
                        talkativeness: "0.5",
                        fav: false,
                        world: "",
                        depth_prompt: {
                            prompt: "",
                            depth: 4,
                            role: "system"
                        }
                    },
                    group_only_greetings: []
                },
                create_date: new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
            };

            const blob = new Blob([JSON.stringify(characterData, null, 4)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportPNG(characterId) {
    const character = characters.find(c => c.id === characterId);
    if (!character) return;

    // é¸æ“‡ç‰ˆæœ¬
    let selectedVersion;
    if (character.versions.length === 1) {
        selectedVersion = character.versions[0];
    } else {
        const versionIndex = prompt(t('selectVersion', character.versions.length));
        const index = parseInt(versionIndex) - 1;
        if (index >= 0 && index < character.versions.length) {
            selectedVersion = character.versions[index];
        } else {
            return;
        }
    }

            // å‰µå»ºèˆ‡JSONç›¸åŒçš„è³‡æ–™çµæ§‹
            const characterData = {
                name: character.name,
                description: selectedVersion.description,
                personality: selectedVersion.personality,
                scenario: selectedVersion.scenario,
                first_mes: selectedVersion.firstMessage,
                mes_example: selectedVersion.dialogue,
                creatorcomment: selectedVersion.creatorNotes,
                avatar: "none",
                talkativeness: "0.5",
                fav: false,
                tags: selectedVersion.tags ? selectedVersion.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                spec: "chara_card_v3",
                spec_version: "3.0",
                data: {
                    name: character.name,
                    description: selectedVersion.description,
                    personality: selectedVersion.personality,
                    scenario: selectedVersion.scenario,
                    first_mes: selectedVersion.firstMessage,
                    mes_example: selectedVersion.dialogue,
                    creator_notes: selectedVersion.creatorNotes,
                    system_prompt: "",
                    post_history_instructions: "",
                    tags: selectedVersion.tags ? selectedVersion.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    creator: selectedVersion.creator,
                    character_version: selectedVersion.charVersion,
                    alternate_greetings: [],
                    extensions: {
                        talkativeness: "0.5",
                        fav: false,
                        world: "",
                        depth_prompt: {
                            prompt: "",
                            depth: 4,
                            role: "system"
                        }
                    },
                    group_only_greetings: []
                },
                create_date: new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
            };

            // å°‡JSONè½‰ç‚ºBase64
            const jsonString = JSON.stringify(characterData);
            const base64Data = btoa(unescape(encodeURIComponent(jsonString)));

            // å‰µå»ºæˆ–ä½¿ç”¨ç¾æœ‰çš„é ­åƒåœ–ç‰‡
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            if (selectedVersion.avatar) {
                // å¦‚æœæœ‰é ­åƒï¼Œä½¿ç”¨é ­åƒä½œç‚ºPNGåœ–ç‰‡
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // åµŒå…¥chara metadataä¸¦ä¸‹è¼‰
                    createPNGWithMetadata(canvas, base64Data, character.name);
                };
                img.src = selectedVersion.avatar;
            } else {
                // å¦‚æœæ²’æœ‰é ­åƒï¼Œå‰µå»ºé è¨­åœ–ç‰‡
                canvas.width = 400;
                canvas.height = 600;
                
                // å‰µå»ºæ¼¸å±¤èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, 0, 600);
                gradient.addColorStop(0, '#f7f5f3');
                gradient.addColorStop(1, '#e2e8f0');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 600);
                
                // æ·»åŠ è§’è‰²åç¨±
                ctx.fillStyle = '#2d3748';
                ctx.font = 'bold 24px "Noto Serif CJK JP", serif';
                ctx.textAlign = 'center';
                ctx.fillText(character.name, 200, 300);
                
                // æ·»åŠ å‰¯æ¨™é¡Œ
                ctx.font = '16px "Noto Serif CJK JP", serif';
                ctx.fillStyle = '#718096';
                ctx.fillText('Character Card', 200, 330);
                
                // åµŒå…¥chara metadataä¸¦ä¸‹è¼‰
                createPNGWithMetadata(canvas, base64Data, character.name);
            }
        }

        function createPNGWithMetadata(canvas, base64Data, characterName, callback) {
    // å°‡Canvasè½‰ç‚ºImageData
    canvas.toBlob(function(blob) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const arrayBuffer = e.target.result;
            const uint8Array = new Uint8Array(arrayBuffer);
            
            // åœ¨PNGä¸­åµŒå…¥tEXt chunk with "chara" keyword
            const modifiedPNG = addTextChunkToPNG(uint8Array, 'chara', base64Data);
            
            // ä¸‹è¼‰ä¿®æ”¹å¾Œçš„PNG
            const modifiedBlob = new Blob([modifiedPNG], { type: 'image/png' });
            const url = URL.createObjectURL(modifiedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${characterName}.png`;
            a.click();
            URL.revokeObjectURL(url);
            
            // å‘¼å«å›èª¿å‡½æ•¸ï¼ˆå¦‚æœæœ‰æä¾›ï¼‰
            if (callback) {
                setTimeout(callback, 100);
            }
        };
        reader.readAsArrayBuffer(blob);
    }, 'image/png');
}

        function addTextChunkToPNG(pngData, keyword, text) {
            // PNGæª”æ¡ˆçµæ§‹ï¼š8ä½å…ƒçµ„PNGç°½å + æ•¸å€‹chunks + IEND chunk
            const signature = pngData.slice(0, 8);
            let pos = 8;
            const chunks = [];
            
            // è®€å–æ‰€æœ‰ç¾æœ‰çš„chunks
            while (pos < pngData.length) {
                const length = (pngData[pos] << 24) | (pngData[pos + 1] << 16) | (pngData[pos + 2] << 8) | pngData[pos + 3];
                const type = String.fromCharCode(pngData[pos + 4], pngData[pos + 5], pngData[pos + 6], pngData[pos + 7]);
                const chunkData = pngData.slice(pos, pos + 12 + length);
                
                chunks.push(chunkData);
                
                if (type === 'IEND') break;
                pos += 12 + length;
            }
            
            // å‰µå»ºtEXt chunk
            const keywordBytes = new TextEncoder().encode(keyword);
            const textBytes = new TextEncoder().encode(text);
            const chunkData = new Uint8Array(keywordBytes.length + 1 + textBytes.length);
            chunkData.set(keywordBytes, 0);
            chunkData[keywordBytes.length] = 0; // null separator
            chunkData.set(textBytes, keywordBytes.length + 1);
            
            // è¨ˆç®—CRC
            const crc = calculateCRC32([0x74, 0x45, 0x58, 0x74, ...chunkData]); // "tEXt" + data
            
            // çµ„è£tEXt chunk
            const textChunk = new Uint8Array(12 + chunkData.length);
            const lengthBytes = [(chunkData.length >>> 24) & 0xFF, (chunkData.length >>> 16) & 0xFF, (chunkData.length >>> 8) & 0xFF, chunkData.length & 0xFF];
            textChunk.set(lengthBytes, 0);
            textChunk.set([0x74, 0x45, 0x58, 0x74], 4); // "tEXt"
            textChunk.set(chunkData, 8);
            textChunk.set([(crc >>> 24) & 0xFF, (crc >>> 16) & 0xFF, (crc >>> 8) & 0xFF, crc & 0xFF], 8 + chunkData.length);
            
            // é‡æ–°çµ„è£PNGï¼šç°½å + åŸæœ‰chunks (é™¤äº†IEND) + tEXt chunk + IEND
            const iendChunk = chunks.pop(); // ç§»é™¤IEND
            const totalLength = signature.length + chunks.reduce((sum, chunk) => sum + chunk.length, 0) + textChunk.length + iendChunk.length;
            const result = new Uint8Array(totalLength);
            
            let offset = 0;
            result.set(signature, offset);
            offset += signature.length;
            
            for (const chunk of chunks) {
                result.set(chunk, offset);
                offset += chunk.length;
            }
            
            result.set(textChunk, offset);
            offset += textChunk.length;
            
            result.set(iendChunk, offset);
            
            return result;
        }

        function calculateCRC32(data) {
            const crcTable = [];
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) {
                    if (c & 1) {
                        c = 0xEDB88320 ^ (c >>> 1);
                    } else {
                        c = c >>> 1;
                    }
                }
                crcTable[i] = c;
            }
            
            let crc = 0xFFFFFFFF;
            for (let i = 0; i < data.length; i++) {
                crc = crcTable[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
            }
            return (crc ^ 0xFFFFFFFF) >>> 0;
        }

        function exportAllVersions(characterId) {
    const character = characters.find(c => c.id === characterId);
    if (!character) return;

    // é¡¯ç¤ºæ ¼å¼é¸æ“‡å°è©±æ¡†
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">${t('exportAllTitle')}</h3>
                <button class="close-modal" onclick="this.closest('.modal').remove()">Ã—</button>
            </div>
            
            <p style="margin-bottom: 20px; color: var(--text-muted); font-size: 0.9em;">
                ${t('exportAllDesc', character.name, character.versions.length)}
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
                <div class="format-option" onclick="selectExportFormat('json')" data-format="json">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                        <input type="radio" name="export-format" value="json" style="margin: 0;">
                        <div>
                            <strong>${t('jsonFormat')}</strong>
                            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 4px;">
                                ${t('jsonDesc')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="format-option" onclick="selectExportFormat('png')" data-format="png">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                        <input type="radio" name="export-format" value="png" style="margin: 0;">
                        <div>
                            <strong>${t('pngFormat')}</strong>
                            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 4px;">
                                ${t('pngDesc')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">${t('cancel')}</button>
                <button class="btn btn-primary" onclick="startBatchExport('${characterId}')" id="start-export" disabled>${t('startExport')}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // é»æ“Šå¤–éƒ¨é—œé–‰
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
let selectedExportFormat = null;

function selectExportFormat(format) {
    selectedExportFormat = format;
    
    // æ›´æ–°é¸ä¸­ç‹€æ…‹
    document.querySelectorAll('.format-option').forEach(option => {
        const container = option.querySelector('div');
        const radio = option.querySelector('input[type="radio"]');
        
        if (option.dataset.format === format) {
            container.style.borderColor = 'var(--primary-color)';
            container.style.backgroundColor = 'var(--bg-color)';
            radio.checked = true;
        } else {
            container.style.borderColor = 'var(--border-color)';
            container.style.backgroundColor = 'transparent';
            radio.checked = false;
        }
    });
    
    // å•Ÿç”¨é–‹å§‹åŒ¯å‡ºæŒ‰éˆ•
    document.getElementById('start-export').disabled = false;
}

function startBatchExport(characterId) {
    if (!selectedExportFormat) return;
    
    const character = characters.find(c => c.id === characterId);
    if (!character) return;
    
    // é—œé–‰å°è©±æ¡†
    document.querySelector('.modal').remove();
    
    // é¡¯ç¤ºé€²åº¦æç¤º
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 500;
        z-index: 9999;
        box-shadow: var(--shadow-large);
        max-width: 300px;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <div>
                <div>${t('exporting', character.versions.length)}</div>
                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 4px;" id="export-progress">${t('preparing')}</div>
            </div>
        </div>
    `;
    
    // æ·»åŠ æ—‹è½‰å‹•ç•«
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // é–‹å§‹æ‰¹æ¬¡åŒ¯å‡º
    if (selectedExportFormat === 'json') {
        exportAllVersionsJSON(character, notification);
    } else {
        exportAllVersionsPNG(character, notification);
    }
    
    // é‡ç½®é¸æ“‡
    selectedExportFormat = null;
}

function exportAllVersionsJSON(character, notification) {
    const progressElement = notification.querySelector('#export-progress');
    
    character.versions.forEach((version, index) => {
        setTimeout(() => {
            progressElement.textContent = `JSON ${index + 1}/${character.versions.length}: ${version.name}`;
            downloadJSON(character, version);
            
            // æœ€å¾Œä¸€å€‹æª”æ¡ˆåŒ¯å‡ºå®Œæˆ
            if (index === character.versions.length - 1) {
                setTimeout(() => {
                    notification.remove();
                    showCompletionNotification(character.versions.length, 'JSON');
                }, 500);
            }
        }, index * 300); // æ¯å€‹æª”æ¡ˆé–“éš”300ms
    });
}

function exportAllVersionsPNG(character, notification) {
    const progressElement = notification.querySelector('#export-progress');
    let completed = 0;
    
    character.versions.forEach((version, index) => {
        setTimeout(() => {
            progressElement.textContent = `PNG ${index + 1}/${character.versions.length}: ${version.name}`;
            
            // ç‚ºPNGåŒ¯å‡ºå‰µå»ºç‰¹æ®Šçš„å®Œæˆå›èª¿
            exportVersionPNG(character, version, () => {
                completed++;
                if (completed === character.versions.length) {
                    notification.remove();
                    showCompletionNotification(character.versions.length, 'PNG');
                }
            });
        }, index * 800); // PNGéœ€è¦æ›´é•·é–“éš”ï¼Œå› ç‚ºè™•ç†æ™‚é–“è¼ƒé•·
    });
}

function exportVersionPNG(character, version, callback) {
    // å‰µå»ºèˆ‡åŸexportPNGç›¸åŒçš„è³‡æ–™çµæ§‹
    const characterData = {
        name: character.name,
        description: version.description,
        personality: version.personality,
        scenario: version.scenario,
        first_mes: version.firstMessage,
        mes_example: version.dialogue,
        creatorcomment: version.creatorNotes,
        avatar: "none",
        talkativeness: "0.5",
        fav: false,
        tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
        spec: "chara_card_v3",
        spec_version: "3.0",
        data: {
            name: character.name,
            description: version.description,
            personality: version.personality,
            scenario: version.scenario,
            first_mes: version.firstMessage,
            mes_example: version.dialogue,
            creator_notes: version.creatorNotes,
            system_prompt: "",
            post_history_instructions: "",
            tags: version.tags ? version.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
            creator: version.creator,
            character_version: version.charVersion,
            alternate_greetings: [],
            extensions: {
                talkativeness: "0.5",
                fav: false,
                world: "",
                depth_prompt: {
                    prompt: "",
                    depth: 4,
                    role: "system"
                }
            },
            group_only_greetings: []
        },
        create_date: new Date().toLocaleString('zh-TW', {
            year: 'numeric',
            month: 'numeric', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }).replace(/\//g, '-').replace(',', ' @').replace(/:/g, 'h ').replace(/(\d+)$/, '$1s') + ' ' + new Date().getMilliseconds() + 'ms'
    };

    // å°‡JSONè½‰ç‚ºBase64
    const jsonString = JSON.stringify(characterData);
    const base64Data = btoa(unescape(encodeURIComponent(jsonString)));

    // å‰µå»ºæˆ–ä½¿ç”¨ç¾æœ‰çš„é ­åƒåœ–ç‰‡
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    if (version.avatar) {
        // å¦‚æœæœ‰é ­åƒï¼Œä½¿ç”¨é ­åƒä½œç‚ºPNGåœ–ç‰‡
        const img = new Image();
        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            // åµŒå…¥chara metadataä¸¦ä¸‹è¼‰
            createPNGWithMetadata(canvas, base64Data, `${character.name}_${version.name}`, callback);
        };
        img.src = version.avatar;
    } else {
        // å¦‚æœæ²’æœ‰é ­åƒï¼Œå‰µå»ºé è¨­åœ–ç‰‡
        canvas.width = 400;
        canvas.height = 600;
        
        // å‰µå»ºæ¼¸å±¤èƒŒæ™¯
        const gradient = ctx.createLinearGradient(0, 0, 0, 600);
        gradient.addColorStop(0, '#f7f5f3');
        gradient.addColorStop(1, '#e2e8f0');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 400, 600);
        
        // æ·»åŠ è§’è‰²åç¨±
        ctx.fillStyle = '#2d3748';
        ctx.font = 'bold 24px "Noto Serif CJK JP", serif';
        ctx.textAlign = 'center';
        ctx.fillText(character.name, 200, 280);
        
        // æ·»åŠ ç‰ˆæœ¬åç¨±
        ctx.font = '18px "Noto Serif CJK JP", serif';
        ctx.fillStyle = '#718096';
        ctx.fillText(version.name, 200, 310);
        
        // æ·»åŠ å‰¯æ¨™é¡Œ
        ctx.font = '16px "Noto Serif CJK JP", serif';
        ctx.fillText('Character Card', 200, 340);
        
        // åµŒå…¥chara metadataä¸¦ä¸‹è¼‰
        createPNGWithMetadata(canvas, base64Data, `${character.name}_${version.name}`, callback);
    }
}

function showCompletionNotification(count, format) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 500;
        z-index: 9999;
        box-shadow: var(--shadow-large);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    notification.innerHTML = t('exportComplete', count, format);
    
    document.body.appendChild(notification);
    
    // æ»‘å…¥å‹•ç•«
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // 3ç§’å¾Œç§»é™¤
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

        function importCharacter() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            if (file.type === 'application/json' || file.name.endsWith('.json')) {
                // è™•ç†JSONæª”æ¡ˆ
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        importCharacterFromData(data);
                    } catch (error) {
                        alert('JSONæª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„è§’è‰²å¡æª”æ¡ˆ');
                    }
                };
                reader.readAsText(file);
           } else if (file.type === 'image/png' || file.name.endsWith('.png')) {
    // è™•ç†PNGæª”æ¡ˆ
    const readerForBuffer = new FileReader();
    readerForBuffer.onload = function(e) {
        try {
            const arrayBuffer = e.target.result;
            const charaData = extractCharaFromPNG(new Uint8Array(arrayBuffer));

            if (charaData) {
                const jsonString = atob(charaData);
                const data = JSON.parse(decodeURIComponent(escape(jsonString)));

                // å†é–‹ä¸€å€‹ FileReader è®€ base64 åœ–ç‰‡
                const readerForImage = new FileReader();
                readerForImage.onload = function(ev) {
                    data.avatar = ev.target.result; // base64 æ ¼å¼
                    console.log("base64 avatar:", data.avatar);
                    importCharacterFromData(data);
                };
                readerForImage.readAsDataURL(file); // è®€æˆ base64
            } else {
                alert('PNGæª”æ¡ˆä¸­æœªæ‰¾åˆ°è§’è‰²è³‡æ–™ï¼Œè«‹ç¢ºèªé€™æ˜¯æœ‰æ•ˆçš„è§’è‰²å¡PNGæª”æ¡ˆ');
            }
        } catch (error) {
            alert('PNGæª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
        }
    };
    readerForBuffer.readAsArrayBuffer(file);
        }else {
                alert('è«‹é¸æ“‡JSONæˆ–PNGæ ¼å¼çš„è§’è‰²å¡æª”æ¡ˆ');
            }
        }

        function extractCharaFromPNG(pngData) {
            // è·³éPNGç°½å
            let pos = 8;
            
            while (pos < pngData.length) {
                // è®€å–chunké•·åº¦
                const length = (pngData[pos] << 24) | (pngData[pos + 1] << 16) | (pngData[pos + 2] << 8) | pngData[pos + 3];
                
                // è®€å–chunké¡å‹
                const type = String.fromCharCode(pngData[pos + 4], pngData[pos + 5], pngData[pos + 6], pngData[pos + 7]);
                
                if (type === 'tEXt') {
                    // è®€å–tEXt chunkçš„è³‡æ–™
                    const textData = pngData.slice(pos + 8, pos + 8 + length);
                    
                    // å°‹æ‰¾nullåˆ†éš”ç¬¦
                    let nullPos = -1;
                    for (let i = 0; i < textData.length; i++) {
                        if (textData[i] === 0) {
                            nullPos = i;
                            break;
                        }
                    }
                    
                    if (nullPos !== -1) {
                        // æå–keywordå’Œtext
                        const keyword = new TextDecoder().decode(textData.slice(0, nullPos));
                        const text = new TextDecoder().decode(textData.slice(nullPos + 1));
                        
                        if (keyword === 'chara') {
                            return text;
                        }
                    }
                }
                
                if (type === 'IEND') break;
                pos += 12 + length;
            }
            
            return null;
        }

        function importCharacterFromData(data) {
    const character = {
        id: generateId(),
        name: data.name || 'Imported Character',
        versions: [{
            id: generateId(),
            name: 'Imported Version',
            avatar: data.avatar && data.avatar !== 'none' ? data.avatar : '',
            creator: data.data?.creator || data.creator || '',
            charVersion: data.data?.character_version || data.character_version || '',
            creatorNotes: data.data?.creator_notes || data.creatorcomment || '',
            tags: Array.isArray(data.tags) ? data.tags.join(', ') : (data.data?.tags ? data.data.tags.join(', ') : ''),
            description: data.data?.description || data.description || '',
            personality: data.data?.personality || data.personality || '',
            scenario: data.data?.scenario || data.scenario || '',
            dialogue: data.data?.mes_example || data.mes_example || '',
            firstMessage: data.data?.first_mes || data.first_mes || ''
        }]
    };
    characters.push(character);
    currentCharacterId = character.id;
    currentVersionId = character.versions[0].id;
    renderAll();
    markAsChanged(); // æ¨™è¨˜æœ‰è®Šæ›´
    alert(t('importSuccess'));
}

document.addEventListener('click', function(e) {
            const langContainer = document.querySelector('.language-menu-container');
            const langMenu = document.getElementById('lang-menu');
            
            if (langContainer && !langContainer.contains(e.target) && langMenu) {
                langMenu.style.display = 'none';
            }
        });

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initApp() {
            // åœ¨ initApp å‡½æ•¸ä¸­ï¼Œæ‰¾åˆ°è¼‰å…¥è‡ªè¨‚é¡è‰²çš„éƒ¨åˆ†
const savedColors = localStorage.getItem('characterCreatorCustomColors');
if (savedColors) {
    const colors = JSON.parse(savedColors);
    const root = document.documentElement;
    root.style.setProperty('--primary-color', colors.primary);
    root.style.setProperty('--secondary-color', colors.secondary);
    root.style.setProperty('--accent-color', colors.accent);
    root.style.setProperty('--bg-color', colors.bg);
    if (colors.surface) {
        root.style.setProperty('--surface-color', colors.surface);
    }
    if (colors.textColor) {
        root.style.setProperty('--text-color', colors.textColor);
    }
    if (colors.textMuted) {
        root.style.setProperty('--text-muted', colors.textMuted);
    }
    // æ–°å¢ï¼šè¼‰å…¥é‚Šæ¡†é¡è‰²
if (colors.borderColor) {
    root.style.setProperty('--border-color', colors.borderColor);
}
    // æ–°å¢ï¼šè¼‰å…¥ç•Œé¢è‰²å½©
    if (colors.headerBg) {
    root.style.setProperty('--header-bg', colors.headerBg);
}
if (colors.sidebarBg) {
    root.style.setProperty('--sidebar-bg', colors.sidebarBg);
}
if (colors.mainContentBg) {
    root.style.setProperty('--main-content-bg', colors.mainContentBg);
}
if (colors.contentBg) {
    root.style.setProperty('--content-bg', colors.contentBg);
}
}

// é›¢é–‹é é¢å‰çš„è­¦å‘Šï¼š
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        const message = currentLang === 'zh' ? 
            'ä½ æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ' : 
            'You have unsaved changes. Are you sure you want to leave?';
        
        e.preventDefault();
        e.returnValue = message; // æ¨™æº–æ–¹å¼
        return message; // æŸäº›ç€è¦½å™¨éœ€è¦
    }
});

            // ä½¿ç”¨CSSé è¨­å€¼ï¼Œä¸éœ€è¦é¡å¤–è¨­å®š

            // è¼‰å…¥è§’è‰²è³‡æ–™
loadData();

// å¦‚æœæ²’æœ‰è§’è‰²ï¼Œå‰µå»ºé è¨­è§’è‰²
if (characters.length === 0) {
    addCharacter();
}

// å¦‚æœæ²’æœ‰è‡ªå®šç¾©å€å¡Šï¼Œå‰µå»ºé è¨­å€å¡Š
if (customSections.length === 0) {
    // ä¸è‡ªå‹•å‰µå»ºï¼Œè®“ç”¨æˆ¶æ‰‹å‹•æ–°å¢
}

// ç¢ºä¿æœ‰æ­£ç¢ºçš„åˆå§‹ç‹€æ…‹
if (!currentMode) {
    currentMode = 'character';
}

renderAll();

             updateLanguageUI();
             updateSaveButtonStates();

            // å®šæœŸæ›´æ–°çµ±è¨ˆ
            setInterval(updateTotalStats, 2000);

            // éŸ¿æ‡‰å¼è™•ç†
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('show');
                }
            });
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
